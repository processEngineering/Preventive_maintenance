<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kartu Riwayat Mesin</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* SETUP HALAMAN A4 & UMUM */
        body {
            font-family: "Times New Roman", Times, serif; /* Font formal dokumen */
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
            color: #000;
        }

        .page-container {
            background-color: white;
            width: 210mm; /* Lebar A4 */
            min-height: 297mm; /* Tinggi A4 */
            margin: auto;
            padding: 20mm;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            box-sizing: border-box;
        }

        h2, h3 {
            text-align: center;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .header-line {
            border-bottom: 2px solid black;
            margin-bottom: 20px;
        }

        /* SECTION STYLING */
        .section-title {
            background-color: #ddd;
            padding: 5px 10px;
            font-weight: bold;
            border: 1px solid #000;
            margin-top: 20px;
            margin-bottom: 15px;
            text-transform: uppercase;
        }

        label {
            font-weight: bold;
            display: block;
            margin-top: 10px;
            font-size: 14px;
        }

        /* INPUT STYLES (Agar terlihat seperti garis isian) */
        input[type="text"], input[type="date"], textarea, select {
            width: 100%;
            border: none;
            border-bottom: 1px dotted #000; /* Garis titik-titik klasik */
            background: transparent;
            font-family: inherit;
            font-size: 14px;
            padding: 5px 0;
            outline: none;
        }

        input:focus, textarea:focus, select:focus {
            background-color: #eef;
            border-bottom: 1px solid blue;
        }

        textarea {
            resize: vertical;
            min-height: 40px;
        }

        /* LAYOUT IDENTITAS MESIN (GRID) */
        .identity-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* BLOK RIWAYAT (ISIAN BERURUTAN) */
        .history-block {
            border: 1px solid #000;
            padding: 15px;
            margin-bottom: 20px;
            page-break-inside: avoid; /* Agar saat print tidak terpotong di tengah */
        }

        .history-header {
            font-weight: bold;
            text-decoration: underline;
            margin-bottom: 10px;
            display: block;
        }

        /* KOLOM DALAM RIWAYAT */
        .row-2-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* TANDA TANGAN */
        .validation-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 30px;
            text-align: center;
        }
        .signature-box {
            height: 100px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        
        /* CANVAS TANDA TANGAN DIGITAL */
        canvas {
            width: 100%;
            height: 100%;
            background: #fff;
        }

        /* TOMBOL (Tidak ikut di-print) */
        .btn-action {
            display: block;
            width: 100%;
            padding: 15px;
            margin-top: 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
        }

        @media print {
            body { background: white; padding: 0; }
            .page-container { width: 100%; box-shadow: none; margin: 0; padding: 10mm; }
            .no-print { display: none !important; }
            input, textarea, select { border-bottom: 1px solid #000; } /* Perjelas garis saat print */
        }
    </style>
</head>
<body>

<div class="page-container">
    <h2>KARTU RIWAYAT MESIN</h2>
    <div class="header-line"></div>

    <form id="logForm">
        
        <div class="section-title">A. IDENTITAS MESIN</div>
        <div class="identity-grid">
            <div>
                <label>NAMA MESIN :</label>
                <select id="machineSelect" required>
                    <option value="">-- Memuat Data... --</option>
                </select>
            </div>
            <div>
                <label>NO. MESIN (ID) :</label>
                <input type="text" id="machineIdDisplay" readonly placeholder="Otomatis terisi...">
            </div>
            <div>
                <label>TAHUN PEMBUATAN :</label>
                <input type="text" placeholder="(Isi manual jika ada)">
            </div>
            <div>
                <label>LOKASI MESIN :</label>
                <input type="text" placeholder="Contoh: Line Produksi A">
            </div>
        </div>

        <div class="section-title">B. RIWAYAT PERAWATAN / PERBAIKAN MESIN</div>
        <div id="historyContainer">
            </div>

        <div class="section-title">C. VALIDASI</div>
        <div class="validation-grid">
            <div>
                <label>Dibuat oleh (PIC):</label>
                <div class="signature-box" style="position:relative; border: 1px dashed #000;">
                    <canvas id="picCanvas"></canvas>
                </div>
                <input type="text" id="picName" placeholder="Nama PIC" style="text-align:center;">
                <br>
                <small>Tanggal: <span id="currentDate"></span></small>
                <button type="button" class="no-print" onclick="clearSig()" style="font-size:10px; margin-top:5px;">Hapus Ttd</button>
            </div>

            <div>
                <label>Diperiksa Supervisor:</label>
                <div class="signature-box">
                    </div>
                <input type="text" placeholder="Nama Supervisor" style="text-align:center;">
                <br>
                <small>Tanggal: __________</small>
            </div>

            <div>
                <label>Disetujui Superintendent:</label>
                <div class="signature-box">
                    </div>
                <input type="text" placeholder="Nama Superintendent" style="text-align:center;">
                <br>
                <small>Tanggal: __________</small>
            </div>
        </div>

        <div class="no-print" style="margin-top: 40px; margin-bottom: 50px;">
            <button type="submit" class="btn-action" id="btnSubmit">üíæ SIMPAN KE DATABASE</button>
            <button type="button" class="btn-action" style="background:#6c757d; margin-top:10px;" onclick="window.print()">üñ®Ô∏è CETAK FORMULIR (PDF)</button>
        </div>

    </form>
</div>

<script>
    // --- 1. SETUP SUPABASE ---
    const SUPABASE_URL = 'https://dsyvlavphvrdidmodokd.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Set Tanggal Hari Ini di tampilan
    document.getElementById('currentDate').innerText = new Date().toLocaleDateString('id-ID');

    // --- 2. GENERATE 25 FORM ISIAN ---
    const historyContainer = document.getElementById('historyContainer');
    
    for (let i = 1; i <= 25; i++) {
        const block = document.createElement('div');
        block.className = 'history-block';
        block.innerHTML = `
            <span class="history-header">RIWAYAT KE-${i}</span>
            
            <div class="row-2-col">
                <div>
                    <label>Tanggal :</label>
                    <input type="date" name="date_${i}">
                </div>
                <div>
                    <label>Spare Part :</label>
                    <input type="text" name="part_${i}" placeholder="Nama part (jika ada)">
                </div>
            </div>

            <label>Permasalahan (Issue) :</label>
            <textarea name="issue_${i}" rows="2"></textarea>

            <label>Tindakan (Action) :</label>
            <textarea name="action_${i}" rows="2"></textarea>

            <label>Keterangan (Remarks) :</label>
            <textarea name="remarks_${i}" rows="1"></textarea>
        `;
        historyContainer.appendChild(block);
    }

    // --- 3. LOAD DATA MESIN ---
    window.addEventListener('DOMContentLoaded', async () => {
        const machineSelect = document.getElementById('machineSelect');
        const machineIdDisplay = document.getElementById('machineIdDisplay');
        
        try {
            const { data, error } = await supabase.from('kartu_riwayat_machines').select('id, name').order('name');
            if (error) throw error;

            machineSelect.innerHTML = '<option value="">-- Pilih Nama Mesin --</option>';
            data.forEach(m => {
                let opt = document.createElement('option');
                opt.value = m.id;
                opt.textContent = m.name;
                machineSelect.appendChild(opt);
            });

            // Update display ID saat mesin dipilih
            machineSelect.addEventListener('change', (e) => {
                machineIdDisplay.value = e.target.value ? `ID-${e.target.value}` : '';
            });

        } catch (err) { alert("Gagal load mesin: " + err.message); }
    });

    // --- 4. TANDA TANGAN (CANVAS) ---
    const canvas = document.getElementById('picCanvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;

    // Resize canvas resolusi
    function resizeCanvas() {
        canvas.width = canvas.parentElement.offsetWidth;
        canvas.height = canvas.parentElement.offsetHeight;
        ctx.lineWidth = 2;
        ctx.lineCap = "round";
    }
    // Delay agar render layout selesai dulu
    setTimeout(resizeCanvas, 500);

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    }

    // Logic menggambar
    const start = (e) => { 
        if(e.type==='touchstart') e.preventDefault(); 
        isDrawing = true; ctx.beginPath(); ctx.moveTo(getPos(e).x, getPos(e).y); 
    };
    const move = (e) => { 
        if(e.type==='touchmove') e.preventDefault(); 
        if(!isDrawing) return; ctx.lineTo(getPos(e).x, getPos(e).y); ctx.stroke(); 
    };
    const end = () => isDrawing = false;

    canvas.addEventListener('mousedown', start);
    canvas.addEventListener('mousemove', move);
    canvas.addEventListener('mouseup', end);
    canvas.addEventListener('touchstart', start, {passive:false});
    canvas.addEventListener('touchmove', move, {passive:false});
    canvas.addEventListener('touchend', end);

    function clearSig() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

    // --- 5. SUBMIT DATA ---
    document.getElementById('logForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btnSubmit');
        btn.innerHTML = "‚è≥ Sedang Mengirim...";

        const machineId = document.getElementById('machineSelect').value;
        const picName = document.getElementById('picName').value;
        const signatureBase64 = canvas.toDataURL();

        if (!machineId || !picName) {
            alert("Harap isi Nama Mesin dan Nama PIC!");
            btn.innerHTML = "üíæ SIMPAN KE DATABASE";
            return;
        }

        let logsToInsert = [];
        // Loop ambil data dari 25 blok
        for (let i = 1; i <= 25; i++) {
            const dateVal = document.querySelector(`[name="date_${i}"]`).value;
            const issue = document.querySelector(`[name="issue_${i}"]`).value;
            const action = document.querySelector(`[name="action_${i}"]`).value;
            const part = document.querySelector(`[name="part_${i}"]`).value;
            const remarks = document.querySelector(`[name="remarks_${i}"]`).value;

            // Jika Issue atau Action diisi, anggap baris ini valid
            if (issue || action) {
                logsToInsert.push({
                    machine_id: machineId,
                    date: dateVal || new Date(), // Gunakan tgl hari ini jika kosong
                    issue: issue,
                    action: action,
                    spare_part: part,
                    remarks: remarks,
                    pic_name: picName,
                    pic_signature: signatureBase64,
                    status: 'Submitted'
                });
            }
        }

        if (logsToInsert.length === 0) {
            alert("Harap isi minimal 1 Riwayat (Permasalahan & Tindakan)!");
            btn.innerHTML = "üíæ SIMPAN KE DATABASE";
            return;
        }

        try {
            const { error } = await supabase.from('kartu_riwayat_logs').insert(logsToInsert);
            if (error) throw error;
            
            alert(`‚úÖ Berhasil menyimpan ${logsToInsert.length} riwayat!`);
            window.location.reload();
        } catch (err) {
            alert("Gagal: " + err.message);
            btn.innerHTML = "üíæ SIMPAN KE DATABASE";
        }
    });
</script>

</body>
</html>
