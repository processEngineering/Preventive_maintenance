<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Input Riwayat Mesin (PIC)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        /* ==================== THEME VARIABLES ==================== */
        :root {
            --primary: #DC2626;
            --primary-dark: #B91C1C;
            --bg-gray: #F9FAFB;
            --bg-white: #FFFFFF;
            --border: #E5E7EB;
            --text-dark: #1F2937;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-gray);
            color: var(--text-dark);
            min-height: 100vh;
            padding-bottom: 100px;
        }

        /* HEADER */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white; padding: 20px;
            box-shadow: 0 4px 20px rgba(220, 38, 38, 0.2);
            margin-bottom: 20px; position: sticky; top: 0; z-index: 50;
        }
        .header h1 { font-size: 18px; font-weight: 800; }
        .back-link { color: white; text-decoration: none; font-size: 14px; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; margin-bottom: 5px; }

        .container { max-width: 100%; padding: 0 15px; }

        /* MACHINE SELECTOR */
        .machine-selector {
            background: white; padding: 15px; border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px;
            border: 1px solid var(--border);
        }
        .form-control {
            width: 100%; padding: 10px; border: 1px solid var(--border);
            border-radius: 6px; font-size: 14px;
        }

        /* TABLE STYLING */
        .table-wrapper {
            background: white; border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            overflow-x: auto; /* Agar bisa digeser di HP */
            margin-bottom: 15px;
        }

        table { width: 100%; border-collapse: collapse; min-width: 900px; } /* Min-width agar kolom tidak gepeng */
        
        th {
            background: #f3f4f6; text-align: left; padding: 12px 8px;
            font-size: 12px; font-weight: 700; color: #4B5563;
            border-bottom: 2px solid var(--border);
            white-space: nowrap;
        }

        td { border-bottom: 1px solid var(--border); padding: 5px; vertical-align: top; }

        /* Input dalam tabel */
        td input, td textarea {
            width: 100%; border: 1px solid #e5e7eb; padding: 8px;
            border-radius: 4px; font-size: 13px; font-family: inherit;
        }
        td input:focus, td textarea:focus { outline: 1px solid var(--primary); }
        
        textarea { resize: vertical; min-height: 40px; }

        /* BUTTONS */
        .btn-add {
            background: #EFF6FF; color: #1D4ED8; border: 1px dashed #3B82F6;
            width: 100%; padding: 12px; border-radius: 8px;
            font-weight: 600; cursor: pointer; margin-bottom: 20px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-add:hover { background: #DBEAFE; }

        .btn-submit {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: calc(100% - 40px); max-width: 600px;
            background: var(--primary); color: white;
            padding: 15px; border: none; border-radius: 12px;
            font-size: 16px; font-weight: 700;
            box-shadow: 0 4px 14px rgba(220, 38, 38, 0.3);
            cursor: pointer; z-index: 100;
        }
        
        .btn-delete {
            background: #FEE2E2; color: #B91C1C; border: none;
            width: 30px; height: 30px; border-radius: 4px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

    </style>
</head>
<body>

    <div class="header">
        <a href="kartu_riwayat.html" class="back-link"><i class="fa-solid fa-arrow-left"></i> Menu Utama</a>
        <h1>Kartu Riwayat Mesin</h1>
        <p>Input Data Pengerjaan (Batch)</p>
    </div>

    <div class="container">
        
        <div class="machine-selector">
            <label style="font-size: 12px; font-weight: 600; color: #666; margin-bottom: 5px; display: block;">Pilih Mesin :</label>
            <select id="machine_name" class="form-control">
                <option value="">-- Sedang memuat daftar mesin... --</option>
            </select>
        </div>

        <div class="table-wrapper">
            <table id="inputTable">
                <thead>
                    <tr>
                        <th style="width: 130px;">Tanggal</th>
                        <th style="width: 200px;">Permasalahan</th>
                        <th style="width: 200px;">Tindakan</th>
                        <th style="width: 150px;">Spare Part</th>
                        <th style="width: 150px;">Keterangan</th>
                        <th style="width: 100px;">PIC</th>
                        <th style="width: 40px;"></th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    </tbody>
            </table>
        </div>

        <button type="button" class="btn-add" onclick="addNewRow()">
            <i class="fa-solid fa-plus"></i> Tambah Baris Lagi
        </button>

    </div>

    <button class="btn-submit" onclick="submitData()">
        <i class="fa-solid fa-save"></i> SIMPAN SEMUA DATA
    </button>

    <script>
        const SUPABASE_URL = 'https://dsyvlavphvrdidmodokd.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E';
        const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 1. INIT: Load Mesin & Buat 5 Baris ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Load Mesin
            const select = document.getElementById('machine_name');
            try {
                const { data } = await db.from('pohm_machine').select('name').order('name');
                select.innerHTML = '<option value="">-- Pilih Mesin --</option>';
                if(data) data.forEach(m => {
                    let opt = document.createElement('option'); opt.value = m.name; opt.textContent = m.name;
                    select.appendChild(opt);
                });
            } catch(e) { console.error(e); }

            // Buat 5 Baris Default
            for(let i=0; i<5; i++) {
                addNewRow();
            }
        });

        // --- 2. FUNGSI TAMBAH BARIS ---
        function addNewRow() {
            const tbody = document.getElementById('tableBody');
            const row = document.createElement('tr');
            
            // Set default date hari ini
            const today = new Date().toISOString().split('T')[0];

            row.innerHTML = `
                <td><input type="date" class="inp-date" value="${today}"></td>
                <td><textarea class="inp-problem" placeholder="Uraian masalah..."></textarea></td>
                <td><textarea class="inp-action" placeholder="Tindakan perbaikan..."></textarea></td>
                <td><textarea class="inp-part" placeholder="Part yg diganti..."></textarea></td>
                <td><input type="text" class="inp-remark" placeholder="-"></td>
                <td><input type="text" class="inp-pic" placeholder="Nama PIC"></td>
                <td>
                    <button type="button" class="btn-delete" onclick="this.closest('tr').remove()">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        }

        // --- 3. SIMPAN DATA (BATCH INSERT) ---
        async function submitData() {
            const machine = document.getElementById('machine_name').value;
            if(!machine) { alert('Pilih Nama Mesin terlebih dahulu!'); return; }

            const rows = document.querySelectorAll('#tableBody tr');
            const dataToInsert = [];
            let isValid = true;

            // Loop setiap baris tabel
            rows.forEach((row, index) => {
                const date = row.querySelector('.inp-date').value;
                const problem = row.querySelector('.inp-problem').value.trim();
                const action = row.querySelector('.inp-action').value.trim();
                const part = row.querySelector('.inp-part').value.trim();
                const remark = row.querySelector('.inp-remark').value.trim();
                const pic = row.querySelector('.inp-pic').value.trim();

                // Hanya simpan baris yang ada isinya (Minimal Masalah & PIC diisi)
                if(problem || action || part) {
                    if(!pic || !date) {
                        alert(`Baris ke-${index+1}: Tanggal dan Nama PIC wajib diisi jika ada data!`);
                        isValid = false;
                        return;
                    }

                    dataToInsert.push({
                        machine_name: machine,
                        entry_date: date,
                        problem_desc: problem,
                        action_taken: action,
                        spare_parts: part,
                        remarks: remark,
                        pic_name: pic
                    });
                }
            });

            if(!isValid) return;
            if(dataToInsert.length === 0) { alert('Isi setidaknya satu baris data!'); return; }

            // Proses Simpan
            const btn = document.querySelector('.btn-submit');
            btn.innerHTML = 'Menyimpan...'; btn.disabled = true;

            try {
                const { error } = await db.from('kartu_riwayat_items').insert(dataToInsert);
                if(error) throw error;

                alert('Berhasil menyimpan ' + dataToInsert.length + ' data riwayat!');
                window.location.href = 'kartu_riwayat.html'; // Kembali ke menu
            } catch(e) {
                console.error(e);
                alert('Gagal menyimpan: ' + e.message);
                btn.innerHTML = '<i class="fa-solid fa-save"></i> SIMPAN SEMUA DATA';
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
