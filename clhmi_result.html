<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>AF.SP 05.13 Rev-00 â€“ CHECKLIST HARIAN MESIN INJECTION</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @page { size: A4 landscape; margin: 5mm; }
        body { font-family: 'Arial Narrow', Arial, sans-serif; font-size: 7.2pt; margin: 0; padding: 10px; background: #f4f4f4; color: #000; }
        
        /* Container */
        .sheet { background: white; padding: 5mm; margin: auto; width: 285mm; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        
        /* Table General */
        table { border-collapse: collapse; width: 100%; table-layout: fixed; }
        td, th { border: 1px solid black; padding: 2px 1px; vertical-align: middle; text-align: center; }

        /* Header Table */
        .header-table td { border: 2px solid black; height: 45px; font-weight: bold; }
        .logo-img { height: 38px; }

        /* Info Section */
        .info-table { border: none; margin: 8px 0; }
        .info-table td { border: none; text-align: left; padding: 1px 0; font-size: 8pt; }
        .dot-line { border-bottom: 1px dotted #000; min-width: 130px; display: inline-block; padding-left: 5px; font-weight: bold; }

        /* Matrix Table Columns */
        .bg-gray { background-color: #dfdfdf; font-weight: bold; text-align: left; padding-left: 8px; text-transform: uppercase; }
        .col-no { width: 22px; }
        .col-nama { width: 185px; text-align: left; padding-left: 5px; font-weight: bold; }
        .col-empty { width: 8px; border-right: none; }
        .col-std { width: 140px; text-align: left; padding-left: 4px; font-size: 6.5pt; word-wrap: break-word; }
        .col-metode { width: 70px; font-size: 6.5pt; }
        .col-catatan { width: 60px; }
        .date-cell { width: 24px; font-weight: bold; font-size: 7pt; }

        /* Status Colors */
        .st-ng { background: #e21c1c !important; color: white !important; }
        .st-na { background: #ffff00 !important; color: black !important; }

        /* Signature Styling */
        .sig-cell { height: 48px !important; padding: 0 !important; background: white; position: relative; }
        .sig-img { 
            max-height: 40px; 
            max-width: 22px; 
            display: block; 
            margin: 0 auto; 
            mix-blend-mode: multiply; 
        }

        /* Footer Section */
        .footer-box { border: 1px solid black; height: 110px; padding: 5px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; }
        .sig-super-img { max-height: 65px; mix-blend-mode: multiply; }
        .name-display { font-weight: bold; text-decoration: underline; text-transform: uppercase; font-size: 8.5pt; }

        /* Control Panel */
        .no-print {
            background: #003366; color: white; padding: 15px; margin-bottom: 15px; border-radius: 8px;
            display: flex; gap: 15px; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        select, button { padding: 8px; border-radius: 4px; border: none; font-weight: bold; }
        button { cursor: pointer; transition: 0.3s; }
        .btn-load { background: #fff; color: #003366; }
        .btn-pdf { background: #d32f2f; color: white; }
        button:hover { opacity: 0.8; transform: translateY(-1px); }

        @media print { .no-print { display: none; } body { background: white; padding: 0; } .sheet { box-shadow: none; width: 100%; } }
    </style>
</head>
<body>

<div class="no-print">
    <span style="font-size:12pt;">ðŸ“‹ REPORT VIEWER</span>
    <select id="machine-select"><option value="">-- Pilih Mesin --</option></select>
    <select id="month-select"></select>
    <select id="year-select"></select>
    <button class="btn-load" onclick="loadData()">TAMPILKAN DATA</button>
    <button class="btn-pdf" onclick="exportToPDF()">DOWNLOAD PDF</button>
</div>

<div class="sheet" id="pdf-content">
    <table class="header-table">
        <tr>
            <td width="15%"><img src="https://amarilyskg.co.id/bootstrap/img/logo.png" class="logo-img"></td>
            <td width="60%" style="font-size: 14pt; letter-spacing: 1px;">CHECK LIST HARIAN MESIN INJECTION</td>
            <td width="25%" style="text-align: left; font-size: 7.5pt; font-weight: normal; padding-left: 8px;">
                No Dokumen : AF.SP 05.13.Rev-00<br>
                Tgl Terbit : 02 Agustus 2024<br>
                Halaman : 1/1<br>
                Tanggal Revisi : -
            </td>
        </tr>
    </table>

    <table class="info-table">
        <tr>
            <td width="10%">MERK MESIN</td><td width="1%">:</td><td width="20%"><span id="out-merk" class="dot-line">-</span></td>
            <td width="10%">SERIAL NO</td><td width="1%">:</td><td width="20%"><span id="out-sn" class="dot-line">-</span></td>
            <td width="8%">BULAN</td><td width="1%">:</td><td width="10%"><span id="out-bln" class="dot-line">-</span></td>
        </tr>
        <tr>
            <td>TONAGE</td><td>:</td><td><span id="out-ton" class="dot-line">-</span></td>
            <td></td><td></td><td></td>
            <td>TAHUN</td><td>:</td><td><span id="out-thn" class="dot-line">-</span></td>
        </tr>
    </table>

    <table>
        <thead>
            <tr>
                <th rowspan="2" class="col-no">No</th>
                <th rowspan="2" class="col-nama">Jenis Pengecekan</th>
                <th rowspan="2" class="col-empty"></th>
                <th rowspan="2" class="col-std">Standard</th>
                <th rowspan="2" class="col-metode">Metode</th>
                <th rowspan="2" class="col-catatan">Catatan</th>
                <th colspan="31">Tanggal</th>
            </tr>
            <tr id="date-row"></tr>
        </thead>
        <tbody id="main-body">
            </tbody>
        <tfoot>
            <tr>
                <td colspan="6" style="text-align:right; font-weight:bold; background:#f9f9f9; padding-right:10px;">Paraf Pelaksana</td>
                <script>for(let i=1;i<=31;i++) document.write(`<td class="sig-cell" id="p-sig-${i}"></td>`);</script>
            </tr>
            <tr>
                <td colspan="6" style="text-align:right; font-weight:bold; background:#f9f9f9; padding-right:10px;">Paraf Koordinator</td>
                <script>for(let i=1;i<=31;i++) document.write(`<td class="sig-cell" id="k-sig-${i}"></td>`);</script>
            </tr>
        </tfoot>
    </table>

    <table style="border:none; margin-top: 10px;">
        <tr>
            <td width="65%" style="border:none; text-align: left; vertical-align: top; line-height: 1.5; font-size: 7.5pt;">
                <b>Catatan :</b><br>
                (*) : Isi kolom laporan ceklist jika unit ini ada dimesin ini<br>
                (**) : Diisi angka jam kerja mesin / running hour yang ada dimesin<br>
                <b>Beri tanda :</b> âˆš (Baik) | x (Rusak/NG) | o (Proses Perbaikan)
            </td>
            <td width="35%" style="border:none;">
                <div class="footer-box">
                    <div style="font-weight:bold; font-size:7.5pt; text-align:center;">DIKETAHUI<br>MECHANIC SUPERINTENDENT</div>
                    <div id="out-sig-super" style="flex-grow:1; display:flex; align-items:center;"></div>
                    <div id="out-name-super" class="name-display">-</div>
                </div>
            </td>
        </tr>
    </table>
</div>

<script>
    const _URL = "https://dsyvlavphvrdidmodokd.supabase.co";
    const _KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
    const sb = supabase.createClient(_URL, _KEY);

    // Master Items dengan kategori yang sangat spesifik untuk akurasi matching data
    const MASTER_ITEMS = [
        {kode:"", cat:"Mekanikal:", label:"1. Mekanikal:", nama:""},
        {kode:"a", cat:"Mekanikal:", nama:"Nozzle visual", std:"Radius tidak rusak, material meler (-)", met:"Visual"},
        {kode:"b", cat:"Mekanikal:", nama:"Kebersihan Head Nozzle barrel", std:"Tidak ada material menempel", met:"Visual"},
        {kode:"c", cat:"Mekanikal:", nama:"Check level oli mesin", std:"> Level garis tengah", met:"Visual"},
        {kode:"d", cat:"Mekanikal:", nama:"Check pump central lubrikasi", std:"Berfungsi baik", met:"Visual"},
        {kode:"e", cat:"Mekanikal:", nama:"Check keseluruhan kondisi mesin", std:"Lengkap dan bersih", met:"Visual"},
        {kode:"f", cat:"Mekanikal:", nama:"Check kondisi lampu indicator", std:"Nyala sesuai fungsi", met:"Visual"},
        {kode:"g", cat:"Mekanikal:", nama:"Pastikan pintu panel tertutup", std:"Tertutup", met:"Tangan"},
        {kode:"h", cat:"Mekanikal:", nama:"Check temperatur oli", std:"40 - 50Â°C", met:"Display"},
        {kode:"i", cat:"Mekanikal:", nama:"Running hour (jam)(**)", std:"Sesuai aktual mesin", met:"Visual"},
        
        {kode:"", cat:"Kebersihan debu :", label:"2. Kebersihan debu :", nama:""},
        {kode:"a", cat:"Kebersihan debu :", nama:"Pintu Mesin (kaca/acrilric)", std:"Bersih tidak berdebu", met:"Lap"},
        {kode:"b", cat:"Kebersihan debu :", nama:"Kap mesin", std:"Bersih tidak berdebu", met:"Lap"},
        {kode:"c", cat:"Kebersihan debu :", nama:"Kap inject unit", std:"Bersih tidak berdebu", met:"Lap"},
        {kode:"d", cat:"Kebersihan debu :", nama:"Panel mesin", std:"Bersih tidak berdebu", met:"Lap"},
        
        {kode:"", cat:"Kebersihan Oli:", label:"3. Kebersihan Oli:", nama:""},
        {kode:"a", cat:"Kebersihan Oli:", nama:"Lantai area mesin", std:"Tidak kotor oli", met:"Spon"},
        {kode:"b", cat:"Kebersihan Oli:", nama:"Bawah mesin", std:"Tidak kotor oli", met:"Spon"},
        {kode:"c", cat:"Kebersihan Oli:", nama:"Bawah inject unit", std:"Tidak kotor oli", met:"Spon"},
        
        {kode:"", cat:"Kebersihan Air :", label:"4. Kebersihan Air :", nama:""},
        {kode:"a", cat:"Kebersihan Air :", nama:"Pemeriksaan instalasi air", std:"Fitting tidak bocor", met:"Visual"},
        {kode:"b", cat:"Kebersihan Air :", nama:"Embun pipa chiller", std:"Dilindungi armaflek", met:"Visual"},
        
        {kode:"", cat:"Kebersihan Area Mesin", label:"5. Kebersihan Area Mesin", nama:""},
        {kode:"a", cat:"Kebersihan Area Mesin", nama:"Alat kerja/sparepart perbaikan", std:"Area bersih", met:"Visual"},
        {kode:"b", cat:"Kebersihan Area Mesin", nama:"Selang angin spiral & air gun", std:"Rapi & lengkap", met:"Visual"}
    ];

    async function initFilter() {
        const { data: m } = await sb.from('clhmi_machine').select('*').order('merk_mesin');
        m?.forEach(x => document.getElementById('machine-select').add(new Option(`${x.merk_mesin} (${x.serial_no})`, x.id)));
        
        const mo = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
        mo.forEach((v, i) => document.getElementById('month-select').add(new Option(v, i+1)));
        
        const y = new Date().getFullYear();
        for(let i=y; i>=y-2; i--) document.getElementById('year-select').add(new Option(i, i));
        
        let h = "";
        for(let i=1; i<=31; i++) h += `<th class="date-cell">${i}</th>`;
        document.getElementById('date-row').innerHTML = h;
    }

    async function loadData() {
        const mId = document.getElementById('machine-select').value;
        const bln = document.getElementById('month-select').value;
        const thn = document.getElementById('year-select').value;
        if(!mId) { alert("Pilih mesin!"); return; }

        // 1. Clear Existing Signatures
        for(let i=1; i<=31; i++) {
            document.getElementById(`p-sig-${i}`).innerHTML = "";
            document.getElementById(`k-sig-${i}`).innerHTML = "";
        }

        // 2. Fetch Headers
        const { data: headers, error: hErr } = await sb.from('clhmi')
            .select('*')
            .eq('machine_id', mId)
            .eq('bulan', parseInt(bln))
            .eq('tahun', parseInt(thn))
            .order('tanggal_isi');

        if(!headers || headers.length === 0) { 
            alert("Data untuk periode ini tidak ditemukan."); 
            return; 
        }

        // 3. Fetch All Results
        const hIds = headers.map(h => h.id);
        const { data: allRes } = await sb.from('clhmi_results').select('*').in('clhmi_id', hIds);

        // 4. Update Header Info
        const head = headers[0];
        document.getElementById('out-merk').innerText = head.merk_mesin || '-';
        document.getElementById('out-sn').innerText = head.serial_no || '-';
        document.getElementById('out-ton').innerText = head.tonage || '-';
        document.getElementById('out-bln').innerText = document.getElementById('month-select').options[bln-1].text;
        document.getElementById('out-thn').innerText = thn;

        // 5. Render Main Table Body
        const tbody = document.getElementById('main-body');
        tbody.innerHTML = "";
        let currentCat = "";

        MASTER_ITEMS.forEach(item => {
            if(item.cat !== currentCat) {
                tbody.innerHTML += `<tr><td colspan="37" class="bg-gray">${item.label}</td></tr>`;
                currentCat = item.cat;
            }
            if(!item.nama) return;

            let row = `<tr>
                <td class="col-no">${item.kode}</td>
                <td class="col-nama">${item.nama}</td>
                <td class="col-empty"></td>
                <td class="col-std">${item.std}</td>
                <td class="col-metode">${item.met}</td>
                <td class="col-catatan"></td>`;

            for(let d=1; d<=31; d++) {
                // Matching data berdasarkan Kode + Kategori + Tanggal
                const f = allRes?.find(r => 
                    r.item_kode === item.kode && 
                    r.kategori === item.cat && 
                    new Date(r.tanggal_cek).getDate() === d
                );

                let sym = '', cls = '';
                if(f) {
                    if(item.kode === 'i' && item.cat === "Mekanikal:") {
                        sym = f.value || ''; // Tampilkan Angka Running Hour
                    } else {
                        sym = f.status === 'OK' ? 'âˆš' : (f.status === 'NG' ? 'x' : (f.status === 'NA' ? 'o' : ''));
                        cls = f.status === 'NG' ? 'st-ng' : (f.status === 'NA' ? 'st-na' : '');
                    }
                }
                row += `<td class="date-cell ${cls}">${sym}</td>`;
            }
            tbody.innerHTML += row + "</tr>";
        });

        // 6. Render Daily Signatures
        headers.forEach(h => {
            const day = new Date(h.tanggal_isi).getDate();
            if(h.paraf) document.getElementById(`p-sig-${day}`).innerHTML = `<img src="${h.paraf}" class="sig-img">`;
            if(h.paraf_coord) document.getElementById(`k-sig-${day}`).innerHTML = `<img src="${h.paraf_coord}" class="sig-img">`;
        });

        // 7. Superintendent Sign-off
        const finalized = headers.find(h => h.status_form === 'finalized') || headers[headers.length-1];
        if(finalized && finalized.paraf_super) {
            document.getElementById('out-sig-super').innerHTML = `<img src="${finalized.paraf_super}" class="sig-super-img">`;
            document.getElementById('out-name-super').innerText = (finalized.approved_by || "MECHANIC SUPERINTENDENT").toUpperCase();
        } else {
            document.getElementById('out-sig-super').innerHTML = `<span style="color:#ccc; font-style:italic; font-size:7.5pt;">Belum Disahkan</span>`;
            document.getElementById('out-name-super').innerText = "-";
        }
    }

    function exportToPDF() {
        const element = document.getElementById('pdf-content');
        const m = document.getElementById('out-merk').innerText;
        const b = document.getElementById('out-bln').innerText;
        const t = document.getElementById('out-thn').innerText;

        const opt = {
            margin: 3,
            filename: `Checklist_${m}_${b}_${t}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
        };
        html2pdf().set(opt).from(element).save();
    }

    window.onload = initFilter;
</script>
</body>
</html>
