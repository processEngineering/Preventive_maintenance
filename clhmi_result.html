<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <!-- VIEWPORT WAJIB AGAR RESPONSIF DI HP -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AF.SP 05.13 Rev-00 – CHECKLIST HARIAN MESIN INJECTION</title>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        :root {
            /* TEMA MERAH PUTIH */
            --primary: #c91919; 
            --primary-light: #e53935;
            --primary-dark: #a50e0e;
            --accent: #dc2626;
            --accent-soft: #ffebeb;
            
            /* BACKGROUND PUTIH */
            --bg-body: #f4f6f8;
            --bg-card: #ffffff;
            --bg-input: #ffffff;
            
            /* TEXT GELAP UNTUK BACKGROUND TERANG */
            --text-main: #333333;
            --text-muted: #6b7280;
            
            /* BORDER TERANG */
            --border: #e5e7eb;
            --border-red: rgba(201, 25, 25, 0.3);
            
            --radius: 16px;
            --sidebar-width: 280px; 
            --header-height: 70px;
        }

        /* --- GLOBAL LAYOUT (UI App) --- */
        body { 
            font-family: 'Inter', sans-serif; /* Font UI Inter */
            margin: 0; 
            padding: 0;
            background: var(--bg-body); 
            color: var(--text-main); 
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: calc(var(--header-height) + 20px); 
            padding-bottom: 40px; 
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- HEADER GARIS 3 (NO-PRINT) --- */
        .main-header {
            position: fixed; top: 0; left: 0; right: 0; height: var(--header-height);
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); z-index: 1000;
            display: flex; align-items: center; padding: 0 20px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            justify-content: center;
        }
        
        .header-content-wrapper {
            width: 100%; max-width: 1200px; display: flex; align-items: center; position: relative;
        }

        .hamburger-menu { font-size: 26px; color: var(--primary); cursor: pointer; transition: transform 0.2s; z-index: 2; }
        .hamburger-menu:active { transform: scale(0.9); }
        
        .header-title-pill { 
            position: absolute; left: 50%; transform: translateX(-50%);
            color: var(--primary); font-weight: 800; font-size: 14px; letter-spacing: 1px;
            border: 2px solid var(--primary); padding: 8px 30px; border-radius: 50px;
            background: white; box-shadow: 0 4px 10px rgba(201, 25, 25, 0.1); white-space: nowrap; z-index: 1;
        }

        /* --- OFF-CANVAS SIDEBAR (TEMA TERANG KONSISTEN) --- */
        .sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; opacity: 0;
            visibility: hidden; transition: all 0.3s ease; backdrop-filter: blur(4px);
        }
        .sidebar-overlay.active { opacity: 1; visibility: visible; }

        .side-nav {
            position: fixed; top: 0; left: -100%; width: 280px; height: 100vh;
            background: white; z-index: 2001; transition: left 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex; flex-direction: column; padding: 20px; box-shadow: 10px 0 30px rgba(0,0,0,0.1);
        }
        .side-nav.active { left: 0; }

        .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .sidebar-title { font-weight: 800; color: #c91919; font-size: 20px; }
        .sidebar-close { font-size: 24px; color: #888; cursor: pointer; transition: color 0.2s; }
        .sidebar-close:hover { color: #c91919; }

        .nav-item {
            display: flex; align-items: center; text-decoration: none; color: #666;
            background: white; width: 100%; padding: 14px 20px; margin-bottom: 15px;
            border: 2px solid #eee; border-radius: 12px; transition: all 0.2s; font-weight: 600;
        }
        .nav-item:hover, .nav-item.active {
            border-color: #c91919; background: #fff5f5; color: #c91919; transform: translateX(5px);
        }
        .nav-icon-box {
            display: flex; align-items: center; justify-content: center; width: 32px; height: 32px;
            margin-right: 15px; font-size: 20px; color: #c91919;
        }
        .nav-item span { font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- PANEL KONTROL (FILTER CARD MODERN) --- */
        .filter-card { 
            background: #ffffff; padding: 25px; margin: 0 15px 20px 15px; 
            width: calc(100% - 30px); max-width: 1000px; display: flex; flex-direction: column; 
            gap: 16px; border-radius: var(--radius); border: 1px solid var(--border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.04); z-index: 10;
        }

        .filter-grid { 
            display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; width: 100%;
        }

        .input-group label {
            display: block; font-size: 11px; font-weight: 700; color: var(--text-muted); 
            margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;
        }

        .input-modern { 
            width: 100%; padding: 14px 16px; border-radius: 10px; border: 1px solid var(--border); 
            font-weight: 600; cursor: pointer; font-size: 14px; background: #fff; color: var(--text-main); 
            outline: none; transition: all 0.2s; box-shadow: inset 0 2px 4px rgba(0,0,0,0.01);
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23c91919' stroke-width='3'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
        }
        .input-modern:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--accent-soft); }
        
        .action-buttons {
            display: flex; gap: 12px; margin-top: 5px;
        }

        .btn-modern {
            flex: 1; padding: 14px 20px; border-radius: 12px; font-weight: 800; font-size: 13px;
            text-transform: uppercase; letter-spacing: 1px; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px; border: none;
        }
        
        .btn-primary { 
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); 
            color: white; box-shadow: 0 6px 15px rgba(201, 25, 25, 0.2); 
        }
        .btn-primary:active { transform: scale(0.98); box-shadow: 0 2px 8px rgba(201, 25, 25, 0.2); }
        
        .btn-outline { 
            background: #fff; color: var(--primary); border: 2px solid var(--primary); 
            box-shadow: 0 4px 10px rgba(0,0,0,0.03); 
        }
        .btn-outline:active { transform: scale(0.98); background: var(--accent-soft); }

        #status-msg { color: var(--primary); font-weight: 700; font-size: 13px; text-align: center; margin-top: 5px;}

        @media (max-width: 768px) {
            .filter-grid { grid-template-columns: 1fr; }
            .action-buttons { flex-direction: column; }
        }


        /* ========================================================================================= */
        /* --- AREA KERTAS CETAK A4 (FIX PIXEL STRICT SIZING UNTUK PDF ANTI RUSAK) --- */
        /* ========================================================================================= */

        .sheet-container {
            width: 100%;
            overflow-x: auto; 
            display: flex;
            justify-content: flex-start; 
            padding: 10px 15px;
            box-sizing: border-box;
            -webkit-overflow-scrolling: touch; 
            position: relative;
            z-index: 1;
        }

        @media (min-width: 1140px) {
            .sheet-container { justify-content: center; }
        }

        .sheet { 
            background: white; 
            color: black; 
            padding: 30px 40px; /* Padding diubah ke px agar presisi */
            width: 1122px; /* FIX LEBAR A4 dalam PIXEL (96dpi) */
            min-width: 1122px; 
            min-height: 794px; /* FIX TINGGI A4 dalam PIXEL */
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); 
            box-sizing: border-box;
            position: relative;
            border-radius: 4px;
            font-family: 'Arial Narrow', 'Helvetica Narrow', Arial, sans-serif; /* Font wajib Cetak */
            font-size: 7pt;
        }

        .sheet table { border-collapse: collapse; width: 100%; table-layout: fixed; margin-bottom: 2px; }
        .sheet td, .sheet th { border: 1px solid black; padding: 1px 2px; vertical-align: middle; line-height: 1.05; color: black; }
        
        .header-table { border: 2px solid black !important; }
        .header-table td { height: 35px; } 
        
        .logo-td { text-align: center; vertical-align: middle; height: 35px; overflow: hidden; }
        .logo-img { height: 35px; max-width: 100%; display: block; margin: 0 auto; object-fit: contain; }
        .logo-canvas { height: 35px !important; width: auto !important; display: block !important; margin: 0 auto !important; }

        .main-title { font-size: 12pt; font-weight: bold; text-align: center; text-transform: uppercase; }
        .doc-info { font-size: 6pt; line-height: 1.15; padding: 2px 4px; }

        .info-table { border: 2px solid black; }
        .info-table td { font-weight: bold; font-size: 7pt; padding: 1px 3px; border: none; }
        .dot-line { border-bottom: 1px dotted #000; display: inline-block; width: 95%; font-weight: normal; padding-left: 5px; }

        .grid-table { border: 2px solid black; }
        .grid-table th { background-color: #ffffff; text-align: center; font-weight: bold; border: 1px solid black; font-size: 6.5pt; height: 18px; }

        .col-no { width: 18px; text-align: center; }
        .col-item { width: 180px; text-align: left; }
        .col-spacer { width: 6px; border-left: none; border-right: none; background: #f4f4f4; } 
        .col-std { width: 110px; text-align: center; font-size: 6pt; white-space: normal; }
        .col-met { width: 50px; text-align: center; font-size: 6pt; }
        .col-note { width: 40px; text-align: center; }
        .col-date { width: 17px; text-align: center; font-size: 7pt; padding: 0; position: relative; }
        
        .cat-row { background-color: #d9d9d9 !important; font-weight: bold; text-align: left; padding-left: 5px; border: 1px solid black; text-transform: uppercase; font-size: 7pt; height: 16px; }

        .st-ok { color: #000; font-weight: 900; font-family: 'DejaVu Sans', sans-serif; font-size: 9pt; } 
        .st-ng { color: red !important; font-weight: 900; font-size: 8pt; }
        .st-mt { color: blue !important; font-weight: 900; font-size: 8pt; } 
        .st-na { color: #666 !important; font-weight: 900; font-size: 8pt; }
        .st-val { color: #000; font-weight: bold; font-size: 7pt; }

        .st-run-hour { 
            color: #000; font-size: 4.5pt !important; word-break: break-all !important; 
            white-space: normal !important; line-height: 0.85 !important; letter-spacing: -0.2px !important; 
            padding: 0px !important; vertical-align: middle;
        }

        .sig-row td { background-color: #f2f2f2 !important; font-weight: bold; text-align: right; padding-right: 4px; font-size: 6pt; }
        
        .sig-cell { 
            height: 28px; background: white !important; padding: 0 !important; 
            text-align: center; vertical-align: middle; position: relative; overflow: hidden;
        }
        
        .sig-img { 
            width: 100%; height: 100%; object-fit: contain; display: block; margin: 0 auto; 
            filter: brightness(0%) contrast(150%);
        }
        .super-img { max-height: 35px; max-width: 75px; width: auto; }
        
        .footer-wrapper { display: flex; border: 2px solid black; margin-top: 3px; height: 75px; }
        .footer-left { flex: 2.2; border-right: 1px solid black; padding: 3px; font-size: 6pt; line-height: 1.3; }
        .footer-right { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 3px; overflow: hidden; }
        .super-title { font-weight: bold; text-align: center; text-decoration: underline; margin-bottom: 2px; font-size: 6.5pt; }
        .super-sig { flex-grow: 1; display: flex; align-items: center; justify-content: center; width: 100%; }
        .super-name { font-weight: bold; text-decoration: underline; text-transform: uppercase; font-size: 7pt; text-align: center; width: 100%; word-wrap: break-word; line-height: 1.1; max-height: 25px; overflow: hidden; }
        
        @media print {
            .main-header, .sidebar-overlay, .side-nav, .no-print { display: none !important; }
            body { padding: 0; background: white; }
            .sheet-container { padding: 0; justify-content: center; }
        }
    </style>
</head>
<body>

<!-- HEADER GARIS 3 (UI App) -->
<header class="main-header no-print">
    <div class="header-content-wrapper">
        <div class="hamburger-menu" onclick="toggleSidebar()">
            <i class="fa-solid fa-bars"></i>
        </div>
        <div class="header-title-pill">DATA LAPORAN</div>
    </div>
</header>

<!-- OVERLAY & SIDEBAR (UI App) -->
<div class="sidebar-overlay no-print" id="sidebarOverlay" onclick="toggleSidebar()"></div>
<nav class="side-nav no-print" id="sidebar">
    <div class="sidebar-header">
        <span class="sidebar-title">Dashboard</span>
        <div class="sidebar-close" onclick="toggleSidebar()">
            <i class="fa-solid fa-xmark"></i>
        </div>
    </div>
    <a href="index.html" id="nav-home" class="nav-item">
        <div class="nav-icon-box"><i class="fa-solid fa-house"></i></div>
        <span>Home</span>
    </a>
    <a href="menu_utama.html" id="nav-menu" class="nav-item">
        <div class="nav-icon-box"><i class="fa-solid fa-table-cells-large"></i></div>
        <span>Menu Utama</span>
    </a>
    <a href="download_data.html" class="nav-item active">
        <div class="nav-icon-box"><i class="fa-solid fa-cloud-arrow-down"></i></div>
        <span>Unduh Data</span>
    </a>
    <a href="informasi_akun.html" class="nav-item">
        <div class="nav-icon-box"><i class="fa-solid fa-user"></i></div>
        <span>Akun</span>
    </a>
</nav>

<!-- PANEL FILTER MODERN (UI App) -->
<div class="no-print filter-card">
    <div class="filter-grid">
        <div class="input-group">
            <label>Mesin Injection</label>
            <select id="machine-select" class="input-modern"><option value="">-- Pilih Mesin --</option></select>
        </div>
        <div class="input-group">
            <label>Bulan</label>
            <select id="month-select" class="input-modern"><option value="">-- Pilih --</option></select>
        </div>
        <div class="input-group">
            <label>Tahun</label>
            <select id="year-select" class="input-modern"><option value="">-- Pilih --</option></select>
        </div>
    </div>

    <div class="action-buttons">
        <button class="btn-modern btn-primary" onclick="loadData()">
            <i class="fa-solid fa-search"></i> Tampilkan Data
        </button>
        <button class="btn-modern btn-outline print-btn" onclick="captureAndExportPDF()">
            <i class="fa-solid fa-file-pdf"></i> Download PDF
        </button>
    </div>
    <div id="status-msg"></div>
</div>

<!-- CONTAINER KERTAS A4 (DOCUMENT PRINT) -->
<div class="sheet-container">
    <div class="sheet" id="sheet-content">
        <table class="header-table">
            <tr>
                <td width="15%" class="logo-td">
                    <img src="https://amarilyskg.co.id/bootstrap/img/logo.png" class="logo-img" id="logo-header" alt="Logo">
                </td>
                <td width="60%" class="main-title">CHECK LIST HARIAN MESIN INJECTION</td>
                <td width="25%" class="doc-info">
                    No Dokumen &nbsp;&nbsp;&nbsp;: AF.SP 05.13.Rev-00<br>
                    Tanggal Terbit : 02 Agustus 2024<br>
                    Halaman &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: 1/1<br>
                    Tanggal Revisi : -
                </td>
            </tr>
        </table>

        <table class="info-table">
            <tr>
                <td width="12%">MERK MESIN</td><td width="1%">:</td><td width="30%"><span id="out-merk" class="dot-line"></span></td>
                <td width="10%">SERIAL NO</td><td width="1%">:</td><td width="25%"><span id="out-sn" class="dot-line"></span></td>
                <td width="8%">BULAN</td><td width="1%">:</td><td><span id="out-bln" class="dot-line"></span></td>
            </tr>
            <tr>
                <td>TONAGE</td><td>:</td><td><span id="out-ton" class="dot-line"></span></td>
                <td></td><td></td><td></td>
                <td>TAHUN</td><td>:</td><td><span id="out-thn" class="dot-line"></span></td>
            </tr>
        </table>

        <table class="grid-table">
            <thead>
                <tr>
                    <th rowspan="2" class="col-no">No</th>
                    <th rowspan="2" class="col-item">Jenis pengecekan</th>
                    <th rowspan="2" class="col-spacer"></th>
                    <th rowspan="2" class="col-std">Standard</th>
                    <th rowspan="2" class="col-met">METODE</th>
                    <th rowspan="2" class="col-note">CATATAN</th>
                    <th colspan="31" style="height:14px;">Tanggal</th>
                </tr>
                <tr id="date-row"></tr>
            </thead>
            <tbody id="main-body">
                <tr><td colspan="38" style="text-align:center; padding:20px; color:black;">Silahkan Pilih Filter Data...</td></tr>
            </tbody>
            
            <tbody id="sig-body" style="display:none;">
                <tr class="sig-row">
                    <td colspan="6">Paraf Pelaksana</td>
                    <script>for(let i=1;i<=31;i++) document.write(`<td class="sig-cell" id="p-sig-${i}"></td>`);</script>
                </tr>
                <tr class="sig-row">
                    <td colspan="6">Paraf Koordinator</td>
                    <script>for(let i=1;i<=31;i++) document.write(`<td class="sig-cell" id="k-sig-${i}"></td>`);</script>
                </tr>
            </tbody>
        </table>

        <div class="footer-wrapper">
            <div class="footer-left">
                <b>Catatan :</b><br>
                (*) : Isi kolom laporan ceklist jika unit ini ada dimesin ini<br>
                (**) : Diisi angka jam kerja mesin / running hour yang ada dimesin<br><br>
                <b>Beri tanda :</b><br>
                <span style="font-weight:bold;">✓</span> OK (Sesuai Standar) &nbsp;&nbsp;
                <span style="font-weight:bold; color:red;">X</span> NG (Rusak/Penyimpangan) &nbsp;&nbsp;
                <span style="font-weight:bold; color:blue;">O</span> Perbaikan (Maintenance) &nbsp;&nbsp;
                <span style="font-weight:bold; color:#666;">-</span> Tidak Ada (NA)
            </div>
            <div class="footer-right">
                <div class="super-title">DIKETAHUI<br>MECHANIC SUPERINTENDENT</div>
                <div class="super-sig" id="out-sig-super">
                    <span style="color:#ccc; font-size:6pt;">(Menunggu Pengesahan)</span>
                </div>
                <div class="super-name" id="out-name-super"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- UI NAVIGATION LOGIC ---
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('active');
        document.getElementById('sidebarOverlay').classList.toggle('active');
    }

    const _URL = "https://dsyvlavphvrdidmodokd.supabase.co";
    const _KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
    const sb = supabase.createClient(_URL, _KEY);

    async function setupDynamicNavigation() {
        try {
            const { data: { session } } = await sb.auth.getSession();
            if (!session) return;

            const { data: profile } = await sb.from('profiles').select('jabatan').eq('id', session.user.id).single();

            if (profile) {
                const jabatan = profile.jabatan.toUpperCase();
                const navHome = document.getElementById('nav-home');
                const navMenu = document.getElementById('nav-menu');

                let homeLink = 'index.html';
                let menuLink = 'menu_utama.html';

                if (jabatan.includes('OPERATOR')) {
                    homeLink = 'OPERATOR_HOME.html';
                    menuLink = 'MENU_UTAMA_OPERATOR.html';
                } else if (jabatan.includes('SUPERVISOR')) {
                    homeLink = 'SUPERVISOR_HOME.html';
                    menuLink = 'MENU_UTAMA_SUPERVISOR.html';
                } else if (jabatan.includes('SUPERINTENDENT')) {
                    homeLink = 'SUPERINTENDENT_HOME.html';
                    menuLink = 'MENU_UTAMA_SUPERINTENDENT.html';
                } else if (jabatan.includes('MANAGER') && !jabatan.includes('JUNIOR')) {
                    homeLink = 'MANAGER_HOME.html';
                    menuLink = 'MENU_UTAMA_MANAGER.html';
                } else if (jabatan.includes('JUNIOR MANAGER PRODUKSI') || jabatan.includes('JM PRODUKSI')) {
                    homeLink = 'JUNIOR_MANAGER_PRODUKSI_HOME.html';
                    menuLink = 'MENU_UTAMA_JM_PRODUKSI.html';
                } else if (jabatan.includes('JUNIOR MANAGER PPIC') || jabatan.includes('JM PPIC')) {
                    homeLink = 'JUNIOR_MANAGER_PPIC_HOME.html';
                    menuLink = 'MENU_UTAMA_JM_PPIC.html';
                }

                if (navHome) navHome.href = homeLink;
                if (navMenu) navMenu.href = menuLink;
            }
        } catch (err) {
            console.error("Gagal mengatur navigasi dinamis:", err);
        }
    }

    // --- DATA & PDF LOGIC (DO NOT MODIFY STRUCTURE) ---
    const MASTER_ITEMS = [
        {kode:"", kategori:"Mekanikal:", nama:""},
        {kode:"a", nama:"Nozzle visual", std:"Radius tidak rusak, tidak ada leleah material meler", met:"Visual"},
        {kode:"b", nama:"Kebersihan Head Nozzle barrel", std:"tidak ada material yang menempel", met:"Visual"},
        {kode:"c", nama:"Check level oli mesin", std:"> Level garis tengah", met:"Visual"},
        {kode:"d", nama:"Check pump central lubrikasi", std:"berfungsi baik", met:"Visual"},
        {kode:"e", nama:"Check keseluruhan kondisi mesin", std:"Lengkap dan bersih", met:"Visual"},
        {kode:"f", nama:"Check kondisi lampu indicator", std:"Nyala sesuai fungsi", met:"Visual"},
        {kode:"g", nama:"Pastikan pintu panel kontrol tertutup", std:"Tertutup", met:"Tangan"},
        {kode:"h", nama:"Check temperatur oli", std:"40 - 50°C", met:"Display control"},
        {kode:"i", nama:"Running hour (jam)(**)", std:"Sesuai aktual mesin", met:"Visual"},
        {kode:"", kategori:"Kebersihan debu :", nama:""},
        {kode:"a", nama:"Pintu Mesin (kaca/acrilric)", std:"Bersih tidak berdebu", met:"Lap majun"},
        {kode:"b", nama:"Kap mesin", std:"Bersih tidak berdebu", met:"Lap majun"},
        {kode:"c", nama:"Kap inject unit", std:"Bersih tidak berdebu", met:"Lap majun"},
        {kode:"d", nama:"Panel mesin", std:"Bersih tidak berdebu", met:"Lap majun"},
        {kode:"", kategori:"Kebersihan Oli:", nama:""},
        {kode:"a", nama:"Lantai area mesin", std:"Tidak kotor oli", met:"Lap & busa spon"},
        {kode:"b", nama:"Bawah mesin", std:"Tidak kotor oli", met:"Lap & busa spon"},
        {kode:"c", nama:"Bawah inject unit", std:"Tidak kotor oli", met:"Lap & busa spon"},
        {kode:"", kategori:"Kebersihan Air :", nama:""},
        {kode:"a", nama:"Pemeriksaan instalasi air", std:"Fitting / balvalve tidak bocor", met:"Lap majun"},
        {kode:"b", nama:"Embun pipa chiller", std:"Dilindungi armaflek", met:"Lap majun"},
        {kode:"", kategori:"Kebersihan Area Mesin", nama:""},
        {kode:"a", nama:"Pemeriksaan alat kerja/ sparepart setelah perbaikan", std:"Area mesin bersih, tidak terdapat ceceran tools & sparepart", met:"Visual"},
        {kode:"b", nama:"Kelengkapan selang angin sprial & air gun", std:"Terpasang rapih,lengkap dan berfungsi", met:"Visual"}
    ];

    const LOGO_URL_ASLI = "https://amarilyskg.co.id/bootstrap/img/logo.png";
    let GLOBAL_BASE64_LOGO = "";

    function showStatus(msg, isError=false) {
        const el = document.getElementById('status-msg');
        el.innerText = msg;
        el.style.color = isError ? '#dc2626' : '#c91919';
        setTimeout(() => { el.innerText = ''; }, 5000);
    }

    async function fetchImageAsBase64(url) {
        const proxies = [
            'https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(url),
            'https://corsproxy.io/?' + encodeURIComponent(url),
            'https://api.allorigins.win/raw?url=' + encodeURIComponent(url)
        ];
        
        for (let proxyUrl of proxies) {
            try {
                const response = await fetch(proxyUrl);
                if (response.ok) {
                    const blob = await response.blob();
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.readAsDataURL(blob);
                    });
                }
            } catch (e) { console.warn("Proxy error:", e); }
        }
        return null;
    }

    async function preloadLogo() {
        const base64 = await fetchImageAsBase64(LOGO_URL_ASLI);
        if(base64) GLOBAL_BASE64_LOGO = base64;
    }

    async function initFilter() {
        setupDynamicNavigation();
        try {
            const { data: m } = await sb.from('clhmi_machine').select('*').order('merk_mesin');
            m?.forEach(x => document.getElementById('machine-select').add(new Option(`${x.merk_mesin}`, x.id)));
            const mo = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
            mo.forEach((v, i) => document.getElementById('month-select').add(new Option(v, i+1)));
            const y = new Date().getFullYear();
            for(let i=y; i>=y-2; i--) document.getElementById('year-select').add(new Option(i, i));
            
            let h = "";
            for(let i=1; i<=31; i++) h += `<th class="col-date">${i}</th>`;
            document.getElementById('date-row').innerHTML = h;

            await preloadLogo();

        } catch(e) { console.error(e); }
    }

    // MEMPERBAIKI MASALAH PDF "RATA KIRI DAN KANAN RUSAK"
    async function captureAndExportPDF() {
        const btn = document.querySelector('.print-btn');
        const originalText = btn.innerHTML;

        if(document.getElementById('machine-select').value === "") {
            showStatus("Mohon pilih data dulu sebelum ekspor!", true);
            return;
        }

        try {
            btn.innerHTML = "<i class='fa-solid fa-spinner fa-spin'></i> Siapkan Layout...";

            if(!GLOBAL_BASE64_LOGO) await preloadLogo();

            const original = document.getElementById('sheet-content');
            const clone = original.cloneNode(true);

            const cloneLogo = clone.querySelector('#logo-header'); 
            if(cloneLogo && GLOBAL_BASE64_LOGO) {
                cloneLogo.src = GLOBAL_BASE64_LOGO;
            } else if (cloneLogo) {
                 const b64 = await fetchImageAsBase64(LOGO_URL_ASLI);
                 if(b64) cloneLogo.src = b64;
            }
            
            // FIX PDF ALIGNMENT: Lock the exact pixel width equivalent to A4 Landscape at 96 DPI
            clone.style.margin = '0';
            clone.style.padding = '30px 40px'; // Gunakan padding PX yang absolut
            clone.style.boxShadow = 'none';
            clone.style.minHeight = '794px';
            clone.style.width = '1122px'; // Lebar Mutlak
            clone.style.maxWidth = 'none';
            clone.style.transform = 'none'; // Cegah scaling browser bocor ke kanvas
            
            const ghostContainer = document.createElement('div');
            ghostContainer.style.position = 'absolute'; // Posisikan absolute di luar viewport
            ghostContainer.style.top = '-9999px';
            ghostContainer.style.left = '-9999px';
            ghostContainer.style.width = '1122px'; // Pastikan container penampung sama ukurannya
            ghostContainer.style.background = '#fff'; 
            ghostContainer.style.overflow = 'visible'; 
            
            ghostContainer.appendChild(clone);
            document.body.appendChild(ghostContainer);

            await new Promise(r => setTimeout(r, 300));

            btn.innerHTML = "<i class='fa-solid fa-spinner fa-spin'></i> Mengambil Gambar...";

            // Hapus deteksi ukuran layar untuk scale. Gunakan fix parameter agar tidak rusak
            const canvas = await html2canvas(clone, {
                scale: 2, // Scale 2 cukup untuk kualitas HD tanpa merusak rasio layout
                useCORS: true,
                allowTaint: false,
                backgroundColor: "#ffffff",
                logging: false,
                width: 1122, // Kunci lebar rendering kanvas ke 1122px
                windowWidth: 1122 // Simulasi lebar viewport komputer Desktop 1122px
            });

            btn.innerHTML = "<i class='fa-solid fa-spinner fa-spin'></i> Membuat PDF...";
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('l', 'mm', 'a4');
            
            const imgData = canvas.toDataURL('image/png'); 
            
            const pdfWidth = 297; 
            const pdfHeight = 210; 
            const imgProps = pdf.getImageProperties(imgData);
            
            const imgRatio = imgProps.width / imgProps.height;
            const pdfRatio = pdfWidth / pdfHeight;
            let finalWidth, finalHeight;
            
            if (imgRatio > pdfRatio) {
                finalWidth = pdfWidth;
                finalHeight = (imgProps.height * pdfWidth) / imgProps.width;
            } else {
                finalHeight = pdfHeight;
                finalWidth = (imgProps.width * pdfHeight) / imgProps.height;
            }
            
            // Rumus posisi ini otomatis membuat layout berada di CENTER Kertas PDF
            const xPos = (pdfWidth - finalWidth) / 2;
            const yPos = (pdfHeight - finalHeight) / 2;
            
            pdf.addImage(imgData, 'PNG', xPos, yPos, finalWidth, finalHeight);
            
            const machineName = document.getElementById('machine-select').selectedOptions[0].text;
            const bln = document.getElementById('month-select').selectedOptions[0].text;
            const filename = `Laporan_${machineName}_${bln}.pdf`;
            
            pdf.save(filename);
            showStatus("PDF berhasil diunduh!");

            document.body.removeChild(ghostContainer);

        } catch (err) {
            console.error(err);
            showStatus("Gagal ekspor PDF: " + err.message, true);
        } finally {
            btn.innerHTML = originalText;
        }
    }

    async function loadData() {
        const mId = document.getElementById('machine-select').value;
        const bln = document.getElementById('month-select').value;
        const thn = document.getElementById('year-select').value;
        if(!mId || !bln || !thn) {
            showStatus("Mohon pilih Mesin, Bulan, dan Tahun dulu!", true);
            return;
        }

        showStatus("Sedang memuat data...");

        const imgLogo = document.getElementById('logo-header');
        if (imgLogo && imgLogo.tagName === 'IMG') {
             imgLogo.src = GLOBAL_BASE64_LOGO || LOGO_URL_ASLI;
        }

        for(let i=1; i<=31; i++) {
            document.getElementById(`p-sig-${i}`).innerHTML = "";
            document.getElementById(`k-sig-${i}`).innerHTML = "";
        }
        document.getElementById('sig-body').style.display = 'table-row-group';

        const { data: headers, error: hErr } = await sb.from('clhmi')
            .select('*, clhmi_machine(tonage, serial_no, merk_mesin)')
            .eq('machine_id', mId).eq('bulan', parseInt(bln)).eq('tahun', parseInt(thn)).order('tanggal_isi');

        if(hErr || !headers || headers.length === 0) { 
            showStatus("Data laporan tidak ditemukan.", true); 
            document.getElementById('main-body').innerHTML = `<tr><td colspan="38" style="text-align:center; padding:20px; color:black;">DATA TIDAK DITEMUKAN</td></tr>`;
            return; 
        }

        const headerIds = headers.map(h => h.id);
        const { data: allRes, error: rErr } = await sb.from('clhmi_results')
            .select('item_kode, status, value, temperature_oli, tanggal_cek, clhmi_items(nama_pengecekan)') 
            .in('clhmi_id', headerIds);

        const head = headers[0];
        document.getElementById('out-merk').innerText = head.clhmi_machine?.merk_mesin || '-';
        document.getElementById('out-sn').innerText = head.clhmi_machine?.serial_no || '-';
        document.getElementById('out-ton').innerText = (head.clhmi_machine?.tonage || '-') + ' T';
        document.getElementById('out-bln').innerText = document.getElementById('month-select').options[bln-1].text.toUpperCase();
        document.getElementById('out-thn').innerText = thn;

        const tbody = document.getElementById('main-body');
        tbody.innerHTML = "";
        let curCat = "";

        MASTER_ITEMS.forEach(item => {
            if(item.kategori && item.kategori !== curCat) {
                tbody.innerHTML += `<tr><td colspan="38" class="cat-row">${item.kategori}</td></tr>`;
                curCat = item.kategori;
            }
            if(!item.nama) return;

            let row = `<tr>
                <td class="col-no">${item.kode}</td>
                <td class="col-item">${item.nama}</td>
                <td class="col-spacer"></td>
                <td class="col-std">${item.std}</td>
                <td class="col-met">${item.met}</td>
                <td class="col-note"></td>`;

            for(let d=1; d<=31; d++) {
                const f = allRes.find(r => {
                    const dbDate = parseInt(r.tanggal_cek.split('-')[2]);
                    const itemNameMatch = r.clhmi_items && r.clhmi_items.nama_pengecekan.trim() === item.nama.trim();
                    return dbDate === d && itemNameMatch;
                });

                let sym = '', cls = '';
                if(f) {
                    const n = item.nama.toLowerCase();
                    if (n.includes("running hour")) {
                        sym = f.value || '-';
                        cls = 'st-run-hour'; 
                    } 
                    else if (n.includes("temperatur") || n.includes("temperature")) {
                        sym = f.temperature_oli || '-';
                        cls = 'st-val';
                    }
                    else {
                        if(f.status === 'OK') { sym = '✓'; cls = 'st-ok'; }
                        else if(f.status === 'NG') { sym = 'X'; cls = 'st-ng'; }
                        else if(f.status === 'MT') { sym = 'O'; cls = 'st-mt'; } 
                        else if(f.status === 'NA') { sym = '-'; cls = 'st-na'; }
                    }
                }
                row += `<td class="col-date ${cls}">${sym}</td>`;
            }
            tbody.innerHTML += row + "</tr>";
        });

        headers.forEach(h => {
            const d = parseInt(h.tanggal_isi.split('-')[2]);
            if(h.paraf) document.getElementById(`p-sig-${d}`).innerHTML = `<img src="${h.paraf}" class="sig-img">`;
            if(h.paraf_coord) document.getElementById(`k-sig-${d}`).innerHTML = `<img src="${h.paraf_coord}" class="sig-img">`;
        });

        const fin = headers.find(h => h.status_form === 'closed');
        const sigBox = document.getElementById('out-sig-super');
        const nameBox = document.getElementById("out-name-super");
        if(fin?.paraf_super) {
            sigBox.innerHTML = `<img src="${fin.paraf_super}" class="super-img">`;
            nameBox.innerText = (fin.verified_by || '').toUpperCase();
        } else {
            sigBox.innerHTML = `<span style="color:#ccc; font-size:6pt;">(Menunggu Pengesahan)</span>`;
            nameBox.innerText = "";
        }
        showStatus("Data berhasil dimuat!");
    }

    window.onload = initFilter;
</script>
</body>
</html>
