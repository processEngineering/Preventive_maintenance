<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AF.SP 05.13 Rev-00 – LAPORAN CLHMI BULANAN</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @page { size: A4 landscape; margin: 5mm; }
        body { font-family: 'Arial Narrow', Arial, sans-serif; font-size: 7pt; margin: 0; padding: 10px; background: #f4f4f4; }
        .sheet { background: white; padding: 5mm; margin: auto; width: 285mm; box-shadow: 0 0 10px rgba(0,0,0,0.1); min-height: 190mm; }
        table { border-collapse: collapse; width: 100%; table-layout: fixed; }
        td, th { border: 1px solid black; padding: 1px; text-align: center; }
        
        /* Header */
        .header-table td { border: 2px solid black; height: 45px; font-weight: bold; }
        .logo-img { height: 35px; }
        
        /* Info */
        .info-table { border: none; margin: 5px 0; }
        .info-table td { border: none; text-align: left; padding: 0; font-size: 8pt; }
        .dot-line { border-bottom: 1px dotted #000; min-width: 120px; display: inline-block; padding-left: 5px; font-weight: bold; }

        /* Content Matrix */
        .bg-gray { background-color: #dfdfdf; font-weight: bold; text-align: left; padding-left: 5px; }
        .col-nama { text-align: left; width: 140px; padding-left: 3px; }
        .col-std { width: 100px; text-align: left; font-size: 6pt; }
        .st-ok { color: green; font-weight: bold; }
        .st-ng { color: white; font-weight: bold; background: #e21c1c; }
        
        /* Signature Grid */
        .sig-cell { height: 35px; padding: 0 !important; vertical-align: middle; background: #fff; }
        .sig-img { max-height: 30px; max-width: 24px; mix-blend-mode: multiply; display: block; margin: auto; }
        
        /* Footer Box */
        .footer-box { border: 1px solid black; height: 90px; vertical-align: top; position: relative; padding: 5px; text-align: center; }

        /* Controls */
        .no-print { background: #003366; color: white; padding: 10px; margin-bottom: 10px; border-radius: 5px; display: flex; gap: 10px; align-items: center; }
        @media print { .no-print { display: none; } body { background: white; padding: 0; } .sheet { box-shadow: none; width: 100%; } }
    </style>
</head>
<body>

<div class="no-print">
    <b>FILTER LAPORAN:</b>
    <select id="machine-select"><option value="">Pilih Mesin...</option></select>
    <select id="month-select"></select>
    <select id="year-select"></select>
    <button onclick="loadData()" style="padding:5px 15px; cursor:pointer; font-weight:bold; background: #ffcc00; border:none; border-radius:4px;">TAMPILKAN DATA</button>
    <button onclick="window.print()" style="padding:5px 15px; background: #28a745; color: white; border:none; border-radius:4px; cursor:pointer">CETAK / PDF</button>
</div>

<div class="sheet">
    <table class="header-table">
        <tr>
            <td width="15%"><img src="https://amarilyskg.co.id/bootstrap/img/logo.png" class="logo-img" alt="Logo"></td>
            <td width="60%" style="font-size: 13pt;">CHECKLIST HARIAN MESIN INJECTION</td>
            <td width="25%" style="text-align: left; font-size: 7pt; font-weight: normal; padding-left: 5px;">
                No Dokumen : AF.SP 05.13.Rev-00<br>
                Tgl Terbit : 02 Agustus 2024<br>
                Halaman : 1/1<br>
                Tanggal Revisi : -
            </td>
        </tr>
    </table>

    <table class="info-table">
        <tr>
            <td width="10%">MERK MESIN</td><td width="1%">:</td><td width="20%"><span id="out-merk" class="dot-line">-</span></td>
            <td width="10%">SERIAL NO</td><td width="1%">:</td><td width="20%"><span id="out-sn" class="dot-line">-</span></td>
            <td width="8%">BULAN</td><td width="1%">:</td><td width="10%"><span id="out-bln" class="dot-line">-</span></td>
        </tr>
        <tr>
            <td>TONAGE</td><td>:</td><td><span id="out-ton" class="dot-line">-</span></td>
            <td></td><td></td><td></td>
            <td>TAHUN</td><td>:</td><td><span id="out-thn" class="dot-line">-</span></td>
        </tr>
    </table>

    <table>
        <thead>
            <tr>
                <th rowspan="2" width="20">No</th>
                <th rowspan="2" class="col-nama">Jenis Pengecekan</th>
                <th rowspan="2" class="col-std">Standard / Metode</th>
                <th colspan="31">Tanggal</th>
            </tr>
            <tr id="date-row"></tr>
        </thead>
        <tbody id="main-body">
            <tr><td colspan="34" style="padding:20px; color:#999;">Silahkan pilih mesin dan periode...</td></tr>
        </tbody>
        <tbody>
            <tr>
                <td colspan="3" style="text-align: right; font-weight: bold; background: #f0f0f0; padding-right: 5px;">Paraf Pelaksana</td>
                <script>for(let i=1; i<=31; i++) document.write(`<td class="sig-cell" id="p-sig-${i}"></td>`);</script>
            </tr>
            <tr>
                <td colspan="3" style="text-align: right; font-weight: bold; background: #f0f0f0; padding-right: 5px;">Paraf Koordinator</td>
                <script>for(let i=1; i<=31; i++) document.write(`<td class="sig-cell" id="k-sig-${i}"></td>`);</script>
            </tr>
        </tbody>
    </table>

    <table style="border:none; margin-top: 10px;">
        <tr>
            <td width="60%" style="border:none; text-align: left; vertical-align: top; line-height: 1.4;">
                <b>Catatan :</b><br>
                (*) : Isi kolom laporan ceklist jika unit ini ada dimesin ini<br>
                (**) : Diisi angka jam kerja mesin / running hour yang ada dimesin<br><br>
                <b>Beri tanda :</b><br>
                √ : Bila item yang diperiksa baik, sesuai standar<br>
                X : Bila terjadi penyimpangan / kerusakan pada item yang diperiksa
            </td>
            <td width="40%" style="border:none;">
                <div class="footer-box">
                    DIKETAHUI<br>(SUPERINTENDENT)<br><br>
                    <div id="out-sig-super"></div>
                    <div id="out-name-super" style="position: absolute; bottom: 5px; width: 100%; font-weight: bold; text-decoration: underline;">-</div>
                </div>
            </td>
        </tr>
    </table>
</div>

<script>
    const _URL = "https://dsyvlavphvrdidmodokd.supabase.co";
    const _KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
    const sb = supabase.createClient(_URL, _KEY);

    // Inisialisasi Filter dropdown
    async function initFilter() {
        const { data: machines } = await sb.from('clhmi_machine').select('*').order('merk_mesin');
        machines.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m.id;
            opt.textContent = `${m.merk_mesin} (${m.serial_no})`;
            document.getElementById('machine-select').appendChild(opt);
        });

        const months = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
        months.forEach((m, i) => {
            const opt = document.createElement('option');
            opt.value = i + 1;
            opt.textContent = m;
            document.getElementById('month-select').appendChild(opt);
        });

        // Set default ke bulan berjalan
        document.getElementById('month-select').value = new Date().getMonth() + 1;

        const year = new Date().getFullYear();
        for(let y=year; y>=year-2; y--) {
            const opt = document.createElement('option');
            opt.value = y; opt.textContent = y;
            document.getElementById('year-select').appendChild(opt);
        }

        // Header Tanggal 1-31
        let h = "";
        for(let i=1; i<=31; i++) h += `<th width="24">${i}</th>`;
        document.getElementById('date-row').innerHTML = h;
    }

    async function loadData() {
        const mId = document.getElementById('machine-select').value;
        const bln = document.getElementById('month-select').value;
        const thn = document.getElementById('year-select').value;
        if(!mId) { alert("Pilih Mesin Terlebih Dahulu"); return; }

        // Bersihkan Grid Paraf
        for(let i=1; i<=31; i++) {
            document.getElementById(`p-sig-${i}`).innerHTML = "";
            document.getElementById(`k-sig-${i}`).innerHTML = "";
        }

        // Ambil Data dari Supabase
        // 1. Header untuk periode ini
        const { data: header } = await sb.from('clhmi')
            .select('*')
            .eq('machine_id', mId)
            .eq('bulan', bln)
            .eq('tahun', thn);

        // 2. Master Items
        const { data: master } = await sb.from('clhmi_items').select('*').order('urutan');
        
        if(!header || header.length === 0) { 
            document.getElementById('main-body').innerHTML = `<tr><td colspan="34" style="padding:20px; color:red;">Data tidak ditemukan untuk periode ini.</td></tr>`;
            return; 
        }

        // Ambil hasil detail dari semua form yang ditemukan di bulan tersebut
        const headerIds = header.map(h => h.id);
        const { data: results } = await sb.from('clhmi_results')
            .select('*')
            .in('clhmi_id', headerIds);

        // Set Info Header Report (Ambil dari salah satu data mesin)
        document.getElementById('out-merk').innerText = header[0].merk_mesin;
        document.getElementById('out-sn').innerText = header[0].serial_no;
        document.getElementById('out-ton').innerText = header[0].tonage || "-";
        document.getElementById('out-bln').innerText = document.getElementById('month-select').options[bln-1].text;
        document.getElementById('out-thn').innerText = thn;

        // Render Matrix Items
        const tbody = document.getElementById('main-body');
        tbody.innerHTML = "";
        let currentCat = "";

        master.forEach(m => {
            if(m.kategori !== currentCat) {
                tbody.innerHTML += `<tr><td colspan="34" class="bg-gray">${m.kategori}</td></tr>`;
                currentCat = m.kategori;
            }
            let rowHtml = `<tr><td>${m.item_kode||''}</td><td class="col-nama">${m.nama_pengecekan}</td><td class="col-std">${m.standar||'-'}</td>`;
            
            for(let d=1; d<=31; d++) {
                // Cari apakah ada pengecekan di tanggal 'd'
                const find = results.find(r => r.item_id === m.id && new Date(r.tanggal_cek).getDate() === d);
                let cellContent = "";
                let cellClass = "";
                
                if(find) {
                    cellContent = (find.status === 'OK' ? '√' : 'X');
                    if(find.status === 'NG') cellClass = 'st-ng';
                }
                rowHtml += `<td class="${cellClass}">${cellContent}</td>`;
            }
            tbody.innerHTML += rowHtml + "</tr>";
        });

        // Mapping Paraf Harian (Loop 31 hari)
        header.forEach(h => {
            const tgl = new Date(h.created_at).getDate();
            if(tgl >= 1 && tgl <= 31) {
                // Paraf Pelaksana (Selalu muncul jika submit)
                if(h.paraf_pelaksana) {
                     document.getElementById(`p-sig-${tgl}`).innerHTML = `<img src="${h.paraf_pelaksana}" class="sig-img">`;
                }
                // Paraf Koordinator (Muncul jika sudah approved/finalized)
                if((h.status_form === 'approved' || h.status_form === 'finalized') && h.paraf_koordinator) {
                     document.getElementById(`k-sig-${tgl}`).innerHTML = `<img src="${h.paraf_koordinator}" class="sig-img">`;
                }
                
                // Jika ada status 'finalized' di bulan ini, tampilkan TTD Superintendent di footer
                if(h.status_form === 'finalized') {
                    document.getElementById('out-name-super').innerText = h.approved_by || "SUPERINTENDENT";
                    // Catatan: Anda perlu kolom paraf_super di DB jika ingin menampilkan TTD Superintendent
                    if(h.paraf_super) {
                        document.getElementById('out-sig-super').innerHTML = `<img src="${h.paraf_super}" style="height:60px; mix-blend-mode: multiply;">`;
                    }
                }
            }
        });
    }

    window.onload = initFilter;
</script>
</body>
</html>
