<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>AF.SP 05.14 Rev-00 ‚Äì CHECKLIST STAND LABEL DAN ROBOT</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- SETTING KERTAS UTAMA (SAMA DENGAN CLHMI) --- */
        @page { 
            size: A4 landscape; 
            margin: 0; 
        }
        
        body { 
            font-family: 'Arial Narrow', 'Helvetica Narrow', Arial, sans-serif; 
            font-size: 8pt; 
            margin: 0; 
            padding: 10px; 
            background: #525659; 
            -webkit-print-color-adjust: exact; 
            padding-bottom: 80px; 
        }

        /* CONTAINER KERTAS DI LAYAR */
        .sheet { 
            background: white; 
            padding: 4mm 6mm; 
            margin: auto; 
            width: 297mm; 
            min-height: 210mm;
            box-shadow: 0 0 10px rgba(0,0,0,0.2); 
            box-sizing: border-box;
            position: relative;
        }

        /* TABEL GLOBAL */
        table { 
            border-collapse: collapse; 
            width: 100%; 
            table-layout: fixed; 
            margin-bottom: 3px; 
        }
        
        td, th { 
            border: 1px solid black; 
            padding: 1px 3px; 
            vertical-align: middle; 
            line-height: 1.05;
        }

        /* --- HEADER SECTION --- */
        .header-table { border: 2px solid black !important; }
        .header-table td { height: 40px; } 
        .logo-img { height: 40px; display: block; margin: 0 auto; }
        .main-title { font-size: 14pt; font-weight: bold; text-align: center; text-transform: uppercase; }
        .doc-info { font-size: 7pt; line-height: 1.2; padding: 2px 5px; }

        /* --- INFO MESIN SECTION --- */
        .info-table { border: 2px solid black; }
        .info-table td { font-weight: bold; font-size: 8.5pt; padding: 2px 4px; border: none; }
        .dot-line { border-bottom: 1px dotted #000; display: inline-block; width: 95%; font-weight: normal; padding-left: 5px; }

        /* --- MAIN GRID TABLE --- */
        .grid-table { border: 2px solid black; }
        .grid-table th { 
            background-color: #ffffff; 
            text-align: center; 
            font-weight: bold; 
            border: 1px solid black;
            font-size: 7.5pt;
            height: 20px;
        }

        /* LEBAR KOLOM (DISESUAIKAN UNTUK ROBOT - TANPA METODE/CATATAN) */
        .col-no { width: 25px; text-align: center; }
        .col-item { width: 320px; text-align: left; } /* Diperlebar karena kolom metode hilang */
        .col-spacer { width: 10px; border-left: none; border-right: none; background: #f4f4f4; } 
        .col-std { width: 200px; text-align: center; font-size: 6.5pt; white-space: normal; } /* Diperlebar */
        .col-date { width: 18px; text-align: center; font-size: 8pt; padding: 0; }

        /* BARIS KATEGORI */
        .cat-row { 
            background-color: #d9d9d9 !important; 
            font-weight: bold; 
            text-align: left; 
            padding-left: 5px; 
            border: 1px solid black;
            text-transform: uppercase;
            font-size: 7.5pt;
            height: 18px;
        }

        /* STATUS VISUAL */
        .st-ok { color: #000; font-weight: 900; font-family: 'DejaVu Sans', sans-serif; font-size: 10pt; } 
        .st-ng { color: red; font-weight: 900; font-size: 8pt; }
        .st-mt { color: blue; font-weight: 900; font-size: 8pt; } 
        .st-na { color: #666; font-weight: 900; font-size: 8pt; }

        /* SIGNATURE AREA */
        .sig-row td { background-color: #f2f2f2; font-weight: bold; text-align: right; padding-right: 5px; font-size: 7pt; }
        .sig-cell { height: 35px; background: white; padding: 0 !important; text-align: center; vertical-align: middle; }
        .sig-img { width: 100%; height: 100%; max-height: 30px; object-fit: contain; mix-blend-mode: multiply; }

        /* --- FOOTER SECTION --- */
        .footer-wrapper { display: flex; border: 2px solid black; margin-top: 5px; height: 90px; }
        .footer-left { flex: 2.2; border-right: 1px solid black; padding: 4px; font-size: 7pt; line-height: 1.35; }
        .footer-right { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 4px; }
        
        .super-title { font-weight: bold; text-align: center; text-decoration: underline; margin-bottom: 2px; font-size: 7.5pt; }
        .super-sig { flex-grow: 1; display: flex; align-items: center; justify-content: center; width: 100%; }
        .super-name { font-weight: bold; text-decoration: underline; text-transform: uppercase; font-size: 8pt; }
        .super-img { max-height: 50px; max-width: 90px; mix-blend-mode: multiply; }

        /* UI PANEL (NON PRINT) */
        .no-print { 
            background: #1e293b; color: white; padding: 15px; margin-bottom: 20px; 
            display: flex; gap: 10px; justify-content: center; align-items: center; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-radius: 8px;
        }
        select, button { padding: 8px 12px; border-radius: 4px; border: none; font-weight: bold; cursor: pointer; }
        button.print-btn { background: #22c55e; color: white; }
        button.load-btn { background: #3b82f6; color: white; }

        /* --- NAVIGASI BAWAH (SESUAI REQUEST) --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; background: #1e293b; color: white;
            display: flex; justify-content: space-around; padding: 15px; z-index: 100;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.2);
        }
        .nav-link {
            text-decoration: none; color: white; font-weight: bold; font-size: 10pt;
            padding: 8px 15px; border-radius: 4px; background: #3b82f6;
            transition: background 0.2s; text-transform: uppercase;
        }
        .nav-link:hover { background: #2563eb; }

        @media print { 
            .no-print, .bottom-nav { display: none !important; }
            body { background: white; margin: 0; padding: 0; zoom: 88%; } 
            .sheet { box-shadow: none; border: none; margin: 0; width: 100%; padding: 4mm; page-break-inside: avoid; }
            .grid-table th { background-color: #fff !important; -webkit-print-color-adjust: exact; }
            .cat-row { background-color: #ddd !important; -webkit-print-color-adjust: exact; }
            .sig-row td { background-color: #eee !important; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>

<div class="no-print">
    <span>üñ®Ô∏è PANEL KONTROL (ROBOT):</span>
    <select id="machine-select"><option value="">-- Pilih Mesin --</option></select>
    <select id="month-select"></select>
    <select id="year-select"></select>
    <button class="load-btn" onclick="loadData()">TAMPILKAN DATA</button>
    <button class="print-btn" onclick="window.print()">CETAK PDF</button>
</div>

<div class="sheet">
    
    <!-- HEADER -->
    <table class="header-table">
        <tr>
            <td width="15%" style="text-align:center;">
                <img src="https://amarilyskg.co.id/bootstrap/img/logo.png" class="logo-img" alt="Logo">
            </td>
            <td width="60%" class="main-title">CHECK LIST HARIAN STAND LABEL DAN ROBOT</td>
            <td width="25%" class="doc-info">
                No Dokumen &nbsp;&nbsp;&nbsp;: AF.SP 05.14.Rev-00<br>
                Tanggal Terbit : 02 Agustus 2024<br>
                Halaman &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: 1/1<br>
                Tanggal Revisi : -
            </td>
        </tr>
    </table>

    <!-- INFO MESIN -->
    <table class="info-table">
        <tr>
            <td width="12%">MERK MESIN</td><td width="1%">:</td><td width="30%"><span id="out-merk" class="dot-line"></span></td>
            <td width="10%">SERIAL NO</td><td width="1%">:</td><td width="25%"><span id="out-sn" class="dot-line"></span></td>
            <td width="8%">BULAN</td><td width="1%">:</td><td><span id="out-bln" class="dot-line"></span></td>
        </tr>
        <tr>
            <td>TONAGE</td><td>:</td><td><span id="out-ton" class="dot-line"></span></td>
            <td></td><td></td><td></td>
            <td>TAHUN</td><td>:</td><td><span id="out-thn" class="dot-line"></span></td>
        </tr>
    </table>

    <!-- GRID CHECKLIST (TANPA METODE & CATATAN) -->
    <table class="grid-table">
        <thead>
            <tr>
                <th rowspan="2" class="col-no">No</th>
                <th rowspan="2" class="col-item">Jenis pengecekan</th>
                <th rowspan="2" class="col-spacer"></th>
                <th rowspan="2" class="col-std">Standard</th>
                <th colspan="31" style="height:15px;">Tanggal</th>
            </tr>
            <tr id="date-row">
                <!-- Diisi Script 1-31 -->
            </tr>
        </thead>
        <tbody id="main-body">
            <tr><td colspan="35" style="text-align:center; padding:20px;">Silahkan Pilih Filter Data...</td></tr>
        </tbody>
        
        <tbody id="sig-body" style="display:none;">
            <tr class="sig-row">
                <td colspan="4">Paraf Pelaksana</td>
                <script>for(let i=1;i<=31;i++) document.write(`<td class="sig-cell" id="p-sig-${i}"></td>`);</script>
            </tr>
            <tr class="sig-row">
                <td colspan="4">Paraf Koordinator</td>
                <script>for(let i=1;i<=31;i++) document.write(`<td class="sig-cell" id="k-sig-${i}"></td>`);</script>
            </tr>
        </tbody>
    </table>

    <!-- FOOTER -->
    <div class="footer-wrapper">
        <div class="footer-left">
            <b>Catatan :</b><br>
            (*) : Isi kolom laporan ceklist jika unit ini ada dimesin ini<br>
            (**) : Diisi angka jam kerja mesin / running hour yang ada dimesin<br><br>
            <b>Beri tanda :</b><br>
            <span style="font-weight:bold;">‚úì</span> OK (Sesuai Standar) &nbsp;&nbsp;
            <span style="font-weight:bold; color:red;">X</span> NG (Rusak/Penyimpangan) &nbsp;&nbsp;
            <span style="font-weight:bold; color:blue;">O</span> Perbaikan (Maintenance) &nbsp;&nbsp;
            <span style="font-weight:bold; color:#666;">-</span> Tidak Ada (NA)
        </div>
        <div class="footer-right">
            <div class="super-title">DIKETAHUI<br>MECHANIC SUPERINTENDENT</div>
            <div class="super-sig" id="out-sig-super">
                <span style="color:#ccc; font-size:7pt;">(Menunggu Pengesahan)</span>
            </div>
            <div class="super-name" id="out-name-super"></div>
        </div>
    </div>

</div>

<!-- BOTTOM NAV -->
<div class="bottom-nav">
    <a href="index.html" class="nav-link nav-home">üè† Home</a>
    <a href="menu_utama.html" class="nav-link nav-menu">üìã Menu</a>
    <a href="download_data.html" class="nav-link nav-data">üìÇ Data</a>
    <a href="informasi_akun.html" class="nav-link nav-akun">üë§ Akun</a>
</div>

<script>
    const _URL = "https://dsyvlavphvrdidmodokd.supabase.co";
    const _KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
    const sb = supabase.createClient(_URL, _KEY);

    // MASTER ITEMS (SAMA DENGAN DATABASE)
    const MASTER_ITEMS = [
        {kode:"", kategori:"FRAME/RANGKA STAND LABEL", nama:""},
        {kode:"a", nama:"Cek kondisi baut frame/rangka", std:"Tidak kendor/lepas"},
        {kode:"b", nama:"Cek bubble leveller", std:"Terpasang dan berfungsi dengan benar"},

        {kode:"", kategori:"MAGAZINE LABEL", nama:""},
        {kode:"a", nama:"Cek As Adjuster/Adjuster Plate Magazine Label", std:"berfungsi baik"},
        {kode:"b", nama:"Cek baut frame/rangka magazine label", std:"Lengkap dan bersih"},

        {kode:"", kategori:"PLATE STAND LABEL", nama:""},
        {kode:"a", nama:"Cek V-Belt kondisi baik", std:"Tidak kendor dan tidak terlalu kencang"},
        {kode:"b", nama:"Cek Gear/Bushing/bearing", std:"Tidak goyang"},
        {kode:"c", nama:"Cek Vacuum Pad", std:"baut dan skun kencang"},
        {kode:"d", nama:"Cek Pergerakan spring/as vacuum pads", std:"Smooth/halus"},
        {kode:"e", nama:"Cek Linier bearing SL", std:"Berfungsi dengan baik, tidak kendor"},
        {kode:"f", nama:"Cek tutup rail", std:"Terpasang dengan benar"},

        {kode:"", kategori:"PANEL KONTROL STANDLABEL", nama:""},
        {kode:"a", nama:"Pastikan kondisi panel dan komponen", std:"Tidak berdebu dan lengket"},
        {kode:"b", nama:"Komponen electrical", std:"Tidak kendor dan terpasang dengan benar"},
        {kode:"c", nama:"Instalasi kabel", std:"Terpasang rapi,tidak kendor"},
        {kode:"d", nama:"Instalasi selenoid valve", std:"Tidak kendor"},
        {kode:"e", nama:"Cek kondisi fan", std:"Tidak berdebu, dalam kondisi bersih"},
        {kode:"f", nama:"Sambungan kabel power/kontrol", std:"Kondisi permanen, tidak ada sambungan sementara"},

        {kode:"", kategori:"SISTEM PNEUMATIC STAND LABEL", nama:""},
        {kode:"a", nama:"Instalasi pneumatic, cylinder,tubing,dll", std:"Terpasang rapi,tidak ada yang bocor"},
        {kode:"b", nama:"Instalasi tubing terpasang", std:"Terpasang rapi, permanen, tidak ada sambungan"},
        {kode:"c", nama:"Cek selenoid valve", std:"Dilengkapi silencer"},
        {kode:"d", nama:"Instalasi Vacuum generator", std:"Dilengkapi silencer"},
        {kode:"e", nama:"Fungsi vacuum generator", std:"spesifikasi (0.4 - 0.5 kpa)"},
        {kode:"f", nama:"Sensor pneumatic", std:"Terpasang, berfungsi dengan baik/stabil"},
        {kode:"g", nama:"Sensor vacuum", std:"Berfungsi dengan baik, pembacaan stabil"},
        {kode:"h", nama:"Cek tekanan supply angin kompressor", std:"Stabil (4-8 bar)"},

        {kode:"", kategori:"SISTEM ROBOT", nama:""},
        {kode:"a", nama:"Dummy robot", std:"Cleaning dummy menggunakan majun hitam (15 menit )"},
        {kode:"b", nama:"Sistem static", std:"Nilai static 9-13 Kv"}
    ];

    async function initFilter() {
        const { data: m } = await sb.from('chslr_mesin').select('*').order('nama_mesin');
        m?.forEach(x => document.getElementById('machine-select').add(new Option(`${x.nama_mesin}`, x.nama_mesin)));
        const mo = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
        mo.forEach((v, i) => document.getElementById('month-select').add(new Option(v, i+1)));
        const y = new Date().getFullYear();
        for(let i=y; i>=y-2; i--) document.getElementById('year-select').add(new Option(i, i));
        
        let h = "";
        for(let i=1; i<=31; i++) h += `<th class="col-date">${i}</th>`;
        document.getElementById('date-row').innerHTML = h;
    }

    async function loadData() {
        const mId = document.getElementById('machine-select').value;
        const bln = parseInt(document.getElementById('month-select').value);
        const thn = parseInt(document.getElementById('year-select').value);
        if(!mId || !bln || !thn) return alert("Pilih Filter dulu!");

        for(let i=1; i<=31; i++) {
            document.getElementById(`p-sig-${i}`).innerHTML = "";
            document.getElementById(`k-sig-${i}`).innerHTML = "";
        }
        document.getElementById('sig-body').style.display = 'table-row-group';

        // 1. GET HEADER (LOG)
        // Kita cari log berdasarkan nama_mesin (karena di database chslr_log pakai nama_mesin string)
        const { data: log, error: err } = await sb.from('chslr_log')
            .select('*, chslr_mesin!inner(nama_mesin, no_seri, lokasi)')
            .eq('mesin_id', mId) // mId di sini adalah nama_mesin (string)
            .eq('bulan', bln)
            .eq('tahun', thn)
            .maybeSingle();

        if(!log) { 
            alert("Data laporan tidak ditemukan."); 
            document.getElementById('main-body').innerHTML = `<tr><td colspan="35" style="text-align:center; padding:20px; color:red;">DATA TIDAK DITEMUKAN</td></tr>`;
            return; 
        }

        // 2. GET RESULTS
        const { data: allRes } = await sb.from('chslr_result')
            .select('item_id, status, tanggal, signature, chslr_items(item_name)')
            .eq('log_id', log.id);

        // ISI HEADER INFO
        document.getElementById('out-merk').innerText = log.chslr_mesin.nama_mesin || '-';
        document.getElementById('out-sn').innerText = log.chslr_mesin.no_seri || '-';
        document.getElementById('out-ton').innerText = '-'; 
        document.getElementById('out-bln').innerText = document.getElementById('month-select').options[bln-1].text.toUpperCase();
        document.getElementById('out-thn').innerText = thn;

        const tbody = document.getElementById('main-body');
        tbody.innerHTML = "";
        let curCat = "";

        MASTER_ITEMS.forEach(item => {
            if(item.kategori && item.kategori !== curCat) {
                tbody.innerHTML += `<tr><td colspan="35" class="cat-row">${item.kategori}</td></tr>`;
                curCat = item.kategori;
            }
            if(!item.nama) return;

            let row = `<tr>
                <td class="col-no">${item.kode}</td>
                <td class="col-item">${item.nama}</td>
                <td class="col-spacer"></td>
                <td class="col-std">${item.std}</td>`;

            for(let d=1; d<=31; d++) {
                // MATCHING DATA: Tanggal & Nama Item
                // Kita gunakan trim() untuk memastikan spasi tidak mengganggu
                const f = allRes.find(r => 
                    r.tanggal === d && 
                    r.chslr_items.item_name.trim() === item.nama.trim()
                );

                let sym = '', cls = '';
                if(f) {
                    if(f.status === 'OK') { sym = '‚úì'; cls = 'st-ok'; }
                    else if(f.status === 'NG') { sym = 'X'; cls = 'st-ng'; }
                    else if(f.status === 'MT') { sym = 'O'; cls = 'st-mt'; }
                    else if(f.status === 'NA') { sym = '-'; cls = 'st-na'; }
                    
                    // Logic Paraf Harian (Ambil dari salah satu item di hari itu)
                    if(f.signature) {
                        document.getElementById(`p-sig-${d}`).innerHTML = `<img src="${f.signature}" class="sig-img">`;
                    }
                }
                row += `<td class="col-date ${cls}">${sym}</td>`;
            }
            tbody.innerHTML += row + "</tr>";
        });

        // Tanda Tangan Superintendent (Logic Dummy karena belum ada di DB chslr_log)
        // Jika status_form = 'closed' (mirip CLHMI), tampilkan
        if(log.status_form === 'closed' && log.paraf_super) {
            document.getElementById('out-sig-super').innerHTML = `<img src="${log.paraf_super}" class="super-img">`;
            document.getElementById("out-name-super").innerText = (log.verified_by || '').toUpperCase();
        } else {
            document.getElementById('out-sig-super').innerHTML = `<span style="color:#ccc; font-size:6pt;">(Menunggu Pengesahan)</span>`;
            document.getElementById("out-name-super").innerText = "";
        }
    }

    window.onload = initFilter;
</script>
</body>
</html>
