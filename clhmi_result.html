<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AF.SP 05.13.Rev-00 - Checklist Harian Mesin Injection</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @page { size: A4 landscape; margin: 5mm; }
        body { font-family: 'Arial Narrow', Arial, sans-serif; font-size: 7.5pt; margin: 0; padding: 10px; background: #f0f2f5; }
        
        /* Container Utama */
        .sheet { background: white; padding: 5mm; margin: auto; width: 285mm; box-shadow: 0 0 10px rgba(0,0,0,0.2); min-height: 190mm; }
        
        /* Table Styling */
        table { border-collapse: collapse; width: 100%; table-layout: fixed; }
        td, th { border: 1px solid black; padding: 2px; vertical-align: middle; text-align: center; }
        
        /* Header Logo & Dokumen */
        .header-table td { border: 2px solid black; height: 50px; font-weight: bold; }
        .logo-img { height: 40px; }
        .doc-info { text-align: left; font-size: 7pt; padding-left: 5px; font-weight: normal; }

        /* Info Mesin */
        .info-table { border: none; margin: 10px 0; }
        .info-table td { border: none; text-align: left; padding: 1px 0; font-size: 8pt; }
        .dot-line { border-bottom: 1px dotted #000; min-width: 140px; display: inline-block; padding-left: 5px; font-weight: bold; }

        /* Sizing Kolom Persis File */
        .bg-gray { background-color: #dfdfdf; font-weight: bold; text-align: left; padding-left: 10px; height: 20px; font-size: 8pt; }
        .col-no { width: 25px; }
        .col-nama { width: 180px; text-align: left; padding-left: 5px; }
        .col-std { width: 150px; text-align: left; padding: 3px; font-size: 6.5pt; white-space: normal; line-height: 1.2; word-wrap: break-word; }
        .col-metode { width: 70px; font-size: 7pt; text-transform: uppercase; }
        .col-catatan { width: 60px; font-size: 6.5pt; }
        .date-cell { width: 22px; font-weight: bold; font-size: 7pt; }

        /* Status & Warna */
        .st-ng { background: #ff4d4d !important; color: white; font-weight: bold; }
        .st-na { background: #fff3cd !important; color: #856404; font-weight: bold; }
        .val-rh { font-size: 6pt; font-weight: normal; color: #000; }

        /* Paraf Section */
        .sig-cell { height: 45px; padding: 0 !important; background: #fff; position: relative; }
        .sig-img { max-height: 42px; max-width: 20px; mix-blend-mode: multiply; display: block; margin: 0 auto; }

        /* Controls */
        .no-print { background: #1a73e8; color: white; padding: 15px; margin-bottom: 20px; border-radius: 8px; display: flex; gap: 15px; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        select, button { padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; }
        button:hover { opacity: 0.9; }

        @media print { 
            .no-print { display: none; } 
            body { background: white; padding: 0; } 
            .sheet { box-shadow: none; width: 100%; border: none; } 
        }
    </style>
</head>
<body>

<div class="no-print">
    <strong>REPORT PANEL:</strong>
    <select id="machine-select"><option value="">-- Pilih Mesin --</option></select>
    <select id="month-select"></select>
    <select id="year-select"></select>
    <button onclick="loadData()" style="background: #ffffff; color: #1a73e8;">TAMPILKAN</button>
    <button onclick="window.print()" style="background: #34a853; color: white;">CETAK PDF</button>
</div>

<div class="sheet">
    <table class="header-table">
        <tr>
            <td width="15%"><img src="https://amarilyskg.co.id/bootstrap/img/logo.png" class="logo-img"></td>
            <td width="55%" style="font-size:14pt; letter-spacing: 1px;">CHECK LIST HARIAN MESIN INJECTION</td>
            <td width="30%" class="doc-info">
                No Dokumen : AF.SP 05.13.Rev-00<br>
                Tanggal Terbit : 02 Agustus 2024<br>
                Halaman : 1/1
            </td>
        </tr>
    </table>

    <table class="info-table">
        <tr>
            <td width="10%">MERK MESIN</td><td width="1%">:</td><td width="20%"><span id="out-merk" class="dot-line">-</span></td>
            <td width="10%">SERIAL NO</td><td width="1%">:</td><td width="20%"><span id="out-sn" class="dot-line">-</span></td>
            <td width="8%">BULAN</td><td width="1%">:</td><td width="10%"><span id="out-bln" class="dot-line">-</span></td>
        </tr>
        <tr>
            <td>TONAGE</td><td>:</td><td><span id="out-ton" class="dot-line">-</span></td>
            <td>TAHUN</td><td>:</td><td><span id="out-thn" class="dot-line">-</span></td>
            <td colspan="3"></td>
        </tr>
    </table>

    <table>
        <thead>
            <tr style="background: #f8f9fa;">
                <th rowspan="2" class="col-no">No</th>
                <th rowspan="2" class="col-nama">Jenis Pengecekan</th>
                <th rowspan="2" style="width: 5px; border-left: none; border-right: none;"></th>
                <th rowspan="2" class="col-std">Standard</th>
                <th rowspan="2" class="col-metode">Metode</th>
                <th rowspan="2" class="col-catatan">Catatan</th>
                <th colspan="31" style="height: 15px;">Tanggal</th>
            </tr>
            <tr id="date-row" style="background: #f8f9fa;"></tr>
        </thead>
        <tbody id="main-body">
            </tbody>
        <tfoot>
            <tr>
                <td colspan="6" style="text-align:right; font-weight:bold; height:45px; padding-right:10px;">Paraf Pelaksana</td>
                <script>for(let i=1;i<=31;i++) document.write(`<td class="sig-cell" id="p-sig-${i}"></td>`);</script>
            </tr>
            <tr>
                <td colspan="6" style="text-align:right; font-weight:bold; height:45px; padding-right:10px;">Paraf Koordinator</td>
                <script>for(let i=1;i<=31;i++) document.write(`<td class="sig-cell" id="k-sig-${i}"></td>`);</script>
            </tr>
        </tfoot>
    </table>

    <table style="border:none; margin-top:15px;">
        <tr>
            <td width="70%" style="border:none; text-align:left; vertical-align:top; font-size:7pt; line-height: 1.4;">
                <b>Catatan:</b><br>
                (*) Isi kolom laporan ceklist jika unit ini ada di mesin ini<br>
                (**) Diisi angka jam kerja mesin / running hour yang ada di mesin<br>
                <b>Tanda:</b> √ (OK), X (NG), O (NA/Repair)
            </td>
            <td width="30%" style="border:none;">
                <div style="border: 1px solid black; height: 110px; padding: 5px; display: flex; flex-direction: column; justify-content: space-between; align-items: center;">
                    <div style="font-weight:bold; text-align:center; font-size:7pt;">DIKETAHUI / DISYAHKAN<br>MECHANIC SUPERINTENDENT</div>
                    <div id="out-sig-super"></div>
                    <div id="out-name-super" style="font-weight: bold; text-decoration: underline; text-transform: uppercase;">-</div>
                </div>
            </td>
        </tr>
    </table>
</div>

<script>
    const _URL = "https://dsyvlavphvrdidmodokd.supabase.co";
    const _KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
    const sb = supabase.createClient(_URL, _KEY);

    async function init() {
        const { data: machines } = await sb.from('clhmi_machine').select('*').order('merk_mesin');
        machines?.forEach(x => document.getElementById('machine-select').add(new Option(`${x.merk_mesin} (${x.serial_no})`, x.id)));
        
        const mo = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
        mo.forEach((v, i) => document.getElementById('month-select').add(new Option(v, i+1)));
        
        const y = new Date().getFullYear();
        for(let i=y; i>=y-2; i--) document.getElementById('year-select').add(new Option(i, i));
        
        let h = "";
        for(let i=1; i<=31; i++) h += `<th class="date-cell">${i}</th>`;
        document.getElementById('date-row').innerHTML = h;
    }

    async function loadData() {
        const mId = document.getElementById('machine-select').value;
        const bln = parseInt(document.getElementById('month-select').value);
        const thn = parseInt(document.getElementById('year-select').value);
        if(!mId) { alert("Pilih Mesin dulu!"); return; }

        const { data: master } = await sb.from('clhmi_items').select('*').order('created_at', { ascending: true });
        const { data: headers } = await sb.from('clhmi').select('*').eq('machine_id', mId).eq('bulan', bln).eq('tahun', thn);
        
        if(!headers || headers.length === 0) { alert("Data tidak ditemukan untuk periode ini."); return; }

        const hIds = headers.map(h => h.id);
        const { data: results } = await sb.from('clhmi_results').select('*').in('clhmi_id', hIds);
        
        const resMap = {};
        results?.forEach(r => {
            const day = parseInt(r.tanggal_cek.split('-')[2]);
            resMap[`${r.item_id}-${day}`] = r;
        });

        // Update Header Info
        const h = headers[0];
        document.getElementById('out-merk').innerText = h.merk_mesin || '-';
        document.getElementById('out-sn').innerText = h.serial_no || '-';
        document.getElementById('out-ton').innerText = h.tonage || '-';
        document.getElementById('out-bln').innerText = document.getElementById('month-select').options[bln-1].text;
        document.getElementById('out-thn').innerText = thn;

        // Render Body
        const tbody = document.getElementById('main-body');
        tbody.innerHTML = "";
        let curCat = "";

        master.forEach(m => {
            if(m.kategori !== curCat) {
                tbody.innerHTML += `<tr><td colspan="37" class="bg-gray">${m.kategori.toUpperCase()}</td></tr>`;
                curCat = m.kategori;
            }

            // Abaikan baris label kategori jika nama_pengecekan sama dengan kategori
            if(m.urutan.length === 1 && !isNaN(m.urutan) && m.nama_pengecekan.toLowerCase().includes(m.kategori.toLowerCase())) return;

            let row = `<tr>
                <td class="col-no">${m.urutan}</td>
                <td class="col-nama">${m.nama_pengecekan}</td>
                <td style="border-left:none; border-right:none;"></td>
                <td class="col-std">${m.standard || ''}</td>
                <td class="col-metode">${m.metode || ''}</td>
                <td class="col-catatan">${m.catatan || ''}</td>`;

            for(let d=1; d<=31; d++) {
                const f = resMap[`${m.id}-${d}`];
                let sym = '', cls = '';
                if(f) {
                    if(m.item_kode === 'i' || m.nama_pengecekan.toLowerCase().includes('hour')) {
                        sym = `<span class="val-rh">${f.value || ''}</span>`;
                    } else {
                        const s = (f.status || '').toUpperCase();
                        sym = s === 'OK' ? '√' : s === 'NG' ? 'X' : s === 'NA' ? 'O' : '';
                        if(s === 'NG') cls = 'st-ng';
                        if(s === 'NA') cls = 'st-na';
                    }
                }
                row += `<td class="date-cell ${cls}">${sym}</td>`;
            }
            tbody.innerHTML += row + "</tr>";
        });

        // Render Paraf
        for(let i=1; i<=31; i++) {
            document.getElementById(`p-sig-${i}`).innerHTML = "";
            document.getElementById(`k-sig-${i}`).innerHTML = "";
        }
        headers.forEach(head => {
            const d = parseInt(head.tanggal_isi.split('-')[2]);
            if(head.paraf) document.getElementById(`p-sig-${d}`).innerHTML = `<img src="${head.paraf}" class="sig-img">`;
            if(head.paraf_coord) document.getElementById(`k-sig-${d}`).innerHTML = `<img src="${head.paraf_coord}" class="sig-img">`;
        });

        // Superintendent
        const final = headers.find(x => x.status_form === 'finalized') || headers[headers.length-1];
        if(final && final.paraf_super) {
            document.getElementById('out-sig-super').innerHTML = `<img src="${final.paraf_super}" style="max-height:60px; mix-blend-mode:multiply;">`;
            document.getElementById('out-name-super').innerText = final.approved_by || '-';
        }
    }

    window.onload = init;
</script>
</body>
</html>
