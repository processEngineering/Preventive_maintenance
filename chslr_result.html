<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Bulanan CHSLR</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            .no-print { display: none; }
            body { background: white; padding: 0; }
            .print-area { border: none; shadow: none; width: 100%; max-width: 100%; }
        }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid black; padding: 2px 4px; font-size: 8px; text-align: center; }
        .text-left-imp { text-align: left !important; font-size: 8px; }
        .bg-gray-header { background-color: #f3f4f6 !important; -webkit-print-color-adjust: exact; }
    </style>
</head>
<body class="bg-slate-100 p-4">

    <div class="max-w-6xl mx-auto mb-6 no-print bg-white p-6 rounded-2xl shadow-sm border">
        <div class="flex flex-wrap gap-4 items-end">
            <div class="flex-1 min-w-[200px]">
                <label class="block text-xs font-bold mb-1">Pilih Mesin</label>
                <select id="f-mesin" class="w-full p-2 border rounded-lg text-sm"></select>
            </div>
            <div class="w-32">
                <label class="block text-xs font-bold mb-1">Bulan</label>
                <select id="f-bulan" class="w-full p-2 border rounded-lg text-sm">
                    <option value="1">Januari</option><option value="2">Februari</option>
                    <option value="3">Maret</option><option value="4">April</option>
                    <option value="5">Mei</option><option value="6">Juni</option>
                    <option value="7">Juli</option><option value="8">Agustus</option>
                    <option value="9">September</option><option value="10">Oktober</option>
                    <option value="11">November</option><option value="12">Desember</option>
                </select>
            </div>
            <button onclick="generateReport()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold">Tampilkan Laporan</button>
            <button onclick="window.print()" class="bg-slate-800 text-white px-6 py-2 rounded-lg font-bold"><i class="fa-solid fa-print"></i> Cetak ke PDF</button>
        </div>
    </div>

    <div id="report-content" class="max-w-[1100px] mx-auto bg-white p-8 shadow-lg border border-slate-300 print-area hidden">
        
        <div class="flex border-2 border-black mb-4">
            <div class="w-1/4 p-4 border-r-2 border-black flex items-center justify-center">
                <img src="https://amarilyskg.co.id/bootstrap/img/logo.png" class="h-10">
            </div>
            <div class="w-1/2 p-2 border-r-2 border-black text-center flex flex-col justify-center">
                <h1 class="text-sm font-black uppercase">Checklist Harian Stand Label dan Robot</h1>
            </div>
            <div class="w-1/4 text-[8px] font-bold p-1 space-y-1">
                <div class="flex justify-between border-b border-black"><span>No Dokumen</span><span>: AF.SP 05.14.Rev-00</span></div>
                <div class="flex justify-between border-b border-black"><span>Tgl Terbit</span><span>: 02 Agustus 2024</span></div>
                <div class="flex justify-between border-b border-black"><span>Halaman</span><span>: 1/1</span></div>
                <div class="flex justify-between"><span>Tgl Revisi</span><span>: -</span></div>
            </div>
        </div>

        <div class="grid grid-cols-2 text-[10px] font-bold mb-2">
            <div>
                <p>MERK MESIN : <span id="out-merk" class="font-normal border-b border-black px-2"></span></p>
                <p>TONAGE : <span id="out-tonage" class="font-normal border-b border-black px-2"></span></p>
            </div>
            <div class="text-right">
                <p>BULAN : <span id="out-bulan" class="font-black border-b-2 border-black px-4 uppercase"></span></p>
                <p>NAMA MESIN : <span id="out-nama" class="font-black border-b-2 border-black px-4 uppercase"></span></p>
            </div>
        </div>

        <table class="mb-4">
            <thead class="bg-gray-header">
                <tr>
                    <th rowspan="2" width="20">No</th>
                    <th rowspan="2" width="180">Jenis Pengecekan</th>
                    <th rowspan="2" width="120">Standard</th>
                    <th colspan="31">Tanggal</th>
                </tr>
                <tr id="date-row">
                    <script>for(let i=1; i<=31; i++) document.write(`<th width="18">${i}</th>`);</script>
                </tr>
            </thead>
            <tbody id="result-body">
                </tbody>
        </table>

        <div class="grid grid-cols-3 border-2 border-black mt-6 text-center text-[10px]">
            <div class="border-r-2 border-black">
                <p class="font-bold border-b border-black py-1">Paraf Pelaksana</p>
                <div id="out-pelaksana" class="h-20 flex flex-wrap items-center justify-center p-2 text-[8px] italic text-slate-400">
                    </div>
            </div>
            <div class="border-r-2 border-black">
                <p class="font-bold border-b border-black py-1">Paraf Pengecek (Koordinator)</p>
                <div class="h-20 flex flex-col items-center justify-center relative">
                    <img id="sig-koordinator" class="h-16 absolute opacity-90" src="">
                    <p id="name-koordinator" class="mt-14 font-bold"></p>
                </div>
            </div>
            <div>
                <p class="font-bold border-b border-black py-1">Diketahui (Superintendent)</p>
                <div class="h-20 flex flex-col items-center justify-center relative">
                    <img id="sig-superintendent" class="h-16 absolute opacity-90" src="">
                    <p id="name-superintendent" class="mt-14 font-bold"></p>
                </div>
            </div>
        </div>

        <div class="mt-4 text-[8px] italic">
            <p>Keterangan: √ = Baik, X = Rusak/NG</p>
        </div>
    </div>

    <script>
        const SB_URL = "https://dsyvlavphvrdidmodokd.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
        const _sb = supabase.createClient(SB_URL, SB_KEY);

        window.onload = async () => {
            const { data } = await _sb.from('chslr_mesin').select('*').order('nama_mesin');
            const sel = document.getElementById('f-mesin');
            data.forEach(m => sel.innerHTML += `<option value="${m.id}">${m.nama_mesin}</option>`);
        };

        async function generateReport() {
            const mId = document.getElementById('f-mesin').value;
            const bln = document.getElementById('f-bulan').value;
            const thn = new Date().getFullYear();

            const { data: log } = await _sb.from('chslr_log')
                .select('*, chslr_mesin(*), chslr_result(*, chslr_items(*))')
                .eq('mesin_id', mId).eq('bulan', bln).eq('tahun', thn).maybeSingle();

            if(!log) return alert("Data tidak ditemukan!");

            // Tampilkan Elemen
            document.getElementById('report-content').classList.remove('hidden');
            
            // Header Info
            document.getElementById('out-merk').innerText = log.chslr_mesin.merk_mesin;
            document.getElementById('out-tonage').innerText = log.chslr_mesin.tonage;
            document.getElementById('out-nama').innerText = log.chslr_mesin.nama_mesin;
            document.getElementById('out-bulan').innerText = document.querySelector('#f-bulan option:checked').text + " " + thn;

            // Populate Table
            const { data: allItems } = await _sb.from('chslr_items').select('*').order('sort_order');
            const body = document.getElementById('result-body');
            body.innerHTML = "";

            allItems.forEach((item, index) => {
                let row = `<tr>
                    <td>${index + 1}</td>
                    <td class="text-left-imp font-bold">${item.item_name}</td>
                    <td class="text-left-imp italic text-[7px]">${item.standard}</td>`;
                
                for(let t=1; t<=31; t++) {
                    const found = log.chslr_result.find(r => r.item_id === item.id && r.tanggal === t);
                    const val = found ? (found.status === 'OK' ? '√' : 'X') : '';
                    row += `<td>${val}</td>`;
                }
                row += `</tr>`;
                body.innerHTML += row;
            });

            // Signatures & Names
            document.getElementById('out-pelaksana').innerText = log.pelaksana_names.join(', ');
            
            if(log.status_verifikasi) {
                document.getElementById('sig-koordinator').src = log.signature_koordinator;
                document.getElementById('name-koordinator').innerText = log.koordinator_nama;
            }
            if(log.status_final) {
                document.getElementById('sig-superintendent').src = log.signature_superintendent;
                document.getElementById('name-superintendent').innerText = log.superintendent_nama;
            }
        }
    </script>
</body>
</html>
