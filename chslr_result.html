<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHECKLIST HARIAN STAND LABEL DAN ROBOT</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* CSS KAMU YANG SUDAH MANTAP */
        @page { size: A4 landscape; margin: 10mm; }
        @media print { 
            body { padding: 0; margin: 0; background: white; }
            .no-print { display: none !important; }
            .document-page { box-shadow: none; border: none; width: 100%; max-width: none; margin: 0; padding: 10px; }
        }
        body { font-family: Arial, Helvetica, sans-serif; background-color: #f0f0f0; padding: 20px; }
        .document-page { background: white; width: 100%; max-width: 1300px; margin: 0 auto; padding: 15px; border: 1px solid #000; box-sizing: border-box; }
        .header-box { border: 2px solid black; margin-bottom: 10px; display: flex; height: 80px; }
        .logo-area { width: 15%; border-right: 2px solid black; padding: 8px; display: flex; align-items: center; justify-content: center; }
        .logo-area img { max-width: 100%; max-height: 100%; }
        .title-area { width: 55%; border-right: 2px solid black; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; text-transform: uppercase; text-align: center;}
        .meta-area { width: 30%; font-size: 11px; padding: 8px; line-height: 1.5; }
        .meta-info { display: flex; justify-content: space-between; margin: 15px 0; font-weight: bold; font-size: 13px; }
        .meta-info span { border-bottom: 1px solid black; min-width: 250px; display: inline-block; padding: 0 5px; }
        .table-official { width: 100%; border-collapse: collapse; font-size: 9pt; }
        .table-official th, .table-official td { border: 1px solid black; padding: 4px; text-align: center; vertical-align: middle; }
        .table-official th { background-color: #f0f0f0; font-weight: bold; }
        .col-no { width: 35px; }
        .col-item { width: 280px; text-align: left !important; padding-left: 8px !important; font-weight: bold; }
        .col-std { width: 200px; text-align: left !important; padding-left: 8px !important; font-size: 8.5pt; font-style: italic; }
        .col-date { width: 26px; font-size: 8.5pt; }
        .section-header { font-weight: bold; background-color: #e0e0e0 !important; }
        .paraf-row { height: 55px; }
        .sig-container { display: flex; justify-content: space-between; margin-top: 30px; font-size: 10pt; }
        .sig-left { width: 60%; }
        .sig-right { width: 30%; text-align: center; }
        .sig-box { border: 1px solid black; width: 200px; height: 70px; margin: 10px auto; display: flex; align-items: center; justify-content: center; }
        .sig-box img { max-height: 100%; max-width: 100%; object-fit: contain; }
        .sig-name { border-top: 1px solid black; width: 200px; margin: 0 auto; padding-top: 8px; font-weight: bold; text-transform: uppercase; }
        .signature-cell-img { height: 40px; width: auto; object-fit: contain; }
        .text-ng { color: red; font-weight: bold; }
        .no-print { margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; gap: 10px; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div class="no-print">
        <label>Mesin:</label>
        <select id="filter-mesin" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;"></select>
        <label>Bulan:</label>
        <select id="filter-bulan" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
            <option value="1">Januari</option><option value="2">Februari</option><option value="3">Maret</option>
            <option value="4">April</option><option value="5">Mei</option><option value="6">Juni</option>
            <option value="7">Juli</option><option value="8">Agustus</option><option value="9">September</option>
            <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
        </select>
        <button onclick="renderDashboard()" style="background: #007bff; color: white; border: none; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-weight: bold;">TAMPILKAN DATA</button>
        <button onclick="window.print()" style="background: #333; color: white; border: none; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-weight: bold;">PRINT / SAVE PDF</button>
    </div>

    <div class="document-page">
        <div class="header-box">
            <div class="logo-area">
                <img src="https://amarilyskg.co.id/bootstrap/img/logo.png" alt="Logo PT AKG">
            </div>
            <div class="title-area">
                CHECKLIST HARIAN STAND LABEL DAN ROBOT
            </div>
            <div class="meta-area">
                <div>No Dokumen : AF.SP 05.14.Rev-00</div>
                <div>Tanggal Terbit : 02 Agustus 2024</div>
                <div>Halaman : 1/1</div>
                <div>Tanggal Revisi : -</div>
            </div>
        </div>

        <div class="meta-info">
            <div>MERK MESIN : <span id="label-mesin">-</span></div>
            <div>BULAN : <span id="label-bulan">-</span></div>
        </div>

        <table class="table-official">
            <thead>
                <tr>
                    <th class="col-no" rowspan="2">No</th>
                    <th class="col-item" rowspan="2">Jenis pengecekan</th>
                    <th class="col-std" rowspan="2">Standard</th>
                    <th colspan="31">Tanggal</th>
                </tr>
                <tr id="date-header">
                    </tr>
            </thead>
            <tbody id="main-table-body">
                </tbody>
            <tfoot>
                <tr class="paraf-row">
                    <td colspan="3" style="text-align: right; font-weight: bold; padding-right: 15px;">Paraf Pelaksana</td>
                    <td colspan="31" id="row-paraf-pelaksana" style="padding: 0;">
                        <table style="width: 100%; height: 100%; border-collapse: collapse; border: none;">
                            <tr id="inner-paraf-pelaksana"></tr>
                        </table>
                    </td>
                </tr>
                <tr class="paraf-row">
                    <td colspan="3" style="text-align: right; font-weight: bold; padding-right: 15px;">Paraf Pengecek (Coord)</td>
                    <td colspan="31" id="paraf-koordinator-cell" style="text-align: left; padding-left: 20px;">
                        </td>
                </tr>
            </tfoot>
        </table>

        <div class="sig-container">
            <div class="sig-left">
                <strong>Beri tanda :</strong><br>
                √&nbsp;&nbsp;&nbsp; Bila item yang diperiksa baik, sesuai standar<br>
                x&nbsp;&nbsp;&nbsp; Bila terjadi penyimpangan / kerusakan pada item yang diperiksa.<br>
                o&nbsp;&nbsp;&nbsp; Bila mesin dalam proses perbaikan
            </div>
            <div class="sig-right">
                <p style="text-transform: uppercase; font-weight: bold; margin-bottom: 5px;">DIKETAHUI</p>
                <div class="sig-box" id="super-sig-box"></div>
                <div class="sig-name" id="super-name-label">( ........................ )</div>
                <p style="margin-top: 5px; font-size: 9pt;">MECHANIC SUPERINTENDENT</p>
            </div>
        </div>
    </div>

    <script>
        // KONFIGURASI SUPABASE
        const SB_URL = "https://dsyvlavphvrdidmodokd.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
        const _sb = supabase.createClient(SB_URL, SB_KEY);

        async function init() {
            // Load Daftar Mesin
            const { data: mesin } = await _sb.from('chslr_mesin').select('id');
            const selectMesin = document.getElementById('filter-mesin');
            mesin.forEach(m => selectMesin.innerHTML += `<option value="${m.id}">${m.id}</option>`);
            
            // Generate Header Tanggal 1-31
            const dateHeader = document.getElementById('date-header');
            for(let i=1; i<=31; i++) dateHeader.innerHTML += `<th class="col-date">${i}</th>`;

            // Set bulan sekarang
            document.getElementById('filter-bulan').value = new Date().getMonth() + 1;

            renderDashboard();
        }

        async function renderDashboard() {
            const m_id = document.getElementById('filter-mesin').value;
            const bln = document.getElementById('filter-bulan').value;
            const thn = new Date().getFullYear();

            document.getElementById('label-mesin').innerText = m_id;
            document.getElementById('label-bulan').innerText = document.getElementById('filter-bulan').options[bln-1].text + " " + thn;

            // 1. Ambil Data Log & Items
            const { data: log } = await _sb.from('chslr_log').select('*').eq('mesin_id', m_id).eq('bulan', bln).eq('tahun', thn).maybeSingle();
            const { data: items } = await _sb.from('chslr_items').select('*').order('sort_order');
            const { data: results } = log ? await _sb.from('chslr_result').select('*').eq('log_id', log.id) : { data: [] };

            // 2. Render Tabel Body
            const tbody = document.getElementById('main-table-body');
            tbody.innerHTML = "";

            items.forEach((item) => {
                let isHeader = !item.standard; // Jika tidak ada standard, berarti itu Section Header (1, 2, 3...)
                let row = `<tr>
                    <td>${item.sort_order.toString().includes('.') ? item.sort_order.split('.')[1] : item.sort_order}</td>
                    <td class="col-item ${isHeader ? 'section-header' : ''}">${item.item_name}</td>
                    <td class="col-std">${item.standard || ''}</td>`;
                
                for(let t=1; t<=31; t++) {
                    const find = results.find(r => r.item_id === item.id && r.tanggal === t);
                    let symbol = "";
                    let cls = "";
                    if(find) {
                        symbol = find.status === 'OK' ? '√' : 'X';
                        cls = find.status === 'NG' ? 'text-ng' : '';
                    }
                    row += `<td class="col-date ${cls}">${isHeader ? '' : symbol}</td>`;
                }
                tbody.innerHTML += row + `</tr>`;
            });

            // 3. Render Paraf Pelaksana (Bawah Tanggal)
            const innerParaf = document.getElementById('inner-paraf-pelaksana');
            innerParaf.innerHTML = "";
            for(let t=1; t<=31; t++) {
                const sig = results.find(r => r.tanggal === t && r.signature);
                innerParaf.innerHTML += `<td style="width: 26.5px; border-right: 1px solid black; border-bottom: none; height: 55px;">
                    ${sig ? `<img src="${sig.signature}" class="signature-cell-img">` : ''}
                </td>`;
            }

            // 4. Render Paraf Koordinator
            const coordCell = document.getElementById('paraf-koordinator-cell');
            if(log?.signature_koordinator) {
                coordCell.innerHTML = `<div style="display:flex; align-items:center; gap:10px;">
                    <img src="${log.signature_koordinator}" style="height:50px;">
                    <span style="font-weight:bold; text-decoration:underline;">${log.koordinator_nama}</span>
                </div>`;
            } else { coordCell.innerHTML = ""; }

            // 5. Render Superintendent (Kanan Bawah)
            const superBox = document.getElementById('super-sig-box');
            const superName = document.getElementById('super-name-label');
            if(log?.signature_superintendent) {
                superBox.innerHTML = `<img src="${log.signature_superintendent}">`;
                superName.innerText = log.superintendent_nama;
            } else {
                superBox.innerHTML = "";
                superName.innerText = "( ........................ )";
            }
        }

        window.onload = init;
    </script>
</body>
</html>
