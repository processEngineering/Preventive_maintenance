<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Result Dashboard - PT AKG</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .table-container { overflow-x: auto; background: white; border-radius: 1rem; }
        table { border-collapse: collapse; width: 100%; font-size: 10px; }
        th, td { border: 1px solid #e2e8f0; padding: 4px 2px; text-align: center; min-width: 25px; }
        th { background-color: #f8fafc; font-weight: 800; text-transform: uppercase; }
        .bg-ok { background-color: #22c55e; color: white; }
        .bg-ng { background-color: #ef4444; color: white; }
        .sticky-col { position: sticky; left: 0; background: white; z-index: 10; min-width: 150px; text-align: left; padding-left: 10px; }
        .sig-box { width: 80px; height: 40px; object-fit: contain; margin: auto; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4">

    <div class="max-w-7xl mx-auto">
        <div class="bg-white p-6 rounded-3xl shadow-sm mb-6 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="font-black italic text-2xl text-slate-800">CHECKLIST HARIAN RESULT</h1>
                <p class="text-slate-500 text-xs font-bold uppercase tracking-widest">PT AKG - Stand Label & Robot</p>
            </div>
            <div class="flex gap-2">
                <select id="filter-mesin" class="bg-slate-50 border p-2 rounded-xl font-bold text-xs"></select>
                <select id="filter-bulan" class="bg-slate-50 border p-2 rounded-xl font-bold text-xs">
                    <option value="1">Januari</option><option value="2">Februari</option><option value="3">Maret</option>
                    <option value="4">April</option><option value="5">Mei</option><option value="6">Juni</option>
                    <option value="7">Juli</option><option value="8">Agustus</option><option value="9">September</option>
                    <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                </select>
                <button onclick="renderDashboard()" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-black text-xs uppercase hover:bg-blue-700">Filter</button>
            </div>
        </div>

        <div class="table-container shadow-2xl">
            <table id="result-table">
                <thead>
                    <tr id="header-row">
                        <th class="sticky-col">Jenis Pengecekan / Tanggal</th>
                        </tr>
                </thead>
                <tbody id="table-body">
                    </tbody>
                <tfoot id="table-foot">
                    </tfoot>
            </table>
        </div>
    </div>

    <script>
        const SB_URL = "https://dsyvlavphvrdidmodokd.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
        const _sb = supabase.createClient(SB_URL, SB_KEY);

        async function init() {
            // Load Daftar Mesin
            const { data: mesin } = await _sb.from('chslr_mesin').select('id');
            const selectMesin = document.getElementById('filter-mesin');
            mesin.forEach(m => selectMesin.innerHTML += `<option value="${m.id}">${m.id}</option>`);
            
            // Set Bulan Sekarang
            document.getElementById('filter-bulan').value = new Date().getMonth() + 1;
            
            // Generate Header Tanggal
            const headerRow = document.getElementById('header-row');
            for(let i=1; i<=31; i++) headerRow.innerHTML += `<th>${i}</th>`;
            
            renderDashboard();
        }

        async function renderDashboard() {
            const m_id = document.getElementById('filter-mesin').value;
            const bln = document.getElementById('filter-bulan').value;
            const thn = new Date().getFullYear();

            // 1. Ambil Log & Result
            const { data: log } = await _sb.from('chslr_log').select('*').eq('mesin_id', m_id).eq('bulan', bln).eq('tahun', thn).maybeSingle();
            const { data: items } = await _sb.from('chslr_items').select('*').order('sort_order');
            
            let results = [];
            if(log) {
                const { data: res } = await _sb.from('chslr_result').select('*').eq('log_id', log.id);
                results = res || [];
            }

            // 2. Render Rows
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = "";

            items.forEach(item => {
                let rowHtml = `<tr><td class="sticky-col font-bold">${item.item_name}</td>`;
                for(let tgl=1; tgl<=31; tgl++) {
                    const find = results.find(r => r.item_id === item.id && r.tanggal === tgl);
                    let display = "";
                    let bgColor = "";
                    if(find) {
                        display = find.status === 'OK' ? 'âˆš' : 'X';
                        bgColor = find.status === 'OK' ? 'bg-ok' : 'bg-ng';
                    }
                    rowHtml += `<td class="${bgColor}">${display}</td>`;
                }
                rowHtml += `</tr>`;
                tbody.innerHTML += rowHtml;
            });

            // 3. Render Footer (Tanda Tangan/Paraf)
            renderFooter(log, results);
        }

        function renderFooter(log, results) {
            const tfoot = document.getElementById('table-foot');
            tfoot.innerHTML = "";
            
            if(!log) return;

            // Row Paraf Pelaksana (Diambil dari Result per tanggal)
            let rowPelaksana = `<tr><td class="sticky-col font-bold bg-slate-50">Paraf Pelaksana</td>`;
            for(let tgl=1; tgl<=31; tgl++) {
                const dayRes = results.find(r => r.tanggal === tgl && r.signature);
                rowPelaksana += `<td>${dayRes ? `<img src="${dayRes.signature}" class="sig-box">` : ''}</td>`;
            }
            tfoot.innerHTML += rowPelaksana;

            // Row Paraf Koordinator & Superintendent
            tfoot.innerHTML += `
                <tr class="bg-slate-100">
                    <td class="sticky-col font-black">Pengecek (Coord)</td>
                    <td colspan="31" class="text-left p-2">
                        ${log.signature_koordinator ? `<div class="flex items-center gap-4"><img src="${log.signature_koordinator}" class="sig-box"> <span class="font-bold underline">${log.koordinator_nama}</span></div>` : '<span class="text-slate-400 italic">Belum Diverifikasi</span>'}
                    </td>
                </tr>
                <tr class="bg-slate-200">
                    <td class="sticky-col font-black">Diketahui (Super)</td>
                    <td colspan="31" class="text-left p-2">
                        ${log.signature_superintendent ? `<div class="flex items-center gap-4"><img src="${log.signature_superintendent}" class="sig-box"> <span class="font-bold underline">${log.superintendent_nama}</span></div>` : '<span class="text-slate-400 italic">Belum Disetujui Final</span>'}
                    </td>
                </tr>
            `;
        }

        window.onload = init;
    </script>
</body>
</html>
