<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REPORT CHECKLIST HARIAN - PT AKG</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* SETTING HALAMAN CETAK (A4 LANDSCAPE) */
        @page { 
            size: A4 landscape; 
            margin: 10mm; 
        }

        body { 
            font-family: 'Arial Narrow', Arial, sans-serif; 
            background-color: #525659; 
            margin: 0; 
            padding: 20px; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* TAMPILAN DOKUMEN KERTAS */
        .document-page { 
            background: white; 
            width: 297mm; /* Lebar A4 Landscape */
            min-height: 210mm; /* Tinggi A4 Landscape */
            padding: 10mm; 
            box-sizing: border-box; 
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        /* HEADER BOX */
        .header-table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid black;
            margin-bottom: 5px;
        }
        .header-table td {
            border: 1px solid black;
            vertical-align: middle;
            padding: 5px;
        }
        .logo-col { width: 15%; text-align: center; }
        .logo-col img { max-width: 80px; height: auto; }
        
        .title-col { 
            width: 60%; 
            text-align: center; 
            font-weight: bold; 
            font-size: 18pt; 
            text-transform: uppercase; 
        }
        
        .meta-col { width: 25%; font-size: 9pt; line-height: 1.3; }

        /* INFO MESIN & BULAN */
        .info-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 11pt;
            border: 1px solid black;
            padding: 5px;
            background: #f0f0f0;
        }

        /* TABEL UTAMA */
        .main-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 8pt;
            table-layout: fixed; /* Agar kolom tanggal sama rata */
        }
        
        .main-table th, .main-table td {
            border: 1px solid black;
            padding: 2px;
            text-align: center;
            vertical-align: middle;
            height: 18px; /* Tinggi baris minimum */
            overflow: hidden;
        }

        .main-table th {
            background-color: #d9d9d9;
            font-weight: bold;
            text-transform: uppercase;
        }

        /* LEBAR KOLOM KHUSUS */
        .col-no { width: 25px; }
        .col-check { width: 200px; text-align: left !important; padding-left: 5px !important; }
        .col-std { width: 150px; text-align: left !important; padding-left: 5px !important; font-style: italic; }
        /* Kolom tanggal otomatis dibagi rata sisanya */

        /* STYLE HEADER KATEGORI (MISAL: I. SAFETY) */
        .section-header {
            background-color: #eeeeee;
            font-weight: bold;
            text-align: left !important;
            padding-left: 10px !important;
        }

        /* STYLE HASIL OK/NG */
        .res-ok { font-weight: bold; color: black; font-family: 'Wingdings 2', sans-serif; } /* Bisa ganti font checklist */
        .res-ng { font-weight: bold; color: red; }

        /* TANDA TANGAN DI TABEL */
        .sig-row td { height: 40px; }
        .sig-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            mix-blend-mode: multiply;
        }

        /* FOOTER KETERANGAN & SUPERINTENDENT */
        .footer-section {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            border: 1px solid black;
            padding: 5px;
        }
        .legend {
            font-size: 8pt;
            width: 70%;
        }
        .approval-box {
            width: 25%;
            text-align: center;
            font-size: 9pt;
        }
        .sig-box {
            height: 70px;
            border-bottom: 1px solid black;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sig-box img {
            max-height: 65px;
            max-width: 100%;
        }

        /* LAYOUT CETAK (HILANGKAN TOMBOL) */
        @media print {
            body { background: white; padding: 0; }
            .no-print { display: none !important; }
            .document-page { 
                width: 100%; height: 100%; 
                box-shadow: none; margin: 0; padding: 0;
            }
            /* Paksa background color tercetak */
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }

        /* MENU NAVIGASI (LAYAR SAJA) */
        .no-print {
            position: fixed; top: 20px; z-index: 999;
            background: #333; padding: 15px; border-radius: 8px;
            display: flex; gap: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        select, button {
            padding: 8px 12px; border-radius: 4px; border: none; font-weight: bold; cursor: pointer;
        }
        button.print { background: #ffc107; color: #000; }
        button.load { background: #0d6efd; color: white; }
    </style>
</head>
<body>

    <div class="no-print">
        <select id="filter-mesin" style="min-width: 150px;"></select>
        <select id="filter-bulan">
            <option value="1">JANUARI</option><option value="2">FEBRUARI</option>
            <option value="3">MARET</option><option value="4">APRIL</option>
            <option value="5">MEI</option><option value="6">JUNI</option>
            <option value="7">JULI</option><option value="8">AGUSTUS</option>
            <option value="9">SEPTEMBER</option><option value="10">OKTOBER</option>
            <option value="11">NOVEMBER</option><option value="12">DESEMBER</option>
        </select>
        <select id="filter-tahun">
            <option value="2025">2025</option>
            <option value="2026">2026</option>
            <option value="2027">2027</option>
        </select>
        <button onclick="renderReport()" class="load">TAMPILKAN DATA</button>
        <button onclick="window.print()" class="print">üñ®Ô∏è CETAK PDF</button>
    </div>

    <div class="document-page">
        
        <table class="header-table">
            <tr>
                <td class="logo-col">
                    <img src="https://via.placeholder.com/100x50?text=LOGO+AKG" alt="LOGO"> 
                </td>
                <td class="title-col">
                    CHECKLIST HARIAN STAND LABEL DAN ROBOT
                </td>
                <td class="meta-col">
                    No. Dokumen : AF.SP 05.14.Rev-00<br>
                    Tgl. Terbit : 02 Agustus 2024<br>
                    Halaman : 1 dari 1<br>
                    Revisi : -
                </td>
            </tr>
        </table>

        <div class="info-bar">
            <span>NAMA MESIN : <span id="disp-mesin">...</span></span>
            <span>PERIODE : <span id="disp-periode">...</span></span>
        </div>

        <table class="main-table">
            <thead>
                <tr>
                    <th rowspan="2" class="col-no">NO</th>
                    <th rowspan="2" class="col-check">JENIS PENGECEKAN</th>
                    <th rowspan="2" class="col-std">STANDARD</th>
                    <th colspan="31">TANGGAL</th>
                </tr>
                <tr id="header-dates">
                    </tr>
            </thead>
            <tbody id="report-body">
                </tbody>
            <tbody id="signature-body">
                <tr class="sig-row" id="row-paraf-pelaksana">
                    <td colspan="3" style="text-align: right; padding-right: 10px; font-weight: bold;">Paraf Pelaksana</td>
                    </tr>
                <tr class="sig-row" id="row-paraf-koordinator">
                    <td colspan="3" style="text-align: right; padding-right: 10px; font-weight: bold;">Paraf Koordinator</td>
                    </tr>
            </tbody>
        </table>

        <div class="footer-section">
            <div class="legend">
                <strong>KETERANGAN:</strong><br>
                ‚àö : Kondisi Baik / Normal<br>
                X : Kondisi Rusak / Abnormal (NG)<br>
                O : Dalam Perbaikan<br>
                <i>Catatan: Segera laporkan ke atasan jika ditemukan ketidaksesuaian.</i>
            </div>
            <div class="approval-box">
                <div style="font-weight: bold; margin-bottom: 5px;">DIKETAHUI OLEH</div>
                <div class="sig-box" id="super-sig-container">
                    </div>
                <div style="font-weight: bold; text-decoration: underline;" id="super-name-disp">( ................................... )</div>
                <div>Superintendent</div>
            </div>
        </div>

    </div>

    <script>
        const SB_URL = "https://dsyvlavphvrdidmodokd.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
        const _sb = supabase.createClient(SB_URL, SB_KEY);

        // --- INIT ---
        window.onload = async function() {
            // Generate Tanggal Header 1-31
            const dateRow = document.getElementById('header-dates');
            for(let i=1; i<=31; i++) {
                const th = document.createElement('th');
                th.innerText = i;
                dateRow.appendChild(th);
            }

            // Load Mesin ke Dropdown
            const { data: mesin } = await _sb.from('chslr_mesin').select('nama_mesin').order('nama_mesin');
            const selMesin = document.getElementById('filter-mesin');
            if(mesin) {
                mesin.forEach(m => {
                    selMesin.innerHTML += `<option value="${m.nama_mesin}">${m.nama_mesin}</option>`;
                });
            }

            // Set Default (Bulan Ini)
            const now = new Date();
            document.getElementById('filter-bulan').value = now.getMonth() + 1;
            document.getElementById('filter-tahun').value = now.getFullYear();

            // Auto Load
            renderReport();
        }

        // --- RENDER LOGIC ---
        async function renderReport() {
            const m_name = document.getElementById('filter-mesin').value;
            const bln = document.getElementById('filter-bulan').value;
            const thn = document.getElementById('filter-tahun').value;
            const blnText = document.getElementById('filter-bulan').options[document.getElementById('filter-bulan').selectedIndex].text;

            // Update Info Bar
            document.getElementById('disp-mesin').innerText = m_name || "PILIH MESIN";
            document.getElementById('disp-periode').innerText = `${blnText} ${thn}`;

            if(!m_name) return;

            // 1. Ambil Data Header (LOG)
            const { data: log } = await _sb.from('chslr_log')
                .select('*')
                .eq('mesin_id', m_name)
                .eq('bulan', bln)
                .eq('tahun', thn)
                .maybeSingle();

            // 2. Ambil List Item Pengecekan
            const { data: items } = await _sb.from('chslr_items')
                .select('*')
                .order('sort_order', { ascending: true });

            // 3. Ambil Result Detail (Jika Log ada)
            let results = [];
            if(log) {
                const resQ = await _sb.from('chslr_result').select('*').eq('log_id', log.id);
                results = resQ.data || [];
            }

            const tbody = document.getElementById('report-body');
            tbody.innerHTML = "";

            // --- RENDER ITEMS ---
            if(items) {
                items.forEach(item => {
                    const tr = document.createElement('tr');
                    
                    // Cek apakah ini Header Bagian (Misal: I. SAFETY) - Biasanya tidak punya standar
                    const isHeaderSection = !item.standard || item.standard.trim() === ""; 

                    // Kolom No, Item, Standard
                    tr.innerHTML = `
                        <td>${item.sort_order}</td>
                        <td class="col-check ${isHeaderSection ? 'section-header' : ''}">${item.item_name}</td>
                        <td class="col-std">${item.standard || ''}</td>
                    `;

                    // Kolom Tanggal 1-31
                    for(let i=1; i<=31; i++) {
                        const td = document.createElement('td');
                        
                        if(isHeaderSection) {
                            td.style.backgroundColor = "#eeeeee"; // Arsir header
                        } else {
                            // Cari data result utk item ini di tanggal i
                            const dataHariIni = results.find(r => r.item_id === item.id && r.tanggal === i);
                            
                            if(dataHariIni) {
                                if(dataHariIni.status === 'OK') {
                                    td.innerText = "‚àö";
                                    td.className = "res-ok";
                                } else if(dataHariIni.status === 'NG') {
                                    td.innerText = "X";
                                    td.className = "res-ng";
                                }
                            }
                        }
                        tr.appendChild(td);
                    }
                    tbody.appendChild(tr);
                });
            }

            // --- RENDER PARAF PELAKSANA (Footer Table) ---
            const rowPel = document.getElementById('row-paraf-pelaksana');
            // Hapus kolom lama (sisakan header row)
            while(rowPel.cells.length > 1) rowPel.deleteCell(1);

            for(let i=1; i<=31; i++) {
                const td = document.createElement('td');
                // Cari apakah ada data APAPUN di tanggal ini
                const hasData = results.some(r => r.tanggal === i);
                
                if(hasData) {
                    // Cari signature di salah satu record hari itu
                    const recordWithSig = results.find(r => r.tanggal === i && r.signature);
                    if(recordWithSig) {
                        td.innerHTML = `<img src="${recordWithSig.signature}" class="sig-img">`;
                    } else {
                        td.innerText = "‚àö"; // Tanda sudah dikerjakan tapi ttd tdk tersimpan per baris
                    }
                }
                rowPel.appendChild(td);
            }

            // --- RENDER PARAF KOORDINATOR (Footer Table) ---
            const rowKoor = document.getElementById('row-paraf-koordinator');
            while(rowKoor.cells.length > 1) rowKoor.deleteCell(1);

            const isVerified = log ? log.status_verifikasi : false;
            const koorSig = log ? log.signature_koordinator : null;

            for(let i=1; i<=31; i++) {
                const td = document.createElement('td');
                // Koordinator paraf jika log verified DAN hari itu ada kegiatan
                const hasActivity = results.some(r => r.tanggal === i);
                
                if(isVerified && hasActivity && koorSig) {
                    td.innerHTML = `<img src="${koorSig}" class="sig-img">`;
                }
                rowKoor.appendChild(td);
            }

            // --- SUPERINTENDENT (Pojok Kanan Bawah) ---
            const superContainer = document.getElementById('super-sig-container');
            const superNameLabel = document.getElementById('super-name-disp');

            if(log && log.status_final && log.signature_superintendent) {
                superContainer.innerHTML = `<img src="${log.signature_superintendent}">`;
                superNameLabel.innerText = `( ${log.superintendent_nama.toUpperCase()} )`;
            } else {
                superContainer.innerHTML = "";
                superNameLabel.innerText = "( ................................... )";
            }
        }
    </script>
</body>
</html>
