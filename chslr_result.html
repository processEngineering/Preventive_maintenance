<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AF.SP 05.14.Rev-00 - REPORT</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* === GLOBAL RESET === */
        * { box-sizing: border-box; }
        
        body {
            margin: 0; padding: 0;
            background: #ccc;
            font-family: Arial, sans-serif;
            font-size: 8pt;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        /* === TAMPILAN LAYAR (PREVIEW) === */
        .sheet {
            background: white;
            width: 297mm; /* Lebar A4 Landscape */
            min-height: 210mm; /* Tinggi A4 Landscape */
            margin: 20px auto;
            padding: 5mm 10mm;
            position: relative;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        /* === KONFIGURASI CETAK/PDF (ENGINE GOOGLE CHROME) === */
        @media print {
            /* 1. Paksa Kertas A4 Landscape Tanpa Margin Browser */
            @page {
                size: A4 landscape;
                margin: 0 !important; 
            }

            /* 2. Kunci Body & HTML agar tidak boleh lebih dari 1 halaman */
            html, body {
                width: 297mm;
                height: 210mm;
                margin: 0 !important;
                padding: 0 !important;
                overflow: hidden !important; /* POTONG sisa hantu halaman 2 */
                background: white;
            }

            /* 3. Sembunyikan tombol kontrol */
            .no-print { display: none !important; }

            /* 4. STRATEGI ABSOLUTE FIT */
            .sheet {
                margin: 0 !important;
                padding: 5mm 8mm !important; /* Padding cetak aman */
                border: none;
                box-shadow: none;
                
                /* Cabut dari flow agar tidak mendorong halaman baru */
                position: absolute;
                top: 0;
                left: 0;
                
                /* TEKNIK SCALING PASTI MUAT */
                /* Scale 0.72 adalah titik manis (Sweet Spot) untuk tabel padat */
                transform: scale(0.72); 
                transform-origin: top left; /* Titik nol di kiri atas */
                
                /* KOMPENSASI LEBAR: Karena di-scale down, container harus dilebarkan 
                   Rumus: 100% / 0.72 = 138.8% */
                width: 138.8%; 
                
                /* Pastikan background putih tercetak */
                background-color: white !important;
            }
        }

        /* === UTILS (Tabel & Garis) === */
        table { border-collapse: collapse; width: 100%; }
        td, th { border: 1px solid black; padding: 2px 4px; vertical-align: middle; }
        .no-border { border: none !important; }
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        .font-bold { font-weight: bold; }
        .uppercase { text-transform: uppercase; }

        /* === HEADER SECTION === */
        .header-table { margin-bottom: 5px; border: 2px solid black; }
        .logo-cell { width: 100px; text-align: center; border-right: 1px solid black; }
        .title-cell { font-size: 14pt; text-align: center; border-right: 1px solid black; width: 50%; }
        .meta-cell { font-size: 7.5pt; width: 25%; padding: 0; }
        .meta-table td { border: none; padding: 1px 4px; }

        /* === INFO SECTION === */
        .info-table { margin-bottom: 5px; border: none; }
        .info-table td { border: none; padding: 1px; font-weight: bold; font-size: 9pt; }
        .dots { border-bottom: 1px dotted black; display: inline-block; min-width: 150px; padding-left: 5px; }

        /* === MAIN CHECKLIST TABLE === */
        .main-table { border: 2px solid black; table-layout: fixed; }
        .main-table th { background-color: #f2f2f2; height: 25px; font-size: 8pt; text-align: center; }
        .main-table td { height: 16px; font-size: 7.5pt; padding: 0 2px; }

        /* Column Widths (Dioptimalkan) */
        .col-no { width: 25px; }
        .col-jenis { width: 200px; text-align: left !important; padding-left: 5px !important; }
        .col-std { width: 140px; text-align: left !important; padding-left: 5px !important; font-style: italic; font-size: 7pt; }
        .col-date { width: 17px; font-size: 7pt; text-align: center; }

        /* Special Rows */
        .cat-row { background-color: #bfbfbf; font-weight: bold; text-align: left !important; padding-left: 5px !important; }
        .sig-row td { height: 35px; vertical-align: middle; }
        
        .sig-img { width: 100%; height: 30px; object-fit: contain; mix-blend-mode: multiply; display: block; margin: 0 auto; }
        .ng-text { color: red; font-weight: bold; }
        .ok-text { font-family: sans-serif; font-weight: bold; }

        /* === FOOTER SECTION === */
        .footer-container { display: flex; justify-content: space-between; margin-top: 10px; }
        
        .legend-box { width: 60%; font-size: 8pt; }
        .legend-table td { border: none; padding: 1px; vertical-align: top; }
        
        .approval-box { width: 220px; text-align: center; font-weight: bold; font-size: 9pt; }
        .sig-box { border: 1px solid black; height: 65px; width: 100%; margin: 2px 0; display: flex; align-items: center; justify-content: center; }
        .super-img { max-height: 60px; max-width: 90%; mix-blend-mode: multiply; }

        /* CONTROLS (TOMBOL) */
        .no-print { 
            position: fixed; top: 10px; left: 50%; transform: translateX(-50%); 
            background: #222; padding: 10px; border-radius: 8px; color: white; 
            display: flex; gap: 10px; z-index: 9999; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        select, button { padding: 5px 10px; cursor: pointer; font-weight: bold; }
        button { background: #ffc107; border: none; border-radius: 4px; }
        button:hover { background: #e0a800; }
    </style>
</head>
<body>

    <div class="no-print">
        <select id="f-mesin"></select>
        <select id="f-bulan">
            <option value="1">Januari</option><option value="2">Februari</option><option value="3">Maret</option>
            <option value="4">April</option><option value="5">Mei</option><option value="6">Juni</option>
            <option value="7">Juli</option><option value="8">Agustus</option><option value="9">September</option>
            <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
        </select>
        <select id="f-tahun"><option value="2026">2026</option><option value="2027">2027</option></select>
        <button onclick="loadData()">TAMPILKAN</button>
        <button onclick="window.print()">EKSPOR PDF</button>
    </div>

    <div class="sheet">
        <table class="header-table">
            <tr>
                <td class="logo-cell">
                    <img src="https://amarilyskg.co.id/bootstrap/img/logo.png" style="width: 80px;">
                </td>
                <td class="title-cell font-bold">
                    CHECKLIST HARIAN STAND LABEL DAN ROBOT
                </td>
                <td class="meta-cell">
                    <table class="meta-table">
                        <tr><td>No Dokumen</td><td>: AF.SP 05.14.Rev-00</td></tr>
                        <tr><td>Tanggal Terbit</td><td>: 02 Agustus 2024</td></tr>
                        <tr><td>Halaman</td><td>: 1/1</td></tr>
                        <tr><td>Tanggal Revisi</td><td>: -</td></tr>
                    </table>
                </td>
            </tr>
        </table>

        <table class="info-table">
            <tr>
                <td width="100">MERK MESIN</td>
                <td width="10">:</td>
                <td width="300"><span id="txt-mesin" class="dots"></span></td>
                <td class="text-right">BULAN :</td>
                <td width="150"><span id="txt-bulan" class="dots"></span></td>
            </tr>
            <tr>
                <td>TONAGE</td>
                <td>:</td>
                <td><span id="txt-ton" class="dots"></span></td>
                <td colspan="2"></td>
            </tr>
        </table>

        <table class="main-table">
            <thead>
                <tr>
                    <th rowspan="2" class="col-no">No</th>
                    <th rowspan="2" class="col-jenis">Jenis pengecekan</th>
                    <th rowspan="2" class="col-std">Standard</th>
                    <th colspan="31">Tanggal</th>
                </tr>
                <tr id="date-row"></tr>
            </thead>
            <tbody id="table-body"></tbody>
            <tbody>
                <tr class="sig-row" id="row-pel">
                    <td colspan="3" class="text-right font-bold" style="padding-right: 10px;">Paraf Pelaksana</td>
                </tr>
                <tr class="sig-row" id="row-cek">
                    <td colspan="3" class="text-right font-bold" style="padding-right: 10px;">Paraf Pengecek</td>
                </tr>
            </tbody>
        </table>

        <div class="footer-container">
            <div class="legend-box">
                <table class="legend-table">
                    <tr><td colspan="2" class="font-bold" style="text-decoration: underline;">Beri tanda :</td></tr>
                    <tr><td width="20" class="text-center">√</td><td>Bila item yang diperiksa baik, sesuai standar</td></tr>
                    <tr><td class="text-center">x</td><td>Bila terjadi penyimpangan / kerusakan pada item yang diperiksa.</td></tr>
                    <tr><td class="text-center">o</td><td>Bila mesin dalam proses perbaikan</td></tr>
                </table>
            </div>

            <div class="approval-box">
                <div style="margin-bottom: 2px;">DIKETAHUI</div>
                <div class="sig-box" id="super-sig-box"></div>
                <div id="super-name-txt" style="text-transform: uppercase; border-top: 1px solid black; display: inline-block; width: 90%; padding-top: 2px;">( ........................ )</div>
                <div style="font-size: 8pt; margin-top: 2px;">MECHANIC SUPERINTENDENT</div>
            </div>
        </div>

    </div>

    <script>
        const SB_URL = "https://dsyvlavphvrdidmodokd.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
        const _sb = supabase.createClient(SB_URL, SB_KEY);

        async function init() {
            const dr = document.getElementById('date-row');
            for(let i=1; i<=31; i++) dr.innerHTML += `<th class="col-date">${i}</th>`;

            const { data } = await _sb.from('chslr_mesin').select('nama_mesin');
            const sel = document.getElementById('f-mesin');
            data?.forEach(d => sel.innerHTML += `<option>${d.nama_mesin}</option>`);

            // Default Date
            document.getElementById('f-bulan').value = 1; 
            document.getElementById('f-tahun').value = 2026;
            loadData();
        }

        async function loadData() {
            const m = document.getElementById('f-mesin').value;
            const b = document.getElementById('f-bulan').value;
            const t = document.getElementById('f-tahun').value;

            document.getElementById('txt-mesin').innerText = m;
            document.getElementById('txt-bulan').innerText = document.getElementById('f-bulan').options[b-1].text.toUpperCase() + " " + t;
            
            const { data: mData } = await _sb.from('chslr_mesin').select('tonage').eq('nama_mesin', m).single();
            document.getElementById('txt-ton').innerText = mData?.tonage || '-';

            const { data: log } = await _sb.from('chslr_log').select('*').eq('mesin_id', m).eq('bulan', b).eq('tahun', t).maybeSingle();
            const { data: items } = await _sb.from('chslr_items').select('*').order('sort_order');
            const { data: res } = log ? await _sb.from('chslr_result').select('*').eq('log_id', log.id) : { data: [] };

            const tbody = document.getElementById('table-body');
            tbody.innerHTML = "";
            let curCat = "", rowNum = 1, subIdx = 0;
            const abjad = "abcdefghijklmnopqrstuvwxyz";

            items.forEach(item => {
                if(item.kategori !== curCat) {
                    curCat = item.kategori;
                    subIdx = 0;
                    tbody.innerHTML += `
                        <tr class="cat-row">
                            <td class="text-center">${rowNum}</td>
                            <td colspan="32" class="uppercase">${curCat}</td>
                        </tr>`;
                    rowNum++;
                }

                let html = `<tr>
                    <td class="text-center">${abjad[subIdx] || '-'}</td>
                    <td class="col-jenis">${item.item_name}</td>
                    <td class="col-std">${item.standard || ''}</td>`;
                
                for(let d=1; d<=31; d++) {
                    const r = res.find(x => x.item_id === item.id && x.tanggal === d);
                    let val = "";
                    if(r) val = r.status === 'OK' ? '<span class="ok-text">√</span>' : '<span class="ng-text">x</span>';
                    html += `<td class="col-date">${val}</td>`;
                }
                html += `</tr>`;
                tbody.innerHTML += html;
                subIdx++;
            });

            // Signatures Logic
            const rPel = document.getElementById('row-pel');
            const rCek = document.getElementById('row-cek');
            while(rPel.cells.length > 1) rPel.deleteCell(1);
            while(rCek.cells.length > 1) rCek.deleteCell(1);

            for(let d=1; d<=31; d++) {
                const dayRes = res.filter(x => x.tanggal === d && x.signature);
                let cellPel = rPel.insertCell();
                cellPel.className = "col-date";
                if(dayRes.length > 0) cellPel.innerHTML = `<img src="${dayRes[0].signature}" class="sig-img">`;

                const hasData = res.some(x => x.tanggal === d);
                let cellCek = rCek.insertCell();
                cellCek.className = "col-date";
                if(log?.status_verifikasi && log?.signature_koordinator && hasData) {
                    cellCek.innerHTML = `<img src="${log.signature_koordinator}" class="sig-img">`;
                }
            }

            const supBox = document.getElementById('super-sig-box');
            const supName = document.getElementById('super-name-txt');
            if(log?.status_final && log?.signature_superintendent) {
                supBox.innerHTML = `<img src="${log.signature_superintendent}" class="super-img">`;
                supName.innerText = `( ${log.superintendent_nama || '........................'} )`;
            } else {
                supBox.innerHTML = "";
                supName.innerText = "( ........................ )";
            }
        }

        window.onload = init;
    </script>
</body>
</html>
