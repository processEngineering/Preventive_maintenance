<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHECKLIST HARIAN STAND LABEL DAN ROBOT</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* === PAGE SETUP (A4 LANDSCAPE) === */
        @page { size: A4 landscape; margin: 5mm; }
        
        body { 
            font-family: Arial, Helvetica, sans-serif; 
            font-size: 9pt; 
            margin: 0; padding: 10px; 
            background: #ccc; /* Background abu di mode web */
        }
        
        .sheet {
            background: white;
            width: 297mm; /* Lebar A4 Landscape */
            min-height: 210mm;
            margin: 0 auto;
            padding: 10mm;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            box-sizing: border-box;
            position: relative;
        }

        /* === HEADER SECTION === */
        .header-table { width: 100%; border-collapse: collapse; margin-bottom: 5px; border: 2px solid black; }
        .header-table td { border: 1px solid black; padding: 5px; vertical-align: middle; }
        
        .title-cell { text-align: center; font-weight: bold; font-size: 14pt; text-transform: uppercase; width: 50%; }
        .doc-info { font-size: 8pt; width: 25%; }
        .doc-info table { width: 100%; border: none; }
        .doc-info td { border: none; padding: 1px; }

        /* === MACHINE INFO SECTION === */
        .info-section { 
            width: 100%; margin-bottom: 5px; font-weight: bold; font-size: 10pt; 
            display: flex; justify-content: space-between; align-items: flex-end;
        }
        .info-left { display: flex; flex-direction: column; gap: 5px; }
        .info-right { text-align: right; padding-right: 50px; }

        /* === MAIN CHECKLIST TABLE === */
        .main-table { 
            width: 100%; border-collapse: collapse; border: 2px solid black; 
            table-layout: fixed; /* Kunci lebar kolom */
        }
        .main-table th, .main-table td { 
            border: 1px solid black; 
            padding: 2px; 
            font-size: 7.5pt; 
            text-align: center;
            vertical-align: middle;
            height: 16px; /* Tinggi baris Excel */
        }
        
        .main-table th { background-color: #f0f0f0; font-weight: bold; }

        /* Column Widths (Adjusted to fit 31 days) */
        .col-no { width: 25px; }
        .col-jenis { width: 220px; text-align: left !important; padding-left: 5px !important; }
        .col-std { width: 130px; text-align: left !important; padding-left: 5px !important; }
        .col-tgl { width: 18px; font-size: 7pt; }

        /* Styling Item Rows */
        .category-row { 
            background-color: #ddd; font-weight: bold; text-align: left !important; padding-left: 5px !important; 
        }
        .item-text { text-align: left !important; padding-left: 5px !important; }
        .std-text { text-align: left !important; padding-left: 5px !important; }
        
        /* Checkmarks */
        .ok-mark { font-family: 'Deja Vu Sans', sans-serif; font-size: 9pt; }
        .ng-mark { color: red; font-weight: bold; font-size: 9pt; }
        
        /* Signatures in Table */
        .sig-img { 
            width: 100%; height: 35px; object-fit: contain; 
            mix-blend-mode: multiply; display: block;
        }

        /* === FOOTER SECTION === */
        .footer-section { 
            display: flex; justify-content: space-between; margin-top: 10px; 
            font-size: 9pt; 
        }
        
        .legend-box { width: 60%; }
        .legend-table { border: none; width: 100%; }
        .legend-table td { border: none; padding: 2px; vertical-align: top; }
        
        .approval-box { 
            width: 250px; text-align: center; margin-right: 20px;
        }
        .approval-title { font-weight: bold; margin-bottom: 5px; }
        .sig-box-super { 
            border: 1px solid black; height: 70px; width: 100%; 
            margin-bottom: 5px; position: relative;
            display: flex; align-items: center; justify-content: center;
        }
        .super-img { max-height: 60px; max-width: 90%; mix-blend-mode: multiply; }

        /* === UI CONTROLS (HIDDEN ON PRINT) === */
        @media print {
            body { background: white; margin: 0; padding: 0; }
            .sheet { margin: 0; box-shadow: none; width: 100%; padding: 0; border: none; }
            .no-print { display: none !important; }
        }
        
        .no-print {
            position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
            background: #333; padding: 10px 20px; border-radius: 8px; color: white;
            display: flex; gap: 10px; z-index: 999; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        select, button { padding: 5px 10px; border-radius: 4px; border: none; font-weight: bold; cursor: pointer; }
        .btn-blue { background: #3b82f6; color: white; }
    </style>
</head>
<body>

    <div class="no-print">
        <select id="f-mesin"></select>
        <select id="f-bulan">
            <option value="1">Januari</option><option value="2">Februari</option><option value="3">Maret</option>
            <option value="4">April</option><option value="5">Mei</option><option value="6">Juni</option>
            <option value="7">Juli</option><option value="8">Agustus</option><option value="9">September</option>
            <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
        </select>
        <select id="f-tahun">
            <option value="2026">2026</option><option value="2027">2027</option>
        </select>
        <button class="btn-blue" onclick="loadReport()">TAMPILKAN DATA</button>
        <button onclick="window.print()">üñ®Ô∏è PRINT</button>
    </div>

    <div class="sheet">
        
        <table class="header-table">
            <tr>
                <td style="width: 15%; text-align: center;">
                    <img src="https://amarilyskg.co.id/bootstrap/img/logo.png" style="width: 100px;">
                </td>
                <td class="title-cell">CHECKLIST HARIAN STAND LABEL DAN ROBOT</td>
                <td class="doc-info">
                    <table>
                        <tr><td>No Dokumen</td><td>: AF.SP 05.14.Rev-00</td></tr>
                        <tr><td>Tanggal Terbit</td><td>: 02 Agustus 2024</td></tr>
                        <tr><td>Halaman</td><td>: 1/1</td></tr>
                        <tr><td>Tanggal Revisi</td><td>: -</td></tr>
                    </table>
                </td>
            </tr>
        </table>

        <div class="info-section">
            <div class="info-left">
                <div>MERK MESIN : <span id="val-mesin" style="margin-left: 10px; border-bottom: 1px dotted black; min-width: 150px; display:inline-block;">-</span></div>
                <div>TONAGE &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <span id="val-ton" style="margin-left: 10px; border-bottom: 1px dotted black; min-width: 150px; display:inline-block;">-</span></div>
            </div>
            <div class="info-right">
                BULAN : <span id="val-bulan" style="margin-left: 10px; border-bottom: 1px dotted black; min-width: 150px; display:inline-block;">-</span>
            </div>
        </div>

        <table class="main-table">
            <thead>
                <tr>
                    <th rowspan="2" class="col-no">No</th>
                    <th rowspan="2" class="col-jenis">Jenis pengecekan</th>
                    <th rowspan="2" class="col-std">Standard</th>
                    <th colspan="31">Tanggal</th>
                </tr>
                <tr id="date-header">
                    </tr>
            </thead>
            <tbody id="checklist-body">
                </tbody>
            <tbody id="sig-body">
                <tr id="row-sig-pel">
                    <td colspan="3" style="text-align: right; font-weight: bold; padding-right: 10px;">Paraf Pelaksana</td>
                    </tr>
                <tr id="row-sig-cek">
                    <td colspan="3" style="text-align: right; font-weight: bold; padding-right: 10px;">Paraf Pengecek</td>
                    </tr>
            </tbody>
        </table>

        <div class="footer-section">
            <div class="legend-box">
                <table class="legend-table">
                    <tr><td colspan="2" style="font-weight: bold; text-decoration: underline;">Beri tanda :</td></tr>
                    <tr><td width="20" align="center">‚àö</td><td>Bila item yang diperiksa baik, sesuai standar</td></tr>
                    <tr><td align="center">x</td><td>Bila terjadi penyimpangan / kerusakan pada item yang diperiksa.</td></tr>
                    <tr><td align="center">o</td><td>Bila mesin dalam proses perbaikan</td></tr>
                </table>
            </div>

            <div class="approval-box">
                <div class="approval-title">DIKETAHUI</div>
                <div class="sig-box-super" id="box-super">
                    </div>
                <div style="border-top: 1px solid black; width: 80%; margin: 0 auto;"></div>
                <div style="font-weight: bold; margin-top: 2px;">MECHANIC SUPERINTENDENT</div>
            </div>
        </div>

    </div>

    <script>
        const SB_URL = "https://dsyvlavphvrdidmodokd.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
        const _sb = supabase.createClient(SB_URL, SB_KEY);

        async function init() {
            // Fill Date Header 1-31
            const dh = document.getElementById('date-header');
            for(let i=1; i<=31; i++) dh.innerHTML += `<th class="col-tgl">${i}</th>`;

            // Load Mesin List
            const { data: m } = await _sb.from('chslr_mesin').select('nama_mesin');
            const sel = document.getElementById('f-mesin');
            m?.forEach(x => sel.innerHTML += `<option>${x.nama_mesin}</option>`);

            // Default Date
            const d = new Date();
            document.getElementById('f-bulan').value = 1; // Default Jan for now or d.getMonth()+1
            document.getElementById('f-tahun').value = 2026;
            
            loadReport();
        }

        async function loadReport() {
            const mesin = document.getElementById('f-mesin').value;
            const bln = document.getElementById('f-bulan').value;
            const thn = document.getElementById('f-tahun').value;
            
            // Render Header Info
            document.getElementById('val-mesin').innerText = mesin;
            document.getElementById('val-bulan').innerText = document.getElementById('f-bulan').options[bln-1].text.toUpperCase() + " " + thn;

            // Fetch Data
            // 1. Log Header
            const { data: log } = await _sb.from('chslr_log')
                .select('*')
                .eq('mesin_id', mesin).eq('bulan', bln).eq('tahun', thn)
                .maybeSingle();

            // 2. Machine Info (Tonage)
            const { data: mData } = await _sb.from('chslr_mesin').select('tonage').eq('nama_mesin', mesin).single();
            document.getElementById('val-ton').innerText = mData?.tonage || '-';

            // 3. Items & Results
            const { data: items } = await _sb.from('chslr_items').select('*').order('sort_order');
            const { data: res } = log ? await _sb.from('chslr_result').select('*').eq('log_id', log.id) : { data: [] };

            // Render Rows
            const tbody = document.getElementById('checklist-body');
            tbody.innerHTML = "";
            
            let currentCat = "";
            let rowCount = 1;

            // Logic huruf (a, b, c...)
            let subIndex = 0; 
            const letters = "abcdefghijklmnopqrstuvwxyz";

            items.forEach(item => {
                // RENDER KATEGORI (Jika berubah)
                if(item.kategori && item.kategori !== currentCat) {
                    currentCat = item.kategori;
                    // Reset sub index
                    subIndex = 0;
                    
                    // Baris Kategori (1, 2, 3...)
                    let catRow = `<tr class="category-row">
                        <td align="center">${rowCount}</td>
                        <td colspan="32" class="item-text">${currentCat}</td>
                    </tr>`;
                    tbody.innerHTML += catRow;
                    rowCount++;
                }

                // Baris Item (a, b, c...)
                let row = `<tr>
                    <td align="center">${letters[subIndex] || '-'}</td>
                    <td class="item-text">${item.item_name}</td>
                    <td class="std-text">${item.standard || ''}</td>`;
                
                // Fill 1-31
                for(let d=1; d<=31; d++) {
                    const r = res.find(x => x.item_id === item.id && x.tanggal === d);
                    let symbol = "";
                    let cls = "";
                    
                    if(r) {
                        if(r.status === 'OK') { symbol = "‚àö"; cls="ok-mark"; }
                        else if(r.status === 'NG') { symbol = "x"; cls="ng-mark"; }
                    }
                    row += `<td class="${cls}">${symbol}</td>`;
                }
                row += `</tr>`;
                tbody.innerHTML += row;
                subIndex++;
            });

            // RENDER SIGNATURES
            const rowPel = document.getElementById('row-sig-pel');
            const rowCek = document.getElementById('row-sig-cek');
            
            // Bersihkan cell lama (sisakan header)
            while(rowPel.cells.length > 1) rowPel.deleteCell(1);
            while(rowCek.cells.length > 1) rowCek.deleteCell(1);

            for(let d=1; d<=31; d++) {
                // Pelaksana Sig (Per hari)
                const dayRes = res.filter(r => r.tanggal === d && r.signature);
                const tdPel = rowPel.insertCell();
                if(dayRes.length > 0) {
                    tdPel.innerHTML = `<img src="${dayRes[0].signature}" class="sig-img">`;
                }

                // Pengecek Sig (Jika verif = true, muncul di hari yg ada data)
                const hasData = res.some(r => r.tanggal === d);
                const tdCek = rowCek.insertCell();
                if(log?.status_verifikasi && log?.signature_koordinator && hasData) {
                    tdCek.innerHTML = `<img src="${log.signature_koordinator}" class="sig-img">`;
                }
            }

            // SUPERINTENDENT BOX
            const superBox = document.getElementById('box-super');
            if(log?.status_final && log?.signature_superintendent) {
                superBox.innerHTML = `<img src="${log.signature_superintendent}" class="super-img">`;
            } else {
                superBox.innerHTML = "";
            }
        }

        window.onload = init;
    </script>
</body>
</html>
