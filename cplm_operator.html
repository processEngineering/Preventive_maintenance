<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Operator Checklist Mold - AKG</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- SweetAlert2 untuk Notifikasi Bagus -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary: #DC2626;
            --primary-dark: #991B1B;
            --bg-dark: #050505;
            --bg-card: #121212; 
            --text-white: #FFFFFF;
            --text-gray: #A3A3A3;
            --border-light: rgba(255,255,255,0.1);
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }

        body {
            background: var(--bg-dark);
            color: var(--text-white);
            padding-bottom: 80px; /* Space for footer */
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #000000 0%, #1a0505 100%);
            padding: 20px;
            border-bottom: 1px solid var(--primary-dark);
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(220, 38, 38, 0.2);
        }

        .header h1 {
            color: var(--primary);
            font-size: 20px;
            font-weight: 800;
            text-transform: uppercase;
        }

        .header p {
            color: var(--text-gray);
            font-size: 12px;
            margin-top: 4px;
        }

        /* Container */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 16px;
        }

        /* Form Group */
        .form-section {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary);
            text-transform: uppercase;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 8px;
        }

        /* Inputs */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }

        @media(min-width: 600px) {
            .form-grid { grid-template-columns: 1fr 1fr; }
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        label {
            font-size: 12px;
            color: var(--text-gray);
            font-weight: 500;
        }

        input, select {
            background: #0a0a0a;
            border: 1px solid var(--border-light);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border 0.3s;
        }

        input:focus, select:focus {
            border-color: var(--primary);
        }

        /* Table Checklist */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px; /* Force scroll on mobile */
        }

        th, td {
            padding: 12px;
            border-bottom: 1px solid var(--border-light);
            font-size: 13px;
            text-align: left;
            vertical-align: middle;
        }

        th {
            background: rgba(220, 38, 38, 0.1);
            color: var(--primary);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 11px;
        }

        /* Custom Radio Buttons / Options */
        .options-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .option-label {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            background: rgba(255,255,255,0.05);
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid transparent;
            transition: all 0.2s;
            font-size: 11px;
            user-select: none;
        }

        .option-label:hover { background: rgba(255,255,255,0.1); }

        /* Hidden Radio Input logic */
        .option-input { display: none; }

        .option-input:checked + span {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            font-weight: 600;
        }
        
        /* Specific Colors for OK/Not OK */
        .option-input[value="OK"]:checked + span { background: #10B981; border-color: #10B981; } /* Green */
        .option-input[value="NOT OK"]:checked + span { background: #EF4444; border-color: #EF4444; } /* Red */
        .option-input[value="REPAIR"]:checked + span { background: #F59E0B; border-color: #F59E0B; color: black; } /* Orange */

        /* Signature Canvas */
        .signature-pad {
            background: #fff;
            border-radius: 8px;
            width: 100%;
            height: 200px;
            cursor: crosshair;
            touch-action: none; /* Prevent scrolling while signing */
        }

        /* Actions */
        .btn-action {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-action:active { transform: scale(0.98); }
        .btn-clear { background: #333; margin-top: 8px; font-size: 12px; padding: 8px; width: auto; }

        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center; align-items: center; z-index: 999;
            flex-direction: column; gap: 10px;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid var(--primary);
            border-top: 4px solid transparent; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <header class="header">
        <div class="container">
            <h1>Form Operator</h1>
            <p>Checklist Perawatan Mold Harian</p>
        </div>
    </header>

    <div class="container">
        
        <!-- FORM HEADER -->
        <div class="form-section">
            <div class="section-title">Informasi Mold</div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Kode Mold</label>
                    <input type="text" id="kode_mold" placeholder="Contoh: M-001">
                </div>
                <div class="form-group">
                    <label>Tanggal Perawatan</label>
                    <input type="date" id="tgl_perawatan">
                </div>
                <div class="form-group">
                    <label>Produk</label>
                    <input type="text" id="produk" placeholder="Nama Produk">
                </div>
                <div class="form-group">
                    <label>Material Mold</label>
                    <input type="text" id="material_mold" placeholder="Jenis Material">
                </div>
                <div class="form-group">
                    <label>Type Mold</label>
                    <select id="type_mold">
                        <option value="SINGLE">SINGLE</option>
                        <option value="FAMILY">FAMILY</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tanggal Akhir Shot</label>
                    <input type="date" id="tgl_akhir_shot">
                </div>
                <div class="form-group">
                    <label>PIC Perawatan</label>
                    <input type="text" id="pic_perawatan" placeholder="Nama Operator">
                </div>
            </div>
        </div>

        <!-- FORM CHECKLIST TABLE -->
        <div class="form-section" style="padding: 0; overflow: hidden;">
            <div class="section-title" style="margin: 20px;">Item Checklist</div>
            
            <div class="table-responsive">
                <table id="checklistTable">
                    <thead>
                        <tr>
                            <th width="5%">No</th>
                            <th width="25%">Item Check</th>
                            <th width="20%">Standart</th>
                            <th width="30%">Kondisi</th>
                            <th width="20%">Catatan</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Javascript will populate this -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- TANDA TANGAN -->
        <div class="form-section">
            <div class="section-title">Paraf Operator</div>
            <p style="font-size: 11px; color: #666; margin-bottom: 10px;">Silakan tanda tangan di area putih di bawah ini:</p>
            <canvas id="signaturePad" class="signature-pad"></canvas>
            <button type="button" class="btn-action btn-clear" onclick="clearSignature()">
                <i class="fa-solid fa-eraser"></i> Hapus Tanda Tangan
            </button>
        </div>

        <!-- SUBMIT BUTTON -->
        <button type="button" class="btn-action" onclick="submitForm()">
            <i class="fa-solid fa-paper-plane"></i> KIRIM LAPORAN
        </button>

    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <span>Menyimpan Data...</span>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        // Konfigurasi Supabase Anda
        const SUPABASE_URL = 'https://dsyvlavphvrdidmodokd.supabase.co';
        const SUPABASE_KEY = ''; // KOSONGKAN SEPERTI INSTRUKSI SYSTEM
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 2. DATA DEFINITION ---
        // Definisi Item Checklist dan Pilihan Tombolnya
        const checklistData = [
            { no: 1, item: "CUCI DIES", std: "BERSIH", opts: ["OK", "DI BERSIHKAN"] },
            { no: 2, item: "COOLING NEPPLE", std: "TIDAK MAMPET", opts: ["OK", "DI BERSIHKAN", "GANTI BARU"] },
            { no: 3, item: "AIR COOLING", std: "TIDAK BOCOR", opts: ["OK", "DI BERSIHKAN", "DISCALING"] },
            { no: 4, item: "WATER COOLING", std: "TIDAK BOCOR", opts: ["OK", "DI BERSIHKAN", "DISCALING"] },
            { no: 5, item: "MANIFOLD RUNNER", std: "BERSIH", opts: ["OK", "DI BERSIHKAN", "GANTI BARU"] },
            { no: 6, item: "HEATER MANIFOLD & KABEL", std: "BERFUNGSI", opts: ["OK", "DI BERSIHKAN", "GANTI BARU"] },
            { no: 7, item: "SPRING EJECTOR", std: "BERFUNGSI IMBANG", opts: ["OK", "DI BERSIHKAN", "GANTI BARU"] },
            { no: 8, item: "POLESHING CAV/CORE MOVE", std: "TIDAK CARBON/MINYAK", opts: ["OK", "DI BERSIHKAN", "REPAIR"] },
            { no: 9, item: "POLESHING CAV/CORE FIX", std: "TIDAK CARBON/MINYAK", opts: ["OK", "DI BERSIHKAN", "REPAIR"] },
            { no: 10, item: "PIN EJECTOR", std: "TIDAK PATAH", opts: ["OK", "DI BERSIHKAN", "GANTI BARU"] },
            { no: 11, item: "PIN INSERT", std: "TIDAK PATAH", opts: ["OK", "DI BERSIHKAN", "GANTI BARU"] },
            { no: 12, item: "RETURN PIN", std: "TIDAK AUS", opts: ["OK", "DI BERSIHKAN", "GANTI BARU"] },
            { no: 13, item: "GUIDE PIN", std: "TIDAK AUS", opts: ["OK", "DI BERSIHKAN", "GANTI BARU"] },
            { no: 14, item: "GUIDE BUSH", std: "TIDAK AUS", opts: ["OK", "DI BERSIHKAN", "GANTI BARU"] },
            { no: 15, item: "ANGULAR PIN (TANDUK)", std: "TIDAK AUS & BENGKOK", opts: ["OK", "DI BERSIHKAN", "GANTI BARU"] },
            { no: 16, item: "SLIDER CORE", std: "TIDAK AUS", opts: ["OK", "DI BERSIHKAN", "REPAIR"] },
            { no: 17, item: "HYDRAULIC CORE", std: "TIDAK BOCOR", opts: ["OK", "GANTI BARU", "REPAIR"] },
            { no: 18, item: "SPRUE BUSH", std: "TIDAK AUS", opts: ["OK", "DI BERSIHKAN", "GANTI BARU"] },
            { no: 19, item: "EJECTOR SLEEVE", std: "TIDAK MAMPET", opts: ["OK", "DI BERSIHKAN", "GANTI BARU"] },
            { no: 20, item: "GAS VENTING", std: "TIDAK MAMPET", opts: ["OK", "DI BERSIHKAN", "GANTI BARU"] },
            { no: 21, item: "BAUT", std: "TIDAK KENDOR", opts: ["OK", "DI BERSIHKAN", "GANTI BARU"] },
            { no: 22, item: "MATCHING SURFACE", std: "PIGMENT MERATA", opts: ["OK", "DI FACING ULANG", "GRINDING"] },
            // Section Food Packaging
            { no: 23, item: "PEMBERSIH BAKTERI", std: "LAP ALCOHOL CORE/CAV", opts: ["OK"] },
            { no: 24, item: "LUBRIKASI PERMUKAAN MOLD", std: "DIBERI LUBRIKASI", opts: ["OK", "OIL SPRAY", "GRACE FG"] },
            { no: 25, item: "BUNGKUS PLASTIK SRINK", std: "TERTUTUP DARI DEBU/HAMA", opts: ["OK"] },
            // Functional Test
            { no: 26, item: "FUNGSIONAL COOLING", std: "TEST", opts: ["OK", "NOT OK"] },
            { no: 27, item: "FUNGSIONAL AJV", std: "TEST", opts: ["OK", "NOT OK"] },
            { no: 28, item: "FUNSIONAL EJEKTOR", std: "TEST", opts: ["OK", "NOT OK"] },
            { no: 29, item: "MATCHING MANIFOL", std: "TEST", opts: ["OK", "NOT OK"] },
            { no: 30, item: "TEMPERATUR TEST", std: "TEST", opts: ["OK", "NOT OK"] }
        ];

        // --- 3. RENDER TABLE ---
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            let html = '';

            checklistData.forEach((row, index) => {
                // Generate Options HTML
                let optionsHtml = '<div class="options-container">';
                row.opts.forEach(opt => {
                    const uniqueId = `row_${row.no}_${opt.replace(/\s/g, '_')}`;
                    const name = `row_${row.no}`;
                    optionsHtml += `
                        <label class="option-label">
                            <input type="radio" name="${name}" value="${opt}" class="option-input" required>
                            <span>${opt}</span>
                        </label>
                    `;
                });
                optionsHtml += '</div>';

                // Separator rows for styling (Optional visual cue)
                if (row.no === 23) {
                    html += `<tr style="background:#1a1a1a;"><td colspan="5" style="font-weight:bold; color:var(--primary); text-align:center;">FOOD PACKAGING MOLD</td></tr>`;
                } else if (row.no === 26) {
                    html += `<tr style="background:#1a1a1a;"><td colspan="5" style="font-weight:bold; color:var(--primary); text-align:center;">FUNGSIONAL TEST</td></tr>`;
                }

                html += `
                    <tr>
                        <td style="text-align:center;">${row.no}</td>
                        <td style="font-weight:600;">${row.item}</td>
                        <td style="color:var(--text-gray);">${row.std}</td>
                        <td>${optionsHtml}</td>
                        <td><input type="text" id="catatan_${row.no}" placeholder="Catatan..." style="width:100%; font-size:12px; padding:6px;"></td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        // --- 4. SIGNATURE PAD LOGIC ---
        const canvas = document.getElementById('signaturePad');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;

        function resizeCanvas() {
            // Make canvas high res
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            ctx.scale(ratio, ratio);
        }
        window.addEventListener("resize", resizeCanvas);
        setTimeout(resizeCanvas, 100); // Init

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            let clientX = e.clientX;
            let clientY = e.clientY;
            
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            }

            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        function startDraw(e) {
            isDrawing = true;
            const pos = getPos(e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000';
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault(); // Stop scrolling on touch
            const pos = getPos(e);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
        }

        function endDraw() { isDrawing = false; }

        // Event Listeners for Canvas
        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', endDraw);
        canvas.addEventListener('mouseout', endDraw);
        
        canvas.addEventListener('touchstart', startDraw, { passive: false });
        canvas.addEventListener('touchmove', draw, { passive: false });
        canvas.addEventListener('touchend', endDraw);

        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Use raw width/height
            // Hack to reset transform/scale if needed, but usually clearRect covers it
            // Re-run resize to be safe
            resizeCanvas();
        }

        function isCanvasBlank() {
            const pixelBuffer = new Uint32Array(
                ctx.getImageData(0, 0, canvas.width, canvas.height).data.buffer
            );
            return !pixelBuffer.some(color => color !== 0);
        }


        // --- 5. SUBMIT LOGIC ---
        async function submitForm() {
            // 1. Validation Header
            const kode = document.getElementById('kode_mold').value;
            const pic = document.getElementById('pic_perawatan').value;
            const tgl = document.getElementById('tgl_perawatan').value;

            if (!kode || !pic || !tgl) {
                Swal.fire({ icon: 'warning', title: 'Data Belum Lengkap', text: 'Mohon isi Kode Mold, Tanggal, dan PIC.' });
                return;
            }

            // 2. Validation Checklist
            // Check if all radio groups have a selected value
            for (let row of checklistData) {
                const radios = document.getElementsByName(`row_${row.no}`);
                let checked = false;
                for (let r of radios) { if (r.checked) checked = true; }
                if (!checked) {
                    Swal.fire({ icon: 'warning', title: 'Checklist Belum Selesai', text: `Item No. ${row.no} (${row.item}) belum dipilih.` });
                    return;
                }
            }

            // 3. Validation Signature
            if (isCanvasBlank()) {
                Swal.fire({ icon: 'warning', title: 'Tanda Tangan Kosong', text: 'Mohon tanda tangan terlebih dahulu.' });
                return;
            }

            document.getElementById('loading').style.display = 'flex';

            try {
                // A. Insert Header to clpm_log
                const signatureData = canvas.toDataURL(); // Base64 image
                
                const { data: logData, error: logError } = await supabase
                    .from('clpm_log')
                    .insert([{
                        kode_mold: kode,
                        tanggal_perawatan: tgl,
                        produk: document.getElementById('produk').value,
                        material_mold: document.getElementById('material_mold').value,
                        type_mold: document.getElementById('type_mold').value,
                        tanggal_akhir_shot: document.getElementById('tgl_akhir_shot').value || null,
                        pic_perawatan: pic,
                        paraf_operator: signatureData
                    }])
                    .select();

                if (logError) throw logError;
                const logId = logData[0].id;

                // B. Prepare Data for clpm_result
                const resultsPayload = checklistData.map(row => {
                    const radios = document.getElementsByName(`row_${row.no}`);
                    let selectedVal = "";
                    for (let r of radios) { if (r.checked) selectedVal = r.value; }
                    
                    const note = document.getElementById(`catatan_${row.no}`).value;

                    return {
                        log_id: logId,
                        no_item: row.no,
                        item_check: row.item,
                        standart: row.std,
                        kondisi: selectedVal,
                        catatan: note
                    };
                });

                // C. Insert Items to clpm_result
                const { error: resultError } = await supabase
                    .from('clpm_result')
                    .insert(resultsPayload);

                if (resultError) throw resultError;

                document.getElementById('loading').style.display = 'none';
                
                Swal.fire({
                    icon: 'success',
                    title: 'Berhasil!',
                    text: 'Data checklist berhasil disimpan.',
                    confirmButtonColor: '#DC2626'
                }).then(() => {
                    window.location.href = 'clpm.html'; // Kembali ke menu
                });

            } catch (err) {
                document.getElementById('loading').style.display = 'none';
                console.error(err);
                Swal.fire({ icon: 'error', title: 'Terjadi Kesalahan', text: err.message });
            }
        }

        // --- INIT ---
        // Set Default Date to Today
        document.getElementById('tgl_perawatan').valueAsDate = new Date();
        renderTable();

    </script>
</body>
</html>
