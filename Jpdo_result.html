<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Bulanan - AKG Maintenance</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --primary: #DC2626;
            --border-color: #000;
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-print-color-adjust: exact; }

        body {
            background: #f5f5f5;
            padding: 20px;
            color: #000;
        }

        /* UI Controls (Hidden on Print) */
        .controls {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            max-width: 297mm;
            margin-left: auto;
            margin-right: auto;
        }

        .btn-print {
            background: var(--primary); color: white; border: none; padding: 10px 20px;
            border-radius: 6px; cursor: pointer; font-weight: 600;
        }
        
        .btn-back {
            background: #333; color: white; border: none; padding: 10px 20px;
            border-radius: 6px; cursor: pointer; text-decoration: none; display: inline-block;
        }

        /* A4 Landscape Paper Layout */
        .sheet {
            background: white;
            width: 297mm;
            min-height: 210mm;
            padding: 10mm;
            margin: 0 auto;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            position: relative;
        }

        /* === ISO HEADER STYLE === */
        .report-header-table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid #000;
            font-family: 'Inter', sans-serif;
        }

        .report-header-table td {
            border: 1px solid #000;
            padding: 5px;
            vertical-align: middle;
        }

        .header-left { 
            width: 25%; 
            padding: 10px !important; 
        }
        
        /* Flex container untuk Logo dan Nama PT agar samping-sampingan */
        .header-brand-container {
            display: flex;
            align-items: center;
            gap: 15px; /* Jarak antara logo dan teks */
            justify-content: center;
        }

        .header-logo { 
            width: 70px; /* Logo agak gede */
            height: auto; 
            display: block; 
        }

        .header-company-name { 
            font-size: 12px; 
            font-weight: 800; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            display: block; 
            text-align: left;
            line-height: 1.3;
        }

        .header-center { width: 45%; text-align: center; }
        .header-title { font-size: 18px; font-weight: 900; text-transform: uppercase; margin: 0; line-height: 1.2; }

        .header-right { width: 30%; padding: 0 !important; }
        .header-meta-table { width: 100%; border-collapse: collapse; font-size: 9px; border: none; }
        .header-meta-table td { border: none; border-bottom: 1px solid #000; padding: 6px 8px; text-align: left; }
        .header-meta-table tr:last-child td { border-bottom: none; }
        .meta-label { font-weight: 700; width: 35%; border-right: 1px solid #000 !important; background-color: #fff; }
        .meta-value { width: 65%; padding-left: 8px; }

        /* Period Display (Updated Style) */
        .period-display {
            text-align: center;
            font-weight: 400; /* Jangan ditebelin */
            font-size: 12px; /* Agak dikecilin */
            margin: 10px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            /* Border dihapus agar lebih bersih seperti PDF header, atau biarkan tipis */
            padding: 5px;
        }

        /* Main Schedule Table */
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9px;
        }

        .schedule-table th, .schedule-table td {
            border: 1px solid var(--border-color);
            padding: 0;
            text-align: center;
            vertical-align: middle;
            height: 18px;
        }

        .schedule-table th { background: #eee; font-weight: 700; height: 30px; padding: 2px; }
        
        .col-no { width: 25px; padding: 2px !important; }
        .col-machine { text-align: left !important; padding-left: 5px !important; width: 250px; font-size: 8px; white-space: normal; }
        .col-type { font-weight: 600; font-size: 7px; width: 35px; padding: 2px !important; }
        .col-pic { width: 40px; font-weight: 700; font-size: 8px; } /* Kolom PIC Baru */

        /* Full Box Markers */
        .cell-fill {
            width: 100%;
            height: 100%;
            display: block;
            min-height: 18px;
        }

        .bg-plan { background-color: #007bff; } /* Biru Solid */
        .bg-actual { background-color: #28a745; } /* Hijau Solid */
        .bg-miss { background-color: #ff0000; } /* Merah Terang (Miss) */
        .bg-holiday { background-color: #D30000; opacity: 1; color: white; } /* MERAH TERANG #D30000 untuk Libur */
        .bg-grey { background-color: #ddd; } /* Tanggal tidak ada */

        /* Signature Section - REVISED */
        .signature-section {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            gap: 10px;
            page-break-inside: avoid;
        }

        .sig-box { flex: 1; border: none; text-align: center; } /* Border dihapus agar lebih bersih/seperti surat */
        
        .sig-header { 
            font-size: 10px; 
            font-weight: 700; 
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        .sig-body { 
            height: 70px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-end; /* Align signature to bottom */
            position: relative;
        }
        
        .sig-img { 
            max-height: 50px; 
            max-width: 90%; 
            margin-bottom: 5px;
        }
        
        .sig-name { 
            font-size: 10px; 
            font-weight: 700; 
            text-decoration: underline; 
            text-transform: uppercase;
        }
        
        .sig-role { 
            font-size: 9px; 
            font-weight: 400; 
            text-transform: uppercase;
            margin-top: 2px;
        }

        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 999;
            display: none; justify-content: center; align-items: center;
            font-size: 20px; font-weight: 600; color: var(--primary);
            flex-direction: column; gap: 10px;
        }

        @media print {
            body { background: white; padding: 0; }
            .controls { display: none; }
            .sheet { box-shadow: none; margin: 0; width: 100%; padding: 0; }
            @page { size: A4 landscape; margin: 5mm; }
        }
    </style>
</head>
<body>

    <div id="loading">
        <i class="fa-solid fa-spinner fa-spin fa-2x"></i> 
        <span>Mengambil Data...</span>
    </div>

    <div class="controls">
        <a href="menu_utama.html" class="btn-back"><i class="fa-solid fa-arrow-left"></i> Kembali</a>
        <div style="flex: 1; display: flex; align-items: center; gap: 10px;">
            <label style="font-weight: 600;">Pilih Periode:</label>
            <input type="month" id="month-picker" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc;" onchange="fetchReport()">
            <button onclick="fetchReport()" style="padding: 8px; cursor:pointer;">Refresh Data</button>
        </div>
        <button onclick="window.print()" class="btn-print"><i class="fa-solid fa-print"></i> Cetak PDF</button>
    </div>

    <div class="sheet">
        <!-- HEADER -->
        <table class="report-header-table">
            <tr>
                <td class="header-left">
                    <div class="header-brand-container">
                        <img src="https://amarilyskg.co.id/bootstrap/img/logo.png" alt="AKG Logo" class="header-logo">
                        <span class="header-company-name">PT. AMARILYS<br>KARISMA<br>GEMILANG</span>
                    </div>
                </td>
                <td class="header-center">
                    <h1 class="header-title">JADWAL PERAWATAN DAN OVERHAUL</h1>
                </td>
                <td class="header-right">
                    <table class="header-meta-table">
                        <tr><td class="meta-label">No Dokumen</td><td class="meta-value">: AF.SP 05.05.Rev-00</td></tr>
                        <tr><td class="meta-label">Tanggal Terbit</td><td class="meta-value">: 02 Agustus 2024</td></tr>
                        <tr><td class="meta-label">Halaman</td><td class="meta-value">: 1/1</td></tr>
                        <tr><td class="meta-label">Tanggal Revisi</td><td class="meta-value">: -</td></tr>
                    </table>
                </td>
            </tr>
        </table>

        <!-- PERIODE DI TENGAH (Tampilan disesuaikan) -->
        <div id="period-text" class="period-display">
            TANGGAL PREVENTIVE / OVERHAUL : -
        </div>

        <!-- TABLE -->
        <table class="schedule-table">
            <thead>
                <tr>
                    <th rowspan="2" class="col-no">NO</th>
                    <th rowspan="2">NAMA MESIN / TOOL / EQUIPMENT</th>
                    <th rowspan="2">STATUS</th>
                    <th colspan="31">TANGGAL</th>
                    <th rowspan="2" class="col-pic">PIC</th>
                </tr>
                <tr id="date-header-row">
                    <!-- Dates injected here -->
                </tr>
            </thead>
            <tbody id="schedule-body">
                <!-- Data injected here -->
            </tbody>
        </table>

        <!-- SIGNATURES (REVISED LAYOUT) -->
        <div class="signature-section">
            <div class="sig-box">
                <div class="sig-header">DIBUAT OLEH :</div>
                <div class="sig-body" id="sig-spv">
                    <div style="font-size: 9px; color: #888; font-style: italic;">(Menunggu Input)</div>
                </div>
                <!-- Jabatan hardcoded untuk kolom ini karena SPV dinamis -->
                <div class="sig-role">SUPERVISOR</div> 
            </div>
            
            <div class="sig-box">
                <div class="sig-header">DIPERIKSA :</div>
                <div class="sig-body" id="sig-supt"></div>
                <div class="sig-role">SUPERINTENDENT</div>
            </div>
            
            <div class="sig-box">
                <div class="sig-header">MENGETAHUI :</div>
                <div class="sig-body" id="sig-prod"></div>
                <div class="sig-role">PRODUKSI</div>
            </div>
            
            <div class="sig-box">
                <div class="sig-header">MENGETAHUI :</div>
                <div class="sig-body" id="sig-ppc"></div>
                <div class="sig-role">PPC</div>
            </div>
            
            <div class="sig-box">
                <div class="sig-header">MENYETUJUI :</div>
                <div class="sig-body" id="sig-mgr"></div>
                <div class="sig-role">MANAGER ENG</div>
            </div>
        </div>
    </div>

    <script>
        var SUPABASE_URL = 'https://dsyvlavphvrdidmodokd.supabase.co';
        var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E'; 
        
        if (!window.supabaseClient) {
            window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        }

        // Updated Machine List
        const machines = [
            { no: 1, id: "INJECT BLOW LIANXIN IBM30H", label: "Inject Blow Lianxin IBM30H" },
            { no: 2, id: "TM EXPRESS 270/2250", label: "TM Express 270/2250 (+ Robot Wittmann 822)" },
            { no: 3, id: "ECO POWER 240/750", label: "ECO Power 240/750 (+ Robot Wittmann 822)" },
            { no: 4, id: "ECO POWER 210 T", label: "ECO Power 210 T (+ Robot Wittmann 823 UHS)" },
            { no: 5, id: "TM EXPRESS 350/3400", label: "TM Express 350/3400 (Sepro S5-25 + Robot Jet Engine)" },
            { no: 6, id: "ARBURG 320 T", label: "Arburg 320 T (Star Lord) + Robot Sonic 142 (Starscream)" },
            { no: 7, id: "WIBA 500 T (STEVE)", label: "WIBA 500 T (Steve Rogers) + Robot Wittmann W837 (Optimus Prime)" },
            { no: 8, id: "WIBA 500 T (THANOS)", label: "WIBA 500 T (Thanos) + Robot Wittmann W837 (Optimus Prime)" },
            { no: 9, id: "FCS 220 T", label: "FCS 220 T (Black Widow) + Robot Sepro S5-25 (Wheel Jack)" },
            { no: 10, id: "ENGEL 220 T", label: "ENGEL 220 T (Deadpool) + Robot Wittmann Primus 26 (Mirage)" },
            { no: 11, id: "ARBURG 200 T", label: "Arburg 200 T (Wolverine) + Robot Wittmann Primus 26 (Mirage)" },
            { no: 12, id: "FCS 380 T (LOKI)", label: "FCS 380 T (Loki) + Robot Sepro S5-25 (Wheel Jack)" },
            { no: 13, id: "ENGEL 380 T (INHUMANS)", label: "ENGEL 380 T (Inhumans) + Robot Wittmann WX142 (Ratchet)" },
            { no: 14, id: "ENGEL 380 T (HULK)", label: "ENGEL 380 T (Hulk) + Robot Wittmann WX142 (Ratchet)" },
            { no: 15, id: "NPC 400 T (WANDA)", label: "NPC 400 T (Wanda) + Robot Sepro Success (Rinox)" },
            { no: 16, id: "ENGEL 280 T", label: "ENGEL 280 T (Doctor Strange) + Robot Wittmann W833 Pro (Fallen)" },
            { no: 31, id: "FCS 100 T (ANTMAN)", label: "FCS 100 T (Antman)" },
            { no: 32, id: "NPC 160 T (WASP)", label: "NPC 160 T (Wasp) + Robot Wittmann W818 (Grimlock)" },
            { no: 33, id: "NPC 160 T (WONG)", label: "NPC 160 T (Wong) + Robot Wittmann W818 (Grimlock)" },
            { no: 34, id: "FCS 150 T (ROCKET)", label: "FCS 150 T (Rocket)" },
            { no: 35, id: "FCS 150 T (MANTIS)", label: "FCS 150 T (Mantis)" },
            { no: 36, id: "NPC 160 T (SHANCHI)", label: "NPC 160 T (Shanchi) + Robot Wittmann W818 (Grimlock)" },
            { no: 37, id: "NPC 260 T (VISION)", label: "NPC 260 T (Vision) + Robot Sepro Success (Rinox)" },
            { no: 38, id: "NPC 200 T (MAGNETO)", label: "NPC 200 T (Magneto) + Robot Wittmann W818 (Grimlock)" },
            { no: 39, id: "FCS 100 T (NICK FURRY)", label: "FCS 100 T (Nick Furry)" },
            { no: 40, id: "FCS 250 T (CYCLOPS)", label: "FCS 250 T (Cyclops) + Robot Wittmann W818 (Grimlock)" },
            { no: 41, id: "NPC 260 T (HAWKEYE)", label: "NPC 260 T (Hawkeye) + Robot Wittmann Primus 26 (Mirage)" },
            { no: 42, id: "WORKSHOP", label: "Workshop (ZSJ 328)" },
            { no: 43, id: "GRINDING", label: "Grinding" },
            { no: 44, id: "MILLING 1", label: "Milling 1" },
            { no: 45, id: "MILLING 2", label: "Milling 2" },
            { no: 46, id: "BUBUT", label: "Bubut" }
        ];

        window.onload = function() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const picker = document.getElementById('month-picker');
            if (picker) picker.value = `${year}-${month}`;
            if (typeof fetchReport === 'function') fetchReport();
        }

        function renderDateHeader(year, month) {
            const daysInMonth = new Date(year, month, 0).getDate();
            const headerRow = document.getElementById('date-header-row');
            headerRow.innerHTML = '';
            for (let i = 1; i <= 31; i++) {
                if (i <= daysInMonth) headerRow.innerHTML += `<th>${i}</th>`;
                else headerRow.innerHTML += `<th class="bg-grey"></th>`;
            }
            return daysInMonth;
        }

        window.fetchReport = async function() {
            const picker = document.getElementById('month-picker');
            if (!picker.value) return;

            document.getElementById('loading').style.display = 'flex';
            
            const [year, month] = picker.value.split('-');
            const daysInMonth = renderDateHeader(year, month);
            
            const monthNames = ["JANUARI", "FEBRUARI", "MARET", "APRIL", "MEI", "JUNI", "JULI", "AGUSTUS", "SEPTEMBER", "OKTOBER", "NOVEMBER", "DESEMBER"];
            document.getElementById('period-text').textContent = `TANGGAL PREVENTIVE / OVERHAUL : ${monthNames[parseInt(month)-1]} ${year}`;

            const startDate = `${picker.value}-01`;
            let nextM = parseInt(month) + 1, nextY = parseInt(year);
            if (nextM > 12) { nextM = 1; nextY++; }
            const endDate = `${nextY}-${String(nextM).padStart(2,'0')}-01`;

            try {
                // Fetch Logs + Tanda Tangan SPV
                const { data: logs, error: logError } = await window.supabaseClient
                    .from('jpdo_log')
                    .select('tanggal, nama_supervisor, tanda_tangan, nama_mesin, status_hari, jpdo_result(plan_status, actual_status)')
                    .gte('tanggal', startDate).lt('tanggal', endDate)
                    .order('created_at', { ascending: false }); // Ambil yang terbaru untuk TTD SPV

                if (logError) throw logError;

                const { data: appSupt } = await window.supabaseClient.from('jpdo_approval').select('*').eq('bulan', picker.value).maybeSingle();
                const { data: appProd } = await window.supabaseClient.from('jpdo_approval_produksi').select('*').eq('bulan', picker.value).maybeSingle();
                const { data: appPPC } = await window.supabaseClient.from('jpdo_approval_ppc').select('*').eq('bulan', picker.value).maybeSingle();
                const { data: appMgr } = await window.supabaseClient.from('jpdo_approval_manager').select('*').eq('bulan', picker.value).maybeSingle();

                const dataMap = {}, holidayMap = {};
                let spvData = null; // Untuk menyimpan TTD SPV

                if (logs && logs.length > 0) {
                    // Ambil SPV dari log terakhir di bulan tersebut yang memiliki tanda tangan
                    const lastLogWithSig = logs.find(l => l.tanda_tangan);
                    if (lastLogWithSig) {
                        spvData = {
                            nama: lastLogWithSig.nama_supervisor,
                            ttd: lastLogWithSig.tanda_tangan,
                            date: lastLogWithSig.tanggal
                        };
                    }

                    logs.forEach(log => {
                        const day = parseInt(log.tanggal.split('-')[2]);
                        if (log.status_hari === 'LIBUR') holidayMap[day] = true;
                        if (log.status_hari === 'KERJA' && log.nama_mesin) {
                            const machine = log.nama_mesin;
                            if (!dataMap[machine]) dataMap[machine] = {};
                            if (log.jpdo_result && log.jpdo_result.length > 0) {
                                dataMap[machine][day] = {
                                    plan: log.jpdo_result[0].plan_status,
                                    actual: log.jpdo_result[0].actual_status
                                };
                            }
                        }
                    });
                }

                const tbody = document.getElementById('schedule-body');
                tbody.innerHTML = '';

                machines.forEach((machineData) => {
                    let rowPlan = `<tr><td rowspan="2" class="col-no">${machineData.no}</td><td rowspan="2" class="col-machine">${machineData.label}</td><td class="col-type">PLAN</td>`;
                    let rowActual = `<tr><td class="col-type">ACTUAL</td>`;

                    for (let d = 1; d <= 31; d++) {
                        let classPlan = '', classActual = '', bgStyle = '';

                        if (d > daysInMonth) bgStyle = 'bg-grey';
                        else if (holidayMap[d]) bgStyle = 'bg-holiday';

                        if (dataMap[machineData.id] && dataMap[machineData.id][d]) {
                            const entry = dataMap[machineData.id][d];
                            if (entry.plan === 'YA') classPlan = 'bg-plan';
                            
                            if (entry.actual === 'YA') classActual = 'bg-actual';
                            else if (entry.plan === 'YA' && entry.actual === 'TIDAK') classActual = 'bg-miss';
                        }

                        rowPlan += `<td class="${classPlan || bgStyle}"><div class="cell-fill"></div></td>`;
                        rowActual += `<td class="${classActual || bgStyle}"><div class="cell-fill"></div></td>`;
                    }
                    
                    // Add PIC Column (Empty for manual use)
                    rowPlan += `<td rowspan="2" class="col-pic"></td>`;

                    rowPlan += `</tr>`; rowActual += `</tr>`;
                    tbody.innerHTML += rowPlan + rowActual;
                });

                // Render SPV Sig manually
                const elSpv = document.getElementById('sig-spv');
                if (spvData) {
                    // Hanya Tanda Tangan dan Nama
                    elSpv.innerHTML = `<img src="${spvData.ttd}" class="sig-img"><div class="sig-name">${spvData.nama}</div>`;
                } else {
                    elSpv.innerHTML = `<span style="color:#ccc; font-size:9px;">(Belum ada data)</span>`;
                }

                renderSig('sig-supt', appSupt, 'nama_superintendent', 'tanda_tangan_superintendent');
                renderSig('sig-prod', appProd, 'nama_produksi', 'tanda_tangan_produksi');
                renderSig('sig-ppc', appPPC, 'nama_ppc', 'tanda_tangan_ppc');
                renderSig('sig-mgr', appMgr, 'nama_manager', 'tanda_tangan_manager');

            } catch (err) {
                alert("Gagal memuat laporan: " + err.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function renderSig(elementId, data, nameField, sigField) {
            const el = document.getElementById(elementId);
            if (data) {
                // Revised: Image -> Name (Underlined)
                el.innerHTML = `<img src="${data[sigField]}" class="sig-img"><div class="sig-name">${data[nameField]}</div>`;
            } else {
                el.innerHTML = `<span style="color:#ccc; font-size:9px;">(Belum ada)</span>`;
            }
        }
    </script>
</body>
</html>
