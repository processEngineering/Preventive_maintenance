<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PMI Superintendent</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* === GLOBAL RESET === */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: #fff; color: #000; padding-bottom: 100px; }

        /* === HEADER === */
        .header-section { display: flex; justify-content: center; margin-top: 30px; margin-bottom: 20px; }
        .header-pill {
            border: 2px solid #000; border-radius: 50px; padding: 12px 50px;
            background: #fff; font-weight: 800; font-size: 20px; letter-spacing: 0.5px;
            text-transform: uppercase; box-shadow: 4px 4px 0 rgba(0,0,0,1);
        }

        /* === FILTER SECTION (BULAN TAHUN MESIN) === */
        .filter-container {
            display: flex; justify-content: space-between; gap: 10px;
            max-width: 600px; margin: 0 auto 30px auto; padding: 0 20px;
        }
        .filter-box {
            flex: 1; border: 2px solid #000; border-radius: 12px;
            background: #fff; font-weight: 700; font-size: 13px;
            padding: 10px; text-align: center; cursor: pointer;
            box-shadow: 3px 3px 0 #000; appearance: none; -webkit-appearance: none;
            /* Custom Arrow Icon */
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23000000%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat; background-position: right .7em top 50%; background-size: .65em auto;
        }

        /* === RESULT CARD (HASIL PENCARIAN) === */
        .result-container { max-width: 600px; margin: 0 auto; padding: 0 20px; }
        
        .card-result {
            border: 3px solid #000; border-radius: 15px; padding: 20px;
            background: #fff; box-shadow: 6px 6px 0 #000; margin-bottom: 40px;
            position: relative; display: none; /* Hidden by default */
        }

        .data-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; font-weight: 700; }
        .label { color: #555; width: 140px; }
        .value { color: #000; text-align: right; flex: 1; font-weight: 800; }

        /* ARROW DOWN ICON */
        .arrow-divider {
            text-align: center; font-size: 30px; margin: 20px 0; display: none;
        }

        /* === FORM INPUT SECTION === */
        .form-section { 
            max-width: 600px; margin: 0 auto; padding: 0 20px; 
            display: none; /* Hidden by default */
        }

        .input-pill {
            width: 100%; border: 2px solid #000; border-radius: 50px;
            padding: 15px 25px; font-size: 14px; font-weight: 700;
            margin-bottom: 15px; outline: none; text-align: center;
        }
        .input-pill::placeholder { color: #888; letter-spacing: 1px; }

        #sig-canvas {
            border: 2px solid #000; border-radius: 20px; width: 100%; height: 180px;
            background: #fff; margin-bottom: 5px;
        }

        .btn-action {
            width: 100%; background: #000; color: #fff; border: 2px solid #000;
            padding: 15px; border-radius: 50px; font-weight: 800; font-size: 16px;
            cursor: pointer; margin-top: 10px; transition: 0.1s;
        }
        .btn-action:active { transform: scale(0.98); }

        /* === BOTTOM NAV === */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; margin: 0 auto;
            width: 100%; max-width: 800px; background: white; border-top: 2px solid #000;
            display: flex; justify-content: space-around; align-items: center;
            padding: 16px 0; z-index: 9999; padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item { text-decoration: none; color: #999; font-size: 24px; width: 25%; display: flex; justify-content: center; }
        .nav-item.active { color: #000; }
    </style>
</head>
<body>

    <div class="header-section">
        <div class="header-pill">Superintendent</div>
    </div>

    <div class="filter-container">
        <select id="sel-bulan" class="filter-box" onchange="fetchData()">
            <option value="" disabled selected>Bulan</option>
            <option value="1">Januari</option><option value="2">Februari</option>
            <option value="3">Maret</option><option value="4">April</option>
            <option value="5">Mei</option><option value="6">Juni</option>
            <option value="7">Juli</option><option value="8">Agustus</option>
            <option value="9">September</option><option value="10">Oktober</option>
            <option value="11">November</option><option value="12">Desember</option>
        </select>
        
        <select id="sel-tahun" class="filter-box" onchange="fetchData()">
            <option value="" disabled selected>Tahun</option>
            <option value="2025">2025</option>
            <option value="2026">2026</option>
            <option value="2027">2027</option>
        </select>
        
        <select id="sel-mesin" class="filter-box" onchange="fetchData()">
            <option value="" disabled selected>Mesin</option>
            </select>
    </div>

    <div class="result-container">
        <div id="status-msg" style="text-align:center; font-size:12px; color:#888; margin-top:20px;">
            Silahkan pilih Bulan, Tahun, dan Mesin.
        </div>

        <div id="report-card" class="card-result">
            <div class="data-row">
                <span class="label">tanggal/bln/tahun</span>
                <span class="value">: <span id="val-date">-</span></span>
            </div>
            <div class="data-row">
                <span class="label">Kondisi mesin</span>
                <span class="value">: <span id="val-kondisi">-</span></span>
            </div>
            <div class="data-row">
                <span class="label">catatan koordinator</span>
                <span class="value">: <span id="val-note">-</span></span>
            </div>
        </div>
    </div>

    <div id="arrow-div" class="arrow-divider">
        <i class="fa-solid fa-arrow-down"></i>
    </div>

    <div id="form-super" class="form-section">
        <input type="text" id="nama_super" class="input-pill" placeholder="Nama Superintendent">
        <input type="text" id="catatan_super" class="input-pill" placeholder="catatan (opsional)">
        
        <div style="text-align:center; font-weight:800; font-size:12px; margin-bottom:5px; text-transform:uppercase;">paraf</div>
        <canvas id="sig-canvas"></canvas>
        <div style="text-align:right; margin-bottom:20px;">
            <button onclick="signaturePad.clear()" style="background:none; border:none; color:red; font-weight:bold; font-size:12px; cursor:pointer; text-decoration:underline;">HAPUS PARAF</button>
        </div>

        <button class="btn-action" id="btnSave" onclick="submitFinal()">APPROVE</button>
    </div>

    <nav class="bottom-nav">
        <a href="index.html" class="nav-item"><i class="fa-solid fa-house"></i></a>
        <a href="menu_utama.html" class="nav-item"><i class="fa-solid fa-bars"></i></a>
        <a href="download_data.html" class="nav-item"><i class="fa-solid fa-download"></i></a>
        <a href="informasi_akun.html" class="nav-item active"><i class="fa-solid fa-circle-user"></i></a>
    </nav>

    <script>
        // --- KONFIGURASI SUPABASE ---
        const SB_URL = "https://dsyvlavphvrdidmodokd.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
        const _sb = supabase.createClient(SB_URL, SB_KEY);

        const signaturePad = new SignaturePad(document.getElementById('sig-canvas'), {penColor:'black'});
        let currentLogId = null;

        // 1. INIT: Load Daftar Mesin saat Halaman Dibuka
        window.onload = async function() {
            resizeCanvas();
            // Ambil ID dan Nama Mesin
            const { data, error } = await _sb.from('pmi_machine').select('id, machine_name');
            const selMesin = document.getElementById('sel-mesin');
            
            if(data) {
                data.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.id; // VALUE ADALAH ID (Penting untuk Query)
                    opt.innerText = m.machine_name; // TEXT ADALAH NAMA (Penting untuk User)
                    selMesin.appendChild(opt);
                });
            } else if (error) {
                console.error("Gagal load mesin:", error);
            }
        };

        // 2. FETCH DATA: Saat Filter Berubah
        async function fetchData() {
            const bln = document.getElementById('sel-bulan').value;
            const thn = document.getElementById('sel-tahun').value;
            const mesId = document.getElementById('sel-mesin').value; // Ini berisi ID (integer)

            // Jangan jalan kalau filter belum lengkap
            if(!bln || !thn || !mesId) return;

            document.getElementById('status-msg').innerText = "Mencari data...";
            resetView();

            try {
                // Query ke pmi_log
                // Filter wajib: bulan, tahun, mesin_id, dan status 'Verified' (sudah di-acc koordinator)
                const { data, error } = await _sb.from('pmi_log')
                    .select(`
                        id, created_at, mesin_id, 
                        catatan_koordinator, status_verifikasi,
                        pmi_result(status)
                    `)
                    .eq('bulan', bln)
                    .eq('tahun', thn)
                    .eq('mesin_id', mesId) // Menggunakan ID (Angka)
                    .eq('status_verifikasi', 'Verified') 
                    .maybeSingle();

                if(error) throw error;

                if(!data) {
                    document.getElementById('status-msg').innerText = "Laporan tidak ditemukan / belum diverifikasi Koordinator.";
                    return;
                }

                // --- DATA DITEMUKAN ---
                currentLogId = data.id;
                document.getElementById('status-msg').style.display = 'none';
                
                // Format Tanggal: DD/MM/YYYY
                const dateObj = new Date(data.created_at);
                const dateStr = dateObj.getDate().toString().padStart(2,'0') + '/' + 
                                (dateObj.getMonth()+1).toString().padStart(2,'0') + '/' + 
                                dateObj.getFullYear();
                
                document.getElementById('val-date').innerText = dateStr;

                // Cek Kondisi (Looping result)
                // Jika ada SATU saja item 'NG', maka status Mesin = NG
                const hasNG = data.pmi_result.some(r => r.status === 'NG');
                const kondisiText = hasNG ? "NG" : "OK";
                const kondisiEl = document.getElementById('val-kondisi');
                
                kondisiEl.innerText = kondisiText;
                kondisiEl.style.color = hasNG ? '#e11d48' : '#166534'; // Merah atau Hijau

                // Catatan Koordinator
                document.getElementById('val-note').innerText = data.catatan_koordinator || "-";

                // Tampilkan Elemen UI
                document.getElementById('report-card').style.display = 'block';
                document.getElementById('arrow-div').style.display = 'block';
                document.getElementById('form-super').style.display = 'block';
                
                resizeCanvas(); // Resize canvas agar responsif

            } catch (err) {
                console.error(err);
                document.getElementById('status-msg').innerText = "Error: " + err.message;
            }
        }

        // 3. SUBMIT FINAL (APPROVE)
        async function submitFinal() {
            const nama = document.getElementById('nama_super').value.trim();
            if(!nama) return alert("ISI NAMA SUPERINTENDENT");
            if(signaturePad.isEmpty()) return alert("PARAF WAJIB DIISI");

            const btn = document.getElementById('btnSave');
            btn.innerText = "PROSES..."; btn.disabled = true;

            // Update database: isi data superintendent & ubah status jadi Completed
            const { error } = await _sb.from('pmi_log').update({
                status_verifikasi: 'Completed',
                nama_superintendent: nama,
                catatan_superintendent: document.getElementById('catatan_super').value,
                signature_superintendent: signaturePad.toDataURL(),
                completed_at: new Date().toISOString()
            }).eq('id', currentLogId);

            if(error) {
                alert("Gagal menyimpan: " + error.message);
                btn.innerText = "APPROVE"; btn.disabled = false;
            } else {
                alert("LAPORAN BERHASIL DI-APPROVE (COMPLETED)!");
                location.reload(); // Refresh halaman
            }
        }

        // Helper: Sembunyikan UI saat mencari ulang
        function resetView() {
            document.getElementById('report-card').style.display = 'none';
            document.getElementById('arrow-div').style.display = 'none';
            document.getElementById('form-super').style.display = 'none';
            currentLogId = null;
        }

        // Helper: Resize Signature Canvas
        function resizeCanvas() {
            const c = document.getElementById('sig-canvas');
            const r = Math.max(window.devicePixelRatio || 1, 1);
            c.width = c.offsetWidth * r; c.height = c.offsetHeight * r;
            c.getContext("2d").scale(r, r);
        }
    </script>
</body>
</html>
