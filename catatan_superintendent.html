<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catatan Superintendent</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --- STYLE GLOBAL --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        
        body { 
            background-color: #fff; 
            padding-bottom: 90px; 
            color: black;
        }

        /* HEADER JUDUL */
        .header-pill {
            margin: 40px auto 30px auto;
            text-align: center;
            border: 1px solid black;
            border-radius: 50px;
            padding: 15px 40px;
            width: fit-content;
            font-weight: 700;
            font-size: 16px;
            background: white;
            position: relative;
        }

        /* IKON ARSIP (POJOK KANAN ATAS) */
        .archive-icon-btn {
            position: absolute; top: 25px; right: 25px;
            font-size: 28px; cursor: pointer; color: black; z-index: 10;
        }
        .archive-badge { font-size: 10px; font-weight: bold; text-align: center; display: block; margin-top: -5px; }

        .container { padding: 20px; max-width: 500px; margin: 0 auto; }

        /* --- KARTU LIST --- */
        .inbox-card {
            background: white;
            border: 3px solid black;
            border-radius: 20px;
            margin-bottom: 25px;
            padding: 0;
            box-shadow: 8px 8px 0px #000;
            position: relative;
            cursor: pointer;
            overflow: hidden;
            transition: 0.1s;
        }
        .inbox-card:active { transform: translate(2px, 2px); box-shadow: 4px 4px 0px #000; }

        .inbox-card.archived {
            background: #f8f8f8; 
            border-color: #444;
            box-shadow: 4px 4px 0px #444;
        }

        .card-header-badge {
            background: white; border-bottom: 3px solid black; padding: 8px 20px;
            font-weight: 700; font-size: 13px; display: inline-block;
            border-right: 3px solid black; border-bottom-right-radius: 15px;
        }

        .card-body { padding: 20px; display: flex; justify-content: space-between; align-items: flex-start; }
        
        .info-lines { font-size: 13px; line-height: 1.6; font-style: italic; width: 85%; }
        .info-lines span { font-weight: 700; font-style: normal; }
        
        .arrow-icon { font-size: 24px; font-weight: 900; margin-top: 10px; }

        /* Tampilan Khusus Arsip: Catatan Super & Tombol Hapus */
        .super-note-display {
            margin-top: 10px; padding-top: 10px; border-top: 1px dashed #999;
            color: #DC2626; font-weight: bold; font-size: 12px;
        }
        .delete-btn {
            position: absolute; bottom: 15px; right: 15px;
            background: #ffe6e6; border: 2px solid red; color: red;
            width: 35px; height: 35px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 5;
        }

        /* --- HALAMAN DETAIL (OVERLAY) --- */
        #detail-view, #archive-list-view {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            background: white; z-index: 50; overflow-y: auto; padding: 20px;
        }

        .back-icon { position: absolute; top: 20px; left: 20px; font-size: 24px; cursor: pointer; }

        /* DETAIL BLOCKS */
        .detail-block {
            text-align: left; margin-bottom: 20px; border: 2px solid black;
            border-radius: 15px; padding: 15px; box-shadow: 4px 4px 0px #ddd;
        }
        .block-title { font-weight: 800; font-size: 14px; text-decoration: underline; margin-bottom: 8px; }
        .block-content { font-size: 13px; line-height: 1.5; }
        .block-label { font-size: 11px; color: #666; font-weight: 600; }

        /* INPUT SUPERINTENDENT */
        .super-section {
            text-align: center; margin-top: 30px; padding: 20px;
            border: 3px solid black; border-radius: 20px; box-shadow: 6px 6px 0px #000;
        }
        .super-input {
            border: none; border-bottom: 3px solid black; width: 80%;
            text-align: center; font-weight: 700; font-size: 16px; padding: 5px; margin-top: 10px;
            outline: none; background: transparent;
        }
        .super-input:focus { border-color: #DC2626; color: #DC2626; }

        .btn-arsip {
            background: black; color: white; border: none; border-radius: 15px;
            padding: 15px; width: 100%; font-weight: 700; margin-top: 20px;
            cursor: pointer; font-size: 14px; box-shadow: 4px 4px 0px #555;
        }

        /* MENU BAWAH */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; border-top: 2px solid #eee;
            display: flex; justify-content: space-around; padding: 20px 0; z-index: 99;
        }
        .nav-item { font-size: 24px; color: black; cursor: pointer; }

        .loading-text { text-align: center; margin-top: 50px; color: gray; font-style: italic; }
    </style>
</head>
<body>

    <div id="main-view">
        <div class="archive-icon-btn" onclick="bukaHalamanArsip()">
            <i class="fa fa-folder-open"></i>
            <span class="archive-badge">Arsip</span>
        </div>
        <div class="header-pill">Tugas Masuk</div>
        <div class="container" id="inbox-container">
            <div class="loading-text">Memuat tugas pending...</div>
        </div>
    </div>

    <div id="archive-list-view">
        <div class="back-icon" onclick="tutupArsip()"><i class="fa fa-arrow-left"></i></div>
        <div class="header-pill">Arsip Laporan</div>
        <div class="container" id="archive-container"></div>
    </div>

    <div id="detail-view">
        <div class="back-icon" onclick="tutupDetail()"><i class="fa fa-times"></i></div>
        
        <div class="header-pill" style="margin-top: 10px;">Review Laporan</div>

        <div style="max-width: 500px; margin: 0 auto;">
            
            <div class="detail-block" style="background: #eeffff; border-color: teal;">
                <div class="block-title">DATA MESIN & TANGGAL</div>
                <div class="block-content">
                    <span class="block-label">JENIS LAPORAN:</span><br>
                    <strong id="d-judul">...</strong><br><br>
                    <span class="block-label">MESIN:</span><br>
                    <strong id="d-mesin">...</strong><br>
                    <span class="block-label">TANGGAL LAPORAN:</span><br>
                    <strong id="d-tanggal">...</strong>
                </div>
            </div>

            <div class="detail-block">
                <div class="block-title">PELAKSANA (TEKNISI)</div>
                <div class="block-content">
                    <span class="block-label">NAMA:</span><br>
                    <strong id="d-pelaksana">...</strong><br><br>
                    <span class="block-label">CATATAN PELAKSANA:</span><br>
                    <i id="d-catatan-pelaksana">...</i>
                </div>
            </div>

            <div class="detail-block">
                <div class="block-title">KOORDINATOR</div>
                <div class="block-content">
                    <span class="block-label">DIPERIKSA OLEH:</span><br>
                    <strong id="d-koordinator">...</strong><br><br>
                    <span class="block-label">CATATAN KOORDINATOR:</span><br>
                    <i id="d-catatan-koordinator">...</i>
                </div>
            </div>

            <div class="super-section">
                <div style="font-size: 12px; font-weight: bold;">KEPUTUSAN ANDA:</div>
                <input type="text" id="d-super-note" class="super-input" placeholder="Tulis catatan..." value="Mantap">
                
                <button class="btn-arsip" onclick="prosesArsip()">
                    <i class="fa fa-check-circle"></i> SETUJUI & ARSIPKAN
                </button>
            </div>

        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item" onclick="window.location.href='home_akg.html'"><i class="fa fa-home"></i></div>
        <div class="nav-item"><i class="fa fa-bars"></i></div>
        <div class="nav-item"><i class="fa fa-download"></i></div>
        <div class="nav-item"><i class="fa fa-user-circle"></i></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://dsyvlavphvrdidmodokd.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E';
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let inboxData = [];
        let archiveData = [];
        let activeItem = null;

        // --- FETCH INBOX (PENDING) ---
        async function fetchInbox() {
            const container = document.getElementById('inbox-container');
            container.innerHTML = '<div class="loading-text">Memeriksa tugas...</div>';
            inboxData = [];

            try {
                // Fetch dari 4 tabel berbeda (Select All Columns)
                let { data: chslr } = await client.from('chslr_log').select('*').eq('status_verifikasi', true).eq('status_final', false);
                let { data: clhmi } = await client.from('clhmi').select('*').neq('approved_by', null).is('verified_by', null);
                let { data: pmi } = await client.from('pmi_header').select('*').neq('status_verifikasi', 'Pending').is('signature_superintendent', null);
                let { data: prslb } = await client.from('prslb_log').select('*').eq('status_verifikasi', true).eq('status_final', false);

                // Mapping Data agar seragam
                if(chslr) chslr.forEach(item => inboxData.push(mapData(item, 'chslr')));
                if(clhmi) clhmi.forEach(item => inboxData.push(mapData(item, 'clhmi')));
                if(pmi) pmi.forEach(item => inboxData.push(mapData(item, 'pmi')));
                if(prslb) prslb.forEach(item => inboxData.push(mapData(item, 'prslb')));

                renderList(container, inboxData, false);
            } catch (err) { console.error(err); }
        }

        // --- FETCH ARSIP (SELESAI) ---
        async function fetchArsip() {
            const container = document.getElementById('archive-container');
            container.innerHTML = '<div class="loading-text">Memuat arsip...</div>';
            archiveData = [];

            try {
                // Fetch data yang sudah final (Limit 20 biar ringan)
                let { data: chslr } = await client.from('chslr_log').select('*').eq('status_final', true).limit(20);
                let { data: clhmi } = await client.from('clhmi').select('*').not('verified_by', 'is', null).limit(20);
                let { data: pmi } = await client.from('pmi_header').select('*').not('signature_superintendent', 'is', null).limit(20);
                let { data: prslb } = await client.from('prslb_log').select('*').eq('status_final', true).limit(20);

                if(chslr) chslr.forEach(item => archiveData.push(mapData(item, 'chslr')));
                if(clhmi) clhmi.forEach(item => archiveData.push(mapData(item, 'clhmi')));
                if(pmi) pmi.forEach(item => archiveData.push(mapData(item, 'pmi')));
                if(prslb) prslb.forEach(item => archiveData.push(mapData(item, 'prslb')));

                renderList(container, archiveData, true);
            } catch (err) { console.error(err); }
        }

        // --- HELPER: MAPPING DATA (Agar field seragam) ---
        function mapData(item, type) {
            // Default Values
            let title = "", mesin = "", pelaksana = "", notePel = "-", koord = "", noteKoord = "-", noteSuper = "-";
            
            if (type === 'chslr') {
                title = "Checklist Standlabel & Robot";
                mesin = item.mesin_id || "Standlabel/Robot";
                pelaksana = (item.pelaksana_names || []).join(', ') || "Tim Pelaksana";
                notePel = item.catatan_pelaksana || "-";
                koord = item.koordinator_nama;
                noteKoord = item.remark_koordinator;
                noteSuper = item.remark_superintendent;
            } 
            else if (type === 'clhmi') {
                title = "Checklist Harian Injection";
                mesin = (item.merk_mesin || "") + " " + (item.tonage || ""); 
                pelaksana = item.pelaksana;
                notePel = "-"; // Di schema CLHMI catatan umum biasanya gabungan
                koord = item.approved_by;
                noteKoord = item.catatan_umum || "-";
                noteSuper = item.catatan_super;
            }
            else if (type === 'pmi') {
                title = "Preventif Injection (Clamping)";
                mesin = "ID Mesin: " + item.machine_id; // Kalau mau nama harus join, sementara pakai ID
                pelaksana = item.nama_pelaksana;
                notePel = item.catatan_pelaksana;
                koord = item.nama_koordinator;
                noteKoord = item.catatan_koordinator;
                noteSuper = item.catatan_superintendent;
            }
            else if (type === 'prslb') {
                title = "Preventif Robot & Standlabel";
                mesin = item.mesin_id;
                pelaksana = item.pelaksana_nama;
                notePel = "-"; 
                koord = item.koordinator_nama;
                noteKoord = item.koordinator_note;
                noteSuper = item.superintendent_note;
            }

            return {
                id: item.id,
                rawDate: item.created_at || item.tanggal_isi || item.tanggal, // Handle beda nama kolom tanggal
                type: type,
                title: title,
                mesin: mesin,
                pelaksana: pelaksana || "Operator",
                notePel: notePel || "Tidak ada catatan",
                koord: koord || "Koordinator",
                noteKoord: noteKoord || "Aman",
                noteSuper: noteSuper || "-",
                tableName: type === 'chslr' ? 'chslr_log' : type === 'clhmi' ? 'clhmi' : type === 'pmi' ? 'pmi_header' : 'prslb_log'
            };
        }

        // --- RENDER FUNCTION ---
        function renderList(container, data, isArchive) {
            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = `<div class="loading-text">${isArchive ? 'Arsip kosong.' : 'Semua pekerjaan beres! '}</div>`;
                return;
            }

            // Sort Terbaru
            data.sort((a, b) => new Date(b.rawDate) - new Date(a.rawDate));

            data.forEach((item, index) => {
                let tgl = new Date(item.rawDate).toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'});
                
                // HTML ARSIP (Ada Delete & Catatan Super)
                let archiveExtras = '';
                let clickAction = `onclick="bukaDetail(${index})"`;
                
                if (isArchive) {
                    clickAction = ''; // Arsip gak usah diklik detail lagi, infonya udah di kartu
                    archiveExtras = `
                        <div class="super-note-display">
                            Catatan superintendent: "${item.noteSuper}"
                        </div>
                        <div class="delete-btn" onclick="hapusArsip('${item.id}', '${item.tableName}')">
                            <i class="fa fa-trash"></i>
                        </div>
                    `;
                }

                let html = `
                <div class="inbox-card ${isArchive ? 'archived' : ''}" ${clickAction}>
                    <div class="card-header-badge">${item.title}</div>
                    <div class="card-body">
                        <div class="info-lines">
                            <span> ${tgl}</span><br>
                            <span> ${item.mesin}</span><br>
                             Koord: ${item.noteKoord}
                            ${archiveExtras}
                        </div>
                        ${!isArchive ? '<div class="arrow-icon"><i class="fa fa-arrow-right"></i></div>' : ''}
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        }

        // --- BUKA DETAIL (POPULATE DATA LENGKAP) ---
        function bukaDetail(index) {
            activeItem = inboxData[index];
            
            // Isi Data ke Overlay Detail
            document.getElementById('d-judul').innerText = activeItem.title;
            document.getElementById('d-mesin').innerText = activeItem.mesin;
            document.getElementById('d-tanggal').innerText = new Date(activeItem.rawDate).toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
            
            document.getElementById('d-pelaksana').innerText = activeItem.pelaksana;
            document.getElementById('d-catatan-pelaksana').innerText = `"${activeItem.notePel}"`;
            
            document.getElementById('d-koordinator').innerText = activeItem.koord;
            document.getElementById('d-catatan-koordinator').innerText = `"${activeItem.noteKoord}"`;

            document.getElementById('d-super-note').value = "Mantap"; // Reset input
            document.getElementById('detail-view').style.display = 'block';
        }

        function tutupDetail() { document.getElementById('detail-view').style.display = 'none'; }
        function bukaHalamanArsip() { document.getElementById('archive-list-view').style.display = 'block'; fetchArsip(); }
        function tutupArsip() { document.getElementById('archive-list-view').style.display = 'none'; }

        // --- ACTION: APPROVE ---
        async function prosesArsip() {
            if(!activeItem) return;
            const btn = document.querySelector('.btn-arsip');
            const note = document.getElementById('d-super-note').value;
            btn.innerText = "PROCESSING..."; btn.disabled = true;

            try {
                const { data: { user } } = await client.auth.getUser();
                const nama = user ? user.user_metadata.full_name : "Superintendent";
                let updateData = {};

                // Logic Update per Tabel
                if (activeItem.type === 'chslr') updateData = { status_final: true, superintendent_nama: nama, remark_superintendent: note };
                else if (activeItem.type === 'clhmi') updateData = { verified_by: nama, catatan_super: note, paraf_super: 'Signed' };
                else if (activeItem.type === 'pmi') updateData = { nama_superintendent: nama, signature_superintendent: 'Signed', catatan_superintendent: note };
                else if (activeItem.type === 'prslb') updateData = { status_final: true, superintendent_nama: nama, superintendent_note: note, signature_superintendent: 'Signed' };

                const { error } = await client.from(activeItem.tableName).update(updateData).eq('id', activeItem.id);
                if (error) throw error;

                alert("Berhasil disetujui!");
                tutupDetail();
                fetchInbox(); 
            } catch (err) { alert("Gagal: " + err.message); btn.disabled = false; }
        }

        // --- ACTION: HAPUS ARSIP ---
        async function hapusArsip(id, tableName) {
            if(!confirm("Yakin ingin menghapus arsip ini selamanya?")) return;
            
            try {
                const { error } = await client.from(tableName).delete().eq('id', id);
                if(error) throw error;
                
                alert("Arsip dihapus.");
                fetchArsip(); // Refresh list arsip
            } catch (err) {
                alert("Gagal hapus: " + err.message);
            }
        }

        fetchInbox(); // Load Awal
    </script>
</body>
</html>
