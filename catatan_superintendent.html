<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hasil Review Koordinator</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --- STYLE --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: #f8f9fa; padding-bottom: 90px; color: #333; }

        .header-pill {
            background: #fff; color: #000; margin: 30px auto 20px auto; text-align: center;
            border: 2px solid #000; border-radius: 50px; padding: 12px 30px; 
            width: fit-content; font-weight: 800; font-size: 16px; 
            box-shadow: 4px 4px 0px #000;
        }

        /* TOMBOL BUKA ARSIP (KANAN ATAS) */
        .top-icon-btn {
            position: absolute; top: 30px; right: 25px;
            font-size: 28px; cursor: pointer; color: black; z-index: 10;
        }
        .icon-label { font-size: 10px; font-weight: bold; text-align: center; display: block; margin-top: -5px; }

        .container { padding: 20px; max-width: 500px; margin: 0 auto; }

        /* KARTU LIST */
        .review-card {
            background: white; border: 2px solid #000; border-radius: 15px; 
            margin-bottom: 20px; padding: 20px; box-shadow: 4px 4px 0px #ccc;
            position: relative; transition: 0.2s; cursor: pointer;
        }
        .review-card:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px #ccc; }
        .review-card.is-archived { background: #f0f0f0; border-color: #666; }

        .card-top { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .card-type { font-size: 11px; font-weight: 800; text-transform: uppercase; background: #000; color: #fff; padding: 4px 10px; border-radius: 6px; }
        .card-date { font-size: 12px; font-weight: 600; color: #666; }
        .card-mesin { font-weight: 700; font-size: 14px; margin-bottom: 5px; display: block; }

        /* PREVIEW CATATAN SUPER DI LIST (REAL DATA) */
        .super-preview {
            margin-top: 10px; font-size: 12px; background: #fee2e2; color: #b91c1c; 
            padding: 8px; border-radius: 6px; font-weight: 600; border-left: 3px solid #ef4444;
        }

        /* TOMBOL HAPUS (TONG SAMPAH) */
        .delete-btn {
            position: absolute; bottom: 15px; right: 15px;
            width: 35px; height: 35px; background: white; border: 2px solid red; color: red;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 5; box-shadow: 2px 2px 0px #ccc;
        }

        /* HALAMAN ARSIP & DETAIL */
        #detail-overlay, #archive-page {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            background: #fff; z-index: 100; overflow-y: auto; padding: 20px;
        }
        .back-btn { font-size: 16px; font-weight: 700; cursor: pointer; margin-bottom: 20px; display: inline-block; }

        /* TIMELINE REAL DATA */
        .timeline-box {
            border-left: 3px solid #ddd; margin-left: 10px; padding-left: 20px; padding-bottom: 30px; position: relative;
        }
        .timeline-box::before {
            content: ''; position: absolute; left: -9px; top: 0; 
            width: 15px; height: 15px; border-radius: 50%; background: #ddd; border: 2px solid #fff;
        }
        
        .level-pelaksana { border-left-color: #3b82f6; } .level-pelaksana::before { background: #3b82f6; }
        .level-koordinator { border-left-color: #f59e0b; } .level-koordinator::before { background: #f59e0b; }
        .level-super { border-left-color: #ef4444; border-left: none; } .level-super::before { background: #ef4444; }

        .note-role { font-size: 12px; font-weight: 800; text-transform: uppercase; margin-bottom: 5px; display: block; }
        .note-name { font-size: 13px; font-weight: 600; color: #555; margin-bottom: 8px; display: block; }
        .note-content { 
            background: #f9f9f9; border: 1px solid #eee; padding: 10px; border-radius: 8px; 
            font-size: 13px; font-style: italic; color: #333; line-height: 1.5;
        }

        /* TOMBOL ARSIPKAN SEKARANG */
        .btn-action {
            width: 100%; padding: 15px; background: #000; color: white;
            border: none; border-radius: 12px; font-weight: 700; font-size: 14px;
            cursor: pointer; margin-top: 30px; box-shadow: 4px 4px 0px #555;
        }
        .btn-action:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px #555; }

        /* MENU BAWAH */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; border-top: 2px solid #000;
            display: flex; justify-content: space-around; padding: 15px 0; z-index: 99;
        }
        .nav-item { font-size: 24px; color: #000; cursor: pointer; opacity: 0.5; }
        .nav-item.active { opacity: 1; transform: scale(1.1); }
        .loading-text { text-align: center; margin-top: 50px; color: gray; font-style: italic; }
    </style>
</head>
<body>

    <div id="main-view">
        <div class="top-icon-btn" onclick="bukaHalamanArsip()">
            <i class="fa fa-folder-open"></i>
            <span class="icon-label">Arsip Saya</span>
        </div>

        <div class="header-pill">Feedback Masuk</div>
        
        <div class="container" id="inbox-container">
            <div class="loading-text">Memuat laporan...</div>
        </div>
    </div>

    <div id="archive-page">
        <div class="back-btn" onclick="tutupArsip()"><i class="fa fa-arrow-left"></i> Kembali</div>
        <div class="header-pill">Arsip Koordinator</div>
        <div class="container" id="archive-container">
            <div class="loading-text">Memuat arsip...</div>
        </div>
    </div>

    <div id="detail-overlay">
        <div class="back-btn" onclick="tutupDetail()"><i class="fa fa-times"></i> Tutup</div>
        
        <h2 style="font-size:16px; font-weight:800; margin-top:10px; margin-bottom:5px;" id="d-judul">JUDUL</h2>
        <div style="font-size:13px; color:#666; margin-bottom:30px;" id="d-mesin">Mesin</div>

        <div class="timeline-box level-pelaksana">
            <span class="note-role" style="color:#3b82f6;">1. PELAKSANA (TEKNISI)</span>
            <span class="note-name" id="d-nama-pelaksana">...</span>
            <div class="note-content" id="d-note-pelaksana">...</div>
        </div>

        <div class="timeline-box level-koordinator">
            <span class="note-role" style="color:#f59e0b;">2. KOORDINATOR (ANDA)</span>
            <span class="note-name" id="d-nama-koordinator">...</span>
            <div class="note-content" id="d-note-koordinator">...</div>
        </div>

        <div class="timeline-box level-super">
            <span class="note-role" style="color:#ef4444;">3. SUPERINTENDENT (BOS)</span>
            <span class="note-name" id="d-nama-super">...</span>
            <div class="note-content" id="d-note-super" style="background:#fef2f2; border-color:#fecaca; color:#b91c1c; font-weight:bold;">...</div>
        </div>

        <button id="btn-archive-action" class="btn-action" onclick="prosesArsip()">
            <i class="fa fa-archive"></i> ARSIPKAN SEKARANG
        </button>
    </div>

    <div class="bottom-nav">
        <div class="nav-item" onclick="window.location.href='home_akg.html'"><i class="fa fa-home"></i></div>
        <div class="nav-item active"><i class="fa fa-envelope-open-text"></i></div>
        <div class="nav-item"><i class="fa fa-clipboard-list"></i></div>
        <div class="nav-item"><i class="fa fa-user"></i></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://dsyvlavphvrdidmodokd.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E';
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let inboxData = [];
        let archiveData = [];
        let activeItem = null;

        // 1. FETCH INBOX (Final = True, Archived = False)
        async function fetchInbox() {
            const container = document.getElementById('inbox-container');
            container.innerHTML = '<div class="loading-text">Cek laporan baru...</div>';
            inboxData = [];

            try {
                let { data: chslr } = await client.from('chslr_log').select('*').eq('status_final', true).eq('coordinator_archived', false);
                let { data: clhmi } = await client.from('clhmi').select('*').not('verified_by', 'is', null).eq('coordinator_archived', false);
                let { data: pmi } = await client.from('pmi_header').select('*').not('signature_superintendent', 'is', null).eq('coordinator_archived', false);
                let { data: prslb } = await client.from('prslb_log').select('*').eq('status_final', true).eq('coordinator_archived', false);

                if(chslr) chslr.forEach(item => inboxData.push(formatData(item, 'chslr')));
                if(clhmi) clhmi.forEach(item => inboxData.push(formatData(item, 'clhmi')));
                if(pmi) pmi.forEach(item => inboxData.push(formatData(item, 'pmi')));
                if(prslb) prslb.forEach(item => inboxData.push(formatData(item, 'prslb')));

                renderList(container, inboxData, false);
            } catch (err) { console.error(err); }
        }

        // 2. FETCH ARSIP (Final = True, Archived = True)
        async function fetchArsip() {
            const container = document.getElementById('archive-container');
            container.innerHTML = '<div class="loading-text">Memuat arsip...</div>';
            archiveData = [];

            try {
                let { data: chslr } = await client.from('chslr_log').select('*').eq('status_final', true).eq('coordinator_archived', true).limit(20);
                let { data: clhmi } = await client.from('clhmi').select('*').not('verified_by', 'is', null).eq('coordinator_archived', true).limit(20);
                let { data: pmi } = await client.from('pmi_header').select('*').not('signature_superintendent', 'is', null).eq('coordinator_archived', true).limit(20);
                let { data: prslb } = await client.from('prslb_log').select('*').eq('status_final', true).eq('coordinator_archived', true).limit(20);

                if(chslr) chslr.forEach(item => archiveData.push(formatData(item, 'chslr')));
                if(clhmi) clhmi.forEach(item => archiveData.push(formatData(item, 'clhmi')));
                if(pmi) pmi.forEach(item => archiveData.push(formatData(item, 'pmi')));
                if(prslb) prslb.forEach(item => archiveData.push(formatData(item, 'prslb')));

                renderList(container, archiveData, true);
            } catch (err) { console.error(err); }
        }

        // 3. MAPPING DATA (PURE DB COLS)
        function formatData(item, type) {
            let res = {
                id: item.id, tableName: '', rawDate: item.created_at || item.tanggal_isi || item.tanggal,
                typeLabel: '', mesin: '', 
                pelaksanaName: '', pelaksanaNote: '',
                koordName: '', koordNote: '',
                superName: '', superNote: ''
            };

            // Mapping PURE ke Kolom DB (Tanpa Default Text)
            if (type === 'chslr') {
                res.tableName = 'chslr_log'; res.typeLabel = 'CHSLR (Robot)';
                res.mesin = item.mesin_id;
                res.pelaksanaName = (item.pelaksana_names || []).join(', '); 
                res.pelaksanaNote = item.catatan_pelaksana;
                res.koordName = item.koordinator_nama; 
                res.koordNote = item.remark_koordinator;
                res.superName = item.superintendent_nama; 
                res.superNote = item.remark_superintendent; // REAL
            } 
            else if (type === 'clhmi') {
                res.tableName = 'clhmi'; res.typeLabel = 'CLHMI (Injection)';
                res.mesin = (item.merk_mesin || '') + ' ' + (item.tonage || '');
                res.pelaksanaName = item.pelaksana; 
                res.pelaksanaNote = null;
                res.koordName = item.approved_by; 
                res.koordNote = item.catatan_umum;
                res.superName = item.verified_by; 
                res.superNote = item.catatan_super; // REAL
            }
            else if (type === 'pmi') {
                res.tableName = 'pmi_header'; res.typeLabel = 'PMI (Preventif)';
                res.mesin = item.machine_id;
                res.pelaksanaName = item.nama_pelaksana; 
                res.pelaksanaNote = item.catatan_pelaksana;
                res.koordName = item.nama_koordinator; 
                res.koordNote = item.catatan_koordinator;
                res.superName = item.nama_superintendent; 
                res.superNote = item.catatan_superintendent; // REAL
            }
            else if (type === 'prslb') {
                res.tableName = 'prslb_log'; res.typeLabel = 'PRSLB (Preventif)';
                res.mesin = item.mesin_id;
                res.pelaksanaName = item.pelaksana_nama; 
                res.pelaksanaNote = null;
                res.koordName = item.koordinator_nama; 
                res.koordNote = item.koordinator_note;
                res.superName = item.superintendent_nama; 
                res.superNote = item.superintendent_note; // REAL
            }

            // Fallback Kosong (Hanya Strip)
            if(!res.pelaksanaNote) res.pelaksanaNote = "-";
            if(!res.koordNote) res.koordNote = "-";
            if(!res.superNote) res.superNote = "-"; // BIAR KETAHUAN KALAU KOSONG

            return res;
        }

        // 4. RENDER HTML
        function renderList(container, data, isArchive) {
            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = `<div class="loading-text">${isArchive ? 'Arsip kosong.' : 'Tidak ada laporan baru.'}</div>`;
                return;
            }

            data.sort((a, b) => new Date(b.rawDate) - new Date(a.rawDate));

            data.forEach((item, index) => {
                let tgl = new Date(item.rawDate).toLocaleDateString('id-ID');
                let deleteBtn = isArchive ? `<div class="delete-btn" onclick="event.stopPropagation(); hapusArsip('${item.id}', '${item.tableName}')"><i class="fa fa-trash"></i></div>` : '';

                let html = `
                <div class="review-card ${isArchive ? 'is-archived' : ''}" onclick="bukaDetail(${index}, ${isArchive})">
                    <div class="card-top">
                        <span class="card-type">${item.typeLabel}</span>
                        <span class="card-date">${tgl}</span>
                    </div>
                    <span class="card-mesin">${item.mesin}</span>
                    <div class="super-preview">
                        <i class="fa fa-comment-dots"></i> Bos: "${item.superNote}"
                    </div>
                    ${deleteBtn}
                </div>`;
                container.innerHTML += html;
            });
        }

        function bukaDetail(index, isArchive) {
            activeItem = isArchive ? archiveData[index] : inboxData[index];
            
            document.getElementById('d-judul').innerText = activeItem.typeLabel;
            document.getElementById('d-mesin').innerText = activeItem.mesin + " (" + new Date(activeItem.rawDate).toLocaleDateString() + ")";

            document.getElementById('d-nama-pelaksana').innerText = activeItem.pelaksanaName || "Teknisi";
            document.getElementById('d-note-pelaksana').innerText = activeItem.pelaksanaNote;

            document.getElementById('d-nama-koordinator').innerText = activeItem.koordName || "Anda";
            document.getElementById('d-note-koordinator').innerText = activeItem.koordNote;

            document.getElementById('d-nama-super').innerText = activeItem.superName || "Superintendent";
            document.getElementById('d-note-super').innerText = activeItem.superNote; // REAL DB DATA

            const btn = document.getElementById('btn-archive-action');
            if (isArchive) {
                btn.style.display = 'none';
            } else {
                btn.style.display = 'block';
                btn.innerHTML = '<i class="fa fa-archive"></i> ARSIPKAN SEKARANG';
            }

            document.getElementById('detail-overlay').style.display = 'block';
        }

        function tutupDetail() { document.getElementById('detail-overlay').style.display = 'none'; }
        function bukaHalamanArsip() { document.getElementById('archive-page').style.display = 'block'; fetchArsip(); }
        function tutupArsip() { document.getElementById('archive-page').style.display = 'none'; fetchInbox(); }

        async function prosesArsip() {
            if(!activeItem) return;
            const btn = document.getElementById('btn-archive-action');
            btn.innerHTML = 'Menyimpan...'; btn.disabled = true;
            try {
                const { error } = await client.from(activeItem.tableName).update({ coordinator_archived: true }).eq('id', activeItem.id);
                if(error) throw error;
                alert("Diarsipkan!");
                tutupDetail();
                fetchInbox();
            } catch (err) { alert("Error: " + err.message); btn.disabled = false; }
        }

        async function hapusArsip(id, tableName) {
            if(!confirm("Hapus selamanya?")) return;
            try {
                const { error } = await client.from(tableName).delete().eq('id', id);
                if(error) throw error;
                fetchArsip();
            } catch (err) { alert("Error: " + err.message); }
        }

        fetchInbox();
    </script>
</body>
</html>
