<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <title>Koordinator Verifikasi</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* === GLOBAL RESET === */
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; outline: none; }
        body, html {
            height: 100%; width: 100%; overflow: hidden;
            font-family: 'Inter', sans-serif; background-color: #f5f5f5; color: #000;
        }

        /* === APP SHELL (Mobile Frame) === */
        #app-shell {
            display: flex; flex-direction: column; height: 100dvh;
            width: 100%; max-width: 480px; margin: 0 auto; 
            background: white; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* Content Area (Scrollable) */
        .app-content {
            flex: 1; overflow-y: auto; overflow-x: hidden; position: relative;
            padding: 20px; padding-bottom: 100px; /* Space for Bottom Nav */
            display: flex; flex-direction: column; align-items: center;
        }

        /* === UI COMPONENTS (WIREFRAME STYLE) === */
        
        /* 1. HEADER */
        .header-pill {
            background: white; border: 3px solid #000; border-radius: 99px;
            padding: 12px 40px; font-weight: 900; font-size: 16px; 
            letter-spacing: 1px; text-transform: uppercase;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.15); margin-top: 10px; margin-bottom: 25px;
        }

        /* 2. CARD ITEM (LIST) */
        .card-item {
            width: 100%; background: white; border: 3px solid #000; border-radius: 16px;
            padding: 16px; margin-bottom: 16px; position: relative;
            box-shadow: 5px 5px 0 #000; transition: transform 0.1s;
            cursor: pointer;
        }
        .card-item:active { transform: translate(2px, 2px); box-shadow: 3px 3px 0 #000; }
        
        .card-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 6px; align-items: center; }
        .lbl { font-weight: 700; color: #444; }
        .val { font-weight: 800; text-transform: uppercase; text-align: right; }
        .status-badge {
            display: inline-block; background: #000; color: #fff; 
            font-size: 10px; font-weight: 800; padding: 6px 12px; 
            border-radius: 6px; margin-top: 8px; width: 100%; text-align: center;
        }

        /* 3. INFO BOX (FORM) */
        .info-box {
            width: 100%; background: #f8f9fa; border: 3px solid #000; border-radius: 16px;
            padding: 16px; margin-bottom: 24px; box-shadow: 4px 4px 0 #000;
        }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 11px; align-items: flex-start; }
        .i-lbl { font-weight: 700; width: 35%; color: #333; }
        .i-sep { width: 5%; text-align: center; font-weight: 700; }
        .i-val { font-weight: 900; width: 60%; text-align: right; text-transform: uppercase; line-height: 1.3; }

        /* 4. INPUTS */
        .label-input { font-size: 12px; font-weight: 800; margin-bottom: 6px; align-self: flex-start; margin-left: 4px; }
        
        .input-field {
            width: 100%; border: 3px solid #000; border-radius: 12px;
            padding: 14px; font-weight: 700; font-size: 14px; text-align: center;
            background: white; outline: none; margin-bottom: 20px;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.1);
        }
        .input-field:focus { box-shadow: 3px 3px 0 #000; }

        /* 5. CANVAS PARAF */
        .signature-container {
            width: 100%; height: 140px; background: white;
            border: 3px solid #000; border-radius: 16px;
            position: relative; overflow: hidden; margin-bottom: 25px;
            /* Pattern dot background agar terlihat area tanda tangan */
            background-image: radial-gradient(#ccc 1px, transparent 1px);
            background-size: 10px 10px;
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* 6. BUTTONS */
        .btn-main {
            background: #000; color: #fff; width: 100%; padding: 16px;
            border: 3px solid #000; border-radius: 14px;
            font-weight: 900; font-size: 14px; text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3); transition: all 0.1s;
        }
        .btn-main:active { transform: translateY(2px); box-shadow: 2px 2px 0 rgba(0,0,0,0.3); }
        .btn-main:disabled { background: #666; border-color: #666; cursor: not-allowed; transform: none; box-shadow: none; }

        .btn-text {
            background: none; border: none; font-weight: 800; font-size: 12px; 
            text-decoration: underline; padding: 10px; margin-top: 10px; color: #000;
        }

        /* 7. SCANNER OVERLAY (FIXED ASPECT RATIO) */
        .scanner-wrapper {
            position: relative; width: 280px; height: 280px; margin: 20px 0;
            border: 4px solid #000; border-radius: 20px; overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); background: #000;
        }
        #reader { width: 100%; height: 100%; }
        #reader video { object-fit: cover; width: 100%; height: 100%; }
        
        /* HIDE DEFAULT HTML5-QRCODE UI */
        #reader__dashboard_section_csr span, 
        #reader__dashboard_section_swaplink { display: none !important; }

        /* Overlay Garis Scan */
        .scan-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            background: linear-gradient(to bottom, transparent 45%, rgba(0,255,0,0.3) 50%, transparent 55%);
            animation: scanAnim 2s infinite linear;
        }
        @keyframes scanAnim { 0% { transform: translateY(-100%); } 100% { transform: translateY(100%); } }

        /* 8. BOTTOM NAV */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 80px;
            background: white; border-top: 3px solid #000;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 50; padding-bottom: 10px;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #aaa; text-decoration: none; }
        .nav-item.active { color: #000; }
        .nav-item i { font-size: 24px; margin-bottom: 4px; }
        .nav-item span { font-size: 10px; font-weight: 800; text-transform: uppercase; }

        /* Helpers */
        .hidden { display: none !important; }
        .text-red-custom { color: #d32f2f; }
        .animate-fade { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="app-shell">

        <main class="app-content">
            
            <div class="header-pill">Koordinator</div>

            <div id="view-list" class="w-full flex flex-col items-center animate-fade">
                <div class="w-full flex justify-between items-end mb-4 px-1">
                    <h2 class="text-sm font-black uppercase">Antrean Laporan</h2>
                    <button onclick="loadQueue()" class="text-[10px] font-bold underline">Refresh</button>
                </div>
                
                <div id="log-container" class="w-full">
                    <div class="text-center py-10 opacity-50">
                        <i class="fa-solid fa-circle-notch fa-spin text-2xl mb-2"></i>
                        <p class="font-bold text-xs uppercase">Memuat data...</p>
                    </div>
                </div>
            </div>

            <div id="view-scanner" class="hidden w-full flex flex-col items-center h-full animate-fade">
                <p class="text-[11px] font-bold text-center uppercase mb-6 px-4 leading-relaxed">
                    Arahkan kamera ke QR Code Mesin<br>untuk memverifikasi laporan.
                </p>
                
                <div class="scanner-wrapper">
                    <div id="reader"></div>
                    <div class="scan-overlay"></div>
                </div>

                <div class="bg-black text-white px-4 py-1 rounded-full text-[10px] font-bold uppercase mb-6 tracking-widest">
                    Scanning...
                </div>

                <button onclick="backToList()" class="btn-text">Batalkan Scan</button>
            </div>

            <div id="view-form" class="hidden w-full flex flex-col items-center animate-fade">
                
                <div class="info-box">
                    <div class="info-row">
                        <span class="i-lbl">MESIN</span> <span class="i-sep">:</span> <span id="form-mesin" class="i-val">...</span>
                    </div>
                    <div class="info-row">
                        <span class="i-lbl">PELAKSANA</span> <span class="i-sep">:</span> <span id="form-pelaksana" class="i-val">...</span>
                    </div>
                    <div class="info-row border-t border-dashed border-gray-400 mt-2 pt-2">
                        <span class="i-lbl">CATATAN</span> <span class="i-sep">:</span> 
                        <span id="form-catatan-pel" class="i-val">...</span>
                    </div>
                </div>

                <label class="label-input">NAMA KOORDINATOR</label>
                <input type="text" id="koor-name" class="input-field" placeholder="Nama Lengkap">

                <label class="label-input">CATATAN TAMBAHAN (OPSIONAL)</label>
                <textarea id="koor-remark" rows="2" class="input-field resize-none !text-left" placeholder="Tulis catatan jika ada..."></textarea>
                
                <div class="w-full flex justify-between items-end mb-1 px-1">
                    <label class="label-input !mb-0">TANDA TANGAN</label>
                    <button onclick="clearPad()" class="text-[10px] font-bold text-red-600 underline uppercase">Hapus Ttd</button>
                </div>
                <div class="signature-container">
                    <canvas id="signature-pad-koor"></canvas>
                </div>

                <button onclick="submitApproval()" id="btn-approve" class="btn-main">
                    VERIFIKASI & SIMPAN
                </button>

                <button onclick="backToList()" class="btn-text">Kembali / Batal</button>
            </div>

        </main>

        <nav class="bottom-nav">
            <a href="index.html" class="nav-item"><i class="fa-solid fa-house"></i><span>Home</span></a>
            <a href="menu_utama.html" class="nav-item"><i class="fa-solid fa-bars"></i><span>Menu</span></a>
            <a href="download_data.html" class="nav-item"><i class="fa-solid fa-download"></i><span>Data</span></a>
            <a href="informasi_akun.html" class="nav-item"><i class="fa-solid fa-user"></i><span>Akun</span></a>
        </nav>

    </div>

    <script>
        const SB_URL = "https://dsyvlavphvrdidmodokd.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
        const _sb = supabase.createClient(SB_URL, SB_KEY);
        
        let activeLog = null;
        let scanner = null;
        let sigPadKoor = null;

        // --- INIT ---
        window.onload = function() {
            loadQueue();
            
            // Setup Signature Pad dengan Resize agar tidak blur/kecil
            const canvas = document.getElementById('signature-pad-koor');
            function resizeCanvas() {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
            }
            window.addEventListener("resize", resizeCanvas);
            resizeCanvas();
            sigPadKoor = new SignaturePad(canvas, { backgroundColor: 'rgba(255, 255, 255, 0)' });
        };

        function clearPad() {
            if(sigPadKoor) sigPadKoor.clear();
        }

        // --- NAVIGATION & ROUTING ---
        function switchView(viewId) {
            ['view-list', 'view-scanner', 'view-form'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
        }

        async function backToList() {
            if(scanner) {
                try {
                    if(scanner.getState() === Html5QrcodeScannerState.SCANNING || scanner.getState() === Html5QrcodeScannerState.PAUSED) {
                        await scanner.stop();
                    }
                } catch (e) { console.log("Scanner stop handled", e); }
                try { scanner.clear(); } catch(e) {}
            }
            switchView('view-list');
            activeLog = null;
            loadQueue(); // Auto refresh agar data update
        }

        // --- 1. LOAD QUEUE (Filtered & Updated) ---
        async function loadQueue() {
            const now = new Date();
            const todayDate = now.getDate();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();

            const container = document.getElementById('log-container');
            container.innerHTML = '<div class="text-center py-10 opacity-50"><i class="fa-solid fa-circle-notch fa-spin"></i></div>';

            // Filter: Bulan Ini & Belum Diverifikasi
            const { data: logs, error } = await _sb.from('chslr_log')
                .select('*')
                .eq('bulan', currentMonth)
                .eq('tahun', currentYear)
                .neq('status_verifikasi', true); 

            if (!logs || logs.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-10 opacity-40 border-2 border-dashed border-gray-300 rounded-xl">
                        <i class="fa-regular fa-folder-open text-4xl mb-2"></i>
                        <p class="font-bold text-xs uppercase">Tidak ada antrean laporan.</p>
                    </div>`;
                return;
            }

            container.innerHTML = "";
            let countVisible = 0;

            for (let log of logs) {
                // Cek apakah ada inputan hari ini di tabel result?
                const { data: results } = await _sb.from('chslr_result')
                    .select('id')
                    .eq('log_id', log.id)
                    .eq('tanggal', todayDate)
                    .limit(1);

                // Hanya tampilkan jika pelaksana SUDAH mengisi hari ini
                if (results && results.length > 0) {
                    countVisible++;
                    const names = log.pelaksana_names ? log.pelaksana_names.join(', ') : '-';
                    const dateStr = `${todayDate}/${currentMonth}/${currentYear}`;

                    container.insertAdjacentHTML('beforeend', `
                        <div class="card-item" onclick="startScanner('${encodeURIComponent(JSON.stringify(log))}')">
                            <div class="card-row">
                                <span class="lbl">MESIN</span> <span class="val">${log.mesin_id}</span>
                            </div>
                            <div class="card-row">
                                <span class="lbl">PELAKSANA</span> <span class="val" style="font-size:10px;">${names}</span>
                            </div>
                            <div class="card-row">
                                <span class="lbl">TANGGAL</span> <span class="val">${dateStr}</span>
                            </div>
                            <div class="status-badge">KETUK UNTUK VERIFIKASI</div>
                        </div>
                    `);
                }
            }

            if (countVisible === 0) {
                container.innerHTML = `
                    <div class="text-center py-10 opacity-40 border-2 border-dashed border-gray-300 rounded-xl">
                        <i class="fa-solid fa-clock text-4xl mb-2"></i>
                        <p class="font-bold text-xs uppercase">Menunggu Pelaksana Input Data Hari Ini...</p>
                    </div>`;
            }
        }

        // --- 2. SCANNER LOGIC ---
        function startScanner(logStr) {
            activeLog = JSON.parse(decodeURIComponent(logStr));
            switchView('view-scanner');
            
            if(!scanner) scanner = new Html5Qrcode("reader");
            
            const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
            scanner.start({ facingMode: "environment" }, config, onScanSuccess)
                   .catch(err => {
                       alert("Gagal membuka kamera: " + err);
                       backToList();
                   });
        }

        async function onScanSuccess(decodedText) {
            // Validasi QR Code Mesin
            if (activeLog.mesin_id.toLowerCase().trim() === decodedText.toLowerCase().trim()) {
                if(navigator.vibrate) navigator.vibrate(100);
                
                // Stop Scanner Aman
                try { await scanner.stop(); scanner.clear(); } catch(e){}
                
                openForm();
            } else {
                // Tampilkan alert tapi JANGAN stop scanner agar bisa coba lagi
                alert(`❌ QR SALAH!\nTerbaca: ${decodedText}\nTarget: ${activeLog.mesin_id}`);
            }
        }

        // --- 3. FORM LOGIC (DATA FETCHING) ---
        async function openForm() {
            switchView('view-form');
            // Reset Form UI
            document.getElementById('form-mesin').innerText = activeLog.mesin_id;
            document.getElementById('form-pelaksana').innerText = activeLog.pelaksana_names ? activeLog.pelaksana_names.join(', ') : '-';
            document.getElementById('koor-name').value = "";
            document.getElementById('koor-remark').value = "";
            sigPadKoor.clear();
            
            const noteEl = document.getElementById('form-catatan-pel');
            noteEl.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            noteEl.className = "i-val"; 

            // Ambil Data Result Hari Ini
            const today = new Date().getDate();
            const { data: results } = await _sb.from('chslr_result')
                .select('status, keterangan, chslr_items(item_name)')
                .eq('log_id', activeLog.id)
                .eq('tanggal', today);

            // Logika Penentuan Catatan
            let finalNote = "-";
            let hasNG = false;
            let ngNotes = [];

            if (results && results.length > 0) {
                results.forEach(r => {
                    if (r.status === 'NG') {
                        hasNG = true;
                        const item = r.chslr_items ? r.chslr_items.item_name : 'Item';
                        const ket = r.keterangan || 'Rusak';
                        ngNotes.push(`${item} (${ket})`);
                    }
                });

                if (hasNG) {
                    finalNote = "NG: " + ngNotes.join(', ');
                    noteEl.classList.add('text-red-custom'); // Merah
                } else {
                    // Jika OK Semua -> Ambil Catatan Header (Log)
                    if (activeLog.catatan && activeLog.catatan.trim() !== "") {
                        finalNote = activeLog.catatan;
                    } else {
                        finalNote = "KONDISI OK (AMAN)";
                    }
                    noteEl.classList.remove('text-red-custom');
                }
            } else {
                finalNote = "Data checklist belum masuk.";
            }

            noteEl.innerText = finalNote;
            
            // Resize Canvas lagi untuk memastikan rendering benar saat hidden->visible
            const canvas = document.getElementById('signature-pad-koor');
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
        }

        // --- 4. SUBMIT ACTION ---
        async function submitApproval() {
            const name = document.getElementById('koor-name').value.trim();
            const remark = document.getElementById('koor-remark').value.trim();
            const btn = document.getElementById('btn-approve');

            // Validasi
            if(!name) return alert("⚠️ Nama Koordinator wajib diisi!");
            if(sigPadKoor.isEmpty()) return alert("⚠️ Harap tanda tangan dulu!");

            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> MENYIMPAN...';
            btn.disabled = true;

            try {
                const { error } = await _sb.from('chslr_log').update({
                    koordinator_nama: name,
                    signature_koordinator: sigPadKoor.toDataURL(),
                    status_verifikasi: true, // SET VERIFIED -> HILANG DARI LIST
                    remark_koordinator: remark
                }).eq('id', activeLog.id);

                if (error) throw error;

                alert("✅ VERIFIKASI BERHASIL!");
                await backToList(); // Kembali ke list (otomatis refresh & hilang)

            } catch (err) {
                alert("Gagal menyimpan: " + err.message);
                btn.innerHTML = 'VERIFIKASI & SIMPAN'; 
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
