<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <title>Koordinator Verifikasi</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* === RESET & CORE === */
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; outline: none; }
        body, html { height: 100%; width: 100%; overflow: hidden; font-family: 'Inter', sans-serif; background-color: #ffffff; color: #000; }

        /* === APP SHELL === */
        #app-shell { display: flex; flex-direction: column; height: 100dvh; max-width: 480px; margin: 0 auto; background: white; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        .app-content { flex: 1; overflow-y: auto; position: relative; padding: 20px; padding-bottom: 100px; display: flex; flex-direction: column; align-items: center; }

        /* === UI COMPONENTS === */
        .header-pill { border: 3px solid #000; border-radius: 99px; padding: 12px 40px; text-align: center; font-weight: 900; text-transform: uppercase; font-size: 16px; letter-spacing: 1px; background: white; margin-top: 10px; margin-bottom: 25px; box-shadow: 4px 4px 0 rgba(0,0,0,0.15); }

        .card-item { width: 100%; background: white; border: 3px solid #000; border-radius: 16px; padding: 15px; margin-bottom: 15px; position: relative; box-shadow: 5px 5px 0 #000; transition: transform 0.1s; cursor: pointer; }
        .card-item:active { transform: translate(2px, 2px); box-shadow: 3px 3px 0 #000; }
        .card-row { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 5px; align-items: center; }
        .lbl { font-weight: 700; color: #333; }
        .val { font-weight: 800; text-transform: uppercase; text-align: right; }
        .badge-status { display: block; width: 100%; background: #000; color: #fff; text-align: center; font-size: 10px; font-weight: 800; padding: 6px; border-radius: 6px; margin-top: 8px; text-transform: uppercase; }

        .info-box { width: 100%; background: #f8f9fa; border: 3px solid #000; border-radius: 16px; padding: 15px; margin-bottom: 20px; box-shadow: 4px 4px 0 #000; }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 11px; align-items: flex-start; }
        .i-lbl { font-weight: 700; width: 35%; }
        .i-sep { font-weight: 700; width: 5%; text-align: center; }
        .i-val { font-weight: 900; width: 60%; text-align: right; text-transform: uppercase; line-height: 1.3; word-break: break-word; }

        .label-input { font-size: 12px; font-weight: 800; margin-bottom: 5px; align-self: flex-start; margin-left: 5px; }
        .input-field { width: 100%; border: 3px solid #000; border-radius: 12px; padding: 12px; font-weight: 700; font-size: 13px; text-align: center; background: white; outline: none; margin-bottom: 15px; box-shadow: 3px 3px 0 rgba(0,0,0,0.1); }
        .input-field:focus { box-shadow: 3px 3px 0 #000; }

        .sig-wrapper { width: 100%; height: 130px; background: white; border: 3px solid #000; border-radius: 16px; position: relative; overflow: hidden; margin-bottom: 20px; background-image: radial-gradient(#ccc 1px, transparent 1px); background-size: 10px 10px; }
        canvas { display: block; width: 100%; height: 100%; }

        .btn-main { background: #000; color: #fff; width: 100%; padding: 15px; border: 3px solid #000; border-radius: 14px; font-weight: 900; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; box-shadow: 4px 4px 0 rgba(0,0,0,0.3); transition: all 0.1s; }
        .btn-main:active { transform: translateY(2px); box-shadow: 2px 2px 0 rgba(0,0,0,0.3); }
        .btn-main:disabled { background: #888; border-color: #888; cursor: not-allowed; }

        .btn-link { background: none; border: none; font-weight: 800; font-size: 11px; text-decoration: underline; padding: 10px; margin-top: 5px; cursor: pointer; }

        .scanner-box { position: relative; width: 260px; height: 260px; margin: 20px 0; border: 4px solid #000; border-radius: 20px; overflow: hidden; background: #000; }
        #reader { width: 100%; height: 100%; }
        #reader video { object-fit: cover; width: 100%; height: 100%; }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 80px; background: white; border-top: 3px solid #000; display: flex; justify-content: space-around; align-items: center; z-index: 50; padding-bottom: 10px; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #999; text-decoration: none; }
        .nav-item.active { color: #000; }
        .nav-item i { font-size: 22px; margin-bottom: 4px; }
        .nav-item span { font-size: 9px; font-weight: 800; text-transform: uppercase; }

        .hidden { display: none !important; }
        .text-red-custom { color: #dc2626 !important; }
        .animate-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="app-shell">

        <main class="app-content">
            <div class="header-pill">Koordinator</div>

            <div id="view-list" class="w-full flex flex-col items-center animate-up">
                <div class="w-full flex justify-between items-end mb-4 px-1">
                    <h2 class="text-sm font-black uppercase">Antrean Verifikasi</h2>
                    <button onclick="loadQueue()" class="text-[10px] font-bold underline">Refresh</button>
                </div>
                <div id="log-container" class="w-full">
                    <div class="text-center py-10 opacity-50"><i class="fa-solid fa-circle-notch fa-spin text-2xl"></i></div>
                </div>
            </div>

            <div id="view-scanner" class="hidden w-full flex flex-col items-center h-full animate-up">
                <p class="text-[11px] font-bold text-center uppercase mb-6 px-6 leading-relaxed">
                    Scan QR Code pada mesin<br>untuk membuka form verifikasi.
                </p>
                <div class="scanner-box">
                    <div id="reader"></div>
                </div>
                <div class="bg-black text-white px-4 py-1 rounded-full text-[10px] font-bold uppercase mb-6">Scanning...</div>
                <button onclick="backToList()" class="btn-link">Batalkan Scan</button>
            </div>

            <div id="view-form" class="hidden w-full flex flex-col items-center animate-up">
                <div class="info-box">
                    <div class="info-row">
                        <span class="i-lbl">MESIN</span> <span class="i-sep">:</span> <span id="form-mesin" class="i-val">...</span>
                    </div>
                    <div class="info-row">
                        <span class="i-lbl">PELAKSANA</span> <span class="i-sep">:</span> <span id="form-pelaksana" class="i-val">...</span>
                    </div>
                    <div class="info-row border-t border-dashed border-gray-400 mt-2 pt-2">
                        <span class="i-lbl">CATATAN</span> <span class="i-sep">:</span> 
                        <span id="form-catatan-pel" class="i-val">...</span>
                    </div>
                </div>

                <label class="label-input">NAMA KOORDINATOR</label>
                <input type="text" id="koor-name" class="input-field" placeholder="Nama Lengkap">

                <label class="label-input">CATATAN KOORDINATOR (OPSIONAL)</label>
                <textarea id="koor-remark" rows="2" class="input-field resize-none !text-left" placeholder="Tulis catatan jika ada..."></textarea>
                
                <div class="w-full flex justify-between items-end mb-1 px-1">
                    <label class="label-input !mb-0">PARAF</label>
                    <button onclick="clearPad()" class="text-[9px] font-bold text-red-600 underline uppercase">Hapus</button>
                </div>
                <div class="sig-wrapper">
                    <canvas id="signature-pad-koor"></canvas>
                </div>

                <button onclick="submitApproval()" id="btn-approve" class="btn-main">VERIFIKASI & SIMPAN</button>
                <button onclick="backToList()" class="btn-link">Kembali / Batal</button>
            </div>
        </main>

        <nav class="bottom-nav">
            <a href="index.html" class="nav-item"><i class="fa-solid fa-house"></i><span>Home</span></a>
            <a href="menu_utama.html" class="nav-item"><i class="fa-solid fa-bars"></i><span>Menu</span></a>
            <a href="download_data.html" class="nav-item"><i class="fa-solid fa-download"></i><span>Data</span></a>
            <a href="informasi_akun.html" class="nav-item"><i class="fa-solid fa-user"></i><span>Akun</span></a>
        </nav>

    </div>

    <script>
        const SB_URL = "https://dsyvlavphvrdidmodokd.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
        const _sb = supabase.createClient(SB_URL, SB_KEY);
        
        let activeLog = null;
        let scanner = null;
        let sigPadKoor = null;

        window.onload = function() {
            loadQueue();
            const canvas = document.getElementById('signature-pad-koor');
            function resizeCanvas() {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
            }
            window.addEventListener("resize", resizeCanvas);
            resizeCanvas();
            sigPadKoor = new SignaturePad(canvas, { backgroundColor: 'rgba(255, 255, 255, 0)' });
        };

        function clearPad() { if(sigPadKoor) sigPadKoor.clear(); }

        function switchView(viewId) {
            ['view-list', 'view-scanner', 'view-form'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        }

        async function backToList() {
            if(scanner) {
                try {
                    if(scanner.getState() === Html5QrcodeScannerState.SCANNING) await scanner.stop();
                } catch(e) {}
                try { scanner.clear(); } catch(e) {}
            }
            switchView('view-list');
            activeLog = null;
            loadQueue();
        }

        async function loadQueue() {
            const now = new Date();
            const todayDate = now.getDate();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();

            const container = document.getElementById('log-container');
            container.innerHTML = '<div class="text-center py-10 opacity-50"><i class="fa-solid fa-circle-notch fa-spin text-2xl"></i></div>';

            const { data: logs } = await _sb.from('chslr_log')
                .select('*')
                .eq('bulan', currentMonth)
                .eq('tahun', currentYear)
                .neq('status_verifikasi', true); 

            if (!logs || logs.length === 0) {
                container.innerHTML = `<div class="text-center py-10 opacity-40 border-2 border-dashed border-gray-300 rounded-xl"><p class="font-bold text-xs uppercase">Tidak ada antrean.</p></div>`;
                return;
            }

            container.innerHTML = "";
            let count = 0;

            for (let log of logs) {
                const { data: results } = await _sb.from('chslr_result')
                    .select('id') 
                    .eq('log_id', log.id)
                    .eq('tanggal', todayDate) 
                    .limit(1);

                if (results && results.length > 0) {
                    count++;
                    const names = log.pelaksana_names ? log.pelaksana_names.join(', ') : '-';
                    const dateStr = `${todayDate}/${currentMonth}/${currentYear}`;
                    container.insertAdjacentHTML('beforeend', `
                        <div class="card-item" onclick="startScanner('${encodeURIComponent(JSON.stringify(log))}')">
                            <div class="card-row"><span class="lbl">MESIN</span> <span class="val">${log.mesin_id}</span></div>
                            <div class="card-row"><span class="lbl">PELAKSANA</span> <span class="val" style="font-size:10px;">${names}</span></div>
                            <div class="card-row"><span class="lbl">TANGGAL</span> <span class="val">${dateStr}</span></div>
                            <div class="badge-status">KETUK UNTUK VERIFIKASI</div>
                        </div>`);
                }
            }

            if(count === 0) {
                container.innerHTML = `<div class="text-center py-10 opacity-40 border-2 border-dashed border-gray-300 rounded-xl"><p class="font-bold text-xs uppercase">Menunggu Pelaksana...</p></div>`;
            }
        }

        function startScanner(logStr) {
            activeLog = JSON.parse(decodeURIComponent(logStr));
            switchView('view-scanner');
            if(!scanner) scanner = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 220, height: 220 }, aspectRatio: 1.0 };
            scanner.start({ facingMode: "environment" }, config, onScanSuccess).catch(err => { alert("Kamera error: " + err); backToList(); });
        }

        async function onScanSuccess(decodedText) {
            if (activeLog.mesin_id.toLowerCase().trim() === decodedText.toLowerCase().trim()) {
                if(navigator.vibrate) navigator.vibrate(100);
                try { if(scanner.getState() === Html5QrcodeScannerState.SCANNING) await scanner.stop(); scanner.clear(); } catch(e){}
                openForm();
            } else {
                alert(`❌ QR SALAH!\nTarget: ${activeLog.mesin_id}`);
            }
        }

        // --- INI LOGIKA "2 KONDISI" YANG PALING PENTING ---
        async function openForm() {
            switchView('view-form');
            document.getElementById('form-mesin').innerText = activeLog.mesin_id;
            document.getElementById('form-pelaksana').innerText = activeLog.pelaksana_names ? activeLog.pelaksana_names.join(', ') : '-';
            document.getElementById('koor-name').value = "";
            document.getElementById('koor-remark').value = "";
            sigPadKoor.clear();
            
            const noteEl = document.getElementById('form-catatan-pel');
            noteEl.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Loading...';
            noteEl.className = "i-val"; 

            // 1. FETCH ULANG DATA LOG (UNTUK DAPATKAN KOLOM 'CATATAN' JIKA OK)
            const { data: freshLog } = await _sb.from('chslr_log')
                .select('catatan')
                .eq('id', activeLog.id)
                .single();
            
            const catatanPelaksanaLog = (freshLog && freshLog.catatan) ? freshLog.catatan : "";

            // 2. FETCH RESULT HARI INI (UNTUK CEK NG)
            const today = new Date().getDate();
            const { data: results } = await _sb.from('chslr_result')
                .select('status, keterangan, chslr_items(item_name)')
                .eq('log_id', activeLog.id)
                .eq('tanggal', today);

            // 3. PROSES KONDISIONAL
            let finalNote = "-";
            let hasNG = false;
            let ngList = [];

            if (results && results.length > 0) {
                // Loop cari NG
                results.forEach(r => {
                    if (r.status === 'NG') {
                        hasNG = true;
                        const item = r.chslr_items ? r.chslr_items.item_name : 'Item';
                        const ket = r.keterangan || 'Rusak';
                        ngList.push(`${item}: ${ket}`);
                    }
                });

                if (hasNG) {
                    // === KONDISI A: ADA NG ===
                    // Ambil dari chslr_result (Keterangan)
                    finalNote = "NG: " + ngList.join(' | ');
                    noteEl.classList.add('text-red-custom'); 
                } else {
                    // === KONDISI B: SEMUA OK ===
                    // Ambil dari chslr_log (Catatan Pelaksana)
                    if (catatanPelaksanaLog.trim() !== "") {
                        finalNote = catatanPelaksanaLog; 
                    } else {
                        finalNote = "KONDISI OK (AMAN)";
                    }
                    noteEl.classList.remove('text-red-custom');
                }
            } else {
                finalNote = "Data checklist belum masuk.";
            }

            // Tampilkan Hasil
            noteEl.innerText = finalNote;
            
            const canvas = document.getElementById('signature-pad-koor');
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
        }

        async function submitApproval() {
            const name = document.getElementById('koor-name').value.trim();
            const remark = document.getElementById('koor-remark').value.trim();
            const btn = document.getElementById('btn-approve');

            if(!name) return alert("⚠️ Nama Koordinator wajib diisi!");
            if(sigPadKoor.isEmpty()) return alert("⚠️ Harap tanda tangan dulu!");

            btn.innerHTML = 'MENYIMPAN...'; btn.disabled = true;

            try {
                const { error } = await _sb.from('chslr_log').update({
                    koordinator_nama: name,
                    signature_koordinator: sigPadKoor.toDataURL(),
                    status_verifikasi: true,
                    remark_koordinator: remark
                }).eq('id', activeLog.id);

                if (error) throw error;

                alert("✅ VERIFIKASI BERHASIL!");
                await backToList();

            } catch (err) {
                alert("Gagal menyimpan: " + err.message);
                btn.innerHTML = 'VERIFIKASI & SIMPAN'; btn.disabled = false;
            }
        }
    </script>
</body>
</html>
