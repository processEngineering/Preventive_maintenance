<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Koordinator - Verifikasi CHSLR</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

    <style>
        body { background-color: #f3f4f6; }
        .canvas-container { border: 2px dashed #cbd5e1; background: white; border-radius: 8px; }
    </style>
</head>
<body class="text-gray-800">

    <nav class="bg-blue-800 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="font-bold text-xl">üõ°Ô∏è Koordinator Panel</h1>
            <button onclick="fetchLogs()" class="text-sm bg-blue-600 px-3 py-1 rounded hover:bg-blue-500">Refresh Data</button>
        </div>
    </nav>

    <div class="container mx-auto p-4 max-w-5xl">
        
        <div class="bg-white p-4 rounded-lg shadow mb-6 flex gap-4 items-end">
            <div class="w-full">
                <label class="block text-sm font-semibold text-gray-600 mb-1">Nama Koordinator (Anda)</label>
                <input type="text" id="coordName" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Masukkan nama Anda...">
            </div>
        </div>

        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                <h2 class="font-bold text-lg text-gray-700">Daftar Laporan Masuk</h2>
                <span id="loadingText" class="text-sm text-gray-500 hidden">Memuat data...</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-100 text-gray-600 uppercase text-xs">
                        <tr>
                            <th class="p-4">Tanggal</th>
                            <th class="p-4">Mesin ID</th>
                            <th class="p-4">Pelaksana</th>
                            <th class="p-4">Catatan Pelaksana</th>
                            <th class="p-4 text-center">Status</th>
                            <th class="p-4 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="logTableBody" class="text-sm divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="verifyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full overflow-hidden transform transition-all">
            
            <div class="bg-blue-800 p-4 text-white flex justify-between">
                <h3 class="font-bold">Verifikasi Laporan</h3>
                <button onclick="closeModal()" class="text-white hover:text-gray-300">&times;</button>
            </div>

            <div class="p-6 space-y-4 max-h-[80vh] overflow-y-auto">
                <input type="hidden" id="selectedLogId">
                
                <div class="bg-gray-50 p-3 rounded text-sm space-y-1 border">
                    <p><strong>Mesin:</strong> <span id="modalMesin"></span></p>
                    <p><strong>Periode:</strong> <span id="modalPeriode"></span></p>
                    <p><strong>Pelaksana:</strong> <span id="modalPelaksana"></span></p>
                    <div class="mt-2 pt-2 border-t border-gray-200">
                        <p class="text-xs text-gray-500 uppercase">Catatan Pelaksana:</p>
                        <p id="modalCatatan" class="text-gray-800 italic">test</p>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Catatan / Remark Koordinator</label>
                    <textarea id="coordRemark" rows="2" class="w-full border border-gray-300 rounded p-2 text-sm focus:ring-blue-500 focus:border-blue-500" placeholder="OK, Lanjut..."></textarea>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Tanda Tangan Koordinator</label>
                    <div class="canvas-container h-40 relative">
                        <canvas id="signatureCanvas" class="w-full h-full block"></canvas>
                        <div class="absolute bottom-2 right-2 text-xs text-gray-400 select-none">Area Tanda Tangan</div>
                    </div>
                    <button onclick="clearSignature()" class="text-xs text-red-500 mt-1 hover:underline">Hapus Tanda Tangan</button>
                </div>
            </div>

            <div class="p-4 border-t bg-gray-50 flex justify-end space-x-2">
                <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded text-sm">Batal</button>
                <button onclick="submitVerification()" class="px-6 py-2 bg-green-600 text-white rounded font-semibold hover:bg-green-700 text-sm shadow-lg">‚úÖ Verifikasi & Simpan</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. KONFIGURASI SUPABASE (ISI DISINI YA!)
        // ==========================================
        const SUPABASE_URL = 'https://YOUR_PROJECT_ID.supabase.co'; 
        const SUPABASE_KEY = 'YOUR_ANON_KEY_HERE';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Global Variables
        let signaturePad;

        // ==========================================
        // 2. INISIALISASI
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            fetchLogs();
            initSignaturePad();
        });

        function initSignaturePad() {
            const canvas = document.getElementById('signatureCanvas');
            // Resize canvas agar tidak pecah di high DPI screen
            function resizeCanvas() {
                const ratio =  Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
            }
            window.addEventListener("resize", resizeCanvas);
            resizeCanvas();
            
            signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgba(255, 255, 255, 0)' });
        }

        function clearSignature() {
            signaturePad.clear();
        }

        // ==========================================
        // 3. AMBIL DATA DARI SUPABASE
        // ==========================================
        async function fetchLogs() {
            const loading = document.getElementById('loadingText');
            const tbody = document.getElementById('logTableBody');
            
            loading.classList.remove('hidden');
            tbody.innerHTML = ''; // Clear table

            // Query ke tabel chslr_log
            // Mengambil semua data, diurutkan dari yang terbaru
            const { data, error } = await supabase
                .from('chslr_log')
                .select('*')
                .order('created_at', { ascending: false });

            loading.classList.add('hidden');

            if (error) {
                alert('Gagal mengambil data: ' + error.message);
                return;
            }

            renderTable(data);
        }

        function renderTable(logs) {
            const tbody = document.getElementById('logTableBody');
            
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">Belum ada data laporan.</td></tr>';
                return;
            }

            logs.forEach(log => {
                const createdDate = new Date(log.created_at).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit' });
                const isVerified = log.status_verifikasi; // Kolom boolean
                
                // Styling status badge
                const statusBadge = isVerified 
                    ? `<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-bold">Terverifikasi</span>`
                    : `<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full font-bold">Pending</span>`;

                // Tombol Aksi (Disabled jika sudah verifikasi)
                const actionBtn = isVerified
                    ? `<button disabled class="text-gray-400 cursor-not-allowed">Selesai</button>`
                    : `<button onclick='openModal(${JSON.stringify(log).replace(/'/g, "&apos;")})' class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 shadow text-xs">üîç Cek & Verif</button>`;

                const pelaksana = log.pelaksana_names ? log.pelaksana_names.join(', ') : '-';

                const row = `
                    <tr class="hover:bg-gray-50 transition border-b">
                        <td class="p-4 whitespace-nowrap text-gray-500">${createdDate}</td>
                        <td class="p-4 font-semibold text-blue-900">${log.mesin_id || '-'}</td>
                        <td class="p-4">${pelaksana}</td>
                        <td class="p-4 text-gray-600 truncate max-w-xs">${log.catatan_pelaksana || '-'}</td>
                        <td class="p-4 text-center">${statusBadge}</td>
                        <td class="p-4 text-center">${actionBtn}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // ==========================================
        // 4. LOGIKA MODAL & VERIFIKASI
        // ==========================================
        function openModal(log) {
            // Cek nama koordinator dulu
            const coordName = document.getElementById('coordName').value.trim();
            if (!coordName) {
                alert("Harap isi 'Nama Koordinator' di bagian atas halaman dulu ya!");
                document.getElementById('coordName').focus();
                return;
            }

            // Isi data ke modal
            document.getElementById('selectedLogId').value = log.id;
            document.getElementById('modalMesin').textContent = log.mesin_id;
            document.getElementById('modalPeriode').textContent = `${log.bulan} / ${log.tahun}`;
            document.getElementById('modalPelaksana').textContent = log.pelaksana_names ? log.pelaksana_names.join(', ') : '-';
            document.getElementById('modalCatatan').textContent = log.catatan_pelaksana || '(Tidak ada catatan)';
            
            // Reset input koordinator
            document.getElementById('coordRemark').value = '';
            signaturePad.clear();

            // Tampilkan modal
            const modal = document.getElementById('verifyModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Fix canvas render issue saat modal muncul
            setTimeout(() => {
                const canvas = document.getElementById('signatureCanvas');
                const ratio =  Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
                signaturePad.clear(); // Clear lagi agar bersih
            }, 100);
        }

        function closeModal() {
            const modal = document.getElementById('verifyModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        async function submitVerification() {
            const id = document.getElementById('selectedLogId').value;
            const remark = document.getElementById('coordRemark').value;
            const namaKoordinator = document.getElementById('coordName').value;

            if (signaturePad.isEmpty()) {
                alert('Tanda tangan Koordinator wajib diisi!');
                return;
            }

            // Ambil gambar tanda tangan (Base64)
            const signatureData = signaturePad.toDataURL('image/png');

            if (!confirm('Apakah Anda yakin ingin memverifikasi laporan ini?')) return;

            // Update ke Supabase
            // Kita update kolom: status_verifikasi, koordinator_nama, signature_koordinator, remark_koordinator
            const { error } = await supabase
                .from('chslr_log')
                .update({
                    status_verifikasi: true,
                    koordinator_nama: namaKoordinator,
                    signature_koordinator: signatureData,
                    remark_koordinator: remark
                })
                .eq('id', id);

            if (error) {
                alert('Gagal update database: ' + error.message);
            } else {
                alert('Berhasil diverifikasi! ‚úÖ');
                closeModal();
                fetchLogs(); // Refresh tabel
            }
        }
    </script>
</body>
</html>
