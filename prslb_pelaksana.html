<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pelaksana Preventif - PT AKG</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #003366;
            --primary-light: #e6f0f9;
            --bg: #f8fafc;
            --ok: #22c55e;
            --ng: #ef4444;
            --text: #1e293b;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 10px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-light);
        }

        .header img { height: 45px; margin-bottom: 10px; }
        .header h2 { 
            font-size: 1.2rem; 
            color: var(--primary); 
            margin: 0;
            text-transform: uppercase;
        }

        .form-section { margin-bottom: 20px; }
        label { 
            display: block; 
            font-weight: 600; 
            margin-bottom: 8px; 
            font-size: 14px; 
            color: var(--primary);
        }

        select, input {
            width: 100%;
            padding: 12px;
            border: 1.5px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Styling Item Checklist */
        .category-header {
            background: var(--primary-light);
            color: var(--primary);
            padding: 10px 15px;
            font-weight: bold;
            border-radius: 8px;
            margin: 25px 0 10px 0;
            font-size: 13px;
            display: flex;
            align-items: center;
        }

        .check-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 5px;
            border-bottom: 1px solid #f1f5f9;
        }

        .item-label { flex: 1; padding-right: 15px; }
        .item-name { font-size: 15px; font-weight: 500; margin-bottom: 3px; }
        .item-std { font-size: 12px; color: #64748b; font-style: italic; }

        .btn-group { display: flex; gap: 8px; }
        .btn-status {
            padding: 10px 18px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.2s;
        }

        .btn-status.active-ok { background: var(--ok); color: white; border-color: var(--ok); }
        .btn-status.active-ng { background: var(--ng); color: white; border-color: var(--ng); }

        .submit-container {
            position: sticky;
            bottom: 10px;
            background: white;
            padding: 15px 0;
            margin-top: 30px;
        }

        .btn-submit {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 51, 102, 0.2);
        }

        .btn-submit:active { transform: scale(0.98); }

        /* Loading Spinner */
        #loader { text-align: center; padding: 40px; color: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <img src="https://amarilyskg.co.id/bootstrap/img/logo.png" alt="Logo PT AKG">
        <h2>Preventif Robot & Stand Label</h2>
    </div>

    <div class="form-section">
        <label>Pilih Mesin / Scan QR:</label>
        <select id="mesin-select">
            <option value="">-- Loading Mesin... --</option>
        </select>
    </div>

    <div class="form-section">
        <label>Nama Pelaksana:</label>
        <input type="text" id="pelaksana-name" placeholder="Contoh: Budi Santoso">
    </div>

    <div id="loader">Memuat item checklist...</div>
    <div id="checklist-content" style="display: none;">
        </div>

    <div class="submit-container">
        <button class="btn-submit" onclick="submitData()">SIMPAN CHECKLIST</button>
    </div>
</div>

<script>
    // Konfigurasi Supabase
    const SB_URL = "https://dsyvlavphvrdidmodokd.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    async function initPage() {
        try {
            // 1. Ambil Data Mesin
            const { data: mesin, error: errMesin } = await _supabase
                .from('prslb_mesin')
                .select('*')
                .order('nickname', { ascending: true });

            const selectMesin = document.getElementById('mesin-select');
            selectMesin.innerHTML = '<option value="">-- Pilih Mesin --</option>';
            mesin.forEach(m => {
                selectMesin.innerHTML += `<option value="${m.id}">${m.nama_mesin} ${m.tonage || ''} (${m.nickname || 'EXT'})</option>`;
            });

            // 2. Ambil Data Item Checklist
            const { data: items, error: errItems } = await _supabase
                .from('prslb_items')
                .select('*')
                .order('id', { ascending: true });

            renderItems(items);
            
            document.getElementById('loader').style.display = 'none';
            document.getElementById('checklist-content').style.display = 'block';

        } catch (e) {
            alert("Gagal koneksi ke database!");
            console.error(e);
        }
    }

    function renderItems(items) {
        const container = document.getElementById('checklist-content');
        let currentCat = "";

        items.forEach(item => {
            // Header Kategori (A, B, C, D)
            if (item.kategori !== currentCat) {
                currentCat = item.kategori;
                const catDiv = document.createElement('div');
                catDiv.className = 'category-header';
                catDiv.innerText = `ITEM CHECK ROBOT (${currentCat})`;
                container.appendChild(catDiv);
            }

            // Baris Item
            const itemDiv = document.createElement('div');
            itemDiv.className = 'check-item';
            itemDiv.innerHTML = `
                <div class="item-label">
                    <div class="item-name">${item.item_name}</div>
                    <div class="item-std">Std: ${item.standard}</div>
                </div>
                <div class="btn-group" data-item-id="${item.id}">
                    <button class="btn-status" onclick="setStatus(this, 'OK')">OK</button>
                    <button class="btn-status" onclick="setStatus(this, 'NG')">NG</button>
                </div>
            `;
            container.appendChild(itemDiv);
        });
    }

    function setStatus(btn, status) {
        const group = btn.parentElement;
        group.querySelectorAll('.btn-status').forEach(b => b.classList.remove('active-ok', 'active-ng'));
        
        if (status === 'OK') btn.classList.add('active-ok');
        else btn.classList.add('active-ng');
    }

    async function submitData() {
        const mesinId = document.getElementById('mesin-select').value;
        const pelaksana = document.getElementById('pelaksana-name').value;
        const groups = document.querySelectorAll('.btn-group');

        if (!mesinId || !pelaksana) {
            return alert("Pilih Mesin dan isi Nama Pelaksana!");
        }

        const dataToSave = [];
        let completed = true;

        groups.forEach(group => {
            const itemId = group.getAttribute('data-item-id');
            const activeBtn = group.querySelector('.active-ok, .active-ng');

            if (!activeBtn) {
                completed = false;
            } else {
                dataToSave.push({
                    mesin_id: parseInt(mesinId),
                    item_id: parseInt(itemId),
                    status: activeBtn.innerText,
                    pelaksana_nama: pelaksana
                });
            }
        });

        if (!completed) {
            return alert("Mohon lengkapi semua item checklist!");
        }

        const { error } = await _supabase.from('prslb_log').insert(dataToSave);

        if (error) {
            alert("Gagal menyimpan: " + error.message);
        } else {
            alert("Data Berhasil Disimpan!");
            location.reload(); // Refresh halaman setelah sukses
        }
    }

    // Jalankan saat load
    initPage();
</script>

</body>
</html>
