<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preventif Pelaksana - PT. Amarilys Karisma Gemilang</title>
    <meta name="theme-color" content="#003366">

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

    <style>
        :root {
            --primary: #003366;
            --primary-light: #004488;
            --primary-dark: #002244;
            --success: #16a34a;
            --danger: #dc2626;
            --gray-100: #f8fafc;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-500: #64748b;
            --gray-700: #334155;
            --gray-900: #0f172a;
            --radius: 16px;
            --shadow: 0 10px 30px -8px rgba(0, 51, 102, 0.18);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8f9ff 0%, #e6f0ff 100%);
            color: var(--gray-900);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 560px;
            margin: 0 auto;
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        /* Header */
        .header {
            background: var(--primary);
            color: white;
            padding: 20px 24px;
            text-align: center;
        }
        .header h1 {
            font-size: 20px;
            font-weight: 800;
            letter-spacing: 0.8px;
        }
        .header p {
            font-size: 13px;
            opacity: 0.9;
            margin-top: 4px;
        }

        /* Content */
        .content {
            padding: 28px 24px;
        }

        /* Scanner View */
        #view-scan {
            text-align: center;
        }
        .scanner-box {
            background: #000;
            border-radius: 14px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        #reader { width: 100% !important; }
        .scan-status {
            padding: 16px;
            background: var(--gray-100);
            border-radius: 12px;
            font-weight: 600;
            color: var(--primary);
        }

        /* Machine Info */
        .machine-card {
            background: linear-gradient(135deg, #eef4ff, #dbeafe);
            border: 2px solid var(--primary);
            border-radius: 14px;
            padding: 18px;
            text-align: center;
            margin-bottom: 24px;
        }
        .machine-card h3 {
            font-size: 22px;
            font-weight: 800;
            color: var(--primary);
        }
        .rescan-btn {
            margin-top: 10px;
            font-size: 12px;
            color: var(--primary);
            background: none;
            border: none;
            text-decoration: underline;
            cursor: pointer;
        }

        /* Form Styling */
        .form-group {
            margin-bottom: 24px;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--gray-700);
        }
        input[type="text"] {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--gray-300);
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.2s;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0, 51, 102, 0.1);
        }

        /* Category Header */
        .cat-header {
            background: var(--primary);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin: 28px 0 16px;
        }

        /* Check Item */
        .check-item {
            background: var(--gray-100);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 14px;
            transition: all 0.2s;
        }
        .item-main {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }
        .item-label {
            flex: 1;
        }
        .item-name {
            font-weight: 700;
            font-size: 15px;
            color: var(--gray-900);
        }
        .item-std {
            font-size: 12px;
            color: var(--gray-500);
            margin-top: 4px;
            font-style: italic;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }
        .btn-status {
            padding: 10px 18px;
            border: 2px solid var(--gray-300);
            background: white;
            border-radius: 10px;
            font-weight: 700;
            font-size: 13px;
            min-width: 56px;
            transition: all 0.2s;
        }
        .btn-ok.active { background: var(--success); border-color: var(--success); color: white; }
        .btn-ng.active { background: var(--danger); border-color: var(--danger); color: white; }

        .note-area {
            margin-top: 12px;
            display: none;
        }
        .note-area.show { display: block; animation: fadeIn 0.3s; }
        .input-note {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--danger);
            border-radius: 10px;
            font-size: 14px;
        }

        /* Signature */
        .signature-box {
            border: 2px solid var(--gray-300);
            border-radius: 12px;
            overflow: hidden;
            background: #fff;
            margin-top: 8px;
        }
        #signature-pad {
            width: 100%;
            height: 180px;
            background: #fafafa;
        }
        .clear-sign {
            margin-top: 8px;
            font-size: 12px;
            color: var(--primary);
            background: none;
            border: none;
            text-decoration: underline;
            cursor: pointer;
        }

        /* Submit Button */
        .btn-submit {
            width: 100%;
            padding: 18px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 700;
            margin-top: 32px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 8px 20px rgba(0, 51, 102, 0.25);
        }
        .btn-submit:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }
        .btn-submit:active {
            transform: translateY(0);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 480px) {
            .content { padding: 20px 16px; }
            .item-main { flex-direction: column; align-items: stretch; }
            .btn-group { justify-content: flex-end; }
        }
    </style>
</head>
<body>

<div class="container">
    <header class="header">
        <h1>Preventif Robot & Stand Label</h1>
        <p>Form Pelaksana • PT. Amarilys Karisma Gemilang</p>
    </header>

    <div class="content">

        <!-- Scanner View -->
        <div id="view-scan">
            <p style="text-align:center; margin-bottom:16px; color:var(--gray-700);">
                Arahkan kamera ke barcode mesin yang akan dicek
            </p>
            <div class="scanner-box">
                <div id="reader"></div>
            </div>
            <div class="scan-status" id="status-scan">Memulai kamera...</div>
        </div>

        <!-- Form View -->
        <div id="view-form" style="display:none;">

            <div class="machine-card">
                <h3 id="txt-mesin">-</h3>
                <button class="rescan-btn" onclick="location.reload()">Scan Ulang Mesin</button>
            </div>

            <div class="form-group">
                <label>Nama Pelaksana</label>
                <input type="text" id="input-nama" placeholder="Masukkan nama lengkap">
            </div>

            <div id="checklist-container"></div>

            <div class="form-group">
                <label>Tanda Tangan Pelaksana</label>
                <div class="signature-box">
                    <canvas id="signature-pad"></canvas>
                </div>
                <button type="button" class="clear-sign" onclick="signaturePad.clear()">
                    Hapus Tanda Tangan
                </button>
            </div>

            <button class="btn-submit" onclick="simpanData()">
                SIMPAN DATA INSPEKSI
            </button>
        </div>
    </div>
</div>

<script>
    const SB_URL = "https://dsyvlavphvrdidmodokd.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
    const _sb = supabase.createClient(SB_URL, SB_KEY);

    let scanner = null;
    let signaturePad = null;
    let currentMesin = null;

    async function startScanner() {
        try {
            scanner = new Html5Qrcode("reader");
            await scanner.start(
                { facingMode: "environment" },
                { fps: 20, qrbox: { width: 280, height: 280 } },
                onScanSuccess,
                () => {}
            );
            document.getElementById('status-scan').innerHTML = "✓ Kamera aktif. Arahkan ke barcode mesin.";
        } catch (err) {
            document.getElementById('status-scan').innerHTML = '<span style="color:#dc2626">Gagal mengakses kamera!</span>';
        }
    }

    async function onScanSuccess(decodedText) {
        const clean = decodedText.trim();
        const { data, error } = await _sb
            .from('prslb_mesin')
            .select('*')
            .ilike('qr_code_id', clean)
            .maybeSingle();

        if (data) {
            currentMesin = data;
            scanner.stop();
            renderForm();
        } else {
            document.getElementById('status-scan').innerHTML = 
                `<span style="color:#dc2626">Barcode "${clean}" tidak terdaftar!</span>`;
        }
    }

    async function renderForm() {
        document.getElementById('view-scan').style.display = 'none';
        document.getElementById('view-form').style.display = 'block';
        document.getElementById('txt-mesin').textContent = currentMesin.qr_code_id;

        const { data: items } = await _sb.from('prslb_items').select('*').order('id');
        const container = document.getElementById('checklist-container');
        let currentCat = "";

        items.forEach(item => {
            if (item.kategori !== currentCat) {
                currentCat = item.kategori;
                container.innerHTML += `<div class="cat-header">Item Check Robot — ${currentCat}</div>`;
            }

            container.innerHTML += `
                <div class="check-item" data-id="${item.id}">
                    <div class="item-main">
                        <div class="item-label">
                            <div class="item-name">${item.item_name}</div>
                            <div class="item-std">Std: ${item.standard}</div>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn-status btn-ok" onclick="setStatus(this,'OK')">OK</button>
                            <button type="button" class="btn-status btn-ng" onclick="setStatus(this,'NG')">NG</button>
                        </div>
                    </div>
                    <div class="note-area">
                        <input type="text" class="input-note" placeholder="Wajib diisi: Jelaskan kerusakan / tindakan...">
                    </div>
                </div>`;
        });

        // Init signature
        const canvas = document.getElementById('signature-pad');
        signaturePad = new SignaturePad(canvas, { backgroundColor: '#fafafa' });
        canvas.width = canvas.offsetWidth * devicePixelRatio;
        canvas.height = canvas.offsetHeight * devicePixelRatio;
        canvas.getContext('2d').scale(devicePixelRatio, devicePixelRatio);
    }

    function setStatus(btn, status) {
        const item = btn.closest('.check-item');
        const buttons = item.querySelectorAll('.btn-status');
        const noteArea = item.querySelector('.note-area');

        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        if (status === 'NG') {
            noteArea.classList.add('show');
        } else {
            noteArea.classList.remove('show');
            noteArea.querySelector('input').value = '';
        }
    }

    async function simpanData() {
        const nama = document.getElementById('input-nama').value.trim();
        if (!nama) return alert("Nama pelaksana wajib diisi!");
        if (signaturePad.isEmpty()) return alert("Tanda tangan wajib diisi!");

        const items = document.querySelectorAll('.check-item');
        let allValid = true;
        const results = [];

        for (const item of items) {
            const activeBtn = item.querySelector('.btn-status.active');
            if (!activeBtn) { allValid = false; continue; }

            const status = activeBtn.textContent;
            const note = item.querySelector('.input-note').value.trim();
            const itemId = item.dataset.id;

            if (status === 'NG' && !note) {
                alert("Item NG wajib diisi keterangannya!");
                allValid = false;
                break;
            }

            results.push({
                item_id: parseInt(itemId),
                status: status,
                keterangan: note
            });
        }

        if (!allValid) return;

        try {
            const { data: log, error: err1 } = await _sb
                .from('prslb_log')
                .insert({
                    mesin_id: currentMesin.id,
                    pelaksana_nama: nama,
                    signature_pelaksana: signaturePad.toDataURL()
                })
                .select()
                .single();

            if (err1) throw err1;

            const payload = results.map(r => ({ ...r, log_id: log.id }));
            const { error: err2 } = await _sb.from('prslb_result').insert(payload);
            if (err2) throw err2;

            alert("Data inspeksi berhasil disimpan!");
            location.reload();
        } catch (e) {
            console.error(e);
            alert("Terjadi kesalahan: " + e.message);
        }
    }

    window.onload = startScanner;
</script>

</body>
</html>
