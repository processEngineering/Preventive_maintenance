<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Final - AF.SP 05.08.Rev-00</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Arial', sans-serif; background: #525659; margin: 0; padding: 20px; color: #000; }
        .no-print { max-width: 900px; margin: 0 auto 15px; background: #fff; padding: 15px; border-radius: 8px; display: flex; gap: 10px; }
        
        .page {
            width: 210mm;
            min-height: 297mm;
            padding: 10mm;
            margin: auto;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            position: relative;
        }

        table { width: 100%; border-collapse: collapse; table-layout: fixed; margin-bottom: -1px; }
        td, th { border: 1px solid black; padding: 3px 6px; font-size: 10px; }

        /* Header Dokumen */
        .logo-box { width: 80px; text-align: center; }
        .title-box { text-align: center; font-size: 13px; font-weight: bold; width: 380px; }
        .meta-box { font-size: 8px; width: 80px; border-right: none; }
        .meta-val { font-size: 8px; border-left: none; }

        /* Info Mesin */
        .label-bg { background-color: #efefef; font-weight: bold; width: 15%; }
        .val-box { width: 35%; }

        /* Table Checklist */
        .th-bg { background-color: #d9d9d9; text-align: center; font-weight: bold; }
        .cat-bg { background-color: #e9e9e9; font-weight: bold; padding-left: 10px; }
        .center { text-align: center; }
        .v-mark { font-family: "DejaVu Sans", Arial; font-weight: bold; font-size: 12px; }

        /* Footer & Note */
        .note-footer { font-size: 9px; margin-top: 10px; line-height: 1.4; }
        .approval-table td { height: 90px; vertical-align: top; text-align: center; padding-top: 5px; }
        .sig-space { height: 60px; display: flex; align-items: center; justify-content: center; }
        .sig-img { max-height: 55px; max-width: 100%; }
        .name-under { font-weight: bold; text-decoration: underline; display: block; margin-top: 5px; }

        @media print {
            body { background: none; padding: 0; }
            .no-print { display: none; }
            .page { margin: 0; border: none; box-shadow: none; width: 100%; }
        }
    </style>
</head>
<body>

<div class="no-print">
    <select id="select-log" style="flex: 1; padding: 8px;"></select>
    <button onclick="renderReport()" style="padding: 8px 20px; background: #003366; color: white; border: none; cursor: pointer;">Tampilkan Laporan</button>
    <button onclick="window.print()" style="padding: 8px 20px; background: #28a745; color: white; border: none; cursor: pointer;">Print / PDF</button>
</div>

<div class="page" id="printable">
    <table>
        <tr>
            <td rowspan="4" class="logo-box"><img src="https://amarilyskg.co.id/bootstrap/img/logo.png" width="70"></td>
            <td rowspan="4" class="title-box">PREVENTIF ROBOT & STAND LABEL BULANAN</td>
            <td class="meta-box">No. Dokumen</td>
            <td class="meta-val">: AF.SP 05.08.Rev-00</td>
        </tr>
        <tr>
            <td class="meta-box">Tanggal Terbit</td>
            <td class="meta-val">: 02 Agustus 2024</td>
        </tr>
        <tr>
            <td class="meta-box">Halaman</td>
            <td class="meta-val">: 1/1</td>
        </tr>
        <tr>
            <td class="meta-box">Tanggal Revisi</td>
            <td class="meta-val">: -</td>
        </tr>
    </table>

    <div style="height:10px"></div>

    <table>
        <tr>
            <td class="label-bg">MERK MESIN</td><td class="val-box" id="m-merk">: -</td>
            <td class="label-bg">TARGET SELESAI</td><td class="val-box">: -</td>
        </tr>
        <tr>
            <td class="label-bg">TONAGE</td><td class="val-box">: -</td>
            <td class="label-bg">START JAM</td><td class="val-box">: -</td>
        </tr>
        <tr>
            <td class="label-bg">TANGGAL</td><td class="val-box" id="m-tgl">: -</td>
            <td class="label-bg">FINISH JAM</td><td class="val-box">: -</td>
        </tr>
        <tr>
            <td class="label-bg">TAHUN</td><td class="val-box" id="m-thn">: -</td>
            <td class="label-bg">RUNNING HOURS</td><td class="val-box">: -</td>
        </tr>
    </table>

    <div style="height:10px"></div>

    <table>
        <thead>
            <tr class="th-bg">
                <th width="30">NO</th>
                <th>ITEM</th>
                <th width="150">STANDARD</th>
                <th width="35">P1</th>
                <th width="35">P2</th>
                <th width="180">KET/PEMAKAIAN SPAREPART</th>
            </tr>
        </thead>
        <tbody id="content-rows">
            </tbody>
    </table>

    <div class="note-footer">
        <b>Note :</b><br>
        P1 = Pelaksana pekerjaan (Teknisi)<br>
        P2 = Pelaksana verifikasi pekerjaan (Kasie/Kabag)<br>
        OK = Item sesuai standar (✓)<br>
        NG = Item bermasalah / Rusak (Ditulis di kolom Keterangan)
    </div>

    <div style="height:15px"></div>

    <table class="approval-table">
        <tr>
            <td width="33%">
                Dibuat Oleh,<br>Pelaksana (P1)
                <div class="sig-space"><img id="s1" class="sig-img"></div>
                <span id="n1" class="name-under"></span>
            </td>
            <td width="33%">
                Diperiksa Oleh,<br>Koordinator (P2)
                <div class="sig-space"><img id="s2" class="sig-img"></div>
                <span id="n2" class="name-under"></span>
            </td>
            <td width="34%">
                Disetujui Oleh,<br>Superintendent
                <div class="sig-space"><img id="s3" class="sig-img"></div>
                <span id="n3" class="name-under"></span>
            </td>
        </tr>
    </table>
</div>

<script>
    const SB_URL = "https://dsyvlavphvrdidmodokd.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
    const _sb = supabase.createClient(SB_URL, SB_KEY);

    async function init() {
        const { data } = await _sb.from('prslb_log').select('*, prslb_mesin(qr_code_id)').order('created_at',{ascending:false});
        const sel = document.getElementById('select-log');
        data.forEach(l => {
            sel.innerHTML += `<option value="${l.id}">${l.prslb_mesin.qr_code_id} - ${new Date(l.created_at).toLocaleDateString('id-ID')}</option>`;
        });
    }

    async function renderReport() {
        const id = document.getElementById('select-log').value;
        if(!id) return;

        const { data: log } = await _sb.from('prslb_log')
            .select('*, prslb_mesin(qr_code_id), prslb_result(*, prslb_items(*))')
            .eq('id', id).single();

        if(log) {
            const date = new Date(log.created_at);
            document.getElementById('m-merk').innerText = ": " + log.prslb_mesin.qr_code_id;
            document.getElementById('m-tgl').innerText = ": " + date.toLocaleDateString('id-ID');
            document.getElementById('m-thn').innerText = ": " + date.getFullYear();

            const body = document.getElementById('content-rows');
            body.innerHTML = "";
            let currentCat = "";
            let no = 1;

            log.prslb_result.forEach(r => {
                if(r.prslb_items.kategori !== currentCat) {
                    currentCat = r.prslb_items.kategori;
                    body.innerHTML += `<tr class="cat-bg"><td colspan="6">ITEM CHECK ${currentCat}</td></tr>`;
                }

                // Logika P1 (Pelaksana) dan P2 (Koordinator)
                const p1_val = r.status === 'OK' ? '✓' : '';
                const p2_val = (log.status_verifikasi && r.status === 'OK') ? '✓' : (r.status === 'NG' ? 'NG' : '');

                body.innerHTML += `
                    <tr>
                        <td class="center">${no++}</td>
                        <td>${r.prslb_items.item_name}</td>
                        <td>${r.prslb_items.standard}</td>
                        <td class="center v-mark">${p1_val}</td>
                        <td class="center v-mark" style="color:${p2_val === 'NG' ? 'red' : 'black'}">${p2_val}</td>
                        <td>${r.keterangan || ''}</td>
                    </tr>
                `;
            });

            // Approval Images
            document.getElementById('s1').src = log.signature_pelaksana || "";
            document.getElementById('n1').innerText = log.pelaksana_nama || "-";
            
            document.getElementById('s2').src = log.signature_koordinator || "";
            document.getElementById('n2').innerText = log.koordinator_nama || "(....................)";
            
            document.getElementById('s3').src = log.signature_superintendent || "";
            document.getElementById('n3').innerText = log.superintendent_nama || "(....................)";
        }
    }

    window.onload = init;
</script>
</body>
</html>
