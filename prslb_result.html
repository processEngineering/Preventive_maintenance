<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Final Preventif - PT AKG</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --border: #000; }
        body { font-family: Arial, sans-serif; background: #f1f5f9; margin: 0; padding: 20px; font-size: 12px; }
        .no-print { max-width: 800px; margin: 0 auto 20px auto; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* Layout Kertas A4 */
        .report-paper { 
            width: 210mm; min-height: 297mm; padding: 10mm; margin: auto; 
            background: white; border: 1px solid #ddd; box-sizing: border-box;
        }

        .header-table, .content-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        .header-table td, .content-table td, .content-table th { border: 1px solid var(--border); padding: 5px; }
        
        .title { text-align: center; font-weight: bold; font-size: 14px; }
        .bg-gray { background: #e2e8f0; font-weight: bold; text-transform: uppercase; }
        .text-center { text-align: center; }
        
        .sig-container { display: flex; justify-content: space-around; margin-top: 20px; text-align: center; }
        .sig-box { width: 30%; }
        .sig-img { height: 60px; object-fit: contain; margin: 5px 0; }
        
        select, button { padding: 10px; border-radius: 5px; border: 1px solid #ccc; cursor: pointer; }
        button { background: #003366; color: white; border: none; font-weight: bold; }

        @media print {
            body { background: white; padding: 0; }
            .no-print { display: none; }
            .report-paper { border: none; width: 100%; padding: 0; }
        }
    </style>
</head>
<body>

<div class="no-print">
    <h3>Pilih Laporan Mesin</h3>
    <div style="display: flex; gap: 10px;">
        <select id="select-log" style="flex: 1;">
            <option value="">-- Loading Laporan Terbaru --</option>
        </select>
        <button onclick="loadDetailLaporan()">Tampilkan Laporan</button>
        <button onclick="window.print()" style="background: #28a745;">Cetak / Save PDF</button>
    </div>
</div>

<div class="report-paper" id="report-content">
    <table class="header-table">
        <tr>
            <td rowspan="4" width="20%" class="text-center">
                <img src="https://amarilyskg.co.id/bootstrap/img/logo.png" style="width: 100px;">
            </td>
            <td rowspan="4" class="title">PREVENTIF ROBOT & STAND LABEL BULANAN</td>
            <td width="15%">No. Dokumen</td>
            <td width="20%">: AF.SP 05.08.Rev-00</td>
        </tr>
        <tr>
            <td>Tanggal Terbit</td>
            <td>: 02 Agustus 2024</td>
        </tr>
        <tr>
            <td>Halaman</td>
            <td>: 1/1</td>
        </tr>
        <tr>
            <td>Tanggal Revisi</td>
            <td>: -</td>
        </tr>
    </table>

    <table class="header-table">
        <tr>
            <td width="20%">MERK MESIN</td><td id="info-mesin" width="30%">-</td>
            <td width="20%">TANGGAL</td><td id="info-tgl" width="30%">-</td>
        </tr>
    </table>

    <table class="content-table" id="table-checklist">
        <thead>
            <tr class="bg-gray">
                <th width="5%">NO</th>
                <th>ITEM CHECK</th>
                <th width="25%">STANDARD</th>
                <th width="10%">STATUS</th>
                <th width="20%">KETERANGAN</th>
            </tr>
        </thead>
        <tbody id="body-checklist">
            <tr><td colspan="5" class="text-center">Silakan pilih mesin terlebih dahulu</td></tr>
        </tbody>
    </table>

    <div class="sig-container">
        <div class="sig-box">
            <div>Dibuat Oleh (Pelaksana)</div>
            <img id="sig-pelaksana" class="sig-img" src="">
            <div id="nama-pelaksana">.........</div>
        </div>
        <div class="sig-box">
            <div>Diperiksa (Koordinator)</div>
            <img id="sig-koordinator" class="sig-img" src="">
            <div id="nama-koordinator">.........</div>
            <div id="note-koordinator" style="font-size: 10px; font-style: italic;"></div>
        </div>
        <div class="sig-box">
            <div>Disetujui (Superintendent)</div>
            <img id="sig-superintendent" class="sig-img" src="">
            <div id="nama-superintendent">.........</div>
            <div id="note-superintendent" style="font-size: 10px; font-style: italic;"></div>
        </div>
    </div>
</div>

<script>
    const SB_URL = "https://dsyvlavphvrdidmodokd.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
    const _sb = supabase.createClient(SB_URL, SB_KEY);

    async function fetchLogs() {
        const { data } = await _sb.from('prslb_log').select('*, prslb_mesin(qr_code_id)').order('created_at', {ascending: false});
        const select = document.getElementById('select-log');
        select.innerHTML = '<option value="">-- Pilih Riwayat Laporan --</option>';
        data.forEach(log => {
            const date = new Date(log.created_at).toLocaleDateString('id-ID');
            select.innerHTML += `<option value="${log.id}">${log.prslb_mesin.qr_code_id} - ${date} (${log.pelaksana_nama})</option>`;
        });
    }

    async function loadDetailLaporan() {
        const logId = document.getElementById('select-log').value;
        if (!logId) return;

        const { data: log } = await _sb.from('prslb_log')
            .select('*, prslb_mesin(qr_code_id), prslb_result(*, prslb_items(*))')
            .eq('id', logId)
            .single();

        if (log) {
            // Fill Info Header
            document.getElementById('info-mesin').innerText = log.prslb_mesin.qr_code_id;
            document.getElementById('info-tgl').innerText = new Date(log.created_at).toLocaleDateString('id-ID');

            // Fill Checklist
            const body = document.getElementById('body-checklist');
            body.innerHTML = "";
            let currentCat = "";
            let no = 1;

            log.prslb_result.forEach(res => {
                if (res.prslb_items.kategori !== currentCat) {
                    currentCat = res.prslb_items.kategori;
                    body.innerHTML += `<tr class="bg-gray"><td colspan="5">ITEM CHECK ${currentCat}</td></tr>`;
                }
                body.innerHTML += `
                    <tr>
                        <td class="text-center">${no++}</td>
                        <td>${res.prslb_items.item_name}</td>
                        <td>${res.prslb_items.standard}</td>
                        <td class="text-center" style="font-weight:bold; color:${res.status==='NG'?'red':'green'}">${res.status}</td>
                        <td>${res.keterangan || ''}</td>
                    </tr>
                `;
            });

            // Fill Signatures & Names
            document.getElementById('sig-pelaksana').src = log.signature_pelaksana || "";
            document.getElementById('nama-pelaksana').innerText = log.pelaksana_nama;

            document.getElementById('sig-koordinator').src = log.signature_koordinator || "";
            document.getElementById('nama-koordinator').innerText = log.koordinator_nama || "Belum Diverifikasi";
            document.getElementById('note-koordinator').innerText = log.koordinator_note ? `Note: ${log.koordinator_note}` : "";

            document.getElementById('sig-superintendent').src = log.signature_superintendent || "";
            document.getElementById('nama-superintendent').innerText = log.superintendent_nama || "Belum Disetujui";
            document.getElementById('note-superintendent').innerText = log.superintendent_note ? `Note: ${log.superintendent_note}` : "";
        }
    }

    window.onload = fetchLogs;
</script>
</body>
</html>
