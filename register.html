<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar Akun (Verifikasi Email)</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; max-width: 500px; margin: 0 auto; }
        
        /* Input dan Select dibuat seragam style-nya */
        input, select { 
            width: 100%; 
            padding: 15px; 
            margin-bottom: 10px; 
            border: 2px solid #000; 
            border-radius: 10px; 
            font-size: 16px; 
            box-sizing: border-box;
            background-color: white; 
        }
        
        button { 
            width: 100%; padding: 20px; background: #DC2626; color: white; 
            font-weight: bold; font-size: 18px; border: none; border-radius: 10px; 
            cursor: pointer; margin-top: 10px;
        }
        button:active { transform: scale(0.98); }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

    <h2>DAFTAR AKUN BARU</h2>
    <p>Silakan isi data. Email Wajib Aktif!</p>

    <input type="text" id="fullname" placeholder="Nama Lengkap" required>
    <input type="text" id="divisi" placeholder="Divisi (Contoh: Produksi)" required>
    
    <select id="jabatan" required>
        <option value="" disabled selected>-- Pilih Jabatan --</option>
        <option value="OPERATOR | PELAKSANA">OPERATOR | PELAKSANA</option>
        <option value="SUPERVISOR | KOORDINATOR">SUPERVISOR | KOORDINATOR</option>
        <option value="SUPERINTENDENT">SUPERINTENDENT</option>
    </select>

    <input type="email" id="email" placeholder="Email Kantor / Pribadi" required>
    <input type="password" id="password" placeholder="Password (Min 6 Karakter)" required>

    <button onclick="prosesDaftar()" id="btnDaftar">MULAI DAFTAR</button>

    <script>
        // --- 1. KONFIGURASI SUPABASE ---
        const SUPABASE_URL = 'https://dsyvlavphvrdidmodokd.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E';
        
        if (typeof supabase === 'undefined') {
            alert("ERROR: Script Supabase Gagal Load.");
            throw new Error("Supabase missing");
        }

        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 2. FUNGSI DAFTAR ---
        async function prosesDaftar() {
            const btn = document.getElementById('btnDaftar');
            
            // Ambil Input
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            const fullname = document.getElementById('fullname').value.trim();
            const divisi = document.getElementById('divisi').value.trim();
            const jabatan = document.getElementById('jabatan').value; // Mengambil value dari dropdown

            if(!email || !password || !fullname || !divisi || !jabatan) { 
                alert("Mohon isi semua data, termasuk memilih jabatan!"); 
                return; 
            }
            if(password.length < 6) { 
                alert("Password minimal 6 karakter!"); 
                return; 
            }

            // Kunci tombol saat loading
            btn.disabled = true;
            btn.innerText = "SEDANG MEMPROSES...";

            try {
                // STEP A: SIGN UP
                const { data: authData, error: authError } = await client.auth.signUp({
                    email: email, 
                    password: password,
                    options: {
                        // Redirect ke halaman sukses setelah klik email
                        emailRedirectTo: 'https://amarilyspm.vercel.app/success.html',
                        
                        // Metadata user
                        data: {
                            full_name: fullname,
                            divisi: divisi,
                            jabatan: jabatan
                        }
                    }
                });

                if (authError) throw new Error(authError.message);

                // Jika sukses
                if (authData.user) {
                    // Paksa logout agar user tidak otomatis login sebelum verifikasi
                    if (authData.session) await client.auth.signOut();

                    alert("PENDAFTARAN BERHASIL!\n\nSilakan CEK EMAIL Anda untuk verifikasi akun.");
                    window.location.href = 'index.html'; 
                } 

            } catch (err) {
                console.error(err);
                alert("GAGAL: " + err.message);
                
                // Buka kunci tombol jika gagal
                btn.disabled = false;
                btn.innerText = "MULAI DAFTAR";
            }
        }
    </script>
</body>
</html>
