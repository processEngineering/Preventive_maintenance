<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#dc2626">
    <title>Daftar Akun Baru</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        /* --- TEMA HITAM-MERAH (Black-Red 3D) --- */
        :root {
            --primary: #DC2626;
            --bg-main: #0A0A0A;
            --bg-card: #FFFFFF;
            --text-primary: #111111;
            --text-secondary: #374151;
            --border: #E5E7EB;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-main);
            background-image: radial-gradient(ellipse at top center, rgba(220, 38, 38, 0.15) 0%, transparent 50%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px;
            color: #ffffff;
            margin: 0;
        }

        .card {
            width: 100%;
            max-width: 420px;
            background: var(--bg-card);
            border-radius: 24px;
            padding: 28px 24px;
            box-shadow: 0 8px 32px rgba(220, 38, 38, 0.3);
            border-top: 4px solid var(--primary);
            color: var(--text-primary);
        }

        .app-header { text-align: center; margin-bottom: 20px; }
        .app-header h2 { color: #fff; text-shadow: 0 0 20px rgba(220, 38, 38, 0.5); margin: 0; font-size: 24px; }
        .app-header p { color: rgba(255,255,255,0.7); font-size: 14px; margin-top: 5px; }

        .logo-box {
            width: 72px; height: 72px; 
            background: linear-gradient(135deg, #DC2626 0%, #991B1B 100%);
            border-radius: 20px; margin: 0 auto 15px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 8px 24px rgba(220, 38, 38, 0.4);
        }

        .form-group { margin-bottom: 16px; }
        .form-group label { 
            display: block; font-size: 12px; font-weight: 700; 
            color: var(--text-secondary); margin-bottom: 6px; 
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        
        input, select {
            width: 100%; padding: 14px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            background: #fff; color: #000;
            box-sizing: border-box;
            transition: 0.2s;
        }

        input:focus, select:focus { 
            outline: none; border-color: var(--primary); 
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        button {
            width: 100%; padding: 18px;
            background: linear-gradient(135deg, #DC2626 0%, #991B1B 100%);
            color: white; font-weight: 800; font-size: 16px;
            border: none; border-radius: 12px;
            cursor: pointer; margin-top: 10px;
            text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 4px 14px rgba(220, 38, 38, 0.4);
            transition: 0.2s;
        }
        button:active { transform: scale(0.98); }
        button:disabled { background: #6B7280; cursor: not-allowed; transform: none; box-shadow: none; }

        .footer-link { text-align: center; margin-top: 24px; font-size: 14px; color: rgba(255, 255, 255, 0.6); }
        .footer-link a { color: var(--primary); text-decoration: none; font-weight: 700; }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="logo-box">
            <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
            </svg>
        </div>
        <h2>DAFTAR AKUN</h2>
        <p>Lengkapi data untuk akses sistem</p>
    </header>

    <main class="card">
        <div class="form-group">
            <label>Nama Lengkap</label>
            <input type="text" id="fullname" placeholder="Contoh: Budi Santoso" required>
        </div>

        <div class="form-group">
            <label>Divisi</label>
            <input type="text" id="divisi" placeholder="Contoh: Produksi / Maintenance" required>
        </div>

        <div class="form-group">
            <label>Jabatan</label>
            <select id="jabatan" required>
                <option value="" disabled selected>-- PILIH JABATAN --</option>
                <option value="OPERATOR | PELAKSANA">OPERATOR | PELAKSANA</option>
                <option value="SUPERVISOR | KOORDINATOR">SUPERVISOR | KOORDINATOR</option>
                <option value="SUPERINTENDENT">SUPERINTENDENT</option>
                <option value="MANAGER">MANAGER</option>
            </select>
        </div>

        <div class="form-group">
            <label>Email</label>
            <input type="email" id="email" placeholder="email@kantor.com" required>
        </div>

        <div class="form-group">
            <label>Password</label>
            <input type="password" id="password" placeholder="Minimal 6 karakter" required>
        </div>

        <button type="button" onclick="registerUser()" id="btnDaftar">DAFTAR SEKARANG</button>
    </main>

    <p class="footer-link">Sudah punya akun? <a href="index.html">Masuk di sini</a></p>

    <script>
        // --- 1. KONEKSI SUPABASE ---
        const SUPABASE_URL = 'https://dsyvlavphvrdidmodokd.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E';
        
        if (typeof supabase === 'undefined') {
            alert("ERROR: Gagal memuat library Supabase. Periksa internet Anda.");
        } 
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 2. LOGIC PENDAFTARAN ---
        async function registerUser() {
            // Ambil Value
            const fullname = document.getElementById('fullname').value.trim();
            const divisi = document.getElementById('divisi').value.trim();
            const jabatan = document.getElementById('jabatan').value;
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;

            // Validasi Sederhana
            if (!fullname || !divisi || !jabatan || !email || !password) {
                alert('Mohon lengkapi semua kolom!');
                return;
            }
            if (password.length < 6) {
                alert('Password minimal 6 karakter!');
                return;
            }

            // Kunci Tombol
            const btn = document.getElementById('btnDaftar');
            btn.disabled = true;
            btn.textContent = 'MEMPROSES...';

            try {
                // STEP A: Buat Akun Auth (Email & Password) dengan Redirect URL
                const { data: authData, error: authError } = await client.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        // --- INI BARIS PENTINGNYA (Redirect ke success.html) ---
                        emailRedirectTo: 'https://amarilyspm.vercel.app/success.html',
                        
                        // Metadata untuk disimpan di Auth User (opsional tapi bagus)
                        data: {
                            full_name: fullname,
                            divisi: divisi,
                            jabatan: jabatan
                        }
                    }
                });

                if (authError) throw authError;

                // STEP B: Simpan ke Tabel 'profiles'
                // Menggunakan .upsert() agar ID Duplicate tidak bikin error
                if (authData.user) {
                    const { error: profileError } = await client
                        .from('profiles') 
                        .upsert([{   // <--- PENTING: Pakai UPSERT, bukan INSERT
                            id: authData.user.id, 
                            full_name: fullname,
                            divisi: divisi,
                            jabatan: jabatan
                        }]);

                    if (profileError) {
                        console.error("Gagal simpan profil:", profileError);
                        alert("Akun Auth berhasil, tapi gagal simpan data profil. Hubungi Admin.\nError: " + profileError.message);
                    } else {
                        // SUKSES SEMPURNA
                        await client.auth.signOut(); // Logout otomatis
                        alert('PENDAFTARAN BERHASIL! \n\nSilakan cek inbox/spam email Anda untuk verifikasi, lalu login.');
                        window.location.href = 'index.html';
                    }
                }

            } catch (error) {
                console.error('Error Utama:', error);
                alert('Gagal Mendaftar: ' + (error.message || 'Terjadi kesalahan sistem.'));
            } finally {
                // Buka Kunci Tombol
                btn.disabled = false;
                btn.textContent = 'DAFTAR SEKARANG';
            }
        }
    </script>
</body>
</html>
