<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CLHMI - Pelaksana</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #003366; --bg: #f4f7f9; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: #333; }
        .container { max-width: 500px; margin: auto; background: white; min-height: 100vh; padding: 20px; box-sizing: border-box; }
        .header { background: var(--primary); color: white; padding: 15px; text-align: center; font-weight: bold; margin: -20px -20px 20px -20px; border-bottom: 4px solid #ffcc00; }
        #reader { width: 100%; border-radius: 10px; background: #000; margin-bottom: 10px; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; }
        .btn-primary { background: var(--primary); color: white; }
        .info-box { background: #fffde7; padding: 10px; border: 1px solid #ffd600; border-radius: 5px; font-size: 13px; margin-bottom: 15px; }
        .item-card { border-bottom: 1px solid #eee; padding: 12px 0; }
        select { width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px; border: 1px solid #ccc; background: #fff; font-size: 15px; }
        canvas { border: 2px dashed #003366; width: 100%; height: 160px; background: #fff; margin-top: 10px; touch-action: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">AF.SP 05.13 REV-00 (PELAKSANA)</div>

    <div id="step_1">
        <label><b>Nama Pelaksana:</b></label>
        <input type="text" id="nama_user" style="width:100%; padding:12px; margin:10px 0; border:1px solid #ccc; border-radius:5px;" placeholder="Input Nama...">
        <button class="btn btn-primary" onclick="startScan()">BUKA KAMERA SCAN</button>
    </div>

    <div id="step_2" style="display:none">
        <div id="reader"></div>
        <p id="scan_status" style="text-align:center; color: #666; font-size: 12px;">Mencari QR Code...</p>
        <button class="btn" onclick="location.reload()" style="background:#ccc;">KEMBALI</button>
    </div>

    <div id="step_3" style="display:none">
        <div class="info-box">
            <b>MESIN:</b> <span id="txt_mesin"></span><br>
            <b>S/N:</b> <span id="txt_sn"></span> | <b>TON:</b> <span id="txt_ton"></span>
        </div>
        
        <form id="formChecklist">
            <div id="list_items"></div>
            
            <p style="margin-top:20px;"><b>Paraf Pelaksana:</b></p>
            <canvas id="sig-canvas"></canvas>
            <button type="button" onclick="clearSig()" style="color:red; border:none; background:none; cursor:pointer;">[ Hapus Tanda Tangan ]</button>

            <button type="submit" class="btn btn-primary" id="btnSimpan" style="margin-top:20px; background: #2e7d32;">SIMPAN KE DATABASE</button>
        </form>
    </div>
</div>

<script>
const _URL = "https://dsyvlavphvrdidmodokd.supabase.co";
const _KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
const sb = supabase.createClient(_URL, _KEY);

let scanner, activeMachine, items = [];

function startScan() {
    if(!document.getElementById('nama_user').value) return alert("Isi nama pelaksana!");
    document.getElementById('step_1').style.display = 'none';
    document.getElementById('step_2').style.display = 'block';

    scanner = new Html5Qrcode("reader");
    scanner.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, 
        (text) => { 
            document.getElementById('scan_status').innerText = "Berhasil! Mencocokkan data...";
            scanner.stop().then(() => lookupMachine(text)); 
        },
        (err) => { /* ignore scan errors */ }
    ).catch(err => alert("Kamera Error: " + err));
}

async function lookupMachine(code) {
    // PENCARIAN DUA ARAH: Cek ID (UUID) atau Nama Mesin
    let query = sb.from('clhmi_machine').select('*');
    if(code.length > 30) { query = query.eq('id', code.trim()); } 
    else { query = query.eq('merk_mesin', code.trim()); }

    const { data, error } = await query.single();

    if(error || !data) {
        alert("MESIN TIDAK TERDAFTAR!\nQR Code terbaca: " + code);
        location.reload();
        return;
    }
    activeMachine = data;
    loadForm();
}

async function loadForm() {
    const { data } = await sb.from('clhmi_items').select('*').order('urutan');
    items = data;

    let html = "";
    data.forEach(it => {
        html += `
            <div class="item-card">
                <div style="font-size:14px; font-weight:bold;">${it.nama_pengecekan}</div>
                <div style="font-size:11px; color:#666; margin-bottom:5px;">Standar: ${it.standar || '-'}</div>
                <select id="status_${it.id}">
                    <option value="OK">âˆš OK</option>
                    <option value="NG">X NG</option>
                </select>
            </div>`;
    });
    
    document.getElementById('list_items').innerHTML = html;
    document.getElementById('txt_mesin').innerText = activeMachine.merk_mesin;
    document.getElementById('txt_sn').innerText = activeMachine.serial_no;
    document.getElementById('txt_ton').innerText = activeMachine.tonage;
    
    document.getElementById('step_2').style.display = 'none';
    document.getElementById('step_3').style.display = 'block';
    
    initCanvas();
}

// LOGIKA SIGNATURE (TOUCH SUPPORT)
const canvas = document.getElementById("sig-canvas");
const ctx = canvas.getContext("2d");
let drawing = false;

function initCanvas() {
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    ctx.lineWidth = 3; ctx.lineCap = "round"; ctx.strokeStyle = "#003366";
}

function getPos(e) {
    const r = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return { x: clientX - r.left, y: clientY - r.top };
}

canvas.addEventListener("touchstart", (e) => { drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); e.preventDefault(); }, {passive:false});
canvas.addEventListener("touchmove", (e) => { if(!drawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); e.preventDefault(); }, {passive:false});
window.addEventListener("touchend", () => drawing = false);

function clearSig() { ctx.clearRect(0,0,canvas.width,canvas.height); }

// SIMPAN DATA
document.getElementById('formChecklist').onsubmit = async (e) => {
    e.preventDefault();
    const sig = canvas.toDataURL();
    if(sig.length < 2000) return alert("Silakan Paraf dulu!");

    const btn = document.getElementById('btnSimpan');
    btn.disabled = true; btn.innerText = "Sedang Mengirim...";

    const now = new Date();
    const tglCheck = now.toISOString().split('T')[0];

    try {
        // 1. UPSERT HEADER (clhmi)
        const { data: header, error: errH } = await sb.from('clhmi').upsert({
            machine_id: activeMachine.id,
            merk_mesin: activeMachine.merk_mesin,
            serial_no: activeMachine.serial_no,
            tonage: activeMachine.tonage,
            bulan: now.getMonth() + 1,
            tahun: now.getFullYear(),
            paraf: sig,
            created_by: document.getElementById('nama_user').value,
            status_form: 'submitted'
        }, { onConflict: 'machine_id,bulan,tahun' }).select().single();

        if(errH) throw errH;

        // 2. INSERT RESULTS (clhmi_results)
        const results = items.map(it => ({
            clhmi_id: header.id,
            item_id: it.id,
            status: document.getElementById('status_'+it.id).value,
            tanggal_cek: tglCheck
        }));

        // Hapus entri lama hari ini biar tidak duplikat
        await sb.from('clhmi_results').delete().eq('clhmi_id', header.id).eq('tanggal_cek', tglCheck);
        const { error: errD } = await sb.from('clhmi_results').insert(results);

        if(errD) throw errD;

        alert("SUKSES! Data berhasil masuk.");
        location.reload();
    } catch (err) {
        console.error(err);
        alert("Gagal Simpan: " + err.message);
        btn.disabled = false;
        btn.innerText = "COBA SIMPAN LAGI";
    }
}
</script>
</body>
</html>
