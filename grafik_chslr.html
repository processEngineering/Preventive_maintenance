<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Statistik CHSLR - AKG Maintenance</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #c91919; 
            --primary-dark: #a50e0e;
            --border: #e2e8f0;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --bg-body: #f8fafc;
            --bg-card: #ffffff;

            /* Status Colors */
            --success: #10b981; /* OK */
            --danger: #ef4444;  /* NG */
            --warning: #f59e0b; /* MN / MT */
            --gray: #94a3b8;    /* NA */
            
            --sidebar-width: 280px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            background: var(--bg-body);
            font-family: 'Inter', sans-serif;
            font-size: 9pt;
            color: var(--text-main);
        }

        /* --- TOP BAR --- */
        .top-bar {
            position: sticky; top: 0; left: 0; right: 0;
            background: #1e293b; padding: 12px 20px;
            display: flex; justify-content: flex-start; align-items: center; gap: 15px; 
            z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.2); flex-wrap: wrap; 
        }

        .hamburger-btn {
            width: 38px; height: 38px; background: var(--primary); color: white;
            border-radius: 8px; display: flex; justify-content: center; align-items: center;
            font-size: 18px; cursor: pointer; transition: 0.2s; flex-shrink: 0;
        }
        .hamburger-btn:hover { background: var(--primary-dark); }

        .ctrl-title { font-size: 11px; font-weight: 900; color: white; text-transform: uppercase; }
        
        .input-ctrl { 
            padding: 8px 12px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); 
            background: rgba(255,255,255,0.05); color: white; font-weight: bold; outline: none;
        }
        .input-ctrl option { background: #1e293b; color: white; }

        .btn-show { 
            background: var(--primary); color: white; border: none; padding: 8px 16px; 
            border-radius: 6px; font-weight: 800; cursor: pointer; transition: 0.2s;
        }
        .btn-show:hover { background: var(--primary-dark); transform: scale(1.02); }

        /* --- SIDEBAR NAV --- */
        .sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            z-index: 2000; opacity: 0; visibility: hidden; transition: 0.3s; backdrop-filter: blur(4px);
        }
        .sidebar-overlay.active { opacity: 1; visibility: visible; }
        
        .side-nav {
            position: fixed; top: 0; left: -100%; width: var(--sidebar-width); height: 100vh; background: white;
            z-index: 2001; transition: left 0.4s cubic-bezier(0.25, 1, 0.5, 1); 
            display: flex; flex-direction: column; padding: 20px; box-shadow: 10px 0 30px rgba(0,0,0,0.1);
        }
        .side-nav.active { left: 0; }
        .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .sidebar-title { font-weight: 800; color: var(--primary); font-size: 20px; }
        .sidebar-close { font-size: 24px; color: #888; cursor: pointer; transition: 0.2s; }
        .sidebar-close:hover { color: var(--primary); }

        .nav-item {
            display: flex; align-items: center; text-decoration: none; color: #666; 
            background: white; width: 100%; padding: 14px 20px; margin-bottom: 15px;
            border: 2px solid #eee; border-radius: 12px; transition: all 0.2s; font-weight: 600;
        }
        .nav-item:hover { border-color: var(--primary); background: #fff5f5; color: var(--primary); transform: translateX(5px); }
        .nav-icon-box { display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; margin-right: 15px; font-size: 22px; color: var(--primary); }

        /* --- CONTENT --- */
        .app-container { width: 100%; max-width: 1240px; margin: 0 auto; padding: 20px; }

        .chart-section {
            background: var(--bg-card); border-radius: 16px; padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid var(--border);
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .chart-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; border-left: 5px solid var(--primary); padding-left: 15px;
        }

        .chart-title { font-size: 16px; font-weight: 900; text-transform: uppercase; color: var(--text-main); }

        .chart-container { 
            width: 100%; 
            min-width: 1000px; /* Lebar minimum agar 27 mesin tidak berhimpitan */
            height: 500px; /* Disesuaikan untuk grafik vertikal */
            position: relative; 
        }

        /* --- SUMMARY CARDS (CLEAN UI) --- */
        .summary-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;
            margin-top: 10px;
        }

        .summary-card {
            background: white; border-radius: 12px; padding: 15px; border: 1px solid var(--border);
            position: relative; overflow: hidden; border-left: 5px solid var(--border);
            display: flex; flex-direction: column;
        }

        .summary-label { font-size: 10px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; margin-top: 8px; }
        .summary-val { font-size: 24px; font-weight: 900; line-height: 1; color: var(--text-main); }

        .loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); display: none; flex-direction: column;
            justify-content: center; align-items: center; z-index: 100;
        }

        /* --- AI SECTION --- */
        .ai-card {
            background: var(--bg-card); border-radius: 16px; padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid var(--border);
            margin-top: 20px;
        }
        .ai-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px;
        }
        .ai-content {
            font-size: 13px; line-height: 1.6; color: var(--text-main);
        }
        .ai-content strong { color: var(--primary); }
        .ai-loading { display: flex; align-items: center; gap: 10px; color: var(--text-muted); font-weight: bold; }
    </style>
</head>
<body>

    <!-- OVERLAY & SIDEBAR -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
    <nav class="side-nav" id="sidebar">
        <div class="sidebar-header">
            <span class="sidebar-title">Dashboard</span>
            <div class="sidebar-close" onclick="toggleSidebar()"><i class="fa-solid fa-xmark"></i></div>
        </div>
        <a href="index.html" class="nav-item" id="nav-home"><div class="nav-icon-box"><i class="fa-solid fa-house"></i></div><span>Home</span></a>
        <a href="menu_utama.html" class="nav-item" id="nav-menu"><div class="nav-icon-box"><i class="fa-solid fa-table-cells-large"></i></div><span>Menu Utama</span></a>
        <a href="download_data.html" class="nav-item"><div class="nav-icon-box"><i class="fa-solid fa-cloud-arrow-down"></i></div><span>Unduh Data</span></a>
        <a href="informasi_akun.html" class="nav-item"><div class="nav-icon-box"><i class="fa-solid fa-user"></i></div><span>Akun</span></a>
    </nav>

    <!-- TOP BAR -->
    <div class="top-bar">
        <div class="hamburger-btn" onclick="toggleSidebar()">
            <i class="fa-solid fa-bars"></i>
        </div>
        <span class="ctrl-title">Periode:</span>
        <select id="f-bulan" class="input-ctrl">
            <option value="1">Januari</option><option value="2">Februari</option><option value="3">Maret</option>
            <option value="4">April</option><option value="5">Mei</option><option value="6">Juni</option>
            <option value="7">Juli</option><option value="8">Agustus</option><option value="9">September</option>
            <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
        </select>
        <select id="f-tahun" class="input-ctrl">
            <option value="2025">2025</option><option value="2026" selected>2026</option>
        </select>
        <button onclick="loadData()" class="btn-show"><i class="fa-solid fa-sync"></i> TAMPILKAN GRAFIK</button>
    </div>

    <!-- CONTENT -->
    <div class="app-container">
        
        <div class="chart-section">
            <div class="chart-header">
                <div class="chart-title" id="main-title">Statistik Checklist Harian Standlabel & Robot</div>
                <div style="font-size: 11px; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">X: Nama Mesin | Y: Jumlah Status</div>
            </div>
            
            <div class="chart-container">
                <canvas id="chslrChart"></canvas>
                <div id="loading" class="loading-overlay">
                    <i class="fa-solid fa-circle-notch fa-spin" style="font-size:35px; color:var(--primary);"></i>
                    <p style="font-weight:900; margin-top:10px; letter-spacing: 1px;">MENGHITUNG DATA...</p>
                </div>
            </div>
        </div>

        <div class="summary-grid">
            <div class="summary-card"><div class="summary-val" id="total-cek">0</div><div class="summary-label">TOTAL ITEM DICEK</div></div>
            <div class="summary-card"><div class="summary-val" id="total-ok">0</div><div class="summary-label">NORMAL (OK)</div></div>
            <div class="summary-card"><div class="summary-val" id="total-ng">0</div><div class="summary-label">TEMUAN (NG)</div></div>
            <div class="summary-card"><div class="summary-val" id="total-mn">0</div><div class="summary-label">PERBAIKAN (MT/MN)</div></div>
        </div>

        <!-- AI SECTION -->
        <div class="ai-card">
            <div class="ai-header">
                <h3 style="margin:0; display:flex; align-items:center; gap:8px; font-size: 16px;">
                    <i class="fa-solid fa-robot text-primary" style="color: var(--primary);"></i> Analisa AI (Gemini)
                </h3>
                <button onclick="generateAIAnalysis()" class="btn-show" style="padding: 8px 16px; font-size: 11px;" id="btn-ai">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> Minta Analisa
                </button>
            </div>
            <div class="ai-content" id="ai-content">
                <p style="color: var(--text-muted); font-style: italic; font-size: 12px; margin: 0;">Silakan "Tampilkan Grafik" terlebih dahulu, lalu klik tombol di atas untuk mendapatkan analisa tren otomatis dari AI.</p>
            </div>
        </div>

    </div>

    <script>
        // Setup Supabase
        const SUPABASE_URL = 'https://dsyvlavphvrdidmodokd.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let chartInstance = null;
        let currentStatsText = ""; // Variabel untuk menyimpan teks prompt AI

        window.onload = () => {
            setupDynamicNavigation();
            const now = new Date();
            document.getElementById('f-bulan').value = now.getMonth() + 1;
            loadData();
        };

        // --- SMART NAVIGATION LOGIC ---
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('sidebarOverlay').classList.toggle('active');
        }

        async function setupDynamicNavigation() {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) return;
                const { data: profile } = await supabaseClient.from('profiles').select('jabatan').eq('id', session.user.id).single();
                if (profile) {
                    const jabatan = profile.jabatan.toUpperCase();
                    const navHome = document.getElementById('nav-home');
                    const navMenu = document.getElementById('nav-menu');
                    let homeLink = 'index.html', menuLink = 'menu_utama.html';
                    
                    if (jabatan.includes('OPERATOR')) { homeLink = 'OPERATOR_HOME.html'; menuLink = 'MENU_UTAMA_OPERATOR.html'; }
                    else if (jabatan.includes('SUPERVISOR')) { homeLink = 'SUPERVISOR_HOME.html'; menuLink = 'MENU_UTAMA_SUPERVISOR.html'; }
                    else if (jabatan.includes('SUPERINTENDENT')) { homeLink = 'SUPERINTENDENT_HOME.html'; menuLink = 'MENU_UTAMA_SUPERINTENDENT.html'; }
                    else if (jabatan.includes('MANAGER')) { homeLink = 'MANAGER_HOME.html'; menuLink = 'MENU_UTAMA_MANAGER.html'; }
                    
                    if (navHome) navHome.href = homeLink;
                    if (navMenu) navMenu.href = menuLink;
                }
            } catch (err) { console.error("Error setting up navigation:", err); }
        }
        // ------------------------------

        async function loadData() {
            const bulan = document.getElementById('f-bulan').value;
            const tahun = document.getElementById('f-tahun').value;
            
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('main-title').innerText = `Statistik Checklist Harian Standlabel & Robot - ${document.getElementById('f-bulan').options[bulan-1].text} ${tahun}`;

            try {
                // 1. Ambil Header (chslr_log)
                const { data: logs, error: lErr } = await supabaseClient
                    .from('chslr_log')
                    .select('id, mesin_id')
                    .eq('bulan', bulan)
                    .eq('tahun', tahun);

                if (lErr) throw lErr;

                if (!logs || logs.length === 0) {
                    resetUI();
                    return;
                }

                // 2. Ambil data status dari tabel chslr_result
                const logIds = logs.map(l => l.id);
                const { data: results, error: rErr } = await supabaseClient
                    .from('chslr_result')
                    .select('log_id, status')
                    .in('log_id', logIds);

                if (rErr) throw rErr;

                // 3. Agregasi Data Per Mesin
                const stats = {}; 
                let gTotal = 0, gOK = 0, gNG = 0, gMN = 0;

                logs.forEach(l => {
                    if (!stats[l.mesin_id]) {
                        stats[l.mesin_id] = { ok: 0, ng: 0, mn: 0, na: 0 };
                    }
                });

                results.forEach(res => {
                    const log = logs.find(l => l.id === res.log_id);
                    if (!log) return;
                    
                    const machineName = log.mesin_id || 'Unknown Machine';

                    let s = (res.status || 'NA').trim().toUpperCase();
                    if (['OK', 'NORMAL', 'BAIK', 'AMAN', 'GOOD', 'V', 'TRUE'].includes(s)) s = 'OK';
                    else if (['NG', 'NOT OK', 'RUSAK', 'ABNORMAL', 'TEMUAN', 'X', 'FALSE'].includes(s)) s = 'NG';
                    else if (['MN', 'MT', 'MAINTENANCE', 'PERBAIKAN', 'REPAIR'].includes(s)) s = 'MN';
                    else s = 'NA';

                    if (s === 'OK') { stats[machineName].ok++; gOK++; }
                    else if (s === 'NG') { stats[machineName].ng++; gNG++; }
                    else if (s === 'MN') { stats[machineName].mn++; gMN++; }
                    else { stats[machineName].na++; }
                    
                    gTotal++;
                });

                document.getElementById('total-cek').innerText = gTotal.toLocaleString();
                document.getElementById('total-ok').innerText = gOK.toLocaleString();
                document.getElementById('total-ng').innerText = gNG.toLocaleString();
                document.getElementById('total-mn').innerText = gMN.toLocaleString();

                // Siapkan teks untuk dibaca AI
                currentStatsText = `Bulan: ${document.getElementById('f-bulan').options[bulan-1].text}, Tahun: ${tahun}.\nData Total: ${gTotal} Item Dicek, ${gOK} OK, ${gNG} NG, ${gMN} Maintenance.\nDetail Mesin:\n`;
                for (const [mesin, data] of Object.entries(stats)) {
                    if (data.ok > 0 || data.ng > 0 || data.mn > 0) {
                        currentStatsText += `- ${mesin}: OK(${data.ok}), NG(${data.ng}), MN(${data.mn}), NA(${data.na})\n`;
                    }
                }

                renderChart(stats);

            } catch (err) {
                console.error("Fetch Error:", err);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function renderChart(stats) {
            const ctx = document.getElementById('chslrChart').getContext('2d');
            
            const labels = Object.keys(stats).sort();
            const dataOK = labels.map(l => stats[l].ok);
            const dataNG = labels.map(l => stats[l].ng);
            const dataMN = labels.map(l => stats[l].mn);
            const dataNA = labels.map(l => stats[l].na);

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Normal (OK)', data: dataOK, backgroundColor: '#10B981' },
                        { label: 'Temuan (NG)', data: dataNG, backgroundColor: '#EF4444' },
                        { label: 'Perbaikan (MT/MN)', data: dataMN, backgroundColor: '#F59E0B' },
                        { label: 'Kosong (NA)', data: dataNA, backgroundColor: '#94a3b8' }
                    ]
                },
                options: {
                    indexAxis: 'x', // X = NAMA MESIN (Vertikal)
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'bottom', // INDIKATOR DIPINDAH KE BAWAH
                            labels: { font: { weight: 'bold', size: 11 }, usePointStyle: true } 
                        },
                        tooltip: { 
                            mode: 'index', 
                            intersect: false,
                            backgroundColor: 'rgba(30, 41, 59, 0.95)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' }
                        }
                    },
                    scales: {
                        x: { 
                            stacked: true, 
                            grid: { display: false },
                            ticks: { 
                                font: { weight: '800', size: 9 }, 
                                color: '#1e293b',
                                maxRotation: 45,
                                minRotation: 45
                            } 
                        },
                        y: { 
                            stacked: true, 
                            grid: { color: '#f1f5f9' },
                            title: { display: true, text: 'Jumlah Status', font: { weight: '900' } } 
                        }
                    }
                }
            });
        }

        function resetUI() {
            document.getElementById('total-cek').innerText = '0';
            document.getElementById('total-ok').innerText = '0';
            document.getElementById('total-ng').innerText = '0';
            document.getElementById('total-mn').innerText = '0';
            if (chartInstance) chartInstance.destroy();
            currentStatsText = "";
            document.getElementById('ai-content').innerHTML = '<p style="color: var(--text-muted); font-style: italic; font-size: 12px; margin: 0;">Silakan "Tampilkan Grafik" terlebih dahulu, lalu klik tombol di atas untuk mendapatkan analisa tren otomatis dari AI.</p>';
        }

        // --- FUNGSI ANALISA AI (GEMINI) ---
        async function generateAIAnalysis() {
            const btn = document.getElementById('btn-ai');
            const content = document.getElementById('ai-content');

            if (!currentStatsText) {
                content.innerHTML = '<span style="color:var(--danger); font-weight:bold;">Silakan klik "Tampilkan Grafik" terlebih dahulu agar AI memiliki data untuk dibaca!</span>';
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Memproses...';
            content.innerHTML = '<div class="ai-loading"><i class="fa-solid fa-circle-notch fa-spin text-primary"></i> AI sedang menganalisa tren data mesin...</div>';

            const apiKey = "AIzaSyCdaZd4xpm-eV-i6b44te3AgYiTCCJZvZw"; // API Key dari gambar

            const prompt = `Kamu adalah Ahli Maintenance Mesin Industri (Superintendent). Analisa data "Checklist Harian Standlabel & Robot" berikut secara profesional, singkat, dan tajam.
            
            Data:
            ${currentStatsText}
            
            Berikan respon dalam format HTML sederhana (tanpa tag <html>/<body>, gunakan <strong> untuk penekanan, dan <br> atau <p> untuk paragraf, gunakan <ul><li> untuk list jika perlu). Jangan menggunakan formatting markdown seperti asterik.
            Struktur yang wajib ada:
            1. Kesimpulan Singkat (1 paragraf)
            2. Fokus Perhatian (Sebutkan mesin dengan NG/MN tertinggi jika ada)
            3. Rekomendasi Tindakan (2-3 poin logis)`;

            try {
                // Implementasi Exponential Backoff
                let retries = 5;
                let delay = 1000;
                let response;
                let errorDetails = "";
                
                while (retries > 0) {
                    // MENGGUNAKAN MODEL GEMINI-1.5-FLASH YANG DI DUKUNG PENUH OLEH API KEY PUBLIK
                    response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: "Gunakan bahasa Indonesia profesional, proaktif, dan analitis." }] }
                        })
                    });
                    
                    if (response.ok) break;
                    
                    // Simpan detail error jika gagal
                    errorDetails = await response.text();
                    retries--;
                    await new Promise(r => setTimeout(r, delay));
                    delay *= 2;
                }

                if (!response || !response.ok) {
                    throw new Error(errorDetails || 'API request failed');
                }
                
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Gagal mendapatkan analisa dari AI.";
                
                content.innerHTML = text;

            } catch (error) {
                console.error("AI Error Lengkap:", error);
                
                // Menampilkan error secara spesifik agar mudah didiagnosa
                let errorMsg = "Gagal terhubung ke layanan AI. Pastikan perangkat memiliki koneksi internet.";
                if (error.message.includes("API key not valid")) {
                    errorMsg = "API Key tidak valid. Silakan periksa kembali API Key Anda.";
                } else if (error.message.includes("quota") || error.message.includes("429")) {
                    errorMsg = "Limit/Kuota API Key AI telah tercapai.";
                } else if (error.message.includes("403")) {
                    errorMsg = "Akses ditolak oleh Google. Mungkin API Key belum mengaktifkan layanan Generative Language API.";
                }
                
                content.innerHTML = `<span style="color:var(--danger); font-weight:bold;"><i class="fa-solid fa-triangle-exclamation"></i> ${errorMsg} <br><br><small style="color:gray;">Cek (Inspect -> Console) untuk detail error.</small></span>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Minta Analisa';
            }
        }
    </script>
</body>
</html>
