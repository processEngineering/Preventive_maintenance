<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Superintendent - Final Approval</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    
    <style>
        :root { --primary: #0f172a; --bg: #f1f5f9; --accent: #2563eb; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .container { max-width: 600px; margin: auto; }
        
        .report-card { 
            background: white; border-radius: 20px; padding: 20px; margin-bottom: 25px;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); border: 1px solid #e2e8f0;
        }

        .mesin-title { font-size: 22px; font-weight: 800; color: var(--primary); margin-bottom: 15px; }

        .sig-container { 
            background: #fff; border: 2px dashed #cbd5e1; border-radius: 12px; 
            position: relative; margin: 10px 0; touch-action: none;
        }
        canvas { width: 100%; height: 180px; display: block; cursor: crosshair; }

        input { 
            width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #cbd5e1; 
            margin-bottom: 10px; font-size: 14px; box-sizing: border-box;
        }

        .btn-submit { 
            width: 100%; padding: 16px; background: #cbd5e1; color: white; border: none; 
            border-radius: 12px; font-size: 15px; font-weight: bold; cursor: not-allowed;
            transition: 0.3s;
        }
        .btn-active { background: var(--primary) !important; cursor: pointer !important; box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2); }
        .btn-clear { position: absolute; top: 5px; right: 5px; background: #eee; border: none; padding: 5px 10px; border-radius: 5px; font-size: 10px; z-index: 20; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div style="text-align:center; margin-bottom:20px;">
        <img src="https://amarilyskg.co.id/bootstrap/img/logo.png" height="40">
        <h3>Superintendent Approval</h3>
    </div>

    <div id="list-container">
        <p style="text-align:center;">Mencari laporan yang perlu disetujui...</p>
    </div>
</div>

<script>
    const SB_URL = "https://dsyvlavphvrdidmodokd.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
    const _sb = supabase.createClient(SB_URL, SB_KEY);

    let signaturePads = {};

    async function loadReports() {
        const { data, error } = await _sb.from('prslb_log')
            .select('*, prslb_mesin(qr_code_id)')
            .eq('status_verifikasi', true)
            .eq('status_final', false);

        const container = document.getElementById('list-container');
        if (!data || data.length === 0) {
            container.innerHTML = "<p style='text-align:center; color:gray;'>Tidak ada laporan menunggu approval.</p>";
            return;
        }

        container.innerHTML = "";
        data.forEach(log => {
            const cardHtml = `
                <div class="report-card" id="card-${log.id}">
                    <div class="mesin-title">${log.prslb_mesin.qr_code_id}</div>
                    <p style="font-size:12px; color:gray;">Teknisi: ${log.pelaksana_nama} | Koordinator: ${log.koordinator_nama}</p>
                    
                    <input type="text" id="name-${log.id}" placeholder="Nama Superintendent" oninput="runValidation('${log.id}')">
                    
                    <div class="sig-container">
                        <button class="btn-clear" onclick="resetCanvas('${log.id}')">Hapus</button>
                        <canvas id="canvas-${log.id}"></canvas>
                    </div>

                    <button id="btn-${log.id}" class="btn-submit" onclick="approveFinal('${log.id}')" disabled>APPROVE & CLOSE</button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', cardHtml);

            // Inisialisasi Signature Pad (SANGAT KRUSIAL)
            setTimeout(() => {
                const canvas = document.getElementById(`canvas-${log.id}`);
                
                // Set ukuran canvas agar pas secara internal
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);

                const pad = new SignaturePad(canvas, {
                    backgroundColor: 'rgba(255, 255, 255, 0)',
                    penColor: 'rgb(0, 0, 0)'
                });

                // Setiap kali user selesai mencoret, jalankan validasi
                pad.addEventListener("endStroke", () => {
                    runValidation(log.id);
                });

                signaturePads[log.id] = pad;
            }, 500);
        });
    }

    // Fungsi Validasi agar tombol menyala
    function runValidation(id) {
        const nameValue = document.getElementById(`name-${id}`).value.trim();
        const pad = signaturePads[id];
        const btn = document.getElementById(`btn-${id}`);

        // Jika Nama >= 3 huruf DAN Tanda Tangan tidak kosong
        if (nameValue.length >= 3 && pad && !pad.isEmpty()) {
            btn.classList.add('btn-active');
            btn.disabled = false;
        } else {
            btn.classList.remove('btn-active');
            btn.disabled = true;
        }
    }

    function resetCanvas(id) {
        if (signaturePads[id]) {
            signaturePads[id].clear();
            runValidation(id);
        }
    }

    async function approveFinal(id) {
        const btn = document.getElementById(`btn-${id}`);
        const name = document.getElementById(`name-${id}`).value;
        const signatureBase64 = signaturePads[id].toDataURL();

        btn.innerText = "‚è≥ Sedang Proses...";
        btn.disabled = true;

        const { error } = await _sb.from('prslb_log').update({
            superintendent_nama: name,
            signature_superintendent: signatureBase64,
            status_final: true
        }).eq('id', id);

        if (!error) {
            document.getElementById(`card-${id}`).style.display = 'none';
            if (document.querySelectorAll('.report-card[style*="display: none"]').length === signaturePads.length) {
                loadReports();
            }
        } else {
            alert("Gagal Approve: " + error.message);
            btn.innerText = "APPROVE & CLOSE";
            btn.disabled = false;
        }
    }

    window.onload = loadReports;
</script>
</body>
</html>
