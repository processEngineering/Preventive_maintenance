<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cek Diagnosa Database</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #00ff00; }
        .log-box { background: #000; padding: 15px; border: 1px solid #333; margin-bottom: 10px; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; }
        h2 { color: white; border-bottom: 1px solid #555; padding-bottom: 10px; }
        .error { color: #ff4444; font-weight: bold; }
        .success { color: #00cc00; font-weight: bold; }
        .warn { color: #ffbb00; }
    </style>
</head>
<body>

<h2>üïµÔ∏è‚Äç‚ôÇÔ∏è DIAGNOSA SUPABASE</h2>
<div id="logs">Memulai pengecekan...<br></div>

<script>
    // 1. CONFIG
    const SB_URL = "https://dsyvlavphvrdidmodokd.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
    const supabase = window.supabase.createClient(SB_URL, SB_KEY);
    const logDiv = document.getElementById('logs');

    function log(msg, type = 'normal') {
        const span = document.createElement('div');
        span.innerHTML = `> ${msg}`;
        span.className = "log-box " + type;
        logDiv.appendChild(span);
    }

    async function runCheck() {
        try {
            // TEST 1: CEK KONEKSI DASAR
            log("1. Cek Koneksi Dasar ke 'prslb_log'...", "warn");
            const { count, error: err1 } = await supabase.from('prslb_log').select('*', { count: 'exact', head: true });
            
            if (err1) {
                log(`‚ùå GAGAL KONEKSI: ${err1.message}`, "error");
                log(`SOLUSI: Cek SQL Editor > Jalankan Script Policy RLS!`, "error");
                return;
            }
            log(`‚úÖ KONEKSI BERHASIL. Total Data di prslb_log: ${count} baris.`, "success");

            // TEST 2: CEK DATA YANG SIAP DI-APPROVE
            log("2. Mencari data dengan syarat: status_verifikasi=TRUE & status_final=FALSE...", "warn");
            const { data: dataFilter, error: err2 } = await supabase
                .from('prslb_log')
                .select('*') // Tanpa join dulu
                .eq('status_verifikasi', true)
                .eq('status_final', false);

            if (err2) {
                log(`‚ùå ERROR FILTER: ${err2.message}`, "error");
                return;
            }

            if (dataFilter.length === 0) {
                log(`‚ö†Ô∏è DATA KOSONG (0 item).`, "warn");
                log(`PENYEBAB: Tidak ada laporan yang statusnya 'Siap Approve'.`, "normal");
                log(`SOLUSI: Pastikan di tabel 'prslb_log' ada baris dimana status_verifikasi = TRUE dan status_final = FALSE.`, "normal");
                
                // Cek data mentah
                const { data: allData } = await supabase.from('prslb_log').select('id, status_verifikasi, status_final').limit(5);
                log(`Sample Data di DB saat ini:\n${JSON.stringify(allData, null, 2)}`, "normal");
                return;
            }
            log(`‚úÖ DITEMUKAN ${dataFilter.length} data siap approve.`, "success");

            // TEST 3: CEK RELASI (JOIN)
            // Ini biasanya yang bikin macet loading kalau nama relasi salah
            log("3. Test JOIN ke tabel 'prslb_result' & 'prslb_items'...", "warn");
            const { data: dataJoin, error: err3 } = await supabase
                .from('prslb_log')
                .select(`
                    id,
                    prslb_result (
                        id,
                        status,
                        prslb_items ( item_name )
                    )
                `)
                .eq('id', dataFilter[0].id); // Test 1 data saja

            if (err3) {
                log(`‚ùå ERROR JOIN: ${err3.message}`, "error");
                log(`PENYEBAB: Nama relasi salah atau RLS tabel anak (result/items) belum dibuka.`, "error");
                log(`SOLUSI: Cek apakah Foreign Key di database sudah benar.`, "error");
                return;
            }

            log(`‚úÖ JOIN BERHASIL! Data lengkap berhasil ditarik.`, "success");
            log(`üéâ KESIMPULAN: Kode HTML Superintendet seharusnya jalan. Jika masih blank, coba clear cache browser.`, "success");

        } catch (e) {
            log(`CRITICAL ERROR: ${e.message}`, "error");
        }
    }

    runCheck();
</script>

</body>
</html>
