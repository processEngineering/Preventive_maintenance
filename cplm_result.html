<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Result Data - AKG Maintenance</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --primary: #DC2626;
            --bg-dark: #050505;
            --bg-card: #121212; 
            --text-white: #FFFFFF;
            --text-gray: #A3A3A3;
            --nav-height: 70px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }

        body {
            background: var(--bg-dark);
            color: var(--text-white);
            padding-bottom: calc(var(--nav-height) + 20px);
            min-height: 100vh;
        }

        /* --- UI APLIKASI (Mode Gelap) --- */
        .app-shell { max-width: 100%; padding: 20px; }
        .search-container { max-width: 800px; margin: 0 auto 20px auto; background: var(--bg-card); padding: 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); }
        .search-title { font-size: 18px; font-weight: 700; color: var(--primary); margin-bottom: 15px; text-transform: uppercase; letter-spacing: 0.5px; }
        .filter-group { display: flex; gap: 10px; }
        .filter-input { flex: 1; background: #1a1a1a; border: 1px solid rgba(255,255,255,0.2); color: white; padding: 12px; border-radius: 8px; outline: none; }
        .filter-input:focus { border-color: var(--primary); }
        
        .result-list { max-width: 800px; margin: 0 auto; display: flex; flex-direction: column; gap: 10px; }
        .result-card { background: var(--bg-card); border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .result-card:hover { border-color: var(--primary); background: #1a1a1a; transform: translateY(-2px); }
        .result-info h3 { font-size: 16px; color: white; margin-bottom: 4px; font-weight: 700; }
        .result-info p { font-size: 12px; color: var(--text-gray); }

        /* --- VIEWER KERTAS (Mode Cetak) --- */
        .paper-viewer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; overflow-y: auto; padding: 20px 0; }
        .viewer-controls { position: fixed; top: 20px; right: 20px; z-index: 1001; display: flex; gap: 10px; }
        .control-btn { background: var(--primary); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; font-size: 20px; transition: transform 0.2s; }
        .control-btn:hover { transform: scale(1.1); }
        .btn-pdf { background: #059669; }

        /* A4 Paper Styling - Strict to PDF Layout */
        .page-a4 { 
            width: 210mm; 
            min-height: 297mm; 
            background: white; 
            color: black; 
            margin: 0 auto; 
            padding: 10mm 15mm; 
            box-shadow: 0 0 30px rgba(0,0,0,0.5); 
            font-family: Arial, Helvetica, sans-serif; 
            position: relative; 
            box-sizing: border-box; 
        }

        /* Responsiveness untuk A4 Viewer */
        @media (max-width: 800px) { 
            .page-a4 { 
                width: 100%; 
                min-height: auto; 
                padding: 10px; 
                transform-origin: top center;
            } 
            .viewer-controls { bottom: 20px; top: auto; right: 20px; flex-direction: column-reverse; }
        }

        /* --- ELEMEN DOKUMEN --- */
        
        /* HEADER */
        .doc-header { display: flex; border: 1px solid black; margin-bottom: 5px; height: 90px; }
        .header-left { width: 40%; border-right: 1px solid black; padding: 5px; display: flex; align-items: center; gap: 10px; }
        .logo-img { width: 60px; height: auto; object-fit: contain; }
        .header-left h1 { font-size: 11px; font-weight: 900; margin: 0; line-height: 1.3; }
        .header-center { width: 35%; border-right: 1px solid black; display: flex; align-items: center; justify-content: center; text-align: center; padding: 5px; }
        .header-center h2 { font-size: 16px; font-weight: 900; text-decoration: underline; margin: 0; }
        .header-right { width: 25%; padding: 5px; font-size: 9px; display: flex; flex-direction: column; justify-content: center; }
        .meta-row { display: flex; margin-bottom: 4px; }
        .meta-label { width: 85px; font-weight: normal; }
        .meta-sep { width: 5px; }
        .meta-val { flex: 1; font-weight: 700; }

        /* INFO GRID */
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; column-gap: 20px; row-gap: 5px; font-size: 10px; margin-bottom: 10px; padding: 0 5px; }
        .info-item { display: flex; align-items: flex-end; }
        .info-item-label { width: 130px; font-weight: 700; }
        .info-item-sep { margin-right: 5px; }
        .info-item-val { flex: 1; border-bottom: 1px dotted black; font-weight: 500; min-height: 14px; }

        /* TABLE - FIXED LAYOUT */
        .main-table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 9px; 
            border: 1px solid black; 
            margin-bottom: 10px;
            table-layout: fixed; /* Kunci lebar kolom */
        }
        .main-table th, .main-table td { 
            border: 1px solid black; 
            padding: 4px 5px; 
            vertical-align: middle; 
            word-wrap: break-word;
        }
        .main-table th { background: #fff; font-weight: 900; text-align: center; height: 25px; text-transform: uppercase; }
        .section-header { background: #eee; font-weight: 900; text-align: center; padding: 4px !important; }

        /* Checkboxes Custom */
        .cb-container { 
            display: flex; 
            gap: 8px; 
            justify-content: center; /* Center alignment */
            align-items: center; 
            width: 100%;
            white-space: nowrap; /* Pastikan satu baris */
        }
        .cb-item { display: flex; align-items: center; gap: 3px; font-weight: bold; }
        .sq-box { width: 10px; height: 10px; border: 1px solid black; display: flex; align-items: center; justify-content: center; font-size: 8px; line-height: 1; font-weight: 900; }

        /* Styling Khusus Fungsional Test */
        .ft-item-cell {
            font-weight: 500 !important; /* Font Normal (Tidak Tebal) */
            padding-left: 10px !important;
            white-space: nowrap !important;
            overflow: hidden;
        }

        /* Layout Kotak Catatan Mould (Kanan Bawah) - REVISED POSISI */
        .mould-note-cell {
            vertical-align: top; /* Align Top */
            padding: 8px;
            background-color: #fff;
            height: 100%;
        }
        .mn-container { 
            display: flex; 
            flex-direction: column; 
            height: 100%;
            justify-content: flex-start; /* Pastikan konten mulai dari atas */
        }
        .mn-title { 
            font-weight: 900; 
            text-decoration: underline; 
            margin-bottom: 5px; 
            font-size: 10px; 
            display: block; 
            margin-top: 0; /* Hapus margin atas default jika ada */
        }
        .mn-text { 
            font-size: 10px; 
            font-weight: 500; 
            white-space: pre-wrap; 
            line-height: 1.4; 
        }

        /* SIGNATURES */
        .sig-container { display: flex; border: 1px solid black; text-align: center; font-size: 9px; page-break-inside: avoid; }
        .sig-box { flex: 1; border-right: 1px solid black; display: flex; flex-direction: column; }
        .sig-box:last-child { border-right: none; }
        .sig-title { border-bottom: 1px solid black; padding: 5px; font-weight: 900; height: 40px; display: flex; align-items: center; justify-content: center; background: #fff; text-transform: uppercase; }
        .sig-space { height: 60px; display: flex; align-items: center; justify-content: center; }
        .sig-img { max-height: 55px; max-width: 90%; }
        .sig-name { border-top: 1px solid black; padding: 5px; font-weight: 700; min-height: 25px; text-transform: uppercase; }

        /* LOADING */
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: 2000; display: none; justify-content: center; align-items: center; flex-direction: column; color: white; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <i class="fa fa-circle-notch fa-spin fa-3x" style="color:var(--primary)"></i>
        <p style="margin-top:15px; font-weight:bold; font-size:18px;">Sedang Memproses...</p>
    </div>

    <div class="app-shell">
        <div class="search-container">
            <div class="search-title"><i class="fa-solid fa-print"></i> Data Laporan Mould</div>
            <div class="filter-group">
                <input type="date" id="searchDate" class="filter-input" onchange="fetchReports()">
                <button onclick="fetchReports()" style="background:var(--primary); border:none; color:white; padding:0 25px; border-radius:8px; cursor:pointer; font-weight:bold;"><i class="fa-solid fa-magnifying-glass"></i></button>
            </div>
        </div>
        <div id="resultList" class="result-list">
            <div style="text-align:center; padding: 40px; color: var(--text-gray); font-style: italic;">Silakan pilih tanggal untuk menampilkan data.</div>
        </div>
    </div>

    <!-- VIEWER -->
    <div id="paperViewer" class="paper-viewer">
        <div class="viewer-controls">
            <button class="control-btn btn-pdf" onclick="downloadPDF()" title="Download PDF"><i class="fa-solid fa-file-pdf"></i></button>
            <button class="control-btn" onclick="closeViewer()" title="Tutup"><i class="fa-solid fa-xmark"></i></button>
        </div>
        
        <div class="page-a4" id="contentToPrint">
            <!-- HEADER -->
            <div class="doc-header">
                <div class="header-left">
                    <img src="https://amarilyskg.co.id/bootstrap/img/logo.png" alt="Logo" id="logoImg" class="logo-img"> 
                    <h1>AKG PT. AMARILYS<br>KARISMA GEMILANG</h1>
                </div>
                <div class="header-center">
                    <h2>CHECK LIST<br>PERAWATAN MOLD</h2>
                </div>
                <div class="header-right">
                    <div class="meta-row"><span class="meta-label">No. Dokumen</span><span class="meta-sep">:</span><span class="meta-val">AF.SP 05.12.Rev-00</span></div>
                    <div class="meta-row"><span class="meta-label">Tanggal Terbit</span><span class="meta-sep">:</span><span class="meta-val">02 Agustus 2024</span></div>
                    <div class="meta-row"><span class="meta-label">Halaman</span><span class="meta-sep">:</span><span class="meta-val">1/1</span></div>
                    <div class="meta-row"><span class="meta-label">Tanggal Revisi</span><span class="meta-sep">:</span><span class="meta-val">-</span></div>
                </div>
            </div>

            <!-- INFO FIELDS -->
            <div class="info-grid">
                <div class="info-item"><span class="info-item-label">KODE MOLD</span><span class="info-item-sep">:</span><span class="info-item-val" id="p_kode"></span></div>
                <div class="info-item"><span class="info-item-label">TANGGAL PERAWATAN</span><span class="info-item-sep">:</span><span class="info-item-val" id="p_tgl"></span></div>
                
                <div class="info-item"><span class="info-item-label">PRODUK</span><span class="info-item-sep">:</span><span class="info-item-val" id="p_produk"></span></div>
                <div class="info-item"><span class="info-item-label">MATERIAL MOLD</span><span class="info-item-sep">:</span><span class="info-item-val" id="p_material"></span></div>
                
                <div class="info-item"><span class="info-item-label">TYPE MOLD</span><span class="info-item-sep">:</span><span class="info-item-val" id="p_type"></span></div>
                <div class="info-item"><span class="info-item-label">TANGGAL AKHIR SHOT</span><span class="info-item-sep">:</span><span class="info-item-val" id="p_akhir"></span></div>
                
                <div class="info-item"><span class="info-item-label">PIC PERAWATAN</span><span class="info-item-sep">:</span><span class="info-item-val" id="p_pic"></span></div>
                <div class="info-item"></div>
            </div>

            <!-- TABLE -->
            <table class="main-table">
                <!-- PROPORSI KOLOM YANG SEIMBANG -->
                <!-- Kolom 1 (No) = 5% -->
                <!-- Kolom 2 (Item) = 35% -->
                <!-- Kolom 3 (Std) = 15% -->
                <!-- Kolom 4 (Kondisi) = 15% (Ramping) -->
                <!-- Kolom 5 (Catatan) = 30% (Lebar) -->
                <!-- Total 100% -->
                <!-- Untuk Row Fungsional (26-30): Col 1-3 digabung = 55% Total -->
                <colgroup>
                    <col style="width: 5%;">
                    <col style="width: 35%;">
                    <col style="width: 15%;">
                    <col style="width: 15%;">
                    <col style="width: 30%;">
                </colgroup>
                <thead>
                    <tr>
                        <th>NO</th>
                        <th>ITEM CHECK</th>
                        <th>STANDART</th>
                        <th>KONDISI</th>
                        <th>CATATAN</th>
                    </tr>
                </thead>
                <tbody id="paperBody">
                    <!-- Dynamic Rows Here -->
                </tbody>
            </table>

            <!-- SIGNATURES -->
            <div class="sig-container">
                <div class="sig-box">
                    <div class="sig-title">PIC PREVENTIVE<br>(OPERATOR)</div>
                    <div class="sig-space"><img id="s_op_img" class="sig-img" src=""></div>
                    <div class="sig-name" id="s_op_name"></div>
                </div>
                <div class="sig-box">
                    <div class="sig-title">DIPERIKSA<br>(SPV. REPAIR & PREPARATION)</div>
                    <div class="sig-space"><img id="s_spv_img" class="sig-img" src=""></div>
                    <div class="sig-name" id="s_spv_name"></div>
                </div>
                <div class="sig-box">
                    <div class="sig-title">DIKETAHUI<br>(SUPERINTENDENT WORKSHOP)</div>
                    <div class="sig-space"><img id="s_supt_img" class="sig-img" src=""></div>
                    <div class="sig-name" id="s_supt_name"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- NAVIGASI BAWAH -->
    <div style="position:fixed; bottom:0; left:0; right:0; background:#111; border-top:1px solid #333; height:70px; display:flex; justify-content:space-around; align-items:center; z-index:100;">
        <a href="index.html" style="color:#666; text-align:center;"><i class="fa-solid fa-house" style="font-size:24px;"></i></a>
        <a href="menu_utama.html" style="color:#666; text-align:center;"><i class="fa-solid fa-bars" style="font-size:24px;"></i></a>
        <a href="download_data.html" style="color:#DC2626; text-align:center;"><i class="fa-solid fa-download" style="font-size:24px;"></i></a>
        <a href="informasi_akun.html" style="color:#666; text-align:center;"><i class="fa-solid fa-circle-user" style="font-size:24px;"></i></a>
    </div>

    <script>
        const APP_URL = 'https://dsyvlavphvrdidmodokd.supabase.co';
        const APP_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E';
        let supabaseClient;
        try { supabaseClient = window.supabase.createClient(APP_URL, APP_KEY); } catch (e) { console.error(e); }

        let itemsDefinition = [];
        const LOGO_URL_ASLI = "https://amarilyskg.co.id/bootstrap/img/logo.png";
        let GLOBAL_BASE64_LOGO = "";

        window.onload = async function() {
            await fetchItemsDef();
            await preloadLogo();
        };

        // --- CORE LOGIC ---
        async function fetchImageAsBase64(url) {
            const proxies = [
                'https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(url),
                'https://corsproxy.io/?' + encodeURIComponent(url)
            ];
            for (let proxyUrl of proxies) {
                try {
                    const response = await fetch(proxyUrl);
                    if (response.ok) {
                        const blob = await response.blob();
                        return new Promise(r => {
                            const reader = new FileReader();
                            reader.onloadend = () => r(reader.result);
                            reader.readAsDataURL(blob);
                        });
                    }
                } catch (e) {}
            }
            return null;
        }

        async function preloadLogo() {
            const base64 = await fetchImageAsBase64(LOGO_URL_ASLI);
            if(base64) GLOBAL_BASE64_LOGO = base64;
        }

        async function replaceImgWithCanvas(imgElement, base64Data) {
            return new Promise(resolve => {
                const image = new Image();
                image.onload = function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = image.naturalWidth;
                    canvas.height = image.naturalHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(image, 0, 0);
                    canvas.className = imgElement.className;
                    canvas.id = imgElement.id;
                    canvas.style.width = getComputedStyle(imgElement).width;
                    canvas.style.height = 'auto';
                    imgElement.parentNode.replaceChild(canvas, imgElement);
                    resolve(canvas);
                };
                image.src = base64Data;
            });
        }

        async function fetchItemsDef() {
            const { data } = await supabaseClient.from('clpm_items').select('*').order('no_item', {ascending: true});
            itemsDefinition = data || [];
        }

        window.fetchReports = async function() {
            const dateVal = document.getElementById('searchDate').value;
            const listEl = document.getElementById('resultList');
            if(!dateVal) return listEl.innerHTML = '<div style="text-align:center; padding:20px;">Pilih tanggal.</div>';
            listEl.innerHTML = '<div style="text-align:center; padding:20px;">Memuat data...</div>';
            
            const { data } = await supabaseClient.from('clpm_log').select('*').eq('tanggal_perawatan', dateVal).order('created_at', {ascending: false});
            
            if(!data || !data.length) return listEl.innerHTML = '<div style="text-align:center; padding:20px;">Tidak ada laporan ditemukan pada tanggal ini.</div>';

            let html = '';
            data.forEach(item => {
                html += `
                <div class="result-card" onclick="openPaper('${item.id}')">
                    <div class="result-info">
                        <h3>${item.kode_mold || 'Tanpa Kode'}</h3>
                        <p>${item.pic_perawatan || '-'} | ${item.produk || '-'}</p>
                    </div>
                    <i class="fa-solid fa-file-pdf" style="color:#DC2626; font-size:24px;"></i>
                </div>`;
            });
            listEl.innerHTML = html;
        }

        window.openPaper = async function(logId) {
            document.getElementById('loading-overlay').style.display = 'flex';
            
            try {
                const { data: logData } = await supabaseClient.from('clpm_log').select('*').eq('id', logId).single();
                const { data: resData } = await supabaseClient.from('clpm_result').select('*').eq('log_id', logId);

                if(GLOBAL_BASE64_LOGO) document.getElementById('logoImg').src = GLOBAL_BASE64_LOGO;
                document.getElementById('p_kode').innerText = logData.kode_mold || '-';
                document.getElementById('p_tgl').innerText = logData.tanggal_perawatan || '-';
                document.getElementById('p_produk').innerText = logData.produk || '-';
                document.getElementById('p_material').innerText = logData.material_mold || '-';
                document.getElementById('p_type').innerText = logData.type_mold || '-';
                document.getElementById('p_akhir').innerText = logData.tanggal_akhir_shot || '-';
                document.getElementById('p_pic').innerText = logData.pic_perawatan || '-';

                const tbody = document.getElementById('paperBody');
                let html = '';
                
                // --- LOGIKA CATATAN KONDISI MOULD ---
                let mouldNoteText = '';
                const mouldNoteItem = resData.find(r => r.catatan_kondisi_mould && r.catatan_kondisi_mould.trim() !== '');
                if (mouldNoteItem) {
                    mouldNoteText = mouldNoteItem.catatan_kondisi_mould;
                }

                for (const def of itemsDefinition) {
                    const res = resData.find(r => r.no_item === def.no_item) || {};
                    const kondisi = res.kondisi || '';

                    // 1. SECTION HEADERS
                    if(def.no_item === 23) {
                        html += `<tr><td colspan="5" class="section-header">FOOD PACKAGING MOLD</td></tr>`;
                    }
                    if(def.no_item === 26) {
                        html += `<tr><td colspan="5" class="section-header">FUNGSIONAL TEST</td></tr>`;
                    }

                    // 2. ITEMS 26-30 (FUNGSIONAL TEST - SPECIAL LAYOUT)
                    if (def.no_item >= 26 && def.no_item <= 30) {
                        const isOk = kondisi === 'OK';
                        const isNg = kondisi === 'NOT OK';

                        // Checkbox OK/NG (Ramping & Center)
                        const checkHtml = `
                            <div class="cb-container">
                                <div class="cb-item"><div class="sq-box">${isOk ? '✓' : ''}</div> OK</div>
                                <div class="cb-item"><div class="sq-box">${isNg ? '✓' : ''}</div> NOT OK</div>
                            </div>
                        `;

                        // Kotak Kanan (Hanya di Item 26, rowspan 5) - CATATAN SAJA
                        let rightCell = '';
                        if (def.no_item === 26) {
                            rightCell = `
                            <td rowspan="5" class="mould-note-cell">
                                <div class="mn-container">
                                    <span class="mn-title">Kondisi Mould :</span>
                                    <div class="mn-text">${mouldNoteText || '-'}</div>
                                </div>
                            </td>`;
                        }

                        // ROW LAYOUT (3 KOLOM GABUNG + STATUS + CATATAN)
                        html += `
                        <tr>
                            <td colspan="3" class="ft-item-cell">
                                ${def.no_item}. ${def.item_check}
                            </td>
                            <td style="text-align:center;">${checkHtml}</td>
                            ${rightCell}
                        </tr>`;
                        
                    } else {
                        // 3. STANDARD ITEMS (1-25)
                        let checkHtml = '<div class="cb-container" style="justify-content:flex-start; flex-wrap:wrap;">';
                        if(def.options && Array.isArray(def.options) && def.options.length > 0) {
                            def.options.forEach(opt => {
                                const isChecked = kondisi === opt;
                                checkHtml += `<div class="cb-item"><div class="sq-box">${isChecked ? '✓' : ''}</div> ${opt}</div>`;
                            });
                        } else {
                            checkHtml += `<div class="cb-item"><div class="sq-box">${kondisi ? '✓' : ''}</div> ${kondisi || '-'}</div>`;
                        }
                        checkHtml += '</div>';

                        html += `
                        <tr>
                            <td style="text-align:center;">${def.no_item}</td>
                            <td>${def.item_check}</td>
                            <td style="text-align:center;">${def.standart || ''}</td>
                            <td>${checkHtml}</td>
                            <td>${res.catatan || ''}</td>
                        </tr>`;
                    }
                }
                
                tbody.innerHTML = html;

                document.getElementById('s_op_img').src = logData.paraf_operator || '';
                document.getElementById('s_op_name').innerText = logData.pic_perawatan || '...';
                
                document.getElementById('s_spv_img').src = logData.paraf_spv || '';
                document.getElementById('s_spv_name').innerText = logData.nama_spv || '...';
                
                document.getElementById('s_supt_img').src = logData.paraf_superintendent || '';
                document.getElementById('s_supt_name').innerText = logData.nama_superintendent || '...';

                document.getElementById('paperViewer').style.display = 'block';

            } catch(e) {
                console.error(e);
                alert("Terjadi kesalahan saat memuat data.");
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        window.closeViewer = function() { document.getElementById('paperViewer').style.display = 'none'; }

        // --- PDF GENERATION ENGINE ---
        window.downloadPDF = async function() {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'flex';
            
            const element = document.getElementById('contentToPrint');
            const imgLogo = document.getElementById('logoImg');
            
            const originalShadow = element.style.boxShadow;
            const originalMargin = element.style.margin;
            
            element.style.boxShadow = 'none';
            element.style.margin = '0';
            element.style.transform = 'none'; 
            window.scrollTo(0,0);

            let originalImgClone = null;
            if (imgLogo && imgLogo.tagName === 'IMG') {
                try {
                    originalImgClone = imgLogo.cloneNode(true);
                    let dataToUse = GLOBAL_BASE64_LOGO || await fetchImageAsBase64(LOGO_URL_ASLI);
                    if (dataToUse) await replaceImgWithCanvas(imgLogo, dataToUse);
                } catch(e){ console.log("Logo swap skip", e); }
            }

            try {
                const canvas = await html2canvas(element, { 
                    scale: 2, 
                    useCORS: true, 
                    allowTaint: true,
                    backgroundColor: "#ffffff",
                    logging: false
                });

                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = 210;
                
                const imgProps = pdf.getImageProperties(imgData);
                const contentHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, contentHeight);
                const kode = document.getElementById('p_kode').innerText || 'Mould';
                const tgl = document.getElementById('p_tgl').innerText || 'Date';
                pdf.save(`Checklist_${kode}_${tgl}.pdf`);

            } catch (err) {
                console.error(err);
                alert("Gagal membuat PDF. Coba lagi.");
            } finally {
                if (originalImgClone) {
                    const canvasLogo = document.getElementById('logoImg');
                    if(canvasLogo && canvasLogo.tagName === 'CANVAS') {
                        canvasLogo.parentNode.replaceChild(originalImgClone, canvasLogo);
                    }
                }
                element.style.boxShadow = originalShadow;
                element.style.margin = originalMargin;
                element.style.transform = ''; 
                overlay.style.display = 'none';
            }
        }
    </script>
</body>
</html>
