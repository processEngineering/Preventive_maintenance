<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.6, maximum-scale=2.0, user-scalable=yes">
    <title>Checklist Perawatan Mould - AKG</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Font & Icons untuk UI Bar & Sidebar -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            /* TEMA WARNA AKG UI */
            --primary: #c91919; 
            --primary-light: #e53935;
            --primary-dark: #a50e0e;
            --border: #e5e7eb;
            --text-main: #333333;
            --sidebar-width: 280px; 
        }

        /* === GLOBAL RESET === */
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        
        body {
            margin: 0; padding: 0;
            background: #525659;
            font-family: Arial, sans-serif;
            font-size: 7pt;
            /* Padding atas dihapus karena sudah di-handle oleh top-bar sticky */
            padding-bottom: 40px;
            overflow: auto; 
        }

        /* --- TOP ACTION BAR (GARIS TIGA + KONTROL HORIZONTAL) --- */
        .top-bar {
            position: sticky;
            top: 0;
            left: 0;
            right: 0;
            background: #1e293b; /* Warna gelap agar kontras */
            padding: 10px 20px;
            display: flex;
            justify-content: flex-start; /* Posisi ke Kiri */
            align-items: center;
            gap: 25px; /* Jarak antara Garis 3 dan Panel Kontrol */
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            flex-wrap: wrap;
        }

        /* Tombol Hamburger di Kiri */
        .hamburger-btn {
            width: 42px; height: 42px;
            background: var(--primary); color: white;
            border-radius: 8px; display: flex; justify-content: center; align-items: center;
            font-size: 20px; cursor: pointer; transition: 0.2s;
            flex-shrink: 0;
        }
        .hamburger-btn:hover { background: var(--primary-dark); transform: scale(1.05); }
        .hamburger-btn:active { transform: scale(0.95); }

        /* Panel Kontrol di sebelah Kanan Garis Tiga */
        .controls-horizontal {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        .controls-horizontal span.ctrl-title {
            font-size: 13px;
            font-weight: bold;
            color: white;
            text-transform: uppercase;
            margin-right: 5px;
            font-family: 'Inter', sans-serif;
        }

        .input-ctrl, .btn-ctrl {
            padding: 8px 12px;
            border-radius: 6px;
            border: none;
            font-size: 12px;
            font-weight: bold;
            font-family: 'Inter', sans-serif;
            outline: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .input-ctrl { background: #f8f9fa; color: #333; }
        .input-ctrl:focus { border-color: var(--primary); outline: 2px solid var(--primary); }

        .btn-show { background: #22c55e; color: white; border: none; }
        .btn-show:hover { background: #16a34a; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        .btn-print { background: var(--primary); color: white; border: none; }
        .btn-print:hover { background: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(201,25,25,0.3); }

        /* --- OFF-CANVAS SIDEBAR --- */
        .sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 2000; opacity: 0; visibility: hidden; transition: 0.3s;
            backdrop-filter: blur(4px);
        }
        .sidebar-overlay.active { opacity: 1; visibility: visible; }
        
        .side-nav {
            position: fixed; top: 0; left: -400px; width: 320px; height: 100vh;
            background: white; z-index: 2001; transition: left 0.4s cubic-bezier(0.25, 1, 0.5, 1); 
            display: flex; flex-direction: column; padding: 25px; box-shadow: 10px 0 30px rgba(0,0,0,0.3);
            font-family: 'Inter', sans-serif; 
        }
        .side-nav.active { left: 0; }

        .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; border-bottom: 2px solid #eee; padding-bottom: 20px; }
        .sidebar-title { font-weight: bold; color: var(--primary); font-size: 24px; }
        .sidebar-close { font-size: 30px; color: #888; cursor: pointer; transition: color 0.2s; }
        .sidebar-close:hover { color: var(--primary); }

        .nav-item {
            display: flex; align-items: center; text-decoration: none; color: #666; 
            background: white; width: 100%; padding: 18px 20px; margin-bottom: 15px;
            border: 2px solid #eee; border-radius: 12px; transition: all 0.2s; font-weight: bold; font-size: 16px;
        }
        .nav-item:hover, .nav-item.active { border-color: var(--primary); background: #fff5f5; color: var(--primary); transform: translateX(5px); }
        .nav-icon-box { display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; margin-right: 15px; font-size: 24px; color: var(--primary); }

        /* === WADAH KERTAS (A4 PORTRAIT) === */
        .sheet-container {
            width: 100%; overflow-x: auto; display: flex; justify-content: flex-start; 
            padding: 30px 15px; box-sizing: border-box; -webkit-overflow-scrolling: touch; 
            position: relative; z-index: 1;
        }

        @media (min-width: 820px) {
            .sheet-container { justify-content: center; }
        }

        .sheet {
            background: white;
            width: 794px; /* Lebar A4 Portrait di 96 DPI */
            min-width: 794px;
            min-height: 1122px; /* Tinggi A4 Portrait di 96 DPI */
            margin: 0 auto;
            padding: 10mm; /* Sesuai file original */
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            border-radius: 4px;
            color: black;
            font-size: 8pt;
            box-sizing: border-box;
        }

        /* =========================================
           HEADER ISO STRICT MODE (TABLE BASED)
           ========================================= */
        table.iso-header {
            width: 100%;
            height: 26mm; 
            border-collapse: collapse;
            border: 1px solid #000;
            margin-bottom: 2mm;
            table-layout: fixed; 
            font-family: Arial, sans-serif;
        }

        table.iso-header td {
            padding: 0 5px;
            vertical-align: middle;
            overflow: hidden;
            border-right: 1px solid #000;
            color: black;
        }
        
        table.iso-header td:last-child {
            border-right: none;
        }

        /* KOLOM 1: IDENTITAS (45%) */
        .h-col-1 { width: 45%; }
        
        table.h-identity {
            width: 100%; border: none; border-collapse: collapse;
        }
        table.h-identity td { border: none; padding: 0; vertical-align: middle; color: black; }
        
        .h-logo { width: 20mm; text-align: center; padding-right: 2mm !important; }
        .h-logo img { height: 18mm; width: auto; display: block; margin: 0 auto; }
        
        .h-text { 
            font-weight: 900; color: black; text-align: left; 
            line-height: 1.2; vertical-align: middle;
        }
        .company-name { font-size: 11pt; display: block; font-weight: bold; }

        /* KOLOM 2: JUDUL (30%) */
        .h-col-2 { width: 30%; text-align: center; }
        .h-title {
            font-weight: 900; font-size: 12pt; text-decoration: underline;
            line-height: 1.2; text-transform: uppercase; display: block;
        }

        /* KOLOM 3: META (25%) */
        .h-col-3 { width: 25%; padding: 2px !important; }
        
        table.h-meta-table {
            width: 100%; border-collapse: collapse; font-size: 7pt; line-height: 1.3;
        }
        table.h-meta-table td { border: none !important; padding: 0; vertical-align: top; color: black;}
        
        .hm-label { width: 28mm; font-weight: bold; white-space: nowrap; }
        .hm-sep   { width: 2mm; text-align: center; font-weight: bold; }
        .hm-val   { font-weight: normal; white-space: nowrap; }

        /* --- INFO AREA --- */
        .info-section { display: flex; width: 100%; margin-bottom: 2mm; font-size: 8pt; }
        .info-col { width: 50%; padding-right: 2mm; }
        .info-row { display: flex; align-items: flex-end; margin-bottom: 1mm; height: 4.5mm; }
        .info-label { width: 35mm; font-weight: bold; flex-shrink: 0; }
        .info-sep { width: 2mm; text-align: center; }
        .info-val { flex-grow: 1; border-bottom: 1px dotted black; font-weight: bold; padding-left: 1mm; white-space: nowrap; overflow: hidden; }

        /* --- TABEL UTAMA (FIXED LAYOUT) --- */
        .main-table {
            width: 100%; border-collapse: collapse; font-size: 7pt;
            table-layout: fixed; border: 1px solid black;
        }
        .main-table th, .main-table td {
            border: 1px solid black; padding: 0 2px; vertical-align: middle; overflow: hidden; color: black;
        }
        .main-table th {
            height: 7mm; background: white; font-weight: 900; text-align: center; text-transform: uppercase;
        }
        .main-table tr { height: 5.5mm; }
        .main-table td { height: 5.5mm; max-height: 5.5mm; }

        /* --- PROPORSI KOLOM --- */
        col.c-no { width: 5%; }
        col.c-item { width: 28%; }
        col.c-std { width: 12%; }
        col.c-cond { width: 25%; }
        col.c-note { width: 30%; }

        .section-header td {
            background-color: #E0E0E0; font-weight: 900; text-align: center; height: 5mm;
        }

        /* --- CHECKBOX LANDSCAPE --- */
        .cb-container {
            display: flex; flex-direction: row; flex-wrap: nowrap; gap: 1.5mm;
            justify-content: flex-start; align-items: center; width: 100%;
            white-space: nowrap; overflow: hidden; 
        }
        .cb-item { 
            display: flex; align-items: center; gap: 0.5mm; font-size: 5.5pt; line-height: 1; 
        }
        .sq-box {
            width: 2.5mm; height: 2.5mm; border: 1px solid black;
            display: flex; align-items: center; justify-content: center;
            font-size: 5pt; font-weight: bold; flex-shrink: 0;
        }

        .item-text, .ft-item-cell { 
            font-weight: normal; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }
        .ft-item-cell { padding-left: 2mm !important; }

        /* --- KONDISI MOULD (KANAN) --- */
        .mould-note-cell {
            vertical-align: top !important; padding: 2mm !important;
        }
        .mn-title {
            font-weight: 900; text-decoration: underline; margin-bottom: 2mm; font-size: 8pt; display: block;
        }
        .mn-content {
            font-weight: normal; font-size: 8pt; white-space: pre-wrap; line-height: 1.2;
        }

        /* --- SIGNATURE --- */
        .sig-section { display: flex; border: 1px solid black; margin-top: 2mm; width: 100%; height: 28mm; }
        .sig-box { flex: 1; border-right: 1px solid black; display: flex; flex-direction: column; }
        .sig-box:last-child { border-right: none; }
        .sig-title {
            border-bottom: 1px solid black; height: 8mm; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 7pt; text-align: center;
        }
        .sig-space { height: 14mm; display: flex; align-items: center; justify-content: center; }
        .sig-img { max-height: 12mm; max-width: 90%; filter: invert(1) brightness(0); /* Filter agar hitam pekat */ }
        .sig-name {
            border-top: 1px solid black; height: 6mm; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 8pt; text-transform: uppercase;
        }

        /* --- LOADING --- */
        #loading-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.85); display: none;
            justify-content: center; align-items: center; flex-direction: column; color: white; z-index: 10000;
        }

        /* === PENGATURAN CETAK === */
        @media print {
            @page { size: A4 portrait; margin: 0; }
            body { background: white; margin: 0; padding: 0; zoom: 95%; }
            .no-print, .top-bar, .sidebar-overlay, .side-nav { display: none !important; }
            .sheet-container { padding: 0; justify-content: center; overflow: hidden; }
            .sheet { margin: 0; box-shadow: none; border: none; width: 100%; padding: 5mm; page-break-inside: avoid; }
            .section-header td { background-color: #E0E0E0 !important; }
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <i class="fa fa-spinner fa-spin fa-3x"></i>
        <p style="margin-top:15px; font-weight:bold; font-family:'Inter', sans-serif;">Memproses...</p>
    </div>

    <!-- TOP ACTION BAR (Horizontal Control Panel & Hamburger) -->
    <div class="top-bar no-print">
        <!-- Tombol Navigasi Garis 3 di sebelah KIRI -->
        <div class="hamburger-btn" onclick="toggleSidebar()">
            <i class="fa-solid fa-bars"></i>
        </div>

        <!-- Panel Kontrol Horizontal di sebelahnya -->
        <div class="controls-horizontal">
            <span class="ctrl-title"><i class="fa-solid fa-print"></i> KONTROL:</span>
            <input type="date" id="searchDate" class="input-ctrl">
            <button class="btn-ctrl btn-show" onclick="fetchReports()"><i class="fa-solid fa-search"></i> CARI DATA</button>
            <button class="btn-ctrl btn-print" onclick="downloadPDF()"><i class="fa-solid fa-file-pdf"></i> CETAK PDF</button>
        </div>
    </div>

    <!-- OVERLAY & SIDEBAR (NO-PRINT) -->
    <div class="sidebar-overlay no-print" id="sidebarOverlay" onclick="toggleSidebar()"></div>
    <nav class="side-nav no-print" id="sidebar">
        <div class="sidebar-header">
            <span class="sidebar-title">Dashboard</span>
            <div class="sidebar-close" onclick="toggleSidebar()">
                <i class="fa-solid fa-xmark"></i>
            </div>
        </div>
        <a href="index.html" id="nav-home" class="nav-item">
            <div class="nav-icon-box"><i class="fa-solid fa-house"></i></div>
            <span>Home</span>
        </a>
        <a href="menu_utama.html" id="nav-menu" class="nav-item">
            <div class="nav-icon-box"><i class="fa-solid fa-table-cells-large"></i></div>
            <span>Menu Utama</span>
        </a>
        <a href="download_data.html" class="nav-item active">
            <div class="nav-icon-box"><i class="fa-solid fa-cloud-arrow-down"></i></div>
            <span>Unduh Data</span>
        </a>
        <a href="informasi_akun.html" class="nav-item">
            <div class="nav-icon-box"><i class="fa-solid fa-user"></i></div>
            <span>Akun</span>
        </a>
    </nav>

    <!-- CONTAINER KERTAS A4 (DOCUMENT PRINT) -->
    <div class="sheet-container">
        <div class="sheet" id="contentToPrint">
            
            <!-- HEADER ISO STRICT (TABLE) -->
            <table class="iso-header">
                <colgroup>
                    <col style="width: 45%;"> <!-- KIRI -->
                    <col style="width: 30%;"> <!-- TENGAH -->
                    <col style="width: 25%;"> <!-- KANAN -->
                </colgroup>
                <tr>
                    <!-- KIRI: IDENTITAS -->
                    <td class="h-col-1">
                        <table class="h-identity">
                            <tr>
                                <td class="h-logo">
                                    <img src="https://amarilyskg.co.id/bootstrap/img/logo.png" alt="Logo" id="logoImg">
                                </td>
                                <td class="h-text">
                                    <span class="company-name">PT. AMARILYS<br>KARISMA GEMILANG</span>
                                </td>
                            </tr>
                        </table>
                    </td>

                    <!-- TENGAH: JUDUL -->
                    <td class="h-col-2">
                        <div class="h-title">
                            CHECK LIST<br>PERAWATAN MOLD
                        </div>
                    </td>

                    <!-- KANAN: META TABLE -->
                    <td class="h-col-3">
                        <table class="h-meta-table">
                            <colgroup>
                                <col style="width: 28mm;">
                                <col style="width: 2mm;">
                                <col style="width: auto;">
                            </colgroup>
                            <tr>
                                <td class="hm-label">No. Dokumen</td>
                                <td class="hm-sep">:</td>
                                <td class="hm-val">AF.SP 05.12.Rev-00</td>
                            </tr>
                            <tr>
                                <td class="hm-label">Tanggal Terbit</td>
                                <td class="hm-sep">:</td>
                                <td class="hm-val">02 Agustus 2024</td>
                            </tr>
                            <tr>
                                <td class="hm-label">Halaman</td>
                                <td class="hm-sep">:</td>
                                <td class="hm-val">1 / 1</td>
                            </tr>
                            <tr>
                                <td class="hm-label">Tanggal Revisi</td>
                                <td class="hm-sep">:</td>
                                <td class="hm-val">-</td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>

            <!-- INFO -->
            <div class="info-section">
                <div class="info-col">
                    <div class="info-row"><span class="info-label">KODE MOLD</span><span class="info-sep">:</span><div class="info-val" id="p_kode"></div></div>
                    <div class="info-row"><span class="info-label">PRODUK</span><span class="info-sep">:</span><div class="info-val" id="p_produk"></div></div>
                    <div class="info-row"><span class="info-label">TYPE MOLD</span><span class="info-sep">:</span><div class="info-val" id="p_type"></div></div>
                    <div class="info-row"><span class="info-label">PIC PERAWATAN</span><span class="info-sep">:</span><div class="info-val" id="p_pic"></div></div>
                </div>
                <div class="info-col">
                    <div class="info-row"><span class="info-label">TANGGAL PERAWATAN</span><span class="info-sep">:</span><div class="info-val" id="p_tgl"></div></div>
                    <div class="info-row"><span class="info-label">MATERIAL MOLD</span><span class="info-sep">:</span><div class="info-val" id="p_material"></div></div>
                    <div class="info-row"><span class="info-label">TANGGAL AKHIR SHOT</span><span class="info-sep">:</span><div class="info-val" id="p_akhir"></div></div>
                </div>
            </div>

            <!-- TABLE -->
            <table class="main-table">
                <!-- LEBAR KOLOM REVISI (Kondisi lebih lebar) -->
                <colgroup>
                    <col class="c-no">   <!-- 5% -->
                    <col class="c-item"> <!-- 28% -->
                    <col class="c-std">  <!-- 12% -->
                    <col class="c-cond"> <!-- 25% (LEBAR) -->
                    <col class="c-note"> <!-- 30% -->
                </colgroup>
                <thead>
                    <tr>
                        <th>NO</th>
                        <th>ITEM CHECK</th>
                        <th>STANDART</th>
                        <th>KONDISI</th>
                        <th>CATATAN</th>
                    </tr>
                </thead>
                <tbody id="paperBody">
                    <!-- Placeholder -->
                    <tr><td colspan="5" style="text-align:center; height:10mm;">Silakan Pilih Tanggal dan Klik Cari Data...</td></tr>
                </tbody>
            </table>

            <!-- SIGNATURE -->
            <div class="sig-section">
                <div class="sig-box">
                    <div class="sig-title">PIC PREVENTIVE<br>(OPERATOR)</div>
                    <div class="sig-space"><img id="s_op_img" class="sig-img" src=""></div>
                    <div class="sig-name" id="s_op_name">...</div>
                </div>
                <div class="sig-box">
                    <div class="sig-title">DIPERIKSA<br>(SPV. REPAIR & PREPARATION)</div>
                    <div class="sig-space"><img id="s_spv_img" class="sig-img" src=""></div>
                    <div class="sig-name" id="s_spv_name">...</div>
                </div>
                <div class="sig-box">
                    <div class="sig-title">DIKETAHUI<br>(SUPERINTENDENT WORKSHOP)</div>
                    <div class="sig-space"><img id="s_supt_img" class="sig-img" src=""></div>
                    <div class="sig-name" id="s_supt_name">...</div>
                </div>
            </div>

        </div>
    </div>

    <!-- LOGIKA JAVASCRIPT (TIDAK DIUBAH FUNGSINYA) -->
    <script>
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('sidebarOverlay').classList.toggle('active');
        }

        const APP_URL = 'https://dsyvlavphvrdidmodokd.supabase.co';
        const APP_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E';
        const supabaseClient = window.supabase.createClient(APP_URL, APP_KEY);

        let itemsDefinition = [];
        const LOGO_URL_ASLI = "https://amarilyskg.co.id/bootstrap/img/logo.png";
        let GLOBAL_BASE64_LOGO = "";

        window.onload = async function() {
            setupDynamicNavigation();
            await fetchItemsDef();
            await preloadLogo();
        };

        async function setupDynamicNavigation() {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) return;

                const { data: profile } = await supabaseClient.from('profiles').select('jabatan').eq('id', session.user.id).single();

                if (profile) {
                    const jabatan = profile.jabatan.toUpperCase();
                    const navHome = document.getElementById('nav-home');
                    const navMenu = document.getElementById('nav-menu');

                    let homeLink = 'index.html';
                    let menuLink = 'menu_utama.html';

                    if (jabatan.includes('OPERATOR')) {
                        homeLink = 'OPERATOR_HOME.html';
                        menuLink = 'MENU_UTAMA_OPERATOR.html';
                    } else if (jabatan.includes('SUPERVISOR')) {
                        homeLink = 'SUPERVISOR_HOME.html';
                        menuLink = 'MENU_UTAMA_SUPERVISOR.html';
                    } else if (jabatan.includes('SUPERINTENDENT')) {
                        homeLink = 'SUPERINTENDENT_HOME.html';
                        menuLink = 'MENU_UTAMA_SUPERINTENDENT.html';
                    } else if (jabatan.includes('MANAGER') && !jabatan.includes('JUNIOR')) {
                        homeLink = 'MANAGER_HOME.html';
                        menuLink = 'MENU_UTAMA_MANAGER.html';
                    } else if (jabatan.includes('JUNIOR MANAGER PRODUKSI') || jabatan.includes('JM PRODUKSI')) {
                        homeLink = 'JUNIOR_MANAGER_PRODUKSI_HOME.html';
                        menuLink = 'MENU_UTAMA_JM_PRODUKSI.html';
                    } else if (jabatan.includes('JUNIOR MANAGER PPIC') || jabatan.includes('JM PPIC')) {
                        homeLink = 'JUNIOR_MANAGER_PPIC_HOME.html';
                        menuLink = 'MENU_UTAMA_JM_PPIC.html';
                    }

                    if (navHome) navHome.href = homeLink;
                    if (navMenu) navMenu.href = menuLink;
                }
            } catch (err) {
                console.error("Gagal mengatur navigasi dinamis:", err);
            }
        }

        // --- CORE LOGIC ---
        async function fetchImageAsBase64(url) {
            const proxies = ['https://api.codetabs.com/v1/proxy?quest=', 'https://corsproxy.io/?'];
            for (let proxy of proxies) {
                try {
                    let response = await fetch(proxy + encodeURIComponent(url));
                    if (response.ok) {
                        let blob = await response.blob();
                        return new Promise(r => {
                            let reader = new FileReader();
                            reader.onloadend = () => r(reader.result);
                            reader.readAsDataURL(blob);
                        });
                    }
                } catch (e) {}
            }
            return null;
        }

        async function preloadLogo() {
            let base64 = await fetchImageAsBase64(LOGO_URL_ASLI);
            if(base64) GLOBAL_BASE64_LOGO = base64;
        }

        async function replaceImgWithCanvas(imgElement, base64Data) {
            return new Promise(resolve => {
                const image = new Image();
                image.onload = function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = image.naturalWidth;
                    canvas.height = image.naturalHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(image, 0, 0);
                    canvas.className = imgElement.className;
                    canvas.id = imgElement.id;
                    canvas.style.width = getComputedStyle(imgElement).width;
                    imgElement.parentNode.replaceChild(canvas, imgElement);
                    resolve(canvas);
                };
                image.src = base64Data;
            });
        }

        async function fetchItemsDef() {
            const { data } = await supabaseClient.from('clpm_items').select('*').order('no_item', {ascending: true});
            itemsDefinition = data || [];
        }

        window.fetchReports = async function() {
            const dateVal = document.getElementById('searchDate').value;
            if(!dateVal) return alert("Pilih tanggal!");
            
            document.getElementById('loading-overlay').style.display = 'flex';
            
            const { data } = await supabaseClient.from('clpm_log').select('*').eq('tanggal_perawatan', dateVal).order('created_at', {ascending: false});
            
            if(!data || !data.length) {
                document.getElementById('loading-overlay').style.display = 'none';
                return alert("Tidak ada data.");
            }
            renderPaper(data[0].id);
        }

        async function renderPaper(logId) {
            const { data: logData } = await supabaseClient.from('clpm_log').select('*').eq('id', logId).single();
            const { data: resData } = await supabaseClient.from('clpm_result').select('*').eq('log_id', logId);

            if(GLOBAL_BASE64_LOGO) {
                const imgEl = document.getElementById('logoImg');
                if(imgEl && imgEl.tagName === 'IMG') imgEl.src = GLOBAL_BASE64_LOGO;
            }
            
            // Fill Info
            const fields = ['kode','tgl','produk','material','type','akhir','pic'];
            const dbFields = ['kode_mold','tanggal_perawatan','produk','material_mold','type_mold','tanggal_akhir_shot','pic_perawatan'];
            fields.forEach((f,i) => document.getElementById('p_'+f).innerText = logData[dbFields[i]] || '-');

            const tbody = document.getElementById('paperBody');
            let html = '';
            
            // Logika Catatan Kondisi Mould
            let mouldNoteText = '';
            const mouldNoteItem = resData.find(r => r.catatan_kondisi_mould && r.catatan_kondisi_mould.trim() !== '');
            if(mouldNoteItem) mouldNoteText = mouldNoteItem.catatan_kondisi_mould;

            itemsDefinition.forEach(def => {
                const res = resData.find(r => r.no_item === def.no_item) || {};
                const kondisi = res.kondisi || '';

                if(def.no_item === 23) html += `<tr class="section-header"><td colspan="5">FOOD PACKAGING MOLD</td></tr>`;
                if(def.no_item === 26) html += `<tr class="section-header"><td colspan="5">FUNGSIONAL TEST</td></tr>`;

                // --- ITEM FUNGSIONAL (26-30) ---
                if(def.no_item >= 26 && def.no_item <= 30) {
                    const isOk = kondisi === 'OK';
                    const isNg = kondisi === 'NOT OK';
                    const checkHtml = `
                        <div class="cb-container" style="justify-content:center; gap:2mm;">
                            <div class="cb-item"><div class="sq-box">${isOk?'✓':''}</div>OK</div>
                            <div class="cb-item"><div class="sq-box">${isNg?'✓':''}</div>NOT OK</div>
                        </div>`;

                    let rightCell = '';
                    if(def.no_item === 26) {
                        rightCell = `
                        <td rowspan="5" class="mould-note-cell">
                            <span class="mn-title">Kondisi Mould :</span>
                            <div class="mn-content">${mouldNoteText || '-'}</div>
                        </td>`;
                    }

                    html += `
                    <tr>
                        <td colspan="3" class="ft-item-cell">
                            ${def.no_item}. ${def.item_check}
                        </td>
                        <td style="text-align:center;">${checkHtml}</td>
                        ${rightCell}
                    </tr>`;

                } else {
                    // --- ITEM STANDAR (1-25) ---
                    // CHECKBOX LANDSCAPE - FULL TEXT
                    let checkHtml = '<div class="cb-container">';
                    if(def.options && def.options.length > 0) {
                        def.options.forEach(opt => {
                            const chk = kondisi === opt;
                            // FULL TEXT: Menampilkan ${opt} apa adanya
                            checkHtml += `<div class="cb-item"><div class="sq-box">${chk?'✓':''}</div>${opt}</div>`;
                        });
                    } else {
                        checkHtml += `<div class="cb-item"><div class="sq-box">${kondisi?'✓':''}</div>${kondisi||'-'}</div>`;
                    }
                    checkHtml += '</div>';

                    html += `
                    <tr>
                        <td style="text-align:center;">${def.no_item}</td>
                        <td class="item-text">${def.item_check}</td>
                        <td style="text-align:center;">${def.standart || ''}</td>
                        <td>${checkHtml}</td>
                        <td>${res.catatan || ''}</td>
                    </tr>`;
                }
            });
            tbody.innerHTML = html;

            document.getElementById('s_op_img').src = logData.paraf_operator || '';
            document.getElementById('s_op_name').innerText = logData.pic_perawatan || '...';
            document.getElementById('s_spv_img').src = logData.paraf_spv || '';
            document.getElementById('s_spv_name').innerText = logData.nama_spv || '...';
            document.getElementById('s_supt_img').src = logData.paraf_superintendent || '';
            document.getElementById('s_supt_name').innerText = logData.nama_superintendent || '...';

            document.getElementById('loading-overlay').style.display = 'none';
        }

        // --- DOWNLOAD PDF FIX ---
        window.downloadPDF = async function() {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'flex';
            
            const element = document.getElementById('contentToPrint');
            const imgLogo = document.getElementById('logoImg');
            
            // Scaling Safety check (DO NOT MODIFY LOGIC)
            const originalHeight = element.scrollHeight;
            const A4_HEIGHT_PX = 1123; 
            
            if (originalHeight > A4_HEIGHT_PX) {
                const scale = A4_HEIGHT_PX / originalHeight;
                element.style.transform = `scale(${scale})`;
                element.style.transformOrigin = "top left";
            }

            const oldShadow = element.style.boxShadow;
            element.style.boxShadow = 'none';
            
            let originalImgClone = null;
            if (imgLogo && imgLogo.tagName === 'IMG') {
                try {
                    originalImgClone = imgLogo.cloneNode(true);
                    let dataToUse = GLOBAL_BASE64_LOGO || await fetchImageAsBase64(LOGO_URL_ASLI);
                    if (dataToUse) await replaceImgWithCanvas(imgLogo, dataToUse);
                } catch(e){}
            }

            try {
                // RENDER
                const canvas = await html2canvas(element, { 
                    scale: 2, 
                    useCORS: true, 
                    allowTaint: true,
                    backgroundColor: "#ffffff",
                    scrollX: 0,
                    scrollY: 0
                });

                const imgData = canvas.toDataURL('image/jpeg', 0.98);
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                pdf.addImage(imgData, 'JPEG', 0, 0, 210, 297);
                
                const kode = document.getElementById('p_kode').innerText || 'Mould';
                const tgl = document.getElementById('p_tgl').innerText || 'Date';
                pdf.save(`Checklist_${kode}_${tgl}.pdf`);

            } catch (err) {
                console.error(err);
                alert("Gagal Export");
            } finally {
                if (originalImgClone) {
                    const canvasLogo = document.getElementById('logoImg');
                    if(canvasLogo && canvasLogo.tagName === 'CANVAS') {
                        canvasLogo.parentNode.replaceChild(originalImgClone, canvasLogo);
                    }
                }
                element.style.boxShadow = oldShadow;
                element.style.transform = ""; 
                overlay.style.display = 'none';
            }
        }
    </script>
</body>
</html>
