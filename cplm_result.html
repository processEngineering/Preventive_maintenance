<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.6, maximum-scale=2.0, user-scalable=yes">
    <title>Checklist Perawatan Mould - AKG</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* --- RESET & BASIC (ISO STANDARD) --- */
        * { 
            box-sizing: border-box; 
            -webkit-print-color-adjust: exact; 
            print-color-adjust: exact; 
        }
        body { 
            margin: 0; 
            padding: 0; 
            background-color: #525659; 
            font-family: Arial, sans-serif; /* HANYA ARIAL */
        }

        /* --- UI CONTROLS --- */
        .ui-controls {
            position: fixed; top: 0; left: 0; right: 0;
            background: #333; color: white; padding: 10px;
            display: flex; justify-content: center; gap: 10px; z-index: 9999;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .ui-controls input, .ui-controls button { padding: 8px 12px; border-radius: 4px; border: none; font-size: 14px; }
        .ui-controls button { background: #DC2626; color: white; font-weight: bold; cursor: pointer; }

        /* --- CONTAINER UTAMA --- */
        .page-container {
            display: flex; justify-content: center;
            padding-top: 60px; padding-bottom: 40px;
            overflow: auto;
        }

        /* --- KERTAS A4 (FISIK) --- */
        .page-a4 {
            width: 210mm; 
            height: 297mm; 
            padding: 10mm; 
            background: white; color: black;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            position: relative;
            font-size: 8pt; 
            overflow: hidden;
        }

        /* =========================================
           HEADER ISO STRICT MODE (TABLE BASED)
           ========================================= */
        table.iso-header {
            width: 100%;
            height: 26mm; /* TINGGI MATI */
            border-collapse: collapse;
            border: 1px solid #000;
            margin-bottom: 2mm;
            table-layout: fixed; /* WAJIB */
            font-family: Arial, sans-serif;
        }

        table.iso-header td {
            padding: 0 5px;
            vertical-align: middle;
            overflow: hidden;
            border-right: 1px solid #000; /* Garis pemisah kolom */
        }
        
        table.iso-header td:last-child {
            border-right: none;
        }

        /* KOLOM 1: IDENTITAS (45%) */
        .h-col-1 { width: 45%; }
        
        /* Layout Logo & Teks menggunakan Table nested untuk presisi */
        table.h-identity {
            width: 100%;
            border: none;
            border-collapse: collapse;
        }
        table.h-identity td { border: none; padding: 0; }
        
        .h-logo { width: 18mm; text-align: center; padding-right: 2mm !important; }
        .h-logo img { height: 16mm; width: auto; display: block; }
        
        .h-text { 
            font-weight: 900; 
            color: black; 
            text-align: left; 
            line-height: 1.1;
        }
        .brand-akg { font-size: 14pt; display: block; margin-bottom: 1px; }
        .company-name { font-size: 9pt; display: block; }

        /* KOLOM 2: JUDUL (30%) */
        .h-col-2 { width: 30%; text-align: center; }
        .h-title {
            font-weight: 900;
            font-size: 12pt;
            text-decoration: underline;
            line-height: 1.2;
            text-transform: uppercase;
            display: block;
        }

        /* KOLOM 3: META (25%) */
        .h-col-3 { width: 25%; padding: 2px !important; }
        
        /* Nested Table untuk Meta Data - GARIS & JARAK PRESISI */
        table.h-meta-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 7pt;
            line-height: 1.3;
        }
        table.h-meta-table td {
            border: none !important;
            padding: 0;
            vertical-align: top;
        }
        
        .hm-label { width: 28mm; font-weight: bold; white-space: nowrap; }
        .hm-sep   { width: 2mm; text-align: center; font-weight: bold; }
        .hm-val   { font-weight: normal; white-space: nowrap; }


        /* --- INFO AREA --- */
        .info-section { display: flex; width: 100%; margin-bottom: 2mm; font-size: 8pt; }
        .info-col { width: 50%; padding-right: 2mm; }
        .info-row { display: flex; align-items: flex-end; margin-bottom: 1mm; height: 4.5mm; }
        .info-label { width: 35mm; font-weight: bold; flex-shrink: 0; }
        .info-sep { width: 2mm; text-align: center; }
        .info-val { flex-grow: 1; border-bottom: 1px dotted black; font-weight: bold; padding-left: 1mm; white-space: nowrap; overflow: hidden; }

        /* --- TABEL UTAMA (FIXED LAYOUT) --- */
        .main-table {
            width: 100%; border-collapse: collapse; font-size: 7pt;
            table-layout: fixed;
            border: 1px solid black;
        }
        .main-table th, .main-table td {
            border: 1px solid black;
            padding: 0 2px;
            vertical-align: middle;
            overflow: hidden;
        }
        .main-table th {
            height: 7mm; background: white; font-weight: 900;
            text-align: center; text-transform: uppercase;
        }
        .main-table tr { height: 5.5mm; }
        .main-table td { height: 5.5mm; max-height: 5.5mm; }

        /* --- PROPORSI KOLOM --- */
        col.c-no { width: 5%; }
        col.c-item { width: 28%; }
        col.c-std { width: 12%; }
        col.c-cond { width: 25%; }
        col.c-note { width: 30%; }

        .section-header td {
            background-color: #E0E0E0; font-weight: 900; text-align: center; height: 5mm;
        }

        /* --- CHECKBOX LANDSCAPE --- */
        .cb-container {
            display: flex; flex-direction: row; 
            flex-wrap: nowrap;
            gap: 1.5mm;
            justify-content: flex-start;
            align-items: center; 
            width: 100%;
            white-space: nowrap;
            overflow: hidden; 
        }
        .cb-item { 
            display: flex; align-items: center; gap: 0.5mm; 
            font-size: 5.5pt;
            line-height: 1; 
        }
        .sq-box {
            width: 2.5mm; height: 2.5mm; border: 1px solid black;
            display: flex; align-items: center; justify-content: center;
            font-size: 5pt; font-weight: bold;
            flex-shrink: 0;
        }

        .item-text, .ft-item-cell { 
            font-weight: normal; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        .ft-item-cell { padding-left: 2mm !important; }

        /* --- KONDISI MOULD (KANAN) --- */
        .mould-note-cell {
            vertical-align: top !important; 
            padding: 2mm !important;
        }
        .mn-title {
            font-weight: 900; text-decoration: underline; margin-bottom: 2mm;
            font-size: 8pt; display: block;
        }
        .mn-content {
            font-weight: normal; font-size: 8pt; white-space: pre-wrap; line-height: 1.2;
        }

        /* --- SIGNATURE --- */
        .sig-section { display: flex; border: 1px solid black; margin-top: 2mm; width: 100%; height: 28mm; }
        .sig-box { flex: 1; border-right: 1px solid black; display: flex; flex-direction: column; }
        .sig-box:last-child { border-right: none; }
        .sig-title {
            border-bottom: 1px solid black; height: 8mm;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 7pt; text-align: center;
        }
        .sig-space { height: 14mm; display: flex; align-items: center; justify-content: center; }
        .sig-img { max-height: 12mm; max-width: 90%; }
        .sig-name {
            border-top: 1px solid black; height: 6mm;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 8pt; text-transform: uppercase;
        }

        /* --- LOADING --- */
        #loading-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.85); display: none;
            justify-content: center; align-items: center; flex-direction: column; color: white; z-index: 10000;
        }

        @media screen and (max-width: 800px) {
            .page-container { justify-content: flex-start; padding-left: 10px; padding-right: 10px; }
            .page-a4 { transform: none; margin: 0; flex-shrink: 0; }
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <i class="fa fa-spinner fa-spin fa-3x"></i>
        <p style="margin-top:15px; font-weight:bold;">Memproses...</p>
    </div>

    <!-- CONTROLS -->
    <div class="ui-controls">
        <input type="date" id="searchDate" onchange="fetchReports()">
        <button onclick="fetchReports()"><i class="fa fa-search"></i> Cari Data</button>
        <span style="border-right:1px solid #777;"></span>
        <button onclick="downloadPDF()"><i class="fa fa-file-pdf"></i> Download PDF</button>
    </div>

    <div class="page-container">
        <div class="page-a4" id="contentToPrint">
            
            <!-- HEADER ISO STRICT (TABLE) -->
            <table class="iso-header">
                <colgroup>
                    <col style="width: 45%;"> <!-- KIRI -->
                    <col style="width: 30%;"> <!-- TENGAH -->
                    <col style="width: 25%;"> <!-- KANAN -->
                </colgroup>
                <tr>
                    <!-- KIRI: IDENTITAS -->
                    <td class="h-col-1">
                        <table class="h-identity">
                            <tr>
                                <td class="h-logo">
                                    <img src="https://amarilyskg.co.id/bootstrap/img/logo.png" alt="Logo">
                                </td>
                                <td class="h-text">
                                    <span class="company-name">PT. AMARILYS<br>KARISMA GEMILANG</span>
                                </td>
                            </tr>
                        </table>
                    </td>

                    <!-- TENGAH: JUDUL -->
                    <td class="h-col-2">
                        <div class="h-title">
                            CHECK LIST<br>PERAWATAN MOLD
                        </div>
                    </td>

                    <!-- KANAN: META TABLE -->
                    <td class="h-col-3">
                        <table class="h-meta-table">
                            <colgroup>
                                <col style="width: 28mm;">
                                <col style="width: 2mm;">
                                <col style="width: auto;">
                            </colgroup>
                            <tr>
                                <td class="hm-label">No. Dokumen</td>
                                <td class="hm-sep">:</td>
                                <td class="hm-val">AF.SP 05.12.Rev-00</td>
                            </tr>
                            <tr>
                                <td class="hm-label">Tanggal Terbit</td>
                                <td class="hm-sep">:</td>
                                <td class="hm-val">02 Agustus 2024</td>
                            </tr>
                            <tr>
                                <td class="hm-label">Halaman</td>
                                <td class="hm-sep">:</td>
                                <td class="hm-val">1 / 1</td>
                            </tr>
                            <tr>
                                <td class="hm-label">Tanggal Revisi</td>
                                <td class="hm-sep">:</td>
                                <td class="hm-val">-</td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>

            <!-- INFO -->
            <div class="info-section">
                <div class="info-col">
                    <div class="info-row"><span class="info-label">KODE MOLD</span><span class="info-sep">:</span><div class="info-val" id="p_kode"></div></div>
                    <div class="info-row"><span class="info-label">PRODUK</span><span class="info-sep">:</span><div class="info-val" id="p_produk"></div></div>
                    <div class="info-row"><span class="info-label">TYPE MOLD</span><span class="info-sep">:</span><div class="info-val" id="p_type"></div></div>
                    <div class="info-row"><span class="info-label">PIC PERAWATAN</span><span class="info-sep">:</span><div class="info-val" id="p_pic"></div></div>
                </div>
                <div class="info-col">
                    <div class="info-row"><span class="info-label">TANGGAL PERAWATAN</span><span class="info-sep">:</span><div class="info-val" id="p_tgl"></div></div>
                    <div class="info-row"><span class="info-label">MATERIAL MOLD</span><span class="info-sep">:</span><div class="info-val" id="p_material"></div></div>
                    <div class="info-row"><span class="info-label">TANGGAL AKHIR SHOT</span><span class="info-sep">:</span><div class="info-val" id="p_akhir"></div></div>
                </div>
            </div>

            <!-- TABLE -->
            <table class="main-table">
                <!-- LEBAR KOLOM REVISI (Kondisi lebih lebar) -->
                <colgroup>
                    <col class="c-no">   <!-- 5% -->
                    <col class="c-item"> <!-- 28% -->
                    <col class="c-std">  <!-- 12% -->
                    <col class="c-cond"> <!-- 25% (LEBAR) -->
                    <col class="c-note"> <!-- 30% -->
                </colgroup>
                <thead>
                    <tr>
                        <th>NO</th>
                        <th>ITEM CHECK</th>
                        <th>STANDART</th>
                        <th>KONDISI</th>
                        <th>CATATAN</th>
                    </tr>
                </thead>
                <tbody id="paperBody">
                    <!-- Placeholder -->
                    <tr><td colspan="5" style="text-align:center; height:10mm;">Silakan Pilih Tanggal...</td></tr>
                </tbody>
            </table>

            <!-- SIGNATURE -->
            <div class="sig-section">
                <div class="sig-box">
                    <div class="sig-title">PIC PREVENTIVE<br>(OPERATOR)</div>
                    <div class="sig-space"><img id="s_op_img" class="sig-img" src=""></div>
                    <div class="sig-name" id="s_op_name">...</div>
                </div>
                <div class="sig-box">
                    <div class="sig-title">DIPERIKSA<br>(SPV. REPAIR & PREPARATION)</div>
                    <div class="sig-space"><img id="s_spv_img" class="sig-img" src=""></div>
                    <div class="sig-name" id="s_spv_name">...</div>
                </div>
                <div class="sig-box">
                    <div class="sig-title">DIKETAHUI<br>(SUPERINTENDENT WORKSHOP)</div>
                    <div class="sig-space"><img id="s_supt_img" class="sig-img" src=""></div>
                    <div class="sig-name" id="s_supt_name">...</div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const APP_URL = 'https://dsyvlavphvrdidmodokd.supabase.co';
        const APP_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E';
        const supabaseClient = window.supabase.createClient(APP_URL, APP_KEY);

        let itemsDefinition = [];
        const LOGO_URL_ASLI = "https://amarilyskg.co.id/bootstrap/img/logo.png";
        let GLOBAL_BASE64_LOGO = "";

        window.onload = async function() {
            await fetchItemsDef();
            await preloadLogo();
        };

        // --- CORE LOGIC ---
        async function fetchImageAsBase64(url) {
            const proxies = ['https://api.codetabs.com/v1/proxy?quest=', 'https://corsproxy.io/?'];
            for (let proxy of proxies) {
                try {
                    let response = await fetch(proxy + encodeURIComponent(url));
                    if (response.ok) {
                        let blob = await response.blob();
                        return new Promise(r => {
                            let reader = new FileReader();
                            reader.onloadend = () => r(reader.result);
                            reader.readAsDataURL(blob);
                        });
                    }
                } catch (e) {}
            }
            return null;
        }

        async function preloadLogo() {
            let base64 = await fetchImageAsBase64(LOGO_URL_ASLI);
            if(base64) GLOBAL_BASE64_LOGO = base64;
        }

        async function replaceImgWithCanvas(imgElement, base64Data) {
            return new Promise(resolve => {
                const image = new Image();
                image.onload = function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = image.naturalWidth;
                    canvas.height = image.naturalHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(image, 0, 0);
                    canvas.className = imgElement.className;
                    canvas.id = imgElement.id;
                    canvas.style.width = getComputedStyle(imgElement).width;
                    imgElement.parentNode.replaceChild(canvas, imgElement);
                    resolve(canvas);
                };
                image.src = base64Data;
            });
        }

        async function fetchItemsDef() {
            const { data } = await supabaseClient.from('clpm_items').select('*').order('no_item', {ascending: true});
            itemsDefinition = data || [];
        }

        window.fetchReports = async function() {
            const dateVal = document.getElementById('searchDate').value;
            if(!dateVal) return alert("Pilih tanggal!");
            
            document.getElementById('loading-overlay').style.display = 'flex';
            
            const { data } = await supabaseClient.from('clpm_log').select('*').eq('tanggal_perawatan', dateVal).order('created_at', {ascending: false});
            
            if(!data || !data.length) {
                document.getElementById('loading-overlay').style.display = 'none';
                return alert("Tidak ada data.");
            }
            renderPaper(data[0].id);
        }

        async function renderPaper(logId) {
            const { data: logData } = await supabaseClient.from('clpm_log').select('*').eq('id', logId).single();
            const { data: resData } = await supabaseClient.from('clpm_result').select('*').eq('log_id', logId);

            if(GLOBAL_BASE64_LOGO) document.getElementById('logoImg').src = GLOBAL_BASE64_LOGO;
            
            // Fill Info
            const fields = ['kode','tgl','produk','material','type','akhir','pic'];
            const dbFields = ['kode_mold','tanggal_perawatan','produk','material_mold','type_mold','tanggal_akhir_shot','pic_perawatan'];
            fields.forEach((f,i) => document.getElementById('p_'+f).innerText = logData[dbFields[i]] || '-');

            const tbody = document.getElementById('paperBody');
            let html = '';
            
            let mouldNoteText = '';
            const mouldNoteItem = resData.find(r => r.catatan_kondisi_mould && r.catatan_kondisi_mould.trim() !== '');
            if(mouldNoteItem) mouldNoteText = mouldNoteItem.catatan_kondisi_mould;

            // MAP OPSI KE SIMBOL (Fix 1)
            const optMap = {
                'OK': 'O',
                'NOT OK': 'X',
                'NG': 'X',
                'DI BERSIHKAN': 'B',
                'BERSIH': 'B',
                'GANTI BARU': 'G',
                'REPAIR': 'R',
                'DISCALING': 'D'
            };

            itemsDefinition.forEach(def => {
                const res = resData.find(r => r.no_item === def.no_item) || {};
                const kondisi = res.kondisi || '';

                if(def.no_item === 23) html += `<tr class="section-header"><td colspan="5">FOOD PACKAGING MOLD</td></tr>`;
                if(def.no_item === 26) html += `<tr class="section-header"><td colspan="5">FUNGSIONAL TEST</td></tr>`;

                // --- ITEM FUNGSIONAL (26-30) ---
                if(def.no_item >= 26 && def.no_item <= 30) {
                    const isOk = kondisi === 'OK';
                    const isNg = kondisi === 'NOT OK';
                    const checkHtml = `
                        <div class="cb-container" style="justify-content:center; gap:2mm;">
                            <div class="cb-item"><div class="sq-box">${isOk?'✓':''}</div>OK</div>
                            <div class="cb-item"><div class="sq-box">${isNg?'✓':''}</div>NOT OK</div>
                        </div>`;

                    let rightCell = '';
                    if(def.no_item === 26) {
                        rightCell = `
                        <td rowspan="5" class="mould-note-cell">
                            <span class="mn-title">Kondisi Mould :</span>
                            <div class="mn-content">${mouldNoteText || '-'}</div>
                        </td>`;
                    }

                    html += `
                    <tr>
                        <td colspan="3" class="ft-item-cell">
                            ${def.no_item}. ${def.item_check}
                        </td>
                        <td style="text-align:center;">${checkHtml}</td>
                        ${rightCell}
                    </tr>`;

                } else {
                    // --- ITEM STANDAR (1-25) ---
                    // PAKE LOGIK SIMBOL (Fix 1)
                    let checkHtml = '<div class="cb-container">';
                    if(def.options && def.options.length > 0) {
                        def.options.forEach(opt => {
                            const chk = kondisi === opt;
                            const label = optMap[opt] || opt.charAt(0); // Ambil simbol atau huruf depan
                            checkHtml += `<div class="cb-item"><div class="sq-box">${chk?'✓':''}</div>${label}</div>`;
                        });
                    } else {
                        checkHtml += `<div class="cb-item"><div class="sq-box">${kondisi?'✓':''}</div>${kondisi||'-'}</div>`;
                    }
                    checkHtml += '</div>';

                    html += `
                    <tr>
                        <td style="text-align:center;">${def.no_item}</td>
                        <td class="item-text">${def.item_check}</td>
                        <td style="text-align:center;">${def.standart || ''}</td>
                        <td>${checkHtml}</td>
                        <td>${res.catatan || ''}</td>
                    </tr>`;
                }
            });
            tbody.innerHTML = html;

            document.getElementById('s_op_img').src = logData.paraf_operator || '';
            document.getElementById('s_op_name').innerText = logData.pic_perawatan || '...';
            document.getElementById('s_spv_img').src = logData.paraf_spv || '';
            document.getElementById('s_spv_name').innerText = logData.nama_spv || '...';
            document.getElementById('s_supt_img').src = logData.paraf_superintendent || '';
            document.getElementById('s_supt_name').innerText = logData.nama_superintendent || '...';

            document.getElementById('loading-overlay').style.display = 'none';
        }

        // --- DOWNLOAD PDF FIX ---
        window.downloadPDF = async function() {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'flex';
            
            const element = document.getElementById('contentToPrint');
            const imgLogo = document.getElementById('logoImg');
            
            const originalHeight = element.scrollHeight;
            const A4_HEIGHT_PX = 1123; 
            
            if (originalHeight > A4_HEIGHT_PX) {
                const scale = A4_HEIGHT_PX / originalHeight;
                element.style.transform = `scale(${scale})`;
                element.style.transformOrigin = "top left";
            }

            const oldShadow = element.style.boxShadow;
            element.style.boxShadow = 'none';
            
            let originalImgClone = null;
            if (imgLogo && imgLogo.tagName === 'IMG') {
                try {
                    originalImgClone = imgLogo.cloneNode(true);
                    let dataToUse = GLOBAL_BASE64_LOGO || await fetchImageAsBase64(LOGO_URL_ASLI);
                    if (dataToUse) await replaceImgWithCanvas(imgLogo, dataToUse);
                } catch(e){}
            }

            try {
                const canvas = await html2canvas(element, { 
                    scale: 2, 
                    useCORS: true, 
                    allowTaint: true,
                    backgroundColor: "#ffffff",
                    scrollX: 0,
                    scrollY: 0
                });

                const imgData = canvas.toDataURL('image/jpeg', 0.98);
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                pdf.addImage(imgData, 'JPEG', 0, 0, 210, 297);
                
                const kode = document.getElementById('p_kode').innerText || 'Mould';
                const tgl = document.getElementById('p_tgl').innerText || 'Date';
                pdf.save(`Checklist_${kode}_${tgl}.pdf`);

            } catch (err) {
                console.error(err);
                alert("Gagal Export");
            } finally {
                if (originalImgClone) {
                    const canvasLogo = document.getElementById('logoImg');
                    if(canvasLogo && canvasLogo.tagName === 'CANVAS') {
                        canvasLogo.parentNode.replaceChild(originalImgClone, canvasLogo);
                    }
                }
                element.style.boxShadow = oldShadow;
                element.style.transform = ""; 
                overlay.style.display = 'none';
            }
        }
    </script>
</body>
</html>
