<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PMI Pelaksana - Maintenance Form</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* Styling tambahan agar tampilan Mobile-Friendly */
        body { background-color: #f3f4f6; font-family: 'Inter', sans-serif; }
        .section-header { 
            background-color: #e5e7eb; 
            padding: 10px 15px; 
            font-weight: bold; 
            border-left: 5px solid #2563EB; 
            margin-top: 25px; 
            margin-bottom: 15px;
            color: #1f2937;
            border-radius: 0 8px 8px 0;
        }
        .input-box {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            margin-top: 5px;
            background-color: #fff;
        }
        .input-box:focus {
            outline: none;
            border-color: #2563EB;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .label-text {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 2px;
        }
    </style>
</head>
<body class="pb-20">

    <div class="max-w-3xl mx-auto bg-white shadow-xl min-h-screen">
        
        <div class="bg-blue-700 p-6 text-white text-center rounded-b-xl shadow-md sticky top-0 z-10">
            <h1 class="text-2xl font-bold tracking-wide">FORM CHECKLIST MESIN</h1>
            <p class="text-sm opacity-90 mt-1">PMI System - Industrial Maintenance</p>
        </div>

        <form id="formPelaksana" class="p-6">

            <div class="mb-4">
                <label class="label-text">Nama Pelaksana / Inspektor</label>
                <input type="text" id="inspector_name" class="input-box" placeholder="Nama Lengkap Anda" required>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="label-text">Shift Group</label>
                    <select id="shift_group" class="input-box">
                        <option value="1">Shift 1 (Pagi)</option>
                        <option value="2">Shift 2 (Sore)</option>
                        <option value="3">Shift 3 (Malam)</option>
                    </select>
                </div>
                <div>
                    <label class="label-text">Tanggal</label>
                    <input type="date" id="date_inspection" class="input-box" required>
                </div>
            </div>

            <div class="section-header">MESIN & STATUS</div>
            <div class="mb-4">
                <label class="label-text text-blue-700">Pilih Mesin (Database)</label>
                <select id="machine_select" class="input-box border-blue-500 border-2" required>
                    <option value="">-- Loading Data Mesin... --</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="label-text">Status Awal Mesin</label>
                <select id="machine_status" class="input-box">
                    <option value="Running">Running (Produksi)</option>
                    <option value="Stop">Stop (Mati)</option>
                    <option value="Repair">Sedang Perbaikan</option>
                </select>
            </div>

            <div class="section-header">1. SAFETY & FISIK (Safety)</div>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                    <label class="label-text">Safety Door</label>
                    <select id="check_safety_door" class="input-box"><option>OK</option><option class="text-red-600">NG</option></select>
                </div>
                <div>
                    <label class="label-text">Tombol Emergency</label>
                    <select id="check_emergency_btn" class="input-box"><option>OK</option><option class="text-red-600">NG</option></select>
                </div>
                <div class="col-span-2">
                    <label class="label-text">Kebersihan Area (5S)</label>
                    <select id="check_cleanliness" class="input-box"><option>Bersih</option><option class="text-red-600">Kotor</option></select>
                </div>
            </div>

            <div class="section-header">2. UNIT INJEKSI (Nozzle/Barrel)</div>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                    <label class="label-text">Kebocoran Nozzle</label>
                    <select id="check_nozzle_leak" class="input-box"><option>Aman</option><option class="text-red-600">Bocor</option></select>
                </div>
                <div>
                    <label class="label-text">Suhu Barrel</label>
                    <select id="check_barrel_temp" class="input-box"><option>Normal</option><option class="text-red-600">Abnormal</option></select>
                </div>
                <div class="col-span-2">
                    <label class="label-text">Kondisi Heater Bands</label>
                    <select id="check_heater_bands" class="input-box"><option>OK</option><option class="text-red-600">Putus/Rusak</option></select>
                </div>
            </div>

            <div class="section-header">3. MOLD & CLAMPING</div>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                    <label class="label-text">Kondisi Mold</label>
                    <select id="check_mold_condition" class="input-box"><option>OK</option><option class="text-red-600">NG</option></select>
                </div>
                <div>
                    <label class="label-text">Pelumasan (Grease)</label>
                    <select id="check_lubrication" class="input-box"><option>Cukup</option><option class="text-red-600">Kering</option></select>
                </div>
            </div>

            <div class="section-header">4. HIDROLIK & ELEKTRIK</div>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                    <label class="label-text">Level Oli</label>
                    <select id="check_oil_level" class="input-box"><option>Normal</option><option class="text-red-600">Low</option></select>
                </div>
                <div>
                    <label class="label-text">Suara Pompa</label>
                    <select id="check_pump_noise" class="input-box"><option>Halus</option><option class="text-red-600">Berisik</option></select>
                </div>
                <div class="col-span-2">
                    <label class="label-text">Tampilan Panel Layar</label>
                    <select id="check_panel_display" class="input-box"><option>Jelas</option><option class="text-red-600">Blank/Error</option></select>
                </div>
            </div>

            <div class="section-header">HASIL & TINDAKAN</div>
            
            <div class="mb-4">
                <label class="label-text mb-2">Kesimpulan Status:</label>
                <div class="flex gap-4">
                    <label class="flex items-center justify-center p-3 bg-green-50 rounded-lg border border-green-200 w-full cursor-pointer hover:bg-green-100">
                        <input type="radio" name="overall_status" value="PASS" checked class="w-5 h-5 text-green-600">
                        <span class="ml-2 font-bold text-green-700">PASS (OK)</span>
                    </label>
                    <label class="flex items-center justify-center p-3 bg-red-50 rounded-lg border border-red-200 w-full cursor-pointer hover:bg-red-100">
                        <input type="radio" name="overall_status" value="FAIL" class="w-5 h-5 text-red-600">
                        <span class="ml-2 font-bold text-red-700">FAIL (NG)</span>
                    </label>
                </div>
            </div>

            <div class="mb-4">
                <label class="label-text">Tindakan Perbaikan (Jika ada NG)</label>
                <input type="text" id="action_taken" class="input-box" placeholder="Contoh: Menambah oli, kencangkan baut...">
            </div>

            <div class="mb-4">
                <label class="label-text">Catatan Tambahan (Remarks)</label>
                <textarea id="remarks" rows="3" class="input-box" placeholder="Catatan khusus operator..."></textarea>
            </div>

            <div class="section-header">VALIDASI FOTO</div>
            <div class="mb-6">
                <label class="label-text">Upload Foto Bukti</label>
                <input type="file" id="photo_evidence" accept="image/*" class="input-box bg-white">
                <p class="text-xs text-gray-500 mt-1">*Disarankan ambil foto jika ada temuan NG</p>
            </div>

            <button type="submit" id="btnSubmit" class="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-4 rounded-lg shadow-lg text-lg transition duration-200">
                KIRIM LAPORAN
            </button>

        </form>
    </div>

    <script>
        // --- 1. CONFIG SUPABASE (SUDAH DIPERBAIKI SESUAI REQUEST) ---
        const supabaseUrl = 'https://dsyvlavphvrdidmodokd.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // Set tanggal hari ini secara otomatis
        document.getElementById('date_inspection').valueAsDate = new Date();

        // --- 2. FUNGSI LOAD DATA MESIN (DARI TABEL pmi_machines) ---
        async function loadMachines() {
            const machineSelect = document.getElementById('machine_select');

            // Kita ambil data dari tabel 'pmi_machines'
            const { data, error } = await supabase
                .from('pmi_machines') 
                .select('*') 
                .order('machine_name', { ascending: true });

            if (error) {
                console.error("Gagal Load Mesin:", error);
                machineSelect.innerHTML = `<option>Error Load DB</option>`;
                return;
            }

            // Bersihkan Dropdown
            machineSelect.innerHTML = '<option value="">-- Pilih Mesin --</option>';

            // Masukkan data ke Dropdown
            if (data && data.length > 0) {
                data.forEach(mesin => {
                    const option = document.createElement('option');
                    // Asumsi kolom database kamu: machine_code & machine_name
                    option.value = mesin.machine_code; 
                    option.textContent = `${mesin.machine_name} (${mesin.machine_code})`;
                    
                    // Simpan nama mesin di atribut 'data-name' agar bisa diambil saat submit
                    option.setAttribute('data-name', mesin.machine_name); 
                    machineSelect.appendChild(option);
                });
            } else {
                machineSelect.innerHTML = '<option>Tidak ada data mesin</option>';
            }
        }

        // Jalankan fungsi load saat halaman dibuka
        loadMachines();

        // --- 3. FUNGSI SUBMIT FORM KE 'maintenance_logs' ---
        document.getElementById('formPelaksana').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('btnSubmit');
            const originalBtnText = btn.innerHTML;
            btn.innerHTML = 'Sedang Mengirim...';
            btn.disabled = true;

            try {
                // A. PROSES UPLOAD FOTO (Jika user memilih file)
                let photoUrl = null;
                const fileInput = document.getElementById('photo_evidence');
                
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    // Buat nama file unik: timestamp_namafile
                    const fileName = `log_${Date.now()}_${file.name.replace(/\s/g, '_')}`; 
                    
                    // Upload ke bucket 'maintenance-photos'
                    const { error: uploadError } = await supabase.storage
                        .from('maintenance-photos')
                        .upload(fileName, file);
                    
                    if (uploadError) throw uploadError;

                    // Dapatkan URL publik file yang baru diupload
                    const { data: urlData } = supabase.storage
                        .from('maintenance-photos')
                        .getPublicUrl(fileName);
                    
                    photoUrl = urlData.publicUrl;
                }

                // B. SIAPKAN DATA UNTUK DIKIRIM KE DATABASE
                const machineSelect = document.getElementById('machine_select');
                // Ambil nama mesin dari atribut data-name yang kita set tadi
                const machineName = machineSelect.options[machineSelect.selectedIndex].getAttribute('data-name');

                const payload = {
                    // Identitas
                    inspector_name: document.getElementById('inspector_name').value,
                    shift_group: document.getElementById('shift_group').value,
                    date_inspection: document.getElementById('date_inspection').value,
                    
                    // Mesin
                    machine_code: machineSelect.value,
                    machine_name: machineName || "Unknown", 
                    machine_status: document.getElementById('machine_status').value,

                    // Checklist Teknis
                    check_safety_door: document.getElementById('check_safety_door').value,
                    check_emergency_btn: document.getElementById('check_emergency_btn').value,
                    check_cleanliness: document.getElementById('check_cleanliness').value,
                    
                    check_nozzle_leak: document.getElementById('check_nozzle_leak').value,
                    check_barrel_temp: document.getElementById('check_barrel_temp').value,
                    check_heater_bands: document.getElementById('check_heater_bands').value,
                    
                    check_mold_condition: document.getElementById('check_mold_condition').value,
                    check_lubrication: document.getElementById('check_lubrication').value,
                    
                    check_oil_level: document.getElementById('check_oil_level').value,
                    check_pump_noise: document.getElementById('check_pump_noise').value,
                    check_panel_display: document.getElementById('check_panel_display').value,

                    // Hasil & Validasi
                    overall_status: document.querySelector('input[name="overall_status"]:checked').value,
                    action_taken: document.getElementById('action_taken').value,
                    remarks: document.getElementById('remarks').value,
                    photo_evidence_url: photoUrl
                };

                // C. KIRIM (INSERT) KE DATABASE
                const { error: dbError } = await supabase
                    .from('maintenance_logs')
                    .insert([payload]);

                if (dbError) throw dbError;

                // D. SUKSES
                Swal.fire({
                    title: 'Berhasil!',
                    text: 'Laporan Maintenance telah tersimpan.',
                    icon: 'success',
                    confirmButtonColor: '#1d4ed8'
                }).then(() => {
                    window.location.reload(); // Refresh halaman untuk input baru
                });

            } catch (err) {
                console.error(err);
                Swal.fire({
                    title: 'Gagal!',
                    text: 'Terjadi kesalahan: ' + err.message,
                    icon: 'error'
                });
                // Kembalikan tombol jika error
                btn.innerHTML = originalBtnText;
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>
