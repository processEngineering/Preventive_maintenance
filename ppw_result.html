<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <!-- VIEWPORT WAJIB AGAR RESPONSIF DI HP -->
    <meta name="viewport" content="width=device-width, initial-scale=0.5, user-scalable=yes">
    <title>AF.SP 05.19.Rev-00 – REPORT PPW</title>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        :root {
            /* TEMA WARNA AKG UI */
            --primary: #c91919; 
            --primary-light: #e53935;
            --primary-dark: #a50e0e;
            --border: #e5e7eb;
            --text-main: #333333;
            --sidebar-width: 280px; 
        }

        /* === GLOBAL RESET === */
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        
        body {
            margin: 0; padding: 0;
            background: #525659;
            font-family: 'Inter', sans-serif;
            font-size: 8pt;
            padding-bottom: 40px;
            overflow: auto; 
        }

        /* --- TOP ACTION BAR (GARIS TIGA + KONTROL HORIZONTAL) --- */
        .top-bar {
            position: sticky;
            top: 0;
            left: 0;
            right: 0;
            background: #1e293b; /* Warna gelap profesional */
            padding: 10px 20px;
            display: flex;
            justify-content: flex-start; 
            align-items: center;
            gap: 25px; 
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            flex-wrap: wrap; 
        }

        /* Tombol Hamburger di Kiri */
        .hamburger-btn {
            width: 42px; height: 42px;
            background: var(--primary); color: white;
            border-radius: 8px; display: flex; justify-content: center; align-items: center;
            font-size: 20px; cursor: pointer; transition: 0.2s;
            flex-shrink: 0;
        }
        .hamburger-btn:hover { background: var(--primary-dark); transform: scale(1.05); }
        .hamburger-btn:active { transform: scale(0.95); }

        /* Panel Kontrol di sebelah Kanan Garis Tiga */
        .controls-horizontal {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        .controls-horizontal span.ctrl-title {
            font-size: 13px;
            font-weight: bold;
            color: white;
            text-transform: uppercase;
            margin-right: 5px;
        }

        .input-ctrl, .btn-ctrl {
            padding: 8px 12px;
            border-radius: 6px;
            border: none;
            font-size: 12px;
            font-weight: bold;
            outline: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .input-ctrl { background: #f8f9fa; color: #333; }
        .input-ctrl:focus { border-color: var(--primary); outline: 2px solid var(--primary); }

        .btn-show { background: #22c55e; color: white; }
        .btn-show:hover { background: #16a34a; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        .btn-pdf { background: var(--primary); color: white; border: none; }
        .btn-pdf:hover { background: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(201,25,25,0.3); }

        /* --- OFF-CANVAS SIDEBAR --- */
        .sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 2000; opacity: 0; visibility: hidden; transition: 0.3s;
            backdrop-filter: blur(4px);
        }
        .sidebar-overlay.active { opacity: 1; visibility: visible; }
        
        .side-nav {
            position: fixed; top: 0; left: -400px; width: 320px; height: 100vh;
            background: white; z-index: 2001; transition: left 0.4s cubic-bezier(0.25, 1, 0.5, 1); 
            display: flex; flex-direction: column; padding: 25px; box-shadow: 10px 0 30px rgba(0,0,0,0.3);
        }
        .side-nav.active { left: 0; }

        .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; border-bottom: 2px solid #eee; padding-bottom: 20px; }
        .sidebar-title { font-weight: bold; color: var(--primary); font-size: 24px; }
        .sidebar-close { font-size: 30px; color: #888; cursor: pointer; transition: color 0.2s; }
        .sidebar-close:hover { color: var(--primary); }

        .nav-item {
            display: flex; align-items: center; text-decoration: none; color: #666; 
            background: white; width: 100%; padding: 18px 20px; margin-bottom: 15px;
            border: 2px solid #eee; border-radius: 12px; transition: all 0.2s; font-weight: bold; font-size: 16px;
        }
        .nav-item:hover, .nav-item.active { border-color: var(--primary); background: #fff5f5; color: var(--primary); transform: translateX(5px); }
        .nav-icon-box { display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; margin-right: 15px; font-size: 24px; color: var(--primary); }

        /* LOADING OVERLAY */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 20000;
            display: none; justify-content: center; align-items: center; flex-direction: column;
            color: white; font-size: 18px; text-align: center;
        }

        /* ==================== WADAH KERTAS A4 LANDSCAPE ==================== */
        .sheet-container {
            width: 100%; overflow-x: auto; display: flex; justify-content: flex-start; 
            padding: 30px 15px; box-sizing: border-box; -webkit-overflow-scrolling: touch; 
            position: relative; z-index: 1;
        }

        @media (min-width: 1140px) {
            .sheet-container { justify-content: center; }
        }

        #exportContainer {
            width: 297mm;
            min-width: 297mm; 
            height: 209.5mm; 
            background: white;
            color: #000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            margin: 0 auto;
            position: relative;
            overflow: hidden; 
            box-sizing: border-box; 
            border-radius: 4px;
        }

        .page {
            width: 100%; height: 100%; padding: 10mm;
            background: transparent; display: flex; flex-direction: column; box-sizing: border-box;
        }

        /* --- STYLING DALAM KERTAS (ISO STANDARD) --- */
        table { width: 100%; border-collapse: collapse; border-spacing: 0; }
        td, th { border: 1px solid black; padding: 4px 6px; vertical-align: middle; text-align: left; color: black !important; border-color: black !important; }

        .doc-header { display: flex; width: 100%; border: 1pt solid #000; margin-bottom: 2mm; flex-shrink: 0; }
        .header-left { width: 25%; border-right: 1pt solid #000; padding: 5px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .header-logo { height: 45px; width: auto; object-fit: contain; }
        .company-name { font-size: 9pt; font-weight: 800; line-height: 1.2; color: #000; }

        .header-center { width: 45%; border-right: 1pt solid #000; display: flex; align-items: center; justify-content: center; text-align: center; padding: 5px; }
        .header-center h2 { font-size: 14pt; font-weight: 800; margin: 0; color: #000; text-transform: uppercase; }

        .header-right { width: 30%; font-size: 8pt; padding: 0; }
        .info-table { width: 100%; border-collapse: collapse; height: 100%; border: none !important;}
        .info-table td { border: none !important; border-bottom: 1pt solid #000 !important; padding: 2px 5px; vertical-align: middle; font-size: 7.5pt; color: black;}
        .info-table tr:last-child td { border-bottom: none !important; }
        .info-label { width: 40%; font-weight: bold; border-right: 1pt solid #000 !important; }

        .section-bar { margin: 5px 0 5px 0; font-size: 10pt; font-weight: bold; color: #000; text-transform: uppercase; flex-shrink: 0; }

        .table-wrapper { flex-grow: 1; }

        .main-table { width: 100%; border-collapse: collapse; font-size: 8pt; border: 1pt solid #000; table-layout: fixed; }
        .main-table thead th { background-color: #fff; color: #000; font-weight: bold; text-transform: uppercase; border: 1pt solid #000; text-align: center; }
        .main-table td { border: 1pt solid #000; padding: 3px; text-align: center; vertical-align: middle; color: #000; overflow: hidden; }
        .text-left { text-align: left !important; padding-left: 5px !important; }

        /* Column Widths */
        .col-no { width: 3%; } .col-date { width: 8%; } .col-part { width: 14%; } .col-job { width: 19%; } 
        .col-time { width: 6%; } .col-ket { width: 12%; } .col-op-name { width: 10%; } .col-check { width: 4%; } .col-ttd { width: 8%; }

        /* FOOTER SIGNATURE */
        .footer-container { margin-top: auto; padding-top: 10px; display: flex; justify-content: space-around; flex-shrink: 0; }
        .sign-box { width: 220px; text-align: center; font-size: 9pt; color: #000; }
        .sign-space { height: 55px; display: flex; align-items: center; justify-content: center; border-bottom: 1pt solid #000; margin-bottom: 5px; background: #fff; }
        .sign-img { max-height: 50px; max-width: 150px; background: #ffffff !important; }
        .sign-name { font-weight: bold; text-transform: uppercase; color: #000; }

        /* EXPORT CLONE STYLE */
        #export-pdf-layer { position: fixed; top: 0; left: 0; z-index: 99999; background: white; width: 297mm; height: 100vh; overflow: auto; display: none; align-items: flex-start; justify-content: flex-start; }
        .print-clone { margin: 0 !important; box-shadow: none !important; transform: none !important; width: 297mm !important; min-width: 297mm !important; height: auto !important; min-height: 209mm !important; padding: 10mm !important; background: white !important; }

        @media print {
            body { background: white; }
            .no-print, .top-bar, .sidebar-overlay, .side-nav { display: none !important; }
            .sheet-container { padding: 0; justify-content: center; overflow: hidden; }
            #exportContainer { margin: 0; box-shadow: none; border: none; width: 297mm; height: 209mm; }
        }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <i class="fa-solid fa-spinner fa-spin fa-3x"></i>
        <p style="margin-top:15px; font-family:'Inter', sans-serif; font-weight: 700;">Menyiapkan Dokumen PDF...</p>
    </div>

    <!-- WADAH KHUSUS UNTUK PROSES EXPORT -->
    <div id="export-pdf-layer"></div>

    <!-- TOP ACTION BAR -->
    <div class="top-bar no-print">
        <div class="hamburger-btn" onclick="toggleSidebar()">
            <i class="fa-solid fa-bars"></i>
        </div>

        <div class="controls-horizontal">
            <span class="ctrl-title">KONTROL:</span>
            <input type="date" id="dateStart" class="input-ctrl">
            <input type="date" id="dateEnd" class="input-ctrl">
            <button class="btn-ctrl btn-show" onclick="loadData()"><i class="fa-solid fa-search"></i> TAMPILKAN</button>
            <button class="btn-ctrl btn-print" onclick="exportPDF()"><i class="fa-solid fa-file-pdf"></i> DOWNLOAD PDF</button>
        </div>
    </div>

    <!-- SIDEBAR -->
    <div class="sidebar-overlay no-print" id="sidebarOverlay" onclick="toggleSidebar()"></div>
    <nav class="side-nav no-print" id="sidebar">
        <div class="sidebar-header">
            <span class="sidebar-title">Dashboard</span>
            <div class="sidebar-close" onclick="toggleSidebar()">
                <i class="fa-solid fa-xmark"></i>
            </div>
        </div>
        <a href="index.html" id="nav-home" class="nav-item">
            <div class="nav-icon-box"><i class="fa-solid fa-house"></i></div>
            <span>Home</span>
        </a>
        <a href="menu_utama.html" id="nav-menu" class="nav-item">
            <div class="nav-icon-box"><i class="fa-solid fa-table-cells-large"></i></div>
            <span>Menu Utama</span>
        </a>
        <a href="download_data.html" class="nav-item active">
            <div class="nav-icon-box"><i class="fa-solid fa-cloud-arrow-down"></i></div>
            <span>Unduh Data</span>
        </a>
        <a href="informasi_akun.html" class="nav-item">
            <div class="nav-icon-box"><i class="fa-solid fa-user"></i></div>
            <span>Akun</span>
        </a>
    </nav>

    <!-- KERTAS LAPORAN -->
    <div class="sheet-container">
        <div id="exportContainer">
            <div class="page" id="documentArea">
                <div class="doc-header">
                    <div class="header-left">
                        <img id="companyLogo" class="header-logo" alt="AKG" crossorigin="anonymous">
                        <div class="company-name">PT. AMARILYS KARISMA<br>GEMILANG</div>
                    </div>

                    <div class="header-center">
                        <h2>PELAKSANAAN PEKERJAAN WORKSHOP</h2>
                    </div>

                    <div class="header-right">
                        <table class="info-table">
                            <tr>
                                <td class="info-label">No Dokumen</td>
                                <td class="info-value">: AF.SP 05.19.Rev-00</td>
                            </tr>
                            <tr>
                                <td class="info-label">Tanggal Terbit</td>
                                <td class="info-value">: 02 Agustus 2024</td>
                            </tr>
                            <tr>
                                <td class="info-label">Halaman</td>
                                <td class="info-value">: 1/1</td>
                            </tr>
                            <tr>
                                <td class="info-label">Tanggal Revisi</td>
                                <td class="info-value">: -</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <div class="section-bar">
                    Bagian : <span id="bagianLabel">MAINTENANCE REPAIR</span>
                </div>

                <div class="table-wrapper">
                    <table class="main-table">
                        <thead>
                            <tr>
                                <th colspan="8" style="background: white; border-bottom: 1pt solid #000; border-top: none; border-left: none;"></th>
                                <th colspan="2">Operator</th>
                                <th>QC</th>
                                <th>Ka.Sie</th>
                            </tr>
                            <tr>
                                <th class="col-no">No</th>
                                <th class="col-date">Tanggal</th>
                                <th class="col-part">Nama Part / Mould</th>
                                <th class="col-job">Job Description</th>
                                <th class="col-time">Est. Waktu</th>
                                <th class="col-time">Mulai</th>
                                <th class="col-time">Selesai</th>
                                <th class="col-ket">Keterangan</th>
                                <th class="col-check">Ok</th>
                                <th class="col-check">Not Ok</th>
                                <th class="col-op-name">Nama Operator</th>
                                <th class="col-ttd">Ttd</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="12" style="height: 300px; color: #999; text-align: center;">
                                    Silakan pilih rentang tanggal dan klik TAMPILKAN untuk memuat data.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="footer-container">
                    <div class="sign-box">
                        <p>Diperiksa,</p>
                        <div class="sign-space" id="signSpv"></div>
                        <p class="sign-name" id="nameSpv">.....................................</p>
                        <p>Spv. Workshop</p>
                    </div>
                    <div class="sign-box">
                        <p>Mengetahui,</p>
                        <div class="sign-space" id="signSupt"></div>
                        <p class="sign-name" id="nameSupt">.....................................</p>
                        <p>Superintendent Workshop</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- UI NAVIGATION ---
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('active');
        document.getElementById('sidebarOverlay').classList.toggle('active');
    }

    const SUPABASE_URL = 'https://dsyvlavphvrdidmodokd.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E';
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const ORIGINAL_LOGO_URL = "https://amarilyskg.co.id/bootstrap/img/logo.png";
    const FALLBACK_LOGO = "data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 60'%3E%3Ctext x='50%25' y='50%25' font-family='Arial' font-weight='900' font-size='40' fill='%23990000' dy='.3em' text-anchor='middle'%3EAKG%3C/text%3E%3C/svg%3E";
    const PROXIED_LOGO_URL = `https://wsrv.nl/?url=${encodeURIComponent(ORIGINAL_LOGO_URL)}&output=png`;

    document.addEventListener("DOMContentLoaded", function() {
        setupDynamicNavigation();
        var today = new Date();
        var startEl = document.getElementById('dateStart');
        var endEl = document.getElementById('dateEnd');
        if (startEl) startEl.valueAsDate = new Date(today.getFullYear(), today.getMonth(), 1);
        if (endEl) endEl.valueAsDate = today;
        initLogo();
    });

    async function setupDynamicNavigation() {
        try {
            const { data: { session } } = await db.auth.getSession();
            if (!session) return;
            const { data: profile } = await db.from('profiles').select('jabatan').eq('id', session.user.id).single();
            if (profile) {
                const jabatan = profile.jabatan.toUpperCase();
                const navHome = document.getElementById('nav-home');
                const navMenu = document.getElementById('nav-menu');
                let homeLink = 'index.html', menuLink = 'menu_utama.html';
                if (jabatan.includes('OPERATOR')) { homeLink = 'OPERATOR_HOME.html'; menuLink = 'MENU_UTAMA_OPERATOR.html'; }
                else if (jabatan.includes('SUPERVISOR')) { homeLink = 'SUPERVISOR_HOME.html'; menuLink = 'MENU_UTAMA_SUPERVISOR.html'; }
                else if (jabatan.includes('SUPERINTENDENT')) { homeLink = 'SUPERINTENDENT_HOME.html'; menuLink = 'MENU_UTAMA_SUPERINTENDENT.html'; }
                else if (jabatan.includes('MANAGER') && !jabatan.includes('JUNIOR')) { homeLink = 'MANAGER_HOME.html'; menuLink = 'MENU_UTAMA_MANAGER.html'; }
                else if (jabatan.includes('JUNIOR MANAGER PRODUKSI') || jabatan.includes('JM PRODUKSI')) { homeLink = 'JUNIOR_MANAGER_PRODUKSI_HOME.html'; menuLink = 'MENU_UTAMA_JM_PRODUKSI.html'; }
                else if (jabatan.includes('JUNIOR MANAGER PPIC') || jabatan.includes('JM PPIC')) { homeLink = 'JUNIOR_MANAGER_PPIC_HOME.html'; menuLink = 'MENU_UTAMA_JM_PPIC.html'; }
                if (navHome) navHome.href = homeLink;
                if (navMenu) navMenu.href = menuLink;
            }
        } catch (err) { console.error(err); }
    }

    function initLogo() {
        const img = document.getElementById('companyLogo');
        img.crossOrigin = "anonymous"; 
        img.src = PROXIED_LOGO_URL;
        img.onerror = function() {
            img.src = FALLBACK_LOGO;
            img.removeAttribute('crossOrigin'); 
        };
    }

    window.loadData = async function() {
        var start = document.getElementById('dateStart').value;
        var end = document.getElementById('dateEnd').value;
        var tableBody = document.getElementById('tableBody');

        if(!start || !end) return alert("Pilih rentang tanggal!");

        tableBody.innerHTML = '<tr><td colspan="12">Sedang memproses data...</td></tr>';

        const { data, error } = await db
            .from('ppw_log')
            .select('*')
            .eq('status_approval', 'Approved')
            .gte('tanggal', start)
            .lte('tanggal', end)
            .order('tanggal', { ascending: true });

        if (error) {
            tableBody.innerHTML = `<tr><td colspan="12" style="color:red">Gagal: ${error.message}</td></tr>`;
            return;
        }

        if (!data || data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="12">Tidak ada data yang ditemukan.</td></tr>';
            resetSigns();
            return;
        }

        let html = '';
        data.forEach((item, index) => {
            const ok = item.status_hasil === 'OK' ? '✓' : '';
            const nok = item.status_hasil === 'NOT OK' ? '✓' : '';
            const date = new Date(item.tanggal).toLocaleDateString('id-ID');

            html += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${date}</td>
                    <td class="text-left">${item.nama_part || ''}</td>
                    <td class="text-left">${item.job_desc || ''}</td>
                    <td>${item.estimasi_waktu || ''}</td>
                    <td>${item.waktu_mulai || ''}</td>
                    <td>${item.waktu_selesai || ''}</td>
                    <td class="text-left">${item.keterangan || ''}</td>
                    <td style="font-weight:bold;">${ok}</td>
                    <td style="font-weight:bold; color:red;">${nok}</td>
                    <td>${item.nama_operator || ''}</td>
                    <td>
                         ${item.ttd_spv ? `<img src="${item.ttd_spv}" style="height:25px; background:white;" crossorigin="anonymous">` : ''}
                    </td>
                </tr>
            `;
        });

        const minRows = 12;
        if (data.length < minRows) {
            for (let i = 0; i < (minRows - data.length); i++) {
                html += `<tr style="height: 25px;">${'<td></td>'.repeat(12)}</tr>`;
            }
        }

        tableBody.innerHTML = html;

        const last = data[data.length - 1];
        if (last) {
            document.getElementById('nameSpv').innerText = (last.nama_spv || '').toUpperCase();
            document.getElementById('signSpv').innerHTML = last.ttd_spv ? `<img src="${last.ttd_spv}" class="sign-img" style="background:white;" crossorigin="anonymous">` : '';
            document.getElementById('nameSupt').innerText = (last.nama_superintendent || '').toUpperCase();
            document.getElementById('signSupt').innerHTML = last.ttd_superintendent ? `<img src="${last.ttd_superintendent}" class="sign-img" style="background:white;" crossorigin="anonymous">` : '';
        }
    };

    window.resetSigns = function() {
        document.getElementById('nameSpv').innerText = '.....................................';
        document.getElementById('signSpv').innerHTML = '';
        document.getElementById('nameSupt').innerText = '.....................................';
        document.getElementById('signSupt').innerHTML = '';
    };

    // --- PDF EXPORT (WYSIWYG FIXED WIDTH) ---
    window.exportPDF = async function() {
        const overlay = document.getElementById('loadingOverlay');
        overlay.style.display = 'flex';
        window.scrollTo(0, 0);

        try {
            const original = document.getElementById('exportContainer');
            const clone = original.cloneNode(true);
            const exportLayer = document.getElementById('export-pdf-layer');

            clone.classList.add('print-clone');
            exportLayer.innerHTML = '';
            exportLayer.appendChild(clone);
            exportLayer.style.display = 'block';

            // Jeda render
            await new Promise(r => setTimeout(r, 500));

            const opt = {
                margin: 0,
                filename: `Laporan_Workshop_${new Date().toISOString().slice(0,10)}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    useCORS: true, 
                    scrollX: 0, scrollY: 0, x: 0, y: 0,
                    width: 1122, // A4 Landscape Pixel Width
                    windowWidth: 1122 
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape', compress: true }
            };

            await html2pdf().set(opt).from(clone).save();

            exportLayer.innerHTML = '';
            exportLayer.style.display = 'none';

        } catch (err) {
            console.error(err);
            alert("Gagal ekspor PDF.");
        } finally {
            overlay.style.display = 'none';
        }
    };
</script>
</body>
</html>
