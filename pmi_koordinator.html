<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Koordinator - Verifikasi</title>
    
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* === GLOBAL STYLES === */
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #e5e7eb; margin: 0; padding: 20px; padding-bottom: 100px; }

        /* === HEADER === */
        .page-header { background: #000; color: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .page-title { font-size: 18px; font-weight: 800; margin: 0; letter-spacing: 1px; }
        .page-subtitle { font-size: 12px; opacity: 0.8; margin-top: 5px; }

        /* === FILTER === */
        .filter-box { background: #fff; padding: 15px; border-radius: 8px; display: flex; gap: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        select { flex: 1; padding: 10px; border: 2px solid #ccc; border-radius: 6px; font-weight: 600; font-size: 14px; }
        .btn-load { background: #000; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 700; cursor: pointer; }

        /* === LIST CARD === */
        .report-list { display: flex; flex-direction: column; gap: 12px; }
        .card { background: #fff; padding: 15px; border-radius: 8px; border-left: 5px solid #ccc; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; }
        .card:active { transform: scale(0.98); }
        
        .card-pending { border-left-color: #f59e0b; }
        .card-verified { border-left-color: #10b981; }

        .card-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .card-date { font-size: 11px; color: #666; font-weight: 600; }
        .badge { font-size: 10px; font-weight: 800; padding: 3px 8px; border-radius: 10px; text-transform: uppercase; }
        .bg-pending { background: #fef3c7; color: #d97706; }
        .bg-verified { background: #d1fae5; color: #059669; }

        .card-title { font-size: 15px; font-weight: 800; color: #000; margin-bottom: 4px; }
        .card-sub { font-size: 12px; color: #555; display: flex; align-items: center; gap: 5px; }

        /* === MODAL POPUP === */
        #modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; display: none; align-items: flex-end; }
        .modal-content { 
            background: #fff; width: 100%; height: 95vh; border-radius: 20px 20px 0 0; 
            padding: 0; display: flex; flex-direction: column; overflow: hidden;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .modal-head { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #f9fafb; }
        .close-btn { font-size: 24px; font-weight: bold; padding: 5px; cursor: pointer; }

        .modal-body { flex: 1; overflow-y: auto; padding: 20px; }

        /* Detail Table inside Modal */
        .detail-tbl { width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 20px; }
        .detail-tbl th { background: #eee; text-align: left; padding: 8px; border-bottom: 2px solid #000; }
        .detail-tbl td { padding: 8px; border-bottom: 1px solid #eee; vertical-align: top; }
        .row-ng { background: #fee2e2; }
        .txt-ng { color: red; font-weight: 800; }
        .txt-ok { color: green; font-weight: 800; }

        /* --- STEP 1: SCANNER (REVISI TAMPILAN) --- */
        .step-scan { 
            background: #fff; padding: 20px 0;
            text-align: center; margin-top: 10px;
        }
        .btn-scan { background: #000; color: #fff; border: none; padding: 15px; width: 100%; font-weight: 800; font-size: 14px; border-radius: 6px; cursor: pointer; margin-top: 10px; }
        
        /* Box Scanner Kotak di Tengah */
        .scanner-container {
            width: 260px; height: 260px; 
            background: #000; 
            margin: 10px auto; 
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            border: 4px solid #000;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
            display: none; /* Hidden awal */
        }
        
        #reader { width: 100%; height: 100%; object-fit: cover; }
        #reader video { object-fit: cover; width: 100% !important; height: 100% !important; }

        /* Garis Laser Merah (Simpel) */
        .laser {
            position: absolute; width: 100%; height: 2px; background: red;
            top: 0; left: 0; z-index: 10;
            box-shadow: 0 0 4px red;
            animation: scanAnim 2s infinite linear;
        }
        @keyframes scanAnim { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }


        /* --- STEP 2: APPROVAL FORM --- */
        .step-form { background: #f0fdf4; border: 2px dashed #16a34a; padding: 15px; border-radius: 8px; margin-top: 10px; display: none; }
        .lbl { font-size: 11px; font-weight: 800; text-transform: uppercase; margin-bottom: 5px; display: block; color: #333; }
        .inp { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; margin-bottom: 10px; }
        
        #sig-wrapper { border: 1px solid #000; background: #fff; width: 100%; height: 160px; margin-bottom: 5px; touch-action: none; }
        canvas { width: 100%; height: 100%; }

        .btn-act { width: 100%; padding: 15px; font-weight: 800; font-size: 14px; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px; }
        .btn-green { background: #16a34a; color: white; }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; border-top: 1px solid #ddd; display: flex; padding: 12px 0; z-index: 1000; }
        .nav-item { flex: 1; text-align: center; color: #9ca3af; font-size: 22px; text-decoration: none; }
        .nav-item.active { color: #000; }
    </style>
</head>
<body>

    <div class="page-header">
        <h1 class="page-title">KOORDINATOR</h1>
        <div class="page-subtitle">VERIFIKASI LAPORAN HARIAN</div>
    </div>

    <div class="filter-box">
        <select id="f-bulan">
            <option value="1">Januari</option><option value="2">Februari</option><option value="3">Maret</option>
            <option value="4">April</option><option value="5">Mei</option><option value="6">Juni</option>
            <option value="7">Juli</option><option value="8">Agustus</option><option value="9">September</option>
            <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
        </select>
        <select id="f-tahun">
            <option value="2025" selected>2025</option>
            <option value="2026">2026</option>
        </select>
        <button class="btn-load" onclick="loadList()">LIHAT</button>
    </div>

    <div id="list-container" class="report-list">
        <div style="text-align:center; padding:20px; color:#888;">Silakan pilih periode dan klik LIHAT</div>
    </div>

    <div id="modal">
        <div class="modal-content">
            <div class="modal-head">
                <div>
                    <h3 style="margin:0; font-size:15px;">CEK LAPORAN</h3>
                    <div id="m-info" style="font-size:11px; color:#666;">-</div>
                </div>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>

            <div class="modal-body">
                <div style="font-weight:800; font-size:12px; margin-bottom:5px;">HASIL KERJA PELAKSANA:</div>
                <div style="max-height:250px; overflow-y:auto; border:1px solid #ccc; margin-bottom:15px; border-radius:6px;">
                    <table class="detail-tbl">
                        <thead><tr><th>ITEM</th><th>STATUS</th><th>ACTUAL</th></tr></thead>
                        <tbody id="tbl-body"></tbody>
                    </table>
                </div>

                <div class="step-scan" id="step-scan">
                    <div style="font-weight:800; font-size:14px; margin-bottom:5px;">VALIDASI MESIN</div>
                    <div style="font-size:12px; color:#555; margin-bottom:10px;">Scan QR Code di mesin untuk membuka form.</div>
                    
                    <div class="scanner-container" id="scanner-ui">
                        <div class="laser"></div>
                        <div id="reader"></div>
                    </div>

                    <button class="btn-scan" id="btn-scan-trigger" onclick="startScanner()">BUKA KAMERA</button>
                </div>

                <div class="step-form" id="step-form">
                    <div style="border-bottom:1px dashed #16a34a; padding-bottom:5px; margin-bottom:10px; font-weight:800; color:#16a34a; text-align:center;">
                        <i class="fa-solid fa-check-circle"></i> MESIN VALID. SILAKAN ISI:
                    </div>

                    <label class="lbl">NAMA KOORDINATOR</label>
                    <input type="text" id="inp-nama" class="inp" placeholder="Nama Anda...">

                    <label class="lbl">CATATAN UNTUK SUPERINTENDENT</label>
                    <textarea id="inp-catatan" class="inp" rows="3" placeholder="Contoh: Mesin OK, temuan di area hydrolik..."></textarea>

                    <label class="lbl">TANDA TANGAN</label>
                    <div id="sig-wrapper">
                        <canvas id="sig-canvas"></canvas>
                    </div>
                    <div style="text-align:right; margin-bottom:10px;">
                        <span onclick="clearSig()" style="font-size:11px; color:red; text-decoration:underline; cursor:pointer;">Hapus Tanda Tangan</span>
                    </div>

                    <button id="btn-submit" class="btn-act btn-green" onclick="submitApprove()">VERIFIKASI & KIRIM</button>
                </div>
                
                <div id="msg-done" style="display:none; text-align:center; padding:20px; background:#eee; border-radius:8px; margin-top:20px;">
                    <i class="fa-solid fa-check-circle" style="font-size:30px; color:green; margin-bottom:10px;"></i><br>
                    <b>SUDAH DIVERIFIKASI</b><br>
                    <small>Menunggu Superintendent</small>
                </div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="index.html" class="nav-item"><i class="fa-solid fa-house"></i></a>
        <a href="#" class="nav-item active"><i class="fa-solid fa-clipboard-check"></i></a>
        <a href="pmi_result.html" class="nav-item"><i class="fa-solid fa-file-pdf"></i></a>
    </nav>

    <script>
        const SB_URL = "https://dsyvlavphvrdidmodokd.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
        const _sb = supabase.createClient(SB_URL, SB_KEY);

        let signaturePad = null;
        let currentHeaderId = null;
        let targetBarcode = null;
        let html5QrCode = null;

        // 1. INIT
        window.onload = function() {
            const now = new Date();
            document.getElementById('f-bulan').value = now.getMonth() + 1;
            document.getElementById('f-tahun').value = now.getFullYear();
        };

        // 2. LOAD LIST
        async function loadList() {
            const b = document.getElementById('f-bulan').value;
            const t = document.getElementById('f-tahun').value;
            const div = document.getElementById('list-container');
            
            div.innerHTML = '<div style="text-align:center; padding:20px;">Memuat data...</div>';

            const { data: headers, error } = await _sb.from('pmi_header')
                .select('*, pmi_machines(nama_mesin, barcode)')
                .eq('bulan', b).eq('tahun', t)
                .order('created_at', {ascending: false});

            if(error) return alert("Gagal memuat: " + error.message);
            if(!headers || headers.length === 0) {
                div.innerHTML = '<div style="text-align:center; padding:20px;">Tidak ada laporan di periode ini.</div>';
                return;
            }

            div.innerHTML = "";
            headers.forEach(h => {
                const isVerif = h.status_verifikasi === 'Verified' || h.status_verifikasi === 'Completed';
                const cls = isVerif ? 'card-verified' : 'card-pending';
                const badge = isVerif ? '<span class="badge bg-verified">SUDAH DIVERIFIKASI</span>' : '<span class="badge bg-pending">PERLU CEK</span>';
                
                div.innerHTML += `
                    <div class="card ${cls}" onclick="openDetail('${h.id}', '${h.pmi_machines.barcode}', ${isVerif})">
                        <div class="card-top">
                            <span class="card-date">${new Date(h.tanggal).toLocaleDateString('id-ID')}</span>
                            ${badge}
                        </div>
                        <div class="card-title">${h.pmi_machines.nama_mesin}</div>
                        <div class="card-sub"><i class="fa-solid fa-user-gear"></i> Teknisi: ${h.nama_pelaksana}</div>
                    </div>`;
            });
        }

        // 3. OPEN DETAIL
        async function openDetail(id, barcode, isDone) {
            currentHeaderId = id;
            targetBarcode = barcode;
            document.getElementById('modal').style.display = 'flex';
            
            // Logic Tampilan
            if(isDone) {
                document.getElementById('step-scan').style.display = 'none';
                document.getElementById('step-form').style.display = 'none';
                document.getElementById('msg-done').style.display = 'block';
            } else {
                document.getElementById('step-scan').style.display = 'block';
                document.getElementById('step-form').style.display = 'none';
                document.getElementById('msg-done').style.display = 'none';
                
                // Reset Scan UI
                document.getElementById('btn-scan-trigger').style.display = 'inline-block';
                document.getElementById('scanner-ui').style.display = 'none'; 
            }

            // Load Data Table
            document.getElementById('tbl-body').innerHTML = '<tr><td colspan="3">Loading...</td></tr>';
            const { data: h } = await _sb.from('pmi_header').select('*, pmi_machines(nama_mesin)').eq('id', id).single();
            document.getElementById('m-info').innerText = h.pmi_machines.nama_mesin + " | " + new Date(h.tanggal).toLocaleDateString('id-ID');

            const { data: res } = await _sb.from('pmi_results')
                .select(`status, nilai_aktual, keterangan, pmi_items(nama_item, urutan), pmi_item_fields(label, tipe_input)`)
                .eq('pmi_header_id', id)
                .order('pmi_items(urutan)');

            const tbody = document.getElementById('tbl-body');
            tbody.innerHTML = "";

            res.forEach(r => {
                const isNG = r.status === 'NG';
                let val = r.nilai_aktual || '-';
                if(r.pmi_item_fields.tipe_input === 'radio_ok_ng') val = r.status;
                if(r.pmi_item_fields.label && r.pmi_item_fields.tipe_input !== 'radio_ok_ng') {
                    val = `<b>${r.pmi_item_fields.label}:</b> ${val}`;
                }

                tbody.innerHTML += `
                    <tr class="${isNG ? 'row-ng' : ''}">
                        <td>${r.pmi_items.nama_item}</td>
                        <td class="${isNG ? 'txt-ng':'txt-ok'}">${r.status || ''}</td>
                        <td>${val} <br><small style="color:gray">${r.keterangan || ''}</small></td>
                    </tr>`;
            });
        }

        // 4. SCANNER LOGIC
        function startScanner() {
            document.getElementById('btn-scan-trigger').style.display = 'none';
            document.getElementById('scanner-ui').style.display = 'block'; // Tampilkan kotak kamera
            
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 220 }, onScanMatch, (err)=>{})
            .catch(err => alert("Kamera error: " + err));
        }

        async function onScanMatch(decodedText) {
            let scanned = decodedText.trim();
            if(scanned.includes('/')) scanned = scanned.split('/').pop().trim();

            if (scanned === targetBarcode) {
                await html5QrCode.stop();
                html5QrCode.clear();
                unlockForm(); // SUKSES
            } else {
                alert("QR CODE SALAH! \nMesin ini: " + scanned + "\nSeharusnya: " + targetBarcode);
            }
        }

        // 5. UNLOCK FORM
        function unlockForm() {
            document.getElementById('step-scan').style.display = 'none';
            document.getElementById('step-form').style.display = 'block';
            
            document.getElementById('inp-nama').value = "";
            document.getElementById('inp-catatan').value = "";
            
            setTimeout(() => {
                const canvas = document.getElementById('sig-canvas');
                canvas.width = document.getElementById('sig-wrapper').offsetWidth;
                canvas.height = document.getElementById('sig-wrapper').offsetHeight;
                if(signaturePad) signaturePad.off(); 
                signaturePad = new SignaturePad(canvas, { penColor: 'blue' });
            }, 300);
        }

        // 6. SUBMIT
        async function submitApprove() {
            const nama = document.getElementById('inp-nama').value.trim();
            const catatan = document.getElementById('inp-catatan').value.trim();

            if(!nama) return alert("Isi Nama Koordinator!");
            if(signaturePad.isEmpty()) return alert("Tanda Tangan Wajib!");

            if(!confirm("Yakin verifikasi laporan ini?")) return;

            document.getElementById('btn-submit').innerText = "MENYIMPAN...";
            document.getElementById('btn-submit').disabled = true;

            const { error } = await _sb.from('pmi_header').update({
                nama_koordinator: nama,
                catatan_koordinator: catatan,
                signature_koordinator: signaturePad.toDataURL(),
                status_verifikasi: 'Verified',
                verified_at: new Date()
            }).eq('id', currentHeaderId);

            if(error) {
                alert("Gagal: " + error.message);
                document.getElementById('btn-submit').disabled = false;
            } else {
                alert("BERHASIL DIVERIFIKASI!");
                closeModal();
                loadList();
            }
        }

        async function closeModal() {
            document.getElementById('modal').style.display = 'none';
            if(html5QrCode) { try{ await html5QrCode.stop(); html5QrCode.clear(); }catch(e){} }
        }
        
        function clearSig() { if(signaturePad) signaturePad.clear(); }
    </script>
</body>
</html>
