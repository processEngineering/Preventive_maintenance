<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Result PMI - A4 Portrait</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Arial', sans-serif; background: #525659; margin: 0; padding: 20px; font-size: 9px; }
        .filter-section { background: #fff; width: 210mm; margin: 0 auto 20px; padding: 15px; border-radius: 5px; display: flex; gap: 10px; }
        select, button { padding: 8px; border: 1px solid #000; font-weight: bold; cursor: pointer; }
        
        .paper { background: #fff; width: 210mm; min-height: 297mm; margin: 0 auto; padding: 10mm 15mm; box-sizing: border-box; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        
        /* HEADER KOP */
        .header-tbl { width: 100%; border: 1px solid #000; margin-bottom: 10px; border-collapse: collapse; }
        .header-tbl td { border: 1px solid #000; padding: 5px; text-align: center; }
        .title { font-weight: 900; font-size: 14px; text-transform: uppercase; }
        
        /* INFO MESIN */
        .info-tbl { width: 100%; border: 1px solid #000; margin-bottom: 10px; font-size: 10px; font-weight: bold; border-collapse: collapse; }
        .info-tbl td { padding: 3px 5px; border: none; }
        .val { font-weight: normal; margin-left: 5px; }

        /* TABEL UTAMA */
        .main-tbl { width: 100%; border-collapse: collapse; font-size: 9px; }
        .main-tbl th, .main-tbl td { border: 1px solid #000; padding: 4px; vertical-align: middle; }
        .main-tbl th { background: #ccc; text-align: center; font-weight: bold; text-transform: uppercase; height: 25px; }
        
        .cat-row { background: #bfbfbf; font-weight: bold; text-transform: uppercase; }
        
        /* Kolom Actual & Keterangan */
        .act-box { text-align: center; font-weight: bold; }
        .ok { color: green; } .ng { color: red; }
        .multi-row { display: flex; justify-content: space-between; border-bottom: 1px dotted #ccc; margin-bottom: 1px; }
        .multi-row:last-child { border: none; }

        /* TANDA TANGAN */
        .sig-tbl { width: 100%; margin-top: 20px; border: 1px solid #000; border-collapse: collapse; text-align: center; }
        .sig-tbl td { border: 1px solid #000; width: 33%; vertical-align: bottom; height: 60px; }
        .sig-head { background: #eee; font-weight: bold; height: auto !important; padding: 5px; vertical-align: top !important; }
        .sig-img { max-height: 50px; display: block; margin: 0 auto; }

        @media print {
            body { background: #fff; padding: 0; }
            .filter-section { display: none; }
            .paper { width: 100%; box-shadow: none; margin: 0; padding: 0; }
            @page { size: A4 portrait; margin: 10mm; }
        }
    </style>
</head>
<body>
    <div class="filter-section">
        <select id="sel-mesin"><option>Loading...</option></select>
        <select id="sel-bulan"><option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option><option value="4">Apr</option><option value="5">Mei</option><option value="6">Jun</option><option value="7">Jul</option><option value="8">Agu</option><option value="9">Sep</option><option value="10">Okt</option><option value="11">Nov</option><option value="12">Des</option></select>
        <select id="sel-tahun"><option value="2025" selected>2025</option><option value="2026">2026</option></select>
        <button onclick="loadReport()" style="background:black; color:white;">CARI DATA</button>
        <button onclick="window.print()" style="background:#c00; color:white;">PRINT</button>
    </div>

    <div class="paper" id="report">
        <table class="header-tbl">
            <tr>
                <td width="80"><img src="https://amarilyskg.co.id/bootstrap/img/logo.png" width="70"></td>
                <td class="title">FORM PREVENTIF MESIN INJECTION<br>(CLAMPING & INJECTION UNIT)</td>
                <td width="150" style="text-align:left; font-size:8px;">
                    No. Dokumen : AF.SP 05.07.Rev-00<br>
                    Tgl Terbit : 02 Agustus 2024<br>
                    Halaman : 1/1<br>
                    Revisi : -
                </td>
            </tr>
        </table>

        <table class="info-tbl">
            <tr>
                <td width="15%">MERK MESIN</td><td width="35%">: <span class="val" id="v_merk"></span></td>
                <td width="15%">TARGET SELESAI</td><td width="35%">: <span class="val" id="v_target"></span></td>
            </tr>
            <tr><td>TONAGE</td><td>: <span class="val" id="v_ton"></span></td><td>START JAM</td><td>: <span class="val" id="v_start"></span></td></tr>
            <tr><td>TANGGAL</td><td>: <span class="val" id="v_date"></span></td><td>FINISH JAM</td><td>: <span class="val" id="v_finish"></span></td></tr>
            <tr><td>TAHUN</td><td>: <span class="val" id="v_year"></span></td><td>RUNNING HOURS</td><td>: <span class="val" id="v_run"></span></td></tr>
        </table>

        <table class="main-tbl">
            <thead>
                <tr>
                    <th width="5%">NO</th>
                    <th width="30%">ITEM PENGECEKAN</th>
                    <th width="30%">STANDARD</th>
                    <th width="15%">ACTUAL</th>
                    <th width="20%">KETERANGAN</th>
                </tr>
            </thead>
            <tbody id="tbl-body"></tbody>
        </table>

        <table class="sig-tbl">
            <tr><td class="sig-head">Dibuat Oleh (Teknisi)</td><td class="sig-head">Diperiksa Oleh (Koordinator)</td><td class="sig-head">Disetujui Oleh (Superintendent)</td></tr>
            <tr>
                <td><div id="s1"></div><b id="n1"></b></td>
                <td><div id="s2"></div><b id="n2"></b></td>
                <td><div id="s3"></div><b id="n3"></b></td>
            </tr>
        </table>
    </div>

    <script>
        const _sb = supabase.createClient("https://dsyvlavphvrdidmodokd.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E");

        window.onload = async () => {
            const { data } = await _sb.from('pmi_machines').select('id, nama_mesin').order('nama_mesin');
            const sel = document.getElementById('sel-mesin');
            sel.innerHTML = '<option value="">-- Pilih Mesin --</option>';
            data.forEach(m => sel.innerHTML += `<option value="${m.id}">${m.nama_mesin}</option>`);
        };

        async function loadReport() {
            const mid = document.getElementById('sel-mesin').value;
            const bln = document.getElementById('sel-bulan').value;
            const thn = document.getElementById('sel-tahun').value;
            if(!mid) return alert("Pilih Mesin!");

            const { data: heads } = await _sb.from('pmi_header').select('*, pmi_machines(*)').eq('machine_id', mid).eq('bulan', bln).eq('tahun', thn).order('created_at', {ascending:false}).limit(1);
            if(!heads || heads.length === 0) return alert("Data tidak ditemukan!");
            const head = heads[0];

            // Render Header
            document.getElementById('v_merk').innerText = head.pmi_machines.nama_mesin;
            document.getElementById('v_ton').innerText = head.pmi_machines.tonage;
            document.getElementById('v_date').innerText = new Date(head.tanggal).toLocaleDateString('id-ID');
            document.getElementById('v_year').innerText = head.tahun;
            document.getElementById('v_target').innerText = new Date(head.target_selesai).toLocaleDateString('id-ID');
            document.getElementById('v_start').innerText = (head.start_jam || '').substring(0,5);
            document.getElementById('v_finish').innerText = (head.finish_jam || '').substring(0,5);
            document.getElementById('v_run').innerText = head.running_hours;

            document.getElementById('n1').innerText = head.nama_pelaksana || '';
            document.getElementById('n2').innerText = head.nama_koordinator || '';
            document.getElementById('n3').innerText = head.nama_superintendent || '';
            if(head.signature_pelaksana) document.getElementById('s1').innerHTML = `<img src="${head.signature_pelaksana}" class="sig-img">`;

            // Render Body
            const { data: res } = await _sb.from('pmi_results').select(`status, nilai_aktual, keterangan, pmi_items(id, kategori, nama_item, standard, urutan), pmi_item_fields(label, tipe_input, satuan, urutan)`).eq('pmi_header_id', head.id);
            
            // Sort
            res.sort((a,b) => (a.pmi_items.urutan - b.pmi_items.urutan) || (a.pmi_item_fields.urutan - b.pmi_item_fields.urutan));

            // Group by Item
            const map = new Map();
            res.forEach(r => {
                const iid = r.pmi_items.id;
                if(!map.has(iid)) map.set(iid, { meta: r.pmi_items, fields: [] });
                map.get(iid).fields.push(r);
            });

            let html = "";
            let lastCat = "";
            let no = 1;

            map.forEach((val) => {
                if(val.meta.kategori !== lastCat) {
                    lastCat = val.meta.kategori;
                    html += `<tr class="cat-row"><td colspan="5">${lastCat}</td></tr>`;
                }

                let actHtml = "";
                let ketHtml = "";

                val.fields.forEach(f => {
                    const fd = f.pmi_item_fields;
                    if(fd.tipe_input === 'radio_ok_ng') {
                        actHtml += `<div class="${f.status === 'OK' ? 'ok' : 'ng'}">${f.status || '-'}</div>`;
                    } else if (fd.tipe_input === 'text' && fd.label === 'Keterangan') {
                        ketHtml += f.nilai_aktual || '';
                    } else {
                        // Value with Label
                        actHtml += `<div class="multi-row"><span>${fd.label}:</span> <span>${f.nilai_aktual || '-'} ${fd.satuan || ''}</span></div>`;
                    }
                    if(f.keterangan) ketHtml += ` ${f.keterangan}`;
                });

                html += `<tr>
                    <td align="center">${no++}</td>
                    <td>${val.meta.nama_item}</td>
                    <td>${val.meta.standard || '-'}</td>
                    <td>${actHtml}</td>
                    <td>${ketHtml}</td>
                </tr>`;
            });

            document.getElementById('tbl-body').innerHTML = html;
            document.getElementById('report').style.display = 'block';
        }
    </script>
</body>
</html>
