<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Preventif - Full Functional Fix</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        @page { size: A4 portrait; margin: 5mm 10mm; }
        body { font-family: "Arial Narrow", Arial, sans-serif; font-size: 8.5pt; margin: 0; padding: 20px; background: #525659; -webkit-print-color-adjust: exact; }
        .no-print { background: white; padding: 15px; width: 210mm; margin: 0 auto 20px; display: flex; gap: 10px; box-sizing: border-box; }
        .paper { background: white; width: 210mm; min-height: 297mm; margin: 0 auto; padding: 5mm; display: none; }
        table { width: 100%; border-collapse: collapse; border-spacing: 0; }
        td, th { border: 1px solid #000; padding: 2px 3px; vertical-align: middle; }
        .header-tbl { margin-bottom: 5px; }
        .logo-img { height: 40px; display: block; margin: 0 auto; }
        .kop-title { font-weight: 900; font-size: 13pt; text-align: center; }
        .doc-tbl { font-size: 7.5pt; border: none; }
        .doc-tbl td { border: none; border-bottom: 1px solid #000; padding: 1px; }
        .info-tbl { border: none; margin-bottom: 5px; font-weight: bold; }
        .info-tbl td { border: none; }
        .main-tbl thead th { background: #d9d9d9 !important; font-weight: 900; text-transform: uppercase; }
        .col-no { width: 30px; text-align: center; font-weight: bold; }
        .col-std { width: 25%; font-style: italic; }
        .col-act { width: 32%; padding: 0 !important; }
        .cat-row td { background: #d9d9d9 !important; font-weight: 900; padding-left: 10px; }
        .special-header td { background: #d9d9d9 !important; font-weight: 900; text-align: center; font-size: 8pt; }
        
        /* Grid Styles */
        .pump-tbl { width: 100%; border: none; font-size: 8pt; }
        .pump-tbl td { border: 1px solid #000; text-align: center; width: 25%; }
        .pump-tbl tr:first-child td { border-top: none; }
        .pump-tbl tr td:first-child { border-left: none; }
        .pump-tbl tr td:last-child { border-right: none; }
        
        .heater-tbl { width: 100%; border: none; }
        .heater-tbl td { border-right: 1px solid #000; text-align: center; width: 50%; border-top:none; border-bottom:none; border-left:none; }
        .heater-tbl td:last-child { border-right: none; }
        
        .grid-simple { width: 100%; border: none; }
        .grid-simple td { border-right: 1px solid #000; text-align: center; width: 25%; border-top:none; border-bottom:none; border-left:none; }
        .grid-simple td:last-child { border-right: none; }
        .grid-head { background: #eee !important; font-size: 7.5pt; font-weight: bold; border-bottom: 1px solid #000 !important; }
        
        .sig-tbl td { height: 85px; vertical-align: top; position: relative; text-align: center; }
        .sig-name { position: absolute; bottom: 18px; width: 90%; left: 5%; font-weight: bold; text-decoration: underline; text-transform: uppercase; }
        .sig-role { position: absolute; bottom: 3px; width: 100%; font-weight: bold; font-size: 8pt; text-transform: uppercase; }
        
        @media print { .no-print { display: none; } .paper { display: block; border: none; width: 100%; margin: 0; } }
    </style>
</head>
<body>

<div class="no-print">
    <b>FILTER:</b>
    <select id="sel-mesin"><option>Loading...</option></select>
    <select id="sel-bulan"><option value="1">Januari</option><option value="2">Februari</option><option value="3">Maret</option><option value="4">April</option><option value="5">Mei</option><option value="6">Juni</option><option value="7">Juli</option><option value="8">Agustus</option><option value="9">September</option><option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option></select>
    <select id="sel-tahun"><option value="2025">2025</option><option value="2026">2026</option></select>
    <button onclick="cariLaporan()">CARI</button>
    <button onclick="window.print()" style="background:#b91c1c; color:white; margin-left:auto;">PRINT PDF</button>
</div>

<div class="paper" id="report-view">
    <table class="header-tbl">
        <tr>
            <td width="15%"><img src="https://amarilyskg.co.id/bootstrap/img/logo.png" class="logo-img"></td>
            <td width="55%"><div class="kop-title">PT. AMARILYS KARISMA GEMILANG</div><div style="text-align:center; font-weight:bold;">FORM PREVENTIF MESIN INJECTION (CLAMPING UNIT)</div></td>
            <td width="30%" style="padding:0;"><table class="doc-tbl"><tr><td>No. Dokumen</td><td>: AF.SP 05.07.Rev-00</td></tr><tr><td>Tanggal Terbit</td><td>: 02 Agustus 2024</td></tr><tr><td>Halaman</td><td>: 1/1</td></tr></table></td>
        </tr>
    </table>

    <table class="info-tbl">
        <tr><td width="15%">MERK MESIN</td><td>: <span id="v_mesin"></span></td><td width="15%">TARGET</td><td>: <span id="v_target"></span></td></tr>
        <tr><td>TONAGE</td><td>: <span id="v_ton"></span></td><td>START</td><td>: <span id="v_start"></span></td></tr>
    </table>

    <table class="main-tbl">
        <thead><tr><th class="col-no">NO</th><th>ITEM PENGECEKAN</th><th class="col-std">STANDARD</th><th class="col-act">ACTUAL</th><th class="col-ket">KETERANGAN</th></tr></thead>
        <tbody id="tbl-body"></tbody>
    </table>

    <table class="sig-tbl">
        <tr>
            <td><span style="display:block;text-align:left;margin:3px;">DI KERJAKAN :</span><div class="sig-name" id="nm_1"></div><div class="sig-role">OPRT. MEKANIK</div></td>
            <td><span style="display:block;text-align:left;margin:3px;">DIPERIKSA</span><div class="sig-name" id="nm_2"></div><div class="sig-role">SPV. MEKANIK</div></td>
            <td><span style="display:block;text-align:left;margin:3px;">MENGETAHUI :</span><div class="sig-name" id="nm_3"></div><div class="sig-role">SPTD. MEKANIK</div></td>
        </tr>
    </table>
</div>

<script>
    const SB_URL = "https://dsyvlavphvrdidmodokd.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
    const _sb = supabase.createClient(SB_URL, SB_KEY);

    window.onload = async () => {
        const { data } = await _sb.from('pmi_machines').select('id, nama_mesin').order('nama_mesin');
        const sel = document.getElementById('sel-mesin');
        sel.innerHTML = '<option value="">-- PILIH MESIN --</option>';
        if(data) data.forEach(m => sel.innerHTML += `<option value="${m.id}">${m.nama_mesin}</option>`);
    };

    async function cariLaporan() {
        const mid = document.getElementById('sel-mesin').value;
        const { data: headers } = await _sb.from('pmi_header').select('*, pmi_machines(nama_mesin, tonage)').eq('machine_id', mid).order('created_at', {ascending:false}).limit(1);
        if(headers) renderReport(headers[0]);
    }

    async function renderReport(head) {
        document.getElementById('report-view').style.display = 'block';
        document.getElementById('v_mesin').innerText = head.pmi_machines.nama_mesin;
        document.getElementById('nm_1').innerText = head.nama_pelaksana || '........';

        const { data: items } = await _sb.from('pmi_items').select('*').order('urutan');
        const { data: fields } = await _sb.from('pmi_item_fields').select('*').order('urutan');
        const { data: results } = await _sb.from('pmi_results').select('*').eq('pmi_header_id', head.id);

        let resMap = {}; if(results) results.forEach(r => resMap[`${r.pmi_item_id}_${r.pmi_item_field_id}`] = r);
        const tbody = document.getElementById('tbl-body'); tbody.innerHTML = ''; let lastCat = '';

        items.forEach(item => {
            const lowerName = item.nama_item.toLowerCase();
            if(item.kategori !== lastCat) { lastCat = item.kategori; tbody.innerHTML += `<tr class="cat-row"><td colspan="5">${lastCat}</td></tr>`; }
            
            if(lowerName.includes('cek temperatur heater barrel')) { tbody.innerHTML += `<tr class="cat-row"><td colspan="5">${item.nama_item}</td></tr>`; return; }
            
            if(lowerName.includes('heater zone 1') || lowerName.includes('zone 1')) {
                tbody.innerHTML += `<tr class="special-header"><td></td><td style="text-align:left;">Mesin (Instalasi Thermocouple)</td><td>Hasil ukur</td><td><div style="float:left; width:50%; border-right:1px solid #000;">Hasil (Display Mesin)</div><div style="float:left; width:50%;">Hasil ukur (Thermo Gun)</div></td><td>KETERANGAN</td></tr>`;
            }

            let rawName = item.nama_item; let finalNo = item.urutan; let finalName = rawName;
            let match = rawName.match(/^(\d+)([a-z]?)[\.\)\s]+\s*(.*)$/i);
            if (match) { finalNo = match[2] ? match[2] : match[1]; finalName = match[3]; }

            const myFields = fields.filter(f => f.pmi_item_id === item.id);
            let actHtml = '';

            // LOGIKA PUMP
            if(lowerName.includes('pump 1')) {
                actHtml = `<table class="pump-tbl"><tr><td colspan="4" style="background:#eee; font-weight:bold;">Valve Idling Sett:</td></tr><tr><td style="background:#eee;">50</td><td style="background:#eee;">100</td><td style="background:#eee;">150</td><td style="background:#eee;">200</td></tr><tr><td colspan="4" style="text-align:left; font-size:7pt; border-bottom:1px solid #000;">Actual Display / Pressure Gauge:</td></tr><tr><td>${getVal(resMap, item.id, myFields[0]?.id)}</td><td>${getVal(resMap, item.id, myFields[1]?.id)}</td><td>${getVal(resMap, item.id, myFields[2]?.id)}</td><td>${getVal(resMap, item.id, myFields[3]?.id)}</td></tr></table>`;
            } else if(lowerName.includes('pump 2')) {
                actHtml = `<table class="pump-tbl"><tr><td>${getVal(resMap, item.id, myFields[0]?.id)}</td><td>${getVal(resMap, item.id, myFields[1]?.id)}</td><td>${getVal(resMap, item.id, myFields[2]?.id)}</td><td>${getVal(resMap, item.id, myFields[3]?.id)}</td></tr></table>`;
            }
            // LOGIKA HEATER
            else if(lowerName.includes('heater') || lowerName.includes('nozzle')) {
                actHtml = `<table class="heater-tbl"><tr><td>${getVal(resMap, item.id, myFields[0]?.id)}</td><td>${getVal(resMap, item.id, myFields[1]?.id)}</td></tr></table>`;
            }
            // LOGIKA TIE BAR & NOZZLE SWITCH (PADA NOZZLE SWITCH DIPAKSA SINGLE)
            else if(lowerName.includes('switch') || lowerName.includes('sensor')) {
                let val = '-'; if(myFields.length > 0) { for(let f of myFields) { let r = resMap[`${item.id}_${f.id}`]; if(r && r.status) { val = r.status; break; } } }
                actHtml = `<div style="text-align:center; font-weight:bold;">${val}</div>`;
            } else if(myFields.length > 1) {
                let tdsHead = lowerName.includes('sebelum kalibrasi') ? `<tr>${myFields.map(f => `<td class="grid-head">${f.label}</td>`).join('')}</tr>` : '';
                actHtml = `<table class="grid-simple">${tdsHead}<tr>${myFields.map(f => `<td>${getVal(resMap, item.id, f.id)}</td>`).join('')}</tr></table>`;
            } else {
                actHtml = `<div style="text-align:center; font-weight:bold;">${getVal(resMap, item.id, myFields[0]?.id)}</div>`;
            }

            tbody.innerHTML += `<tr><td class="col-no">${finalNo}</td><td>${finalName}</td><td>${item.standard || ''}</td><td class="col-act">${actHtml}</td><td>${resMap[`${item.id}_${myFields[0]?.id}`]?.keterangan || ''}</td></tr>`;
        });
    }
    function getVal(map, itm, fld) { return map[`${itm}_${fld}`]?.status || map[`${itm}_${fld}`]?.nilai_aktual || '-'; }
</script>
</body>
</html>
