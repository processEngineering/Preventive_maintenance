<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Preventif - Precision Final</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        @page { size: A4 portrait; margin: 5mm 10mm; }
        body { font-family: "Arial Narrow", Arial, sans-serif; font-size: 8.5pt; margin: 0; padding: 20px; background: #525659; -webkit-print-color-adjust: exact; }
        .no-print { background: white; padding: 15px; width: 210mm; margin: 0 auto 20px; display: flex; gap: 10px; box-sizing: border-box; }
        .paper { background: white; width: 210mm; min-height: 297mm; margin: 0 auto; display: none; }
        table { width: 100%; border-collapse: collapse; }
        td, th { border: 1px solid #000; padding: 2px 3px; vertical-align: middle; }
        .header-tbl { margin-bottom: 5px; }
        .logo-img { height: 40px; display: block; margin: 0 auto; }
        .kop-title { font-weight: 900; font-size: 13pt; text-align: center; }
        .doc-tbl { font-size: 7.5pt; border: none; }
        .doc-tbl td { border: none; border-bottom: 1px solid #000; }
        .main-tbl thead th { background: #d9d9d9 !important; font-weight: 900; text-transform: uppercase; }
        .col-no { width: 30px; text-align: center; font-weight: bold; }
        .col-std { width: 25%; font-style: italic; }
        .col-act { width: 32%; padding: 0 !important; }
        .col-ket { width: 12%; }
        .cat-row td { background: #d9d9d9 !important; font-weight: 900; padding-left: 10px; }
        .special-header td { background: #d9d9d9 !important; font-weight: 900; text-align: center; font-size: 8pt; }
        .pump-tbl { border: none; }
        .pump-tbl td { border: 1px solid #000; text-align: center; width: 25%; }
        .grid-simple { border: none; }
        .grid-simple td { border-right: 1px solid #000; text-align: center; width: 25%; }
        .grid-head { background: #eee !important; font-weight: bold; border-bottom: 1px solid #000 !important; }
        .sig-tbl td { height: 85px; vertical-align: top; position: relative; text-align: center; }
        .sig-name { position: absolute; bottom: 18px; width: 90%; left: 5%; font-weight: bold; text-decoration: underline; text-transform: uppercase; }
        .sig-role { position: absolute; bottom: 3px; width: 100%; font-weight: bold; font-size: 8pt; text-transform: uppercase; }
        @media print { .no-print { display: none; } .paper { display: block; border: none; } }
    </style>
</head>
<body>

<div class="no-print">
    <select id="sel-mesin"><option>Loading Mesin...</option></select>
    <select id="sel-bulan"><option value="1">Januari</option><option value="2">Februari</option><option value="3">Maret</option><option value="4">April</option><option value="5">Mei</option><option value="6">Juni</option><option value="7">Juli</option><option value="8">Agustus</option><option value="9">September</option><option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option></select>
    <select id="sel-tahun"><option value="2025">2025</option><option value="2026">2026</option></select>
    <button onclick="cariLaporan()">CARI</button>
    <button onclick="window.print()" style="background:#b91c1c; color:white; margin-left:auto;">CETAK PDF</button>
</div>

<div class="paper" id="report-view">
    <table class="header-tbl">
        <tr>
            <td width="15%"><img src="https://amarilyskg.co.id/bootstrap/img/logo.png" class="logo-img"></td>
            <td width="55%"><div class="kop-title">PT. AMARILYS KARISMA GEMILANG</div><div style="text-align:center; font-weight:bold;">FORM PREVENTIF MESIN INJECTION (CLAMPING UNIT)</div></td>
            <td width="30%" style="padding:0;"><table class="doc-tbl"><tr><td>No. Dokumen</td><td>: AF.SP 05.07.Rev-00</td></tr><tr><td>Tanggal Terbit</td><td>: 02 Agustus 2024</td></tr><tr><td>Halaman</td><td>: 1/1</td></tr></table></td>
        </tr>
    </table>

    <table class="main-tbl">
        <thead><tr><th class="col-no">NO</th><th>ITEM PENGECEKAN</th><th class="col-std">STANDARD</th><th class="col-act">ACTUAL</th><th class="col-ket">KETERANGAN</th></tr></thead>
        <tbody id="tbl-body"></tbody>
    </table>

    <table class="sig-tbl">
        <tr>
            <td><span style="display:block;text-align:left;margin:3px;">DI KERJAKAN :</span><div id="sig_1"></div><div class="sig-name" id="nm_1"></div><div class="sig-role">OPRT. MEKANIK</div></td>
            <td><span style="display:block;text-align:left;margin:3px;">DIPERIKSA</span><div id="sig_2"></div><div class="sig-name" id="nm_2"></div><div class="sig-role">SPV. MEKANIK</div></td>
            <td><span style="display:block;text-align:left;margin:3px;">MENGETAHUI :</span><div id="sig_3"></div><div class="sig-name" id="nm_3"></div><div class="sig-role">SPTD. MEKANIK</div></td>
        </tr>
    </table>
</div>

<script>
    const SB_URL = "https://dsyvlavphvrdidmodokd.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
    const _sb = supabase.createClient(SB_URL, SB_KEY);

    window.onload = async () => {
        const { data } = await _sb.from('pmi_machines').select('id, nama_mesin').order('nama_mesin');
        const sel = document.getElementById('sel-mesin');
        sel.innerHTML = '<option value="">-- PILIH MESIN --</option>';
        if(data) data.forEach(m => sel.innerHTML += `<option value="${m.id}">${m.nama_mesin}</option>`);
    };

    async function cariLaporan() {
        const mid = document.getElementById('sel-mesin').value;
        const bln = document.getElementById('sel-bulan').value;
        const thn = document.getElementById('sel-tahun').value;
        if(!mid) return alert("Pilih Mesin!");
        const { data: headers } = await _sb.from('pmi_header').select('*, pmi_machines(nama_mesin, tonage)').eq('machine_id', mid).eq('bulan', bln).eq('tahun', thn).order('created_at', {ascending:false}).limit(1);
        if(!headers || headers.length === 0) return alert("Data tidak ada!");
        renderReport(headers[0]);
    }

    async function renderReport(head) {
        document.getElementById('report-view').style.display = 'block';
        document.getElementById('nm_1').innerText = head.nama_pelaksana || '........';
        document.getElementById('nm_2').innerText = head.nama_koordinator || '........';
        document.getElementById('nm_3').innerText = head.nama_superintendent || '........';
        if(head.signature_pelaksana) document.getElementById('sig_1').innerHTML = `<img src="${head.signature_pelaksana}" style="height:45px;">`;

        const { data: items } = await _sb.from('pmi_items').select('*').order('urutan');
        const { data: fields } = await _sb.from('pmi_item_fields').select('*').order('urutan');
        const { data: results } = await _sb.from('pmi_results').select('*').eq('pmi_header_id', head.id);

        let resMap = {}; if(results) results.forEach(r => resMap[`${r.pmi_item_id}_${r.pmi_item_field_id}`] = r);
        const tbody = document.getElementById('tbl-body'); tbody.innerHTML = ''; let lastCat = '';

        items.forEach(item => {
            if(item.kategori !== lastCat) { lastCat = item.kategori; tbody.innerHTML += `<tr class="cat-row"><td colspan="5">${lastCat}</td></tr>`; }
            const lowerName = item.nama_item.toLowerCase();
            let rawName = item.nama_item; let finalNo = item.urutan; let finalName = rawName;
            let match = rawName.match(/^(\d+)[\.\)\s]+\s*(.*)$/);
            if (match) { finalNo = match[1]; finalName = match[2]; }

            const myFields = fields.filter(f => f.pmi_item_id === item.id);
            let actHtml = '';

            if(lowerName.includes('switch') || lowerName.includes('sensor')) {
                let val = '-'; if(myFields.length > 0) { for(let f of myFields) { let r = resMap[`${item.id}_${f.id}`]; if(r && r.status) { val = r.status; break; } } }
                actHtml = `<div style="text-align:center; font-weight:bold;">${val}</div>`;
            } else if(myFields.length > 1) {
                let tdsVal = ''; myFields.forEach(f => tdsVal += `<td>${resMap[`${item.id}_${f.id}`]?.status || '-'}</td>`);
                actHtml = `<table class="grid-simple"><tr>${tdsVal}</tr></table>`;
            } else {
                actHtml = `<div style="text-align:center; font-weight:bold;">${resMap[`${item.id}_${myFields[0]?.id}`]?.status || '-'}</div>`;
            }

            tbody.innerHTML += `<tr><td class="col-no">${finalNo}</td><td>${finalName}</td><td>${item.standard || ''}</td><td class="col-act">${actHtml}</td><td></td></tr>`;
        });
    }
</script>
</body>
</html>
