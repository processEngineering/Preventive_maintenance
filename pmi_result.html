<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AF.SP 05.07.Rev-00 - FORM PREVENTIF MESIN INJECTION</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* === CONFIG A4 PORTRAIT === */
        @page { size: A4 portrait; margin: 5mm; }
        
        /* === RESET & FONT === */
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        body { 
            font-family: "Arial Narrow", "Helvetica Condensed", Arial, sans-serif; 
            font-size: 8pt; /* Font mikro agar muat 1 halaman */
            background: #525659; 
            margin: 0; padding: 20px; 
            color: #000;
            line-height: 1.1;
        }

        /* === UI LAYAR (NO PRINT) === */
        .filter-section {
            background: #fff; width: 210mm; margin: 0 auto 10px; padding: 10px;
            display: flex; gap: 5px; align-items: center; border: 1px solid #ccc;
        }
        select, button { padding: 5px; font-size: 12px; border: 1px solid #333; cursor: pointer; }
        .btn-print { background: #b91c1c; color: #fff; margin-left: auto; border: none; font-weight: bold; }

        /* === KERTAS A4 === */
        .paper {
            background: #fff; width: 210mm; min-height: 297mm; 
            margin: 0 auto; padding: 5mm; position: relative;
            box-shadow: 0 0 15px rgba(0,0,0,0.5); display: none;
        }

        /* === TABEL SYSTEM === */
        table { width: 100%; border-collapse: collapse; margin-bottom: 2px; }
        td, th { border: 1px solid #000; padding: 1px 3px; vertical-align: middle; }
        
        .no-border { border: none !important; }
        .border-bottom { border-bottom: 1px solid #000 !important; }
        .text-center { text-align: center; }
        .text-bold { font-weight: bold; }
        .bg-gray { background-color: #d9d9d9 !important; } /* Warna PDF */

        /* Header Grid */
        .col-no { width: 20px; text-align: center; }
        .col-item { width: 35%; }
        .col-std { width: 25%; font-style: italic; }
        .col-act { width: 20%; text-align: center; padding: 0 !important; }
        .col-ket { width: 15%; }

        /* Multi Value Grid (Tie Bar, Pump, etc) */
        .mv-grid { display: flex; width: 100%; height: 100%; }
        .mv-item { flex: 1; border-right: 1px solid #000; text-align: center; display: flex; flex-direction: column; justify-content: center; min-height: 14px; }
        .mv-item:last-child { border-right: none; }
        .mv-lbl { font-size: 6pt; font-weight: 700; border-bottom: 1px dotted #ccc; background: #eee; }
        .mv-val { font-weight: 900; font-size: 8pt; }

        /* Status Colors */
        .st-ok { font-weight: 900; color: #000; }
        .st-ng { font-weight: 900; color: #b91c1c; }

        /* === PRINT MEDIA === */
        @media print {
            body { margin: 0; padding: 0; background: #fff; zoom: 0.95; }
            .filter-section { display: none !important; }
            .paper { width: 100%; margin: 0; box-shadow: none; padding: 0; display: block !important; }
        }
    </style>
</head>
<body>

    <div class="filter-section">
        <b>FILTER FORM:</b>
        <select id="sel-mesin"><option value="">Loading...</option></select>
        <select id="sel-bulan" style="width:100px;"><option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option><option value="4">Apr</option><option value="5">Mei</option><option value="6">Jun</option><option value="7">Jul</option><option value="8">Agu</option><option value="9">Sep</option><option value="10">Okt</option><option value="11">Nov</option><option value="12">Des</option></select>
        <select id="sel-tahun" style="width:80px;"><option value="2025">2025</option><option value="2026">2026</option></select>
        <button class="btn-search" onclick="cariLaporan()">CARI LAPORAN</button>
        <button class="btn-print" onclick="window.print()">üñ®Ô∏è CETAK</button>
    </div>

    <div class="paper" id="report-view">
        
        <table class="no-border" style="border: 1px solid #000; margin-bottom: 5px;">
            <tr>
                <td style="width: 25%; padding: 5px;" class="no-border">
                    <img src="https://amarilyskg.co.id/bootstrap/img/logo.png" style="width: 50px; float: left; margin-right: 5px;">
                    <span style="font-weight: 900; font-size: 10pt;">PT. AMARILYS KARISMA GEMILANG</span>
                </td>
                <td style="width: 50%;" class="text-center no-border">
                    <span style="font-size: 14pt; font-weight: 900; text-decoration: underline;">FORM PREVENTIF MESIN INJECTION</span><br>
                    <span style="font-size: 10pt; font-weight: 700;">(CLAMPING UNIT)</span>
                </td>
                <td style="width: 25%; padding: 0;" class="no-border">
                    <table style="width: 100%; border: none; margin: 0; font-size: 7pt;">
                        <tr><td class="no-border border-bottom">No. Dokumen : AF SP 05.07.Rev-00</td></tr>
                        <tr><td class="no-border border-bottom">Tanggal Terbit : 02 Agustus 2024</td></tr>
                        <tr><td class="no-border border-bottom">Halaman : 1/1</td></tr>
                        <tr><td class="no-border">Tanggal Revisi :-</td></tr>
                    </table>
                </td>
            </tr>
        </table>

        <table style="font-weight: bold; border: 1px solid #000; font-size: 8pt;">
            <tr>
                <td class="no-border" width="15%">MERK MESIN</td><td class="no-border" width="35%">: <span id="v_mesin" style="font-weight:normal;"></span></td>
                <td class="no-border" width="15%">TARGET SELESAI</td><td class="no-border" width="35%">: <span id="v_target" style="font-weight:normal;"></span></td>
            </tr>
            <tr>
                <td class="no-border">TONAGE</td><td class="no-border">: <span id="v_ton" style="font-weight:normal;"></span></td>
                <td class="no-border">START JAM</td><td class="no-border">: <span id="v_start" style="font-weight:normal;"></span></td>
            </tr>
            <tr>
                <td class="no-border">TANGGAL</td><td class="no-border">: <span id="v_tgl" style="font-weight:normal;"></span></td>
                <td class="no-border">FINISH JAM</td><td class="no-border">: <span id="v_finish" style="font-weight:normal;"></span></td>
            </tr>
            <tr>
                <td class="no-border border-bottom">TAHUN</td><td class="no-border border-bottom">: <span id="v_thn" style="font-weight:normal;"></span></td>
                <td class="no-border border-bottom">RUNNING HOURS</td><td class="no-border border-bottom">: <span id="v_hm" style="font-weight:normal;"></span></td>
            </tr>
        </table>

        <table>
            <thead class="bg-gray text-bold text-center">
                <tr><td class="col-no">NO</td><td class="col-item">ITEM</td><td class="col-std">STANDARD</td><td class="col-act">ACTUAL</td><td class="col-ket">KETERANGAN</td></tr>
            </thead>
            <tbody style="font-size: 8pt;">
                <tr class="bg-gray text-bold"><td colspan="5" class="text-center">Mekanikal Clamping unit :</td></tr>
                <tr><td class="text-center">1</td><td>Pompa lubrikasi berfungsi baik</td><td>Power ON, grease keluar sampe target</td><td id="act_1" class="text-center text-bold"></td><td id="ket_1"></td></tr>
                <tr><td class="text-center">2</td><td>Distributor valve lubrikasi</td><td>Tidak bocor</td><td id="act_2" class="text-center text-bold"></td><td id="ket_2"></td></tr>
                <tr><td class="text-center">3</td><td>Selang lubrikasi</td><td>Tidak bocor/pecah</td><td id="act_3" class="text-center text-bold"></td><td id="ket_3"></td></tr>
                <tr><td class="text-center">4</td><td>Slide shoc</td><td>Tidak kering (basah pelumas)</td><td id="act_4" class="text-center text-bold"></td><td id="ket_4"></td></tr>
                <tr><td class="text-center">5</td><td>Gear thikness</td><td>Tidak kering (basah pelumas)</td><td id="act_5" class="text-center text-bold"></td><td id="ket_5"></td></tr>
                <tr><td class="text-center">6</td><td>Arm togle</td><td>Fungsi mekanikal normal</td><td id="act_6" class="text-center text-bold"></td><td id="ket_6"></td></tr>
                <tr><td class="text-center">7</td><td>As pengarah plat ejector</td><td>Tidak kering (basah pelumas)</td><td id="act_7" class="text-center text-bold"></td><td id="ket_7"></td></tr>
                <tr><td class="text-center">8</td><td>Permukaan dan lubang baut (move/fix platten)</td><td>Bersih dan drat tidak rusak</td><td id="act_8" class="text-center text-bold"></td><td id="ket_8"></td></tr>
                <tr><td class="text-center">9</td><td>Cek As nebar</td><td>Kalibrasi sensommate</td><td id="act_9" class="text-center text-bold"></td><td id="ket_9"></td></tr>

                <tr class="bg-gray text-bold"><td colspan="5">Hydrolik :</td></tr>
                <tr><td class="text-center">10</td><td>Ejector cylinder hydrolik</td><td>Tidak bocor (pengecekan pressure gauge)</td><td id="act_10" class="text-center text-bold"></td><td id="ket_10"></td></tr>
                <tr><td class="text-center">11</td><td>Clamping cylinder hydrolik</td><td>Tidak bocor (pengecekan pressure gange)</td><td id="act_11" class="text-center text-bold"></td><td id="ket_11"></td></tr>
                <tr><td class="text-center">12</td><td>Cek solenoid valve</td><td>Tidak bocort pengecekan pressure gauge)</td><td id="act_12" class="text-center text-bold"></td><td id="ket_12"></td></tr>
                <tr><td class="text-center">13</td><td>Selang & fitting hydrolik (clamping ejector/core)</td><td>Tidak pecah retak</td><td id="act_13" class="text-center text-bold"></td><td id="ket_13"></td></tr>

                <tr class="bg-gray text-bold"><td colspan="5">Electrical :</td></tr>
                <tr><td class="text-center">14</td><td>Periksa safety limit switch pintu</td><td>Berfungsi haik'normal</td><td id="act_14" class="text-center text-bold"></td><td id="ket_14"></td></tr>
                <tr><td class="text-center">15</td><td>Sensor (thikness/kon√≠ injecti</td><td>Berfungsi baik normal</td><td id="act_15" class="text-center text-bold"></td><td id="ket_15"></td></tr>
                <tr><td class="text-center">16</td><td>Linier Potensiometer (LP) Clamping& ejector</td><td>Membaca normal</td><td id="act_16" class="text-center text-bold"></td><td id="ket_16"></td></tr>
                <tr><td class="text-center">17</td><td>Linut switch panel</td><td>Berfingsi baik/normal</td><td id="act_17" class="text-center text-bold"></td><td id="ket_17"></td></tr>
                <tr><td class="text-center">18</td><td>Limit switch penutup nozzle</td><td>Berfungsi haik/normal</td><td id="act_18" class="text-center text-bold"></td><td id="ket_18"></td></tr>
                <tr><td class="text-center">19</td><td>Limit switch penutup serew</td><td>Berfungsi baik/normal</td><td id="act_19" class="text-center text-bold"></td><td id="ket_19"></td></tr>

                <tr class="bg-gray text-bold">
                    <td colspan="3">Kalibrasi Tie Bar :</td>
                    <td style="padding:0;">
                        <div class="mv-grid">
                            <div class="mv-item"><span class="mv-lbl">S1</span><span class="mv-val" id="val_s1"></span></div>
                            <div class="mv-item"><span class="mv-lbl">S2</span><span class="mv-val" id="val_s2"></span></div>
                            <div class="mv-item"><span class="mv-lbl">S3</span><span class="mv-val" id="val_s3"></span></div>
                            <div class="mv-item"><span class="mv-lbl">S4</span><span class="mv-val" id="val_s4"></span></div>
                        </div>
                    </td>
                    <td class="text-center">KETERANGAN</td>
                </tr>
                <tr><td class="text-center">20</td><td>Hasil sebelum kalibrasi</td><td>Menggunakan mold yang sedang rumming produksi</td><td id="act_20" class="text-center text-bold"></td><td id="ket_20"></td></tr>
                <tr><td class="text-center">21</td><td>Hasil kalibrasi</td><td>Menggunakan mold base</td><td id="act_21" class="text-center text-bold"></td><td id="ket_21"></td></tr>
                <tr><td class="text-center">22</td><td>Hasil setelah kalibrasi</td><td>Menggunakan mold yang running produksi (product relesae)</td><td id="act_22" class="text-center text-bold"></td><td id="ket_22"></td></tr>
            </tbody>
        </table>

        <table>
            <tr class="bg-gray text-center text-bold"><td colspan="5">Pump & Elektrikal:</td></tr>
            <tr class="bg-gray text-center text-bold"><td colspan="2">ITEM</td><td>STANDART</td><td>ACTUAL</td><td>KETERANGAN</td></tr>
            <tr><td class="text-center" width="25">1</td><td>Cek coupling porma</td><td>Tidak kendor. Vistul</td><td id="p_act_1" class="text-center text-bold"></td><td id="p_ket_1"></td></tr>
            <tr><td class="text-center">2</td><td>kebersihim sirkulasi alma motor</td><td>Sirkkalasi lancar, tidak berdelm</td><td id="p_act_2" class="text-center text-bold"></td><td id="p_ket_2"></td></tr>

            <tr class="bg-gray text-bold"><td colspan="5">Hydrolik :</td></tr>
            <tr><td class="text-center">3</td><td>Cek temperature oli</td><td>40-50</td><td id="p_act_3" class="text-center text-bold"></td><td id="p_ket_3"></td></tr>
            <tr><td class="text-center">4</td><td>cak level oli</td><td>Dhiatas level batas tengah</td><td id="p_act_4" class="text-center text-bold"></td><td id="p_ket_4"></td></tr>
            <tr><td class="text-center">5</td><td>Periksa selameid valve</td><td>Tudak bocor</td><td id="p_act_5" class="text-center text-bold"></td><td id="p_ket_5"></td></tr>
            <tr><td class="text-center">6</td><td>cek oil cooler</td><td>Tidak bocor</td><td id="p_act_6" class="text-center text-bold"></td><td id="p_ket_6"></td></tr>

            <tr class="bg-gray text-bold">
                <td colspan="3">Pump Hydrolik :</td>
                <td style="padding:0;">
                    <div style="font-size: 6pt; text-align: center; border-bottom: 1px solid #000; background:#eee;">Valve Idling Sett:</div>
                    <div class="mv-grid">
                        <div class="mv-item"><span class="mv-lbl">50</span><span class="mv-val" id="val_50"></span></div>
                        <div class="mv-item"><span class="mv-lbl">100</span><span class="mv-val" id="val_100"></span></div>
                        <div class="mv-item"><span class="mv-lbl">150</span><span class="mv-val" id="val_150"></span></div>
                        <div class="mv-item"><span class="mv-lbl">200</span><span class="mv-val" id="val_200"></span></div>
                    </div>
                </td>
                <td class="text-center">KETERANGAN</td>
            </tr>
            <tr><td class="text-center" rowspan="2">7</td><td rowspan="2">Pump 1</td><td>Actual disply</td><td id="p1_ad" class="text-center text-bold"></td><td rowspan="2" id="p1_ket"></td></tr>
            <tr><td>Pressure Gauge</td><td id="p1_pg" class="text-center text-bold"></td></tr>
            <tr><td class="text-center" rowspan="2">8</td><td rowspan="2">Pump 2</td><td>Actul disply</td><td id="p2_ad" class="text-center text-bold"></td><td rowspan="2" id="p2_ket"></td></tr>
            <tr><td>Pressure Gauge</td><td id="p2_pg" class="text-center text-bold"></td></tr>

            <tr class="bg-gray text-bold"><td colspan="3">Electrical :</td><td class="text-center">ACTUAL</td><td class="text-center">KETERANGAN</td></tr>
            <tr><td class="text-center">6</td><td>Cek kotnik birmmunal dan connector kabel</td><td>Spot thermal camera</td><td id="e_act_6" class="text-center text-bold"></td><td id="e_ket_6"></td></tr>
            <tr><td class="text-center">7</td><td>Cek fan dan motor inverter</td><td>Berliansi dengan baik (spot thermal camera)</td><td id="e_act_7" class="text-center text-bold"></td><td id="e_ket_7"></td></tr>
            <tr><td class="text-center">8</td><td>Cek sirkulasi ndara di panel electric</td><td>Berfungsi dengan baik (spot thermal camera)</td><td id="e_act_8" class="text-center text-bold"></td><td id="e_ket_8"></td></tr>
            <tr><td class="text-center">9</td><td>Cek sambung kabel Listrik</td><td>Tidak yang terkelupas (spot thermal camera)</td><td id="e_act_9" class="text-center text-bold"></td><td id="e_ket_9"></td></tr>
            <tr><td class="text-center">10</td><td>Cek Stop Kontak</td><td>tidak ada bagian raak (spot thermal camera)</td><td id="e_act_10" class="text-center text-bold"></td><td id="e_ket_10"></td></tr>
            <tr><td class="text-center">11</td><td>Cek Sakelar Kelistrikan</td><td>tidak ada bagian rusak (spot thermal co–≤–µ—Ç–∞)</td><td id="e_act_11" class="text-center text-bold"></td><td id="e_ket_11"></td></tr>
            <tr><td class="text-center">12</td><td>Pastikan kondisi dalam panel bersih bersih</td><td>tidak berdebu dan lengket (spot thermal camera)</td><td id="e_act_12" class="text-center text-bold"></td><td id="e_ket_12"></td></tr>
            <tr>
                <td class="text-center">13</td><td>Cek tegangan breaker NFB</td><td>Pengukuran Voltage (Voltmeter)</td>
                <td style="padding:0;">
                    <div class="mv-grid">
                        <div class="mv-item"><span class="mv-lbl">R-S</span><span class="mv-val" id="val_rs"></span></div>
                        <div class="mv-item"><span class="mv-lbl">R-T</span><span class="mv-val" id="val_rt"></span></div>
                        <div class="mv-item"><span class="mv-lbl">S-T</span><span class="mv-val" id="val_st"></span></div>
                    </div>
                </td>
                <td id="e_ket_13"></td>
            </tr>
        </table>

        <table>
            <tr class="bg-gray text-bold"><td colspan="5">INJECTION UNITE :</td></tr>
            <tr><td class="text-center" width="25">1</td><td>Nozie visual</td><td>Kencang, Radiuus tidak rusak & center terhadap sprue bas</td><td id="inj_act_1" class="text-center text-bold"></td><td id="inj_ket_1"></td></tr>
            <tr><td class="text-center">2</td><td>Screw tips</td><td>Test inject 2 kali tidak ngempos</td><td id="inj_act_2" class="text-center text-bold"></td><td id="inj_ket_2"></td></tr>
            <tr><td class="text-center">3</td><td>Periksa apakah ada kerusakan di area slide way</td><td>Baut2 kencang dan ada pelumas</td><td id="inj_act_3" class="text-center text-bold"></td><td id="inj_ket_3"></td></tr>
            <tr><td class="text-center">4</td><td>Lubrikasi Linier slide unit</td><td>Tidak mampet (heim)</td><td id="inj_act_4" class="text-center text-bold"></td><td id="inj_ket_4"></td></tr>

            <tr>
                <td class="text-center">5</td><td colspan="4" style="padding:0;">
                    <table style="width: 100%; border: none; margin: 0;">
                        <tr><td class="no-border" colspan="5" style="border-bottom:1px solid #000!important; font-weight:bold;">Cek temperatur heater barrel:</td></tr>
                        <tr class="bg-gray text-center text-bold">
                            <td width="30%">Mesin (Instalasi Thermocouple)</td><td width="20%">Hasil ukur</td>
                            <td width="20%">Hasil (Display Mesin)</td><td width="20%">Hasil ukur (Thermo Gun)</td>
                            <td width="10%">KETERANGAN</td>
                        </tr>
                        <tr><td>a. Zone 1</td><td>Toleransi ¬± 15¬∞C</td><td id="t_ukr_1" class="text-center text-bold"></td><td id="t_gun_1" class="text-center text-bold"></td><td id="t_ket_1"></td></tr>
                        <tr><td>b. Zone 2</td><td>Toleransi ¬± 15¬∞C</td><td id="t_ukr_2" class="text-center text-bold"></td><td id="t_gun_2" class="text-center text-bold"></td><td id="t_ket_2"></td></tr>
                        <tr><td>c. Zone 3</td><td>Toleransi ¬± 15¬∞C</td><td id="t_ukr_3" class="text-center text-bold"></td><td id="t_gun_3" class="text-center text-bold"></td><td id="t_ket_3"></td></tr>
                        <tr><td>d. Zone 4</td><td>Toleransi ¬± 15¬∞C</td><td id="t_ukr_4" class="text-center text-bold"></td><td id="t_gun_4" class="text-center text-bold"></td><td id="t_ket_4"></td></tr>
                        <tr><td>e. Zone 5</td><td>Toletunsa ¬± 15¬∞C</td><td id="t_ukr_5" class="text-center text-bold"></td><td id="t_gun_5" class="text-center text-bold"></td><td id="t_ket_5"></td></tr>
                        <tr><td>f. Zone Nozle</td><td>Toletunsi ¬± 15¬∞C</td><td id="t_ukr_6" class="text-center text-bold"></td><td id="t_gun_6" class="text-center text-bold"></td><td id="t_ket_6"></td></tr>
                    </table>
                </td>
            </tr>

            <tr class="bg-gray text-bold"><td colspan="4">Hydrolik :</td><td class="text-center">KETERANGAN</td></tr>
            <tr><td class="text-center">6</td><td>Hydrolik evlinder carrier & carrier</td><td>Tidak bocar</td><td id="inj_act_6" class="text-center text-bold"></td><td id="inj_ket_6"></td></tr>
            <tr><td class="text-center">7</td><td>Unit zotary screw & coupling screw.</td><td>Tidak bocor & coupling kencang</td><td id="inj_act_7" class="text-center text-bold"></td><td id="inj_ket_7"></td></tr>
            <tr><td class="text-center">8</td><td>Cek solenoid valve</td><td>Tidak bocor & cek pressure</td><td id="inj_act_8" class="text-center text-bold"></td><td id="inj_ket_8"></td></tr>
            <tr><td class="text-center">9</td><td>Oli gearbox screw</td><td>Sesuai batas level</td><td id="inj_act_9" class="text-center text-bold"></td><td id="inj_ket_9"></td></tr>
            <tr><td class="text-center">10</td><td>Tidak ada sisa oh yang terbuang</td><td>Bersih dari oli</td><td id="inj_act_10" class="text-center text-bold"></td><td id="inj_ket_10"></td></tr>

            <tr>
                <td class="text-center">11</td><td>Accumulator pressure *</td><td>120 - 135 bar</td>
                <td style="padding:0;">
                    <div class="mv-grid">
                        <div class="mv-item"><span class="mv-lbl">Tabung A</span><span class="mv-val" id="val_tb_a"></span></div>
                        <div class="mv-item"><span class="mv-lbl">Tabung B</span><span class="mv-val" id="val_tb_b"></span></div>
                        <div class="mv-item"><span class="mv-lbl">Tabung C</span><span class="mv-val" id="val_tb_c"></span></div>
                    </div>
                </td>
                <td id="inj_ket_11"></td>
            </tr>

            <tr class="bg-gray text-bold"><td colspan="4">Electrik :</td><td class="text-center">KETERANGAN</td></tr>
            <tr><td class="text-center">12</td><td>Hopper & support (autoloader)</td><td>Berfungsi normal</td><td id="inj_act_12" class="text-center text-bold"></td><td id="inj_ket_12"></td></tr>
            <tr>
                <td class="text-center">13</td><td>Linier potensiometer (LP) inject stroke</td><td>Membaca normal pada sett. Chusion</td>
                <td style="padding:0;">
                    <div class="mv-grid">
                        <div class="mv-item"><span class="mv-lbl">Sett Value</span><span class="mv-val" id="val_sett"></span></div>
                        <div class="mv-item"><span class="mv-lbl">Actual Display</span><span class="mv-val" id="val_disp"></span></div>
                    </div>
                </td>
                <td id="inj_ket_13"></td>
            </tr>
        </table>

        <table class="no-border" style="margin-top: 20px;">
            <tr class="text-center no-border">
                <td class="no-border" width="33%">DI KERJAKAN :</td>
                <td class="no-border" width="33%">DIPERIKSA</td>
                <td class="no-border" width="33%">MENGETAHUI :</td>
            </tr>
            <tr class="text-center no-border">
                <td class="no-border" style="height: 60px; vertical-align: bottom;">
                    <div id="sig_1" style="height: 40px; margin-bottom: 5px;"></div>
                    <div style="border-top: 1px solid #000; display: inline-block; padding: 0 10px; font-weight:bold;">OPRT.MEKANIK</div>
                    <div id="nm_1" style="font-size:8pt;"></div>
                </td>
                <td class="no-border" style="height: 60px; vertical-align: bottom;">
                    <div id="sig_2" style="height: 40px; margin-bottom: 5px;"></div>
                    <div style="border-top: 1px solid #000; display: inline-block; padding: 0 10px; font-weight:bold;">SPV.MEKANIK</div>
                    <div id="nm_2" style="font-size:8pt;"></div>
                </td>
                <td class="no-border" style="height: 60px; vertical-align: bottom;">
                    <div id="sig_3" style="height: 40px; margin-bottom: 5px;"></div>
                    <div style="border-top: 1px solid #000; display: inline-block; padding: 0 10px; font-weight:bold;">SPTD.MEKANIK</div>
                    <div id="nm_3" style="font-size:8pt;"></div>
                </td>
            </tr>
        </table>

    </div>

    <script>
        // CONFIG DB
        const SB_URL = "https://dsyvlavphvrdidmodokd.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
        const _sb = supabase.createClient(SB_URL, SB_KEY);

        // 1. LOAD DATA MESIN
        window.onload = async () => {
            const { data } = await _sb.from('pmi_machines').select('id, nama_mesin').order('nama_mesin');
            const sel = document.getElementById('sel-mesin');
            sel.innerHTML = '<option value="">-- PILIH MESIN --</option>';
            if(data) data.forEach(m => {
                let opt = document.createElement('option');
                opt.value = m.id; opt.innerText = m.nama_mesin;
                sel.appendChild(opt);
            });
        };

        // 2. CARI LAPORAN
        async function cariLaporan() {
            const mid = document.getElementById('sel-mesin').value;
            const bln = document.getElementById('sel-bulan').value;
            const thn = document.getElementById('sel-tahun').value;

            if(!mid) return alert("Pilih Mesin dulu!");

            const { data: headers, error } = await _sb.from('pmi_header')
                .select('*, pmi_machines(nama_mesin, tonage)')
                .eq('machine_id', mid)
                .eq('bulan', bln)
                .eq('tahun', thn)
                .order('created_at', {ascending:false})
                .limit(1);

            if(error || !headers || headers.length === 0) {
                alert("Data Laporan TIDAK DITEMUKAN pada periode ini.");
                document.getElementById('report-view').style.display = 'none';
                return;
            }

            renderReport(headers[0]);
        }

        // 3. RENDER DATA
        async function renderReport(head) {
            document.getElementById('report-view').style.display = 'block';

            // A. HEADER INFO
            const m = head.pmi_machines || {};
            document.getElementById('v_mesin').innerText = m.nama_mesin || '-';
            document.getElementById('v_ton').innerText = m.tonage || '-';
            document.getElementById('v_tgl').innerText = head.tanggal;
            document.getElementById('v_thn').innerText = head.tahun;
            document.getElementById('v_target').innerText = (head.target_selesai || '').substring(0,5);
            document.getElementById('v_start').innerText = (head.start_jam || '').substring(0,5);
            document.getElementById('v_finish').innerText = (head.finish_jam || '').substring(0,5);
            document.getElementById('v_hm').innerText = head.running_hours;

            // B. TANDA TANGAN
            document.getElementById('nm_1').innerText = head.nama_pelaksana || '........';
            document.getElementById('nm_2').innerText = head.nama_koordinator || '........';
            document.getElementById('nm_3').innerText = head.nama_superintendent || '........';

            if(head.signature_pelaksana) document.getElementById('sig_1').innerHTML = `<img src="${head.signature_pelaksana}" class="sig-img">`;
            if(head.signature_koordinator) document.getElementById('sig_2').innerHTML = `<img src="${head.signature_koordinator}" class="sig-img">`;
            if(head.signature_superintendent) document.getElementById('sig_3').innerHTML = `<img src="${head.signature_superintendent}" class="sig-img">`;

            // C. FETCH DETAILS & MAP
            const { data: items } = await _sb.from('pmi_items').select('*').order('urutan');
            const { data: fields } = await _sb.from('pmi_item_fields').select('*').order('urutan');
            const { data: results } = await _sb.from('pmi_results').select('*').eq('pmi_header_id', head.id);

            let map = {};
            results.forEach(r => { map[`${r.pmi_item_id}_${r.pmi_item_field_id}`] = r; });

            const setVal = (id, val) => { 
                if(document.getElementById(id)) {
                    document.getElementById(id).innerText = val || '-';
                    if(val === 'NG') document.getElementById(id).style.color = 'red';
                }
            };

            // MAPPING STRATEGY: SORT DB ITEMS, THEN MAP SEQUENTIALLY TO VISUAL IDS
            let grouped = {};
            results.forEach(r => {
                if(!grouped[r.pmi_item_id]) grouped[r.pmi_item_id] = [];
                grouped[r.pmi_item_id].push(r);
            });
            let sortedItemIds = Object.keys(grouped).sort((a,b) => grouped[a][0].pmi_items.urutan - grouped[b][0].pmi_items.urutan);

            let idx = 0;
            // Clamping 1-19
            for(let i=1; i<=19; i++) {
                if(sortedItemIds[idx]) {
                    let r = grouped[sortedItemIds[idx]][0];
                    setVal(`act_${i}`, r.status);
                    setVal(`ket_${i}`, r.keterangan);
                    idx++;
                }
            }
            // Tie Bar 20 (Grid) - Assume next item is the Header for grid values
            if(sortedItemIds[idx]) {
                let r = grouped[sortedItemIds[idx]];
                r.forEach(f => {
                    if(f.pmi_item_fields.label === 'S1') setVal('val_s1', f.nilai_aktual);
                    if(f.pmi_item_fields.label === 'S2') setVal('val_s2', f.nilai_aktual);
                    if(f.pmi_item_fields.label === 'S3') setVal('val_s3', f.nilai_aktual);
                    if(f.pmi_item_fields.label === 'S4') setVal('val_s4', f.nilai_aktual);
                });
                idx++;
            }
            // Tie Bar Rows 20-22
            for(let i=20; i<=22; i++) {
                if(sortedItemIds[idx]) {
                    let r = grouped[sortedItemIds[idx]][0];
                    setVal(`act_${i}`, r.status);
                    setVal(`ket_${i}`, r.keterangan);
                    idx++;
                }
            }
            // Pump 1-2
            for(let i=1; i<=2; i++) {
                if(sortedItemIds[idx]) {
                    let r = grouped[sortedItemIds[idx]][0];
                    setVal(`p_act_${i}`, r.status);
                    setVal(`p_ket_${i}`, r.keterangan);
                    idx++;
                }
            }
            // Hydrolik 3-6
            for(let i=3; i<=6; i++) {
                if(sortedItemIds[idx]) {
                    let r = grouped[sortedItemIds[idx]][0];
                    setVal(`p_act_${i}`, r.status);
                    setVal(`p_ket_${i}`, r.keterangan);
                    idx++;
                }
            }
            // Pump 7-8
            if(sortedItemIds[idx]) {
                let r = grouped[sortedItemIds[idx]];
                r.forEach(f => {
                    if(f.pmi_item_fields.label === '50') setVal('val_50', f.nilai_aktual);
                    if(f.pmi_item_fields.label === '100') setVal('val_100', f.nilai_aktual);
                    if(f.pmi_item_fields.label === '150') setVal('val_150', f.nilai_aktual);
                    if(f.pmi_item_fields.label === '200') setVal('val_200', f.nilai_aktual);
                    if(f.pmi_item_fields.label === 'Actual disply') setVal('p1_ad', f.nilai_aktual);
                    if(f.pmi_item_fields.label === 'Pressure Gauge') setVal('p1_pg', f.nilai_aktual);
                });
                setVal('p1_ket', r[0].keterangan);
                idx++;
            }
            if(sortedItemIds[idx]) {
                let r = grouped[sortedItemIds[idx]];
                r.forEach(f => {
                    if(f.pmi_item_fields.label === 'Actul disply') setVal('p2_ad', f.nilai_aktual);
                    if(f.pmi_item_fields.label === 'Pressure Gauge') setVal('p2_pg', f.nilai_aktual);
                });
                setVal('p2_ket', r[0].keterangan);
                idx++;
            }
            // Electrical 6-12
            for(let i=6; i<=12; i++) {
                if(sortedItemIds[idx]) {
                    let r = grouped[sortedItemIds[idx]][0];
                    setVal(`e_act_${i}`, r.status);
                    setVal(`e_ket_${i}`, r.keterangan);
                    idx++;
                }
            }
            // Breaker 13
            if(sortedItemIds[idx]) {
                let r = grouped[sortedItemIds[idx]];
                r.forEach(f => {
                    if(f.pmi_item_fields.label === 'R-S') setVal('val_rs', f.nilai_aktual);
                    if(f.pmi_item_fields.label === 'R-T') setVal('val_rt', f.nilai_aktual);
                    if(f.pmi_item_fields.label === 'S-T') setVal('val_st', f.nilai_aktual);
                });
                setVal('e_ket_13', r[0].keterangan);
                idx++;
            }
            // Injection 1-4
            for(let i=1; i<=4; i++) {
                if(sortedItemIds[idx]) {
                    let r = grouped[sortedItemIds[idx]][0];
                    setVal(`inj_act_${i}`, r.status);
                    setVal(`inj_ket_${i}`, r.keterangan);
                    idx++;
                }
            }
            // Heater 5 (Zones a-f) - Assuming 6 separate items in DB
            for(let i=1; i<=6; i++) {
                if(sortedItemIds[idx]) {
                    let r = grouped[sortedItemIds[idx]];
                    // Map generic fields if labels match, else assume order: 0=Ukur, 1=Display, 2=Gun
                    // Safe approach: check labels if available
                    r.forEach(f => {
                       // Simple heuristic:
                       if(f.pmi_item_fields.label === 'Hasil ukur') setVal(`t_ukr_${i}`, f.nilai_aktual);
                       if(f.pmi_item_fields.label === 'Hasil (Display Mesin)') setVal(`t_ukr_${i}`, f.nilai_aktual); 
                       if(f.pmi_item_fields.label === 'Hasil ukur (Thermo Gun)') setVal(`t_gun_${i}`, f.nilai_aktual);
                       // Fallback if labels vary slightly
                       if(f.pmi_item_fields.urutan === 1) setVal(`t_ukr_${i}`, f.nilai_aktual);
                       if(f.pmi_item_fields.urutan === 2) setVal(`t_gun_${i}`, f.nilai_aktual);
                    });
                    setVal(`t_ket_${i}`, r[0].keterangan);
                    idx++;
                }
            }
            // Hydrolik Inj 6-10
            for(let i=6; i<=10; i++) {
                if(sortedItemIds[idx]) {
                    let r = grouped[sortedItemIds[idx]][0];
                    setVal(`inj_act_${i}`, r.status);
                    setVal(`inj_ket_${i}`, r.keterangan);
                    idx++;
                }
            }
            // Accumulator 11
            if(sortedItemIds[idx]) {
                let r = grouped[sortedItemIds[idx]];
                r.forEach(f => {
                    if(f.pmi_item_fields.label === 'Tabung A') setVal('val_tb_a', f.nilai_aktual);
                    if(f.pmi_item_fields.label === 'Tabung B') setVal('val_tb_b', f.nilai_aktual);
                    if(f.pmi_item_fields.label === 'Tabung C') setVal('val_tb_c', f.nilai_aktual);
                });
                setVal('inj_ket_11', r[0].keterangan);
                idx++;
            }
            // Electrik 12
            if(sortedItemIds[idx]) {
                let r = grouped[sortedItemIds[idx]][0];
                setVal(`inj_act_12`, r.status);
                setVal(`inj_ket_12`, r.keterangan);
                idx++;
            }
            // Linier Pot 13
            if(sortedItemIds[idx]) {
                let r = grouped[sortedItemIds[idx]];
                r.forEach(f => {
                    if(f.pmi_item_fields.label === 'Sett Value') setVal('val_sett', f.nilai_aktual);
                    if(f.pmi_item_fields.label === 'Actual Display') setVal('val_disp', f.nilai_aktual);
                });
                setVal('inj_ket_13', r[0].keterangan);
                idx++;
            }
        }
    </script>
</body>
</html>
