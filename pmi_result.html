<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>PMI Result - PT AKG</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #003366; }
        body { font-family: 'Arial', sans-serif; background: #525659; margin: 0; padding: 20px; font-size: 9px; }
        
        /* Filter Section */
        .filter-box { max-width: 210mm; margin: 0 auto 15px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        select, button { padding: 10px; border-radius: 4px; border: 1px solid #ccc; font-size: 11px; }
        button { background: var(--primary); color: white; font-weight: bold; cursor: pointer; border: none; }
        button:hover { background: #004a94; }
        
        .list-area { margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; }
        .log-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #f0f0f0; align-items: center; background: #f9f9f9; margin-bottom: 5px; border-radius: 4px; }

        /* Paper A4 */
        .paper { width: 210mm; min-height: 297mm; background: white; padding: 10mm; margin: 0 auto; box-sizing: border-box; display: none; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 8px; }
        th, td { border: 1px solid black; padding: 4px; vertical-align: middle; }
        
        .header-title { font-size: 13px; font-weight: bold; text-align: center; line-height: 1.4; }
        .section-row { background: #d1d5db; font-weight: bold; text-transform: uppercase; }
        .sub-section { background: #f3f4f6; font-style: italic; font-weight: bold; }
        .center { text-align: center; }
        .info-table td { border: none !important; padding: 2px 5px; }

        .sig-row { height: 60px; text-align: center; vertical-align: bottom; padding-bottom: 5px; }
        .sig-img { max-height: 55px; display: block; margin: 0 auto; }

        @media print {
            body { background: white; padding: 0; }
            .filter-box, .btn-print, .log-item { display: none !important; }
            .paper { display: block !important; border: none; width: 100%; padding: 5mm; box-shadow: none; }
        }
    </style>
</head>
<body>

    <div class="filter-box">
        <h2 style="margin-top:0; color:var(--primary); font-size: 16px;">Arsip Laporan Preventif Mesin Injection</h2>
        <div class="filter-grid">
            <select id="sel-mesin">
                <option value="">-- Pilih Mesin --</option>
            </select>
            <select id="sel-bulan">
                <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
            </select>
            <select id="sel-tahun">
                <option value="2024">2024</option><option value="2025" selected>2025</option>
            </select>
            <button onclick="searchLogs()">CARI LAPORAN</button>
        </div>
        <div id="list-output" class="list-area">
            <p style="color: #666;">Pilih parameter di atas untuk mencari data laporan.</p>
        </div>
    </div>

    <div class="paper" id="report-paper">
        <table>
            <tr>
                <td rowspan="4" width="100" align="center">
                    <img src="https://amarilyskg.co.id/bootstrap/img/logo.png" width="90">
                </td>
                <td rowspan="4" class="header-title">FORM PREVENTIF MESIN INJECTION<br>(CLAMPING & INJECTION UNIT)</td>
                <td width="160">No. Dokumen: AF.SP 05.07.Rev-00</td>
            </tr>
            <tr><td>Tanggal Terbit: 02 Agustus 2024</td></tr>
            <tr><td>Halaman: 1/1</td></tr>
            <tr><td>Tanggal Revisi: -</td></tr>
        </table>

        <table class="info-table" style="margin-top: 5px; margin-bottom: 10px;">
            <tr>
                <td width="15%">MERK MESIN</td><td width="35%">: <b id="v-merk"></b></td>
                <td width="18%">TARGET SELESAI</td><td width="32%">: -</td>
            </tr>
            <tr>
                <td>TONAGE</td><td>: <b id="v-ton"></b></td>
                <td>START JAM</td><td>: <span id="v-start"></span></td>
            </tr>
            <tr>
                <td>TANGGAL</td><td>: <span id="v-tgl"></span></td>
                <td>FINISH JAM</td><td>: <span id="v-finish"></span></td>
            </tr>
            <tr>
                <td>KODE HERO</td><td>: <b id="v-hero"></b></td>
                <td>RUNNING HOURS</td><td>: -</td>
            </tr>
        </table>

        <table id="main-data">
            <thead>
                <tr style="background:#eee">
                    <th width="25">NO</th>
                    <th>ITEM PENGECEKAN</th>
                    <th width="180">STANDARD</th>
                    <th width="80">ACTUAL</th>
                    <th width="120">KETERANGAN</th>
                </tr>
            </thead>
            <tbody id="v-body">
                </tbody>
        </table>

        <table style="margin-top:15px;">
            <tr class="center" style="background: #f9f9f9; font-weight: bold;">
                <td width="33%">Dibuat Oleh (Teknisi)</td>
                <td width="33%">Diperiksa Oleh (Koordinator)</td>
                <td width="33%">Disetujui Oleh (Superintendent)</td>
            </tr>
            <tr class="sig-row">
                <td id="s-1"></td>
                <td id="s-2"></td>
                <td id="s-3"></td>
            </tr>
            <tr class="center">
                <td><b id="n-1"></b></td>
                <td><b id="n-2"></b></td>
                <td><b id="n-3"></b></td>
            </tr>
        </table>

        <div style="text-align:right; margin-top:20px;">
            <button class="btn-print" onclick="window.print()" style="padding:10px 30px; background:#cc0000; border-radius: 5px;">CETAK LAPORAN (PDF)</button>
        </div>
    </div>

    <script>
        // KONFIGURASI SUPABASE
        const SB_URL = "https://dsyvlavphvrdidmodokd.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
        const _sb = supabase.createClient(SB_URL, SB_KEY);

        // 1. Inisialisasi: Load Daftar Mesin ke Dropdown
        (async function initMesin() {
            try {
                const { data, error } = await _sb.from('pmi_machine').select('mesin_id').order('mesin_id');
                if (error) throw error;
                const sel = document.getElementById('sel-mesin');
                data.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.mesin_id;
                    opt.textContent = m.mesin_id;
                    sel.appendChild(opt);
                });
            } catch (err) {
                console.error("Gagal memuat mesin:", err.message);
            }
        })();

        // 2. Fungsi Cari Laporan
        async function searchLogs() {
            const mesin = document.getElementById('sel-mesin').value;
            const bulan = document.getElementById('sel-bulan').value;
            const tahun = document.getElementById('sel-tahun').value;
            const out = document.getElementById('list-output');
            
            if(!mesin) return alert("Pilih mesin terlebih dahulu!");

            out.innerHTML = "<i>Mencari data laporan...</i>";
            
            const startDate = `${tahun}-${bulan}-01T00:00:00`;
            const endDate = `${tahun}-${bulan}-31T23:59:59`;

            const { data, error } = await _sb.from('pmi_log').select('*')
                .eq('mesin_id', mesin)
                .gte('created_at', startDate).lte('created_at', endDate)
                .order('created_at', {ascending: false});

            if(!data || data.length === 0) {
                out.innerHTML = "<span style='color:red'>Data tidak ditemukan untuk periode ini.</span>";
                return;
            }

            out.innerHTML = `<p>Ditemukan <b>${data.length}</b> laporan:</p>` + data.map(d => `
                <div class="log-item">
                    <span>ðŸ“… <b>${new Date(d.created_at).toLocaleDateString('id-ID')}</b> | Pelaksana: ${d.nama_pelaksana}</span>
                    <button onclick="loadForm('${d.id}')">LIHAT HASIL</button>
                </div>
            `).join('');
        }

        // 3. Fungsi Load Detail Laporan ke dalam Form
        async function loadForm(id) {
            const { data: log, error } = await _sb.from('pmi_log').select('*, pmi_result(*)').eq('id', id).single();
            if(!log) return alert("Gagal mengambil detail laporan.");

            document.getElementById('report-paper').style.display = 'block';
            
            // Header Info
            document.getElementById('v-hero').innerText = log.mesin_id;
            document.getElementById('v-merk').innerText = log.mesin_id.split(' ')[0];
            document.getElementById('v-ton').innerText = log.mesin_id.includes('T') ? log.mesin_id.match(/\d+/)[0] + ' T' : '-';
            document.getElementById('v-tgl').innerText = new Date(log.created_at).toLocaleDateString('id-ID', {day:'2-digit', month:'long', year:'numeric'});
            document.getElementById('v-start').innerText = new Date(log.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            document.getElementById('v-finish').innerText = log.completed_at ? new Date(log.completed_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '-';

            const tbody = document.getElementById('v-body');
            tbody.innerHTML = "";

            const res = log.pmi_result;
            const addSec = (title) => tbody.innerHTML += `<tr class="section-row"><td colspan="5">${title}</td></tr>`;

            // SEKSI MEKANIKAL
            addSec("Mekanikal Clamping unit :");
            filterAndRender(tbody, res, 'Mekanikal Clamping Unit', 1);

            // SEKSI HYDROLIK
            addSec("Hydrolik :");
            filterAndRender(tbody, res, 'Hydrolik Clamping', 10);

            // SEKSI ELECTRICAL
            addSec("Electrical :");
            filterAndRender(tbody, res, 'Electrical Clamping', 14);

            // SEKSI TIE BAR (Tampilan Khusus)
            addSec("Kalibrasi Tie Bar :");
            tbody.innerHTML += `<tr><td class="center">20-22</td><td>Kalibrasi Sensormate (S1, S2, S3, S4)</td><td>Toleransi Max 5%</td><td class="center"><b>OK</b></td><td>Hasil data terlampir</td></tr>`;

            // SEKSI INJECTION
            addSec("INJECTION UNIT :");
            filterAndRender(tbody, res, 'Injection Unit', 1);

            // SEKSI HEATER
            tbody.innerHTML += `<tr class="sub-section"><td colspan="5">5. Cek temperatur heater barrel :</td></tr>`;
            ["Zone 1", "Zone 2", "Zone 3", "Zone 4", "Zone 5", "Zone Nozle"].forEach(z => {
                tbody.innerHTML += `<tr><td></td><td>${z}</td><td>Toleransi Â± 15Â°C</td><td class="center">OK</td><td>-</td></tr>`;
            });

            // Tanda Tangan
            document.getElementById('n-1').innerText = log.nama_pelaksana;
            document.getElementById('n-2').innerText = log.nama_koordinator || '-';
            document.getElementById('n-3').innerText = log.nama_superintendent || '-';
            
            if(log.signature_pelaksana) document.getElementById('s-1').innerHTML = `<img src="${log.signature_pelaksana}" class="sig-img">`;
            if(log.signature_koordinator) document.getElementById('s-2').innerHTML = `<img src="${log.signature_koordinator}" class="sig-img">`;
            if(log.signature_superintendent) document.getElementById('s-3').innerHTML = `<img src="${log.signature_superintendent}" class="sig-img">`;

            window.scrollTo({ top: document.getElementById('report-paper').offsetTop, behavior: 'smooth' });
        }

        function filterAndRender(target, data, category, startNo) {
            const filtered = data.filter(r => r.category === category);
            filtered.forEach((r, i) => {
                target.innerHTML += `<tr>
                    <td class="center">${startNo + i}</td>
                    <td>${r.item_name}</td>
                    <td>${r.standard || '-'}</td>
                    <td class="center"><b>${r.status}</b></td>
                    <td>${r.keterangan || ''}</td>
                </tr>`;
            });
        }
    </script>
</body>
</html>
