<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>PMI Final Report - PT AKG</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Arial', sans-serif; background: #525659; margin: 0; padding: 20px; font-size: 9px; }
        .paper { width: 210mm; background: white; padding: 10mm; margin: 0 auto; box-sizing: border-box; border: 1px solid #000; }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 5px; }
        th, td { border: 1px solid black; padding: 3px; }
        
        .header-text { font-size: 12px; font-weight: bold; text-align: center; }
        .section-title { background: #d1d5db; font-weight: bold; text-transform: uppercase; }
        .sub-title { background: #f3f4f6; font-weight: bold; }
        .center { text-align: center; }
        .no-border td { border: none !important; padding: 1px 5px; }
        
        .sig-container { height: 60px; vertical-align: bottom; text-align: center; }
        .sig-img { max-height: 50px; display: block; margin: 0 auto; }

        @media print {
            body { background: white; padding: 0; }
            .no-print { display: none; }
            .paper { border: none; width: 100%; }
        }
    </style>
</head>
<body>

    <div class="no-print" style="background:white; padding:15px; max-width:210mm; margin:0 auto 10px; border-radius:8px;">
        <input type="text" id="input-id" placeholder="Masukkan ID Log / Cari..." style="padding:8px; width:200px;">
        <button onclick="loadData()" style="padding:8px; cursor:pointer; background:#003366; color:white; border:none;">TAMPILKAN FORM</button>
    </div>

    <div class="paper" id="form-pmi" style="display:none;">
        <table>
            <tr>
                <td rowspan="4" width="100" align="center"><img src="https://amarilyskg.co.id/bootstrap/img/logo.png" width="90"></td>
                <td rowspan="4" class="header-text">FORM PREVENTIF MESIN INJECTION<br>(CLAMPING & INJECTION UNIT)</td>
                <td width="150">No. Dokumen: AF.SP 05.07.Rev-00</td>
            </tr>
            <tr><td>Tanggal Terbit: 02 Agustus 2024</td></tr>
            <tr><td>Halaman: 1/1</td></tr>
            <tr><td>Tanggal Revisi: -</td></tr>
        </table>

        <table class="no-border" style="margin-bottom:10px;">
            <tr>
                <td width="15%">MERK MESIN</td><td width="35%">: <b id="m-merk"></b></td>
                <td width="15%">TARGET SELESAI</td><td width="35%">: -</td>
            </tr>
            <tr>
                <td>TONAGE</td><td>: <b id="m-ton"></b></td>
                <td>START JAM</td><td>: <span id="m-start"></span></td>
            </tr>
            <tr>
                <td>TANGGAL</td><td>: <span id="m-tgl"></span></td>
                <td>FINISH JAM</td><td>: <span id="m-finish"></span></td>
            </tr>
            <tr>
                <td>TAHUN</td><td>: <span id="m-thn"></span></td>
                <td>KODE HERO</td><td>: <b id="m-hero"></b></td>
            </tr>
        </table>

        <table id="main-table">
            <thead>
                <tr style="background:#eee">
                    <th width="20">NO</th>
                    <th>ITEM</th>
                    <th width="200">STANDARD</th>
                    <th width="100">ACTUAL</th>
                    <th width="100">KETERANGAN</th>
                </tr>
            </thead>
            <tbody id="content-body">
                </tbody>
        </table>

        <table style="margin-top:15px;">
            <tr class="center">
                <td>Dibuat Oleh (Teknisi)</td>
                <td>Diperiksa Oleh (Koordinator)</td>
                <td>Disetujui Oleh (Superintendent)</td>
            </tr>
            <tr class="sig-container">
                <td id="s-pel"></td><td id="s-koo"></td><td id="s-sup"></td>
            </tr>
            <tr class="center">
                <td><b id="n-pel"></b></td><td><b id="n-koo"></b></td><td><b id="n-sup"></b></td>
            </tr>
        </table>
    </div>

    <script>
        const SB_URL = "https://dsyvlavphvrdidmodokd.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
        const _sb = supabase.createClient(SB_URL, SB_KEY);

        async function loadData() {
            const id = document.getElementById('input-id').value;
            const { data: log, error } = await _sb.from('pmi_log').select('*, pmi_result(*)').eq('id', id).single();

            if (error || !log) return alert("Data tidak ditemukan!");

            document.getElementById('form-pmi').style.display = 'block';
            
            // Info Header
            document.getElementById('m-hero').innerText = log.mesin_id;
            document.getElementById('m-merk').innerText = log.mesin_id.split(' ')[0];
            document.getElementById('m-ton').innerText = log.mesin_id.includes('T') ? log.mesin_id.split('T')[0].split(' ').pop() + ' T' : '-';
            document.getElementById('m-tgl').innerText = new Date(log.created_at).toLocaleDateString('id-ID');
            document.getElementById('m-thn').innerText = new Date(log.created_at).getFullYear();
            document.getElementById('m-start').innerText = new Date(log.created_at).toLocaleTimeString();
            document.getElementById('m-finish').innerText = log.completed_at ? new Date(log.completed_at).toLocaleTimeString() : '-';

            const tbody = document.getElementById('content-body');
            tbody.innerHTML = "";

            // LOGIKA PENYUSUNAN TABEL SESUAI CSV
            // Kita asumsikan urutan log.pmi_result sudah sesuai dengan urutan input teknisi
            
            const res = log.pmi_result;

            // 1. Mekanikal Clamping
            addSection(tbody, "Mekanikal Clamping unit :");
            res.slice(0, 9).forEach((item, i) => addRow(tbody, i+1, item));

            // 2. Hydrolik Clamping
            addSection(tbody, "Hydrolik :");
            res.slice(9, 13).forEach((item, i) => addRow(tbody, i+10, item));

            // 3. Electrical Clamping
            addSection(tbody, "Electrical :");
            res.slice(13, 19).forEach((item, i) => addRow(tbody, i+14, item));

            // 4. Kalibrasi Tie Bar (Custom Column S1-S4)
            addSection(tbody, "Kalibrasi Tie Bar :");
            tbody.innerHTML += `<tr class="center"><td>20-22</td><td>Data Kalibrasi</td><td colspan="3">S1: 25% | S2: 25% | S3: 25% | S4: 25%</td></tr>`;

            // 5. Injection Unit
            addSection(tbody, "INJECTION UNIT :");
            res.slice(19, 23).forEach((item, i) => addRow(tbody, i+1, item));

            // 6. Heater Zone (Custom Layout)
            tbody.innerHTML += `<tr class="sub-title"><td colspan="5">5. Cek temperatur heater barrel :</td></tr>`;
            const zones = ["Zone 1", "Zone 2", "Zone 3", "Zone 4", "Zone 5", "Zone Nozle"];
            zones.forEach(z => {
                tbody.innerHTML += `<tr><td></td><td>${z}</td><td>Toleransi ± 15°C</td><td class="center">OK</td><td>-</td></tr>`;
            });

            // Signatures
            document.getElementById('n-pel').innerText = log.nama_pelaksana;
            document.getElementById('n-koo').innerText = log.nama_koordinator || '-';
            document.getElementById('n-sup').innerText = log.nama_superintendent || '-';
            if(log.signature_pelaksana) document.getElementById('s-pel').innerHTML = `<img src="${log.signature_pelaksana}" class="sig-img">`;
            if(log.signature_koordinator) document.getElementById('s-koo').innerHTML = `<img src="${log.signature_koordinator}" class="sig-img">`;
            if(log.signature_superintendent) document.getElementById('s-sup').innerHTML = `<img src="${log.signature_superintendent}" class="sig-img">`;
        }

        function addSection(target, title) {
            target.innerHTML += `<tr class="section-title"><td colspan="5">${title}</td></tr>`;
        }

        function addRow(target, no, data) {
            if (!data) return;
            target.innerHTML += `<tr>
                <td class="center">${no}</td>
                <td>${data.item_name}</td>
                <td>${data.standard || '-'}</td>
                <td class="center"><b>${data.status}</b></td>
                <td>${data.keterangan || ''}</td>
            </tr>`;
        }
    </script>
</body>
</html>
