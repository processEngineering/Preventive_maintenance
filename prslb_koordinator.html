<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Koordinator - Approval Preventif</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

    <style>
        :root { --primary: #003366; --primary-light: #004488; --success: #16a34a; --warning: #f59e0b; --radius: 20px; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; color: #0f172a; padding: 15px; }
        .container { max-width: 500px; margin: 0 auto; background: white; border-radius: var(--radius); overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .header { background: var(--primary); color: white; padding: 25px 20px; text-align: center; }
        .content { padding: 20px; }
        
        /* Queue Card */
        .queue-card {
            background: #fff; border: 2px solid var(--warning); border-radius: 16px;
            padding: 18px; margin-bottom: 12px; display: flex;
            justify-content: space-between; align-items: center;
        }
        .queue-info h4 { font-size: 14px; font-weight: 800; color: #1e293b; line-height: 1.2; }
        .queue-info p { font-size: 11px; color: #64748b; margin-top: 4px; font-weight: 600; }

        .btn-approve-init { background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 10px; font-weight: 800; font-size: 11px; cursor: pointer; }

        /* Scanner */
        .scanner-box { background: #000; border-radius: 16px; overflow: hidden; margin: 15px 0; }
        #reader { width: 100% !important; }
        .scan-hint { background: #dbeafe; padding: 12px; border-radius: 12px; font-size: 12px; font-weight: 700; color: var(--primary); text-align: center; }

        /* Detail View */
        .machine-header { background: var(--primary); color: white; padding: 20px; border-radius: 16px; text-align: center; margin-bottom: 20px; }
        .machine-header h3 { font-size: 16px; font-weight: 800; }
        .machine-header p { font-size: 11px; opacity: 0.8; margin-top: 5px; }

        .item-row { background: #f8fafc; padding: 12px 15px; border-radius: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #e2e8f0; }
        .item-name { font-weight: 700; font-size: 13px; color: #1e293b; }
        .status-badge { padding: 4px 10px; border-radius: 6px; font-weight: 800; font-size: 10px; }
        .status-ok { background: #dcfce7; color: #166534; }
        .status-ng { background: #fee2e2; color: #991b1b; }

        .note-box { background: #fffbeb; border: 1px solid #fde68a; padding: 8px 12px; border-radius: 8px; font-size: 11px; margin-top: 5px; font-style: italic; }

        /* Form */
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 800; margin-bottom: 8px; font-size: 12px; text-transform: uppercase; }
        input, textarea { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 14px; font-weight: 600; outline: none; }
        .sig-box { border: 2px solid #e2e8f0; border-radius: 12px; background: #fff; margin-top: 5px; overflow: hidden; }
        #signature-pad { width: 100%; height: 160px; }

        .btn-submit { width: 100%; padding: 18px; background: var(--success); color: white; border: none; border-radius: 16px; font-size: 15px; font-weight: 800; margin-top: 25px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <header class="header">
        <h1>APPROVAL KOORDINATOR</h1>
        <p>Preventif Robot & Label • PT AKG</p>
    </header>

    <div class="content">
        <div id="view-list">
            <h2 style="font-size: 14px; font-weight: 800; margin-bottom: 15px; color: #475569;"><i class="fas fa-clock"></i> MENUNGGU VERIFIKASI</h2>
            <div id="antrean-container">Memuat data...</div>
        </div>

        <div id="view-scan" style="display:none;">
            <div class="scan-hint">VERIFIKASI LOKASI: SCAN BARCODE <br> <span id="target-name" style="color:#dc2626"></span></div>
            <div class="scanner-box"><div id="reader"></div></div>
            <button onclick="location.reload()" style="width:100%; padding:12px; background:#94a3b8; color:white; border:none; border-radius:12px; font-weight:800;">BATAL</button>
        </div>

        <div id="view-approve" style="display:none;">
            <div class="machine-header">
                <h3 id="disp-mesin">-</h3>
                <p id="disp-pelaksana"></p>
            </div>

            <div id="detail-items" style="margin-bottom: 25px;"></div>

            <div class="form-group">
                <label>Nama Koordinator</label>
                <input type="text" id="koor-nama" placeholder="Ketik nama lengkap...">
            </div>

            <div class="form-group">
                <label>Catatan (Opsional)</label>
                <textarea id="koor-note" placeholder="Tambahkan catatan jika perlu..."></textarea>
            </div>

            <div class="form-group">
                <label>Tanda Tangan Approval</label>
                <div class="sig-box"><canvas id="signature-pad"></canvas></div>
                <button onclick="signaturePad.clear()" style="font-size:10px; color:red; border:none; background:none; margin-top:8px; font-weight:bold;">HAPUS TANDA TANGAN</button>
            </div>

            <button class="btn-submit" id="btn-submit-approve" onclick="submitApproval()">APPROVE & SELESAI</button>
        </div>
    </div>
</div>

<script>
    const SB_URL = "https://dsyvlavphvrdidmodokd.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
    const _sb = supabase.createClient(SB_URL, SB_KEY);

    let scanner = null, signaturePad = null, targetName = null, activeLog = null;

    // 1. LOAD ANTREAN
    async function loadAntrean() {
        const { data, error } = await _sb.from('prslb_log')
            .select('*')
            .eq('status_verifikasi', false)
            .order('created_at', { ascending: false });

        const container = document.getElementById('antrean-container');
        if (!data || data.length === 0) {
            container.innerHTML = '<p style="text-align:center; padding:30px; font-size:12px; color:#94a3b8;">Tidak ada laporan pending.</p>';
            return;
        }

        container.innerHTML = '';
        data.forEach(log => {
            container.innerHTML += `
                <div class="queue-card">
                    <div class="queue-info">
                        <h4>${log.mesin_id}</h4>
                        <p>Pelaksana: ${log.pelaksana_nama}</p>
                    </div>
                    <button class="btn-approve-init" onclick="startScan('${log.mesin_id}')">APPROVE</button>
                </div>`;
        });
    }

    // 2. START SCAN VERIFIKASI
    function startScan(name) {
        targetName = name;
        document.getElementById('view-list').style.display = 'none';
        document.getElementById('view-scan').style.display = 'block';
        document.getElementById('target-name').textContent = name;

        scanner = new Html5Qrcode("reader");
        scanner.start(
            { facingMode: "environment" },
            { fps: 25, qrbox: { width: 300, height: 150 } },
            async (decodedText) => {
                // Mencocokkan teks barcode dengan nama mesin di log
                if (decodedText.trim().toLowerCase().includes(targetName.toLowerCase().trim())) {
                    await scanner.stop();
                    loadDetail(targetName);
                } else {
                    alert("Gagal! Scan mesin yang salah.\nHarusnya: " + targetName);
                }
            }
        );
    }

    // 3. LOAD DETAIL LAPORAN
    async function loadDetail(name) {
        const { data } = await _sb.from('prslb_log')
            .select('*, prslb_result(*, prslb_items(item_name))')
            .eq('status_verifikasi', false)
            .eq('mesin_id', name)
            .order('created_at', { ascending: false })
            .limit(1)
            .single();

        if (!data) return location.reload();

        activeLog = data;
        document.getElementById('view-scan').style.display = 'none';
        document.getElementById('view-approve').style.display = 'block';
        document.getElementById('disp-mesin').textContent = data.mesin_id;
        document.getElementById('disp-pelaksana').textContent = `Pelaksana: ${data.pelaksana_nama}`;

        const container = document.getElementById('detail-items');
        container.innerHTML = '';
        data.prslb_result.forEach(res => {
            container.innerHTML += `
                <div class="item-row">
                    <div class="item-name">${res.prslb_items.item_name}</div>
                    <span class="status-badge ${res.status === 'OK' ? 'status-ok' : 'status-ng'}">${res.status}</span>
                </div>
                ${res.keterangan ? `<div class="note-box">${res.keterangan}</div>` : ''}`;
        });

        const canvas = document.getElementById('signature-pad');
        signaturePad = new SignaturePad(canvas);
        canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
    }

    // 4. SUBMIT APPROVAL
    async function submitApproval() {
        const nama = document.getElementById('koor-nama').value.trim();
        const btn = document.getElementById('btn-submit-approve');

        if (!nama || signaturePad.isEmpty()) return alert("Nama & Tanda Tangan Wajib!");

        btn.disabled = true; btn.innerText = "MEMPROSES...";

        const { error } = await _sb.from('prslb_log').update({
            koordinator_nama: nama,
            koordinator_note: document.getElementById('koor-note').value.trim(),
            status_verifikasi: true,
            signature_koordinator: signaturePad.toDataURL()
        }).eq('id', activeLog.id);

        if (error) {
            alert("Gagal: " + error.message);
            btn.disabled = false; btn.innerText = "APPROVE & SELESAI";
        } else {
            alert("Laporan Berhasil Di-Approve! ✅");
            location.reload();
        }
    }

    window.onload = loadAntrean;
</script>

</body>
</html>
