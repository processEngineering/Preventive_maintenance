<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Pelaksana</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; color: #000; overflow-x: hidden; }

        /* SCANNER VIEW (Wireframe Style) */
        .pill-header {
            border: 2px solid #000;
            border-radius: 9999px; /* Pill shape */
            padding: 1rem 3rem;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1); /* Sedikit shadow halus */
            background: white;
            display: inline-block;
            width: 80%;
        }

        /* Viewfinder Brackets */
        .scanner-frame {
            position: relative;
            width: 280px;
            height: 280px;
            margin: 0 auto;
        }
        .bracket {
            position: absolute;
            width: 40px;
            height: 40px;
            border-color: #000;
            border-style: solid;
            border-width: 0;
            z-index: 20;
        }
        .tl { top: 0; left: 0; border-top-width: 6px; border-left-width: 6px; }
        .tr { top: 0; right: 0; border-top-width: 6px; border-right-width: 6px; }
        .bl { bottom: 0; left: 0; border-bottom-width: 6px; border-left-width: 6px; }
        .br { bottom: 0; right: 0; border-bottom-width: 6px; border-right-width: 6px; }

        /* Video element fix */
        #reader { width: 100%; height: 100%; border-radius: 12px; overflow: hidden; background: #eee; }
        #reader video { object-fit: cover; width: 100%; height: 100%; }

        /* Trapezoid Lines Effect */
        .trapezoid-lines {
            position: absolute;
            bottom: 80px; /* Di atas navbar */
            left: 0; 
            right: 0;
            height: 150px;
            z-index: 5;
            pointer-events: none;
        }
        .line-left, .line-right {
            position: absolute;
            bottom: 0;
            width: 2px;
            height: 100%;
            background: #000;
        }
        .line-left { left: 20px; transform-origin: bottom left; transform: rotate(25deg); }
        .line-right { right: 20px; transform-origin: bottom right; transform: rotate(-25deg); }

        /* Button "SCAN QR" */
        .scan-badge {
            position: absolute;
            top: -10px; /* Posisi di ujung atas garis trapesium */
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 2px solid #000;
            border-radius: 8px;
            padding: 4px 16px;
            font-weight: 900;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            z-index: 10;
            box-shadow: 2px 2px 0 #000;
        }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 70px;
            background: white;
            border-top: 2px solid #000;
            display: flex;
            justify-content: space-around;
            items-align: center;
            padding-top: 15px;
            z-index: 50;
        }
        .nav-icon { font-size: 24px; color: #000; }

        /* FORM STYLING (Tetap Rapi tapi logic jalan) */
        .form-ng:checked + div {
            background-color: #fee2e2; /* Red-100 */
            border-color: #ef4444;
            color: #b91c1c;
        }
        .form-ok:checked + div {
            background-color: #dcfce7; /* Green-100 */
            border-color: #22c55e;
            color: #15803d;
        }
    </style>
</head>
<body class="bg-white min-h-screen relative">

    <div id="page-scanner" class="flex flex-col h-screen relative">
        
        <div class="pt-12 pb-4 text-center z-20">
            <div class="pill-header">
                <h1 class="text-xl font-bold text-black">Pelaksana</h1>
            </div>
        </div>

        <div class="px-10 mb-6 text-center z-20">
            <p class="text-[13px] italic text-gray-600 leading-tight">
                Silahkan scan QR code pada mesin<br>untuk melanjutkan ke halaman form check list
            </p>
        </div>

        <div class="flex-grow flex flex-col items-center justify-start pt-4 z-20">
            <div class="scanner-frame">
                <div class="bracket tl"></div>
                <div class="bracket tr"></div>
                <div class="bracket bl"></div>
                <div class="bracket br"></div>
                
                <div id="reader"></div>
            </div>
        </div>

        <div class="trapezoid-lines">
            <div class="scan-badge">SCAN QR</div>
            <div class="line-left"></div>
            <div class="line-right"></div>
        </div>

        <div class="bottom-nav">
            <i class="fa-solid fa-house nav-icon"></i>
            <i class="fa-solid fa-bars nav-icon"></i>
            <i class="fa-solid fa-download nav-icon"></i>
            <i class="fa-solid fa-circle-user nav-icon"></i>
        </div>
    </div>


    <div id="page-form" class="hidden min-h-screen pb-24 px-5 pt-8 bg-slate-50">
        <div class="bg-white border-2 border-black rounded-2xl p-6 mb-6 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]">
            <h2 id="machine-name" class="text-2xl font-black uppercase tracking-tighter mb-1">LOADING...</h2>
            <div class="flex gap-4 text-xs font-bold text-gray-500">
                <p>TON: <span id="machine-ton" class="text-black">-</span></p>
                <p>SN: <span id="machine-sn" class="text-black">-</span></p>
            </div>
        </div>

        <div class="mb-6">
            <label class="text-xs font-bold uppercase mb-2 block ml-1">Nama Pelaksana</label>
            <input type="text" id="technician-name" class="w-full border-2 border-black rounded-xl p-3 font-bold uppercase outline-none focus:bg-blue-50" placeholder="ISIKAN NAMA ANDA">
        </div>

        <div id="checklist-container" class="space-y-4 mb-6">
            </div>

        <div class="bg-white border-2 border-black rounded-2xl p-4 mb-8">
            <div class="flex justify-between mb-2">
                <span class="text-xs font-bold uppercase">Tanda Tangan</span>
                <button onclick="sigPad.clear()" class="text-[10px] font-bold text-red-600 uppercase border border-red-200 px-2 rounded">Hapus</button>
            </div>
            <canvas id="signature-pad" class="w-full h-32 bg-gray-50 border border-dashed border-gray-300 rounded-lg"></canvas>
        </div>

        <button onclick="saveAll()" id="btn-save" class="w-full bg-black text-white font-black py-4 rounded-xl shadow-[4px_4px_0px_0px_rgba(100,100,100,1)] active:translate-y-1 active:shadow-none transition-all uppercase tracking-widest text-sm">
            Kirim Laporan
        </button>
    </div>

    <script>
        const SB_URL = "https://dsyvlavphvrdidmodokd.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
        const _sb = supabase.createClient(SB_URL, SB_KEY);

        let scanner, currentMachineId, sigPad;

        window.onload = () => {
            // Start Scanner langsung agar tampil di kotak viewfinder
            scanner = new Html5Qrcode("reader");
            scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccess);
        };

        // --- SCAN LOGIC ---
        async function onScanSuccess(decodedText) {
            // Hentikan scanner
            await scanner.stop();
            
            // Cari data mesin
            const { data: mesin } = await _sb.from('chslr_mesin')
                .select('*').ilike('nama_mesin', `%${decodedText.trim()}%`).maybeSingle();

            if (mesin) {
                currentMachineId = mesin.nama_mesin;
                
                // Pindah Halaman
                document.getElementById('page-scanner').classList.add('hidden');
                document.getElementById('page-form').classList.remove('hidden');

                // Isi Data Header
                document.getElementById('machine-name').innerText = mesin.nama_mesin;
                document.getElementById('machine-ton').innerText = mesin.tonage || '-';
                document.getElementById('machine-sn').innerText = mesin.no_seri || '-';

                // Init Signature & Items
                initSigPad();
                loadItems();
            } else {
                alert("❌ Mesin tidak terdaftar!");
                location.reload();
            }
        }

        function initSigPad() {
            const canvas = document.getElementById('signature-pad');
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            sigPad = new SignaturePad(canvas);
        }

        // --- LOAD ITEMS & LOGIC OK/NG ---
        async function loadItems() {
            const { data: items } = await _sb.from('chslr_items').select('*').order('sort_order');
            const container = document.getElementById('checklist-container');
            container.innerHTML = "";

            items.forEach((item, idx) => {
                const html = `
                <div class="bg-white p-4 rounded-xl border border-gray-300 shadow-sm">
                    <p class="font-bold text-sm mb-3">${idx + 1}. ${item.item_name}</p>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="status-${item.id}" value="OK" class="hidden form-ok" checked 
                                onclick="toggleNote(${item.id}, false)">
                            <div class="py-2 text-center border rounded-lg font-bold text-xs bg-gray-50 text-gray-400 transition-all">
                                OK
                            </div>
                        </label>
                        
                        <label class="cursor-pointer">
                            <input type="radio" name="status-${item.id}" value="NG" class="hidden form-ng" 
                                onclick="toggleNote(${item.id}, true)">
                            <div class="py-2 text-center border rounded-lg font-bold text-xs bg-gray-50 text-gray-400 transition-all">
                                NG
                            </div>
                        </label>
                    </div>

                    <div id="note-box-${item.id}" class="hidden mt-3 animate-[fadeIn_0.3s_ease-out]">
                        <textarea id="note-${item.id}" rows="2" 
                            class="w-full bg-red-50 border border-red-200 rounded-lg p-2 text-xs placeholder-red-300 outline-none" 
                            placeholder="Wajib isi detail kerusakan..."></textarea>
                    </div>
                </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        // FUNGSI UTAMA LOGIC CATATAN
        // Dipanggil saat radio button diklik
        window.toggleNote = function(id, isNG) {
            const box = document.getElementById(`note-box-${id}`);
            const input = document.getElementById(`note-${id}`);
            
            if (isNG) {
                // Kalo NG: Munculkan kotak catatan
                box.classList.remove('hidden');
                input.focus();
            } else {
                // Kalo OK: Sembunyikan & Kosongkan isinya
                box.classList.add('hidden');
                input.value = ""; 
            }
        }

        // --- SAVE FUNCTION ---
        async function saveAll() {
            const name = document.getElementById('technician-name').value.trim();
            if(!name || sigPad.isEmpty()) return alert("Isi Nama & Tanda Tangan!");

            // Validasi: Jika ada status NG, catatannya harus diisi
            const ngInputs = document.querySelectorAll('input[value="NG"]:checked');
            for (let radio of ngInputs) {
                const itemId = radio.name.split('-')[1]; // status-123 -> 123
                const noteVal = document.getElementById(`note-${itemId}`).value.trim();
                if (!noteVal) {
                    return alert("⚠️ Item NG wajib diberi catatan!");
                }
            }

            const btn = document.getElementById('btn-save');
            btn.innerText = "MENGIRIM..."; btn.disabled = true;

            const now = new Date();
            const d = now.getDate(), m = now.getMonth() + 1, y = now.getFullYear();

            try {
                // 1. Cek Log Harian
                let { data: log } = await _sb.from('chslr_log')
                    .select('*').eq('mesin_id', currentMachineId).eq('bulan', m).eq('tahun', y).maybeSingle();

                if (!log) {
                    const { data: nLog } = await _sb.from('chslr_log')
                        .insert({ mesin_id: currentMachineId, bulan: m, tahun: y, pelaksana_names: [name] })
                        .select().single();
                    log = nLog;
                } else {
                    if (!log.pelaksana_names.includes(name)) {
                        await _sb.from('chslr_log')
                            .update({ pelaksana_names: [...log.pelaksana_names, name] }).eq('id', log.id);
                    }
                }

                // 2. Simpan Item
                const { data: items } = await _sb.from('chslr_items').select('id');
                const results = items.map(i => {
                    const status = document.querySelector(`input[name="status-${i.id}"]:checked`).value;
                    return {
                        log_id: log.id,
                        item_id: i.id,
                        tanggal: d,
                        status: status,
                        // Ambil catatan hanya jika NG (sebenarnya sudah diclear di toggleNote, tapi double check)
                        keterangan: (status === 'NG') ? document.getElementById(`note-${i.id}`).value : "",
                        signature: sigPad.toDataURL()
                    };
                });

                await _sb.from('chslr_result').delete().eq('log_id', log.id).eq('tanggal', d);
                const { error } = await _sb.from('chslr_result').insert(results);
                if (error) throw error;

                alert("✅ Sukses!");
                location.reload();

            } catch (e) {
                alert("Error: " + e.message);
                btn.innerText = "Kirim Laporan"; btn.disabled = false;
            }
        }
    </script>
</body>
</html>
