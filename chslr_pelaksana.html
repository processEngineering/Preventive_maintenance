<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pelaksana - Input Harian CHSLR</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-slate-50 min-h-screen pb-20">

    <div class="bg-white border-b p-4 sticky top-0 z-10 shadow-sm">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <h1 class="font-bold text-slate-800 text-lg">Input Harian CHSLR</h1>
            <span id="display-date" class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-bold"></span>
        </div>
    </div>

    <div class="max-w-md mx-auto p-4">
        <div class="bg-white rounded-2xl p-4 shadow-sm mb-6 border border-slate-200">
            <div class="mb-4">
                <label class="block text-xs font-bold text-slate-500 mb-1">NAMA MESIN</label>
                <select id="select-mesin" class="w-full p-3 rounded-xl border border-slate-200 bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none">
                    <option value="">-- Pilih Mesin --</option>
                </select>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">TANGGAL CEK</label>
                    <input type="date" id="input-date" class="w-full p-3 rounded-xl border border-slate-200 bg-slate-50 text-sm">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">NAMA PELAKSANA</label>
                    <input type="text" id="input-nama" placeholder="Nama anda" class="w-full p-3 rounded-xl border border-slate-200 bg-slate-50 text-sm">
                </div>
            </div>
            <button onclick="loadChecklist()" class="w-full mt-4 bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition">MULAI CEK</button>
        </div>

        <div id="checklist-container" class="hidden space-y-4">
            <h2 class="font-black text-slate-900 text-xl px-1">Item Inspeksi</h2>
            <div id="items-list" class="space-y-3">
                </div>

            <button onclick="submitHarian()" id="btn-save" class="w-full bg-slate-900 text-white font-black py-4 rounded-2xl shadow-lg mt-8 active:scale-95 transition">
                SIMPAN DATA HARIAN
            </button>
        </div>
    </div>

    <script>
        const SB_URL = "https://dsyvlavphvrdidmodokd.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
        const _sb = supabase.createClient(SB_URL, SB_KEY);

        // Set default date to today
        const today = new Date();
        document.getElementById('input-date').value = today.toISOString().split('T')[0];
        document.getElementById('display-date').innerText = today.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' });

        // Load Mesin
        async function loadMesin() {
            const { data } = await _sb.from('chslr_mesin').select('*').order('nama_mesin');
            const select = document.getElementById('select-mesin');
            data.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.id;
                opt.innerText = `${m.merk_mesin} ${m.tonage} (${m.nama_mesin})`;
                select.appendChild(opt);
            });
        }

        // Load Checklist Items
        async function loadChecklist() {
            const mId = document.getElementById('select-mesin').value;
            const nama = document.getElementById('input-nama').value;
            if(!mId || !nama) return alert("Pilih mesin dan isi nama dulu bro!");

            const { data: items } = await _sb.from('chslr_items').select('*').order('sort_order');
            const list = document.getElementById('items-list');
            list.innerHTML = "";

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-2xl border border-slate-200 shadow-sm";
                div.innerHTML = `
                    <p class="text-[10px] font-bold text-blue-600 mb-1 uppercase">${item.kategori}</p>
                    <p class="font-bold text-slate-800 text-sm mb-1">${item.item_name}</p>
                    <p class="text-xs text-slate-500 mb-3 italic">Std: ${item.standard}</p>
                    <div class="flex gap-3">
                        <label class="flex-1">
                            <input type="radio" name="status-${item.id}" value="OK" class="hidden peer" checked>
                            <div class="text-center p-2 rounded-lg border-2 border-slate-100 peer-checked:border-green-500 peer-checked:bg-green-50 text-slate-400 peer-checked:text-green-600 font-bold text-sm transition cursor-pointer">OK</div>
                        </label>
                        <label class="flex-1">
                            <input type="radio" name="status-${item.id}" value="NG" class="hidden peer">
                            <div class="text-center p-2 rounded-lg border-2 border-slate-100 peer-checked:border-red-500 peer-checked:bg-red-50 text-slate-400 peer-checked:text-red-600 font-bold text-sm transition cursor-pointer">NG</div>
                        </label>
                    </div>
                    <input type="text" id="note-${item.id}" placeholder="Catatan jika NG..." class="w-full mt-3 p-2 text-xs bg-slate-50 border rounded-lg outline-none focus:border-blue-500">
                `;
                list.appendChild(div);
            });
            document.getElementById('checklist-container').classList.remove('hidden');
        }

        async function submitHarian() {
            const mId = document.getElementById('select-mesin').value;
            const nama = document.getElementById('input-nama').value;
            const dateVal = new Date(document.getElementById('input-date').value);
            const tgl = dateVal.getDate();
            const bln = dateVal.getMonth() + 1;
            const thn = dateVal.getFullYear();

            const btn = document.getElementById('btn-save');
            btn.disabled = true;
            btn.innerText = "MENYIMPAN...";

            // 1. Cari atau Buat Log untuk bulan ini
            let { data: log } = await _sb.from('chslr_log').select('*').eq('mesin_id', mId).eq('bulan', bln).eq('tahun', thn).maybeSingle();

            if (!log) {
                const { data: newLog, error: errLog } = await _sb.from('chslr_log').insert({
                    mesin_id: mId, bulan: bln, tahun: thn, pelaksana_names: [nama]
                }).select().single();
                log = newLog;
            } else {
                // Update nama pelaksana jika belum ada di list
                if(!log.pelaksana_names.includes(nama)) {
                    await _sb.from('chslr_log').update({
                        pelaksana_names: [...log.pelaksana_names, nama]
                    }).eq('id', log.id);
                }
            }

            // 2. Simpan Result per item
            const { data: items } = await _sb.from('chslr_items').select('id');
            const results = items.map(item => {
                return {
                    log_id: log.id,
                    item_id: item.id,
                    tanggal: tgl,
                    status: document.querySelector(`input[name="status-${item.id}"]:checked`).value,
                    keterangan: document.getElementById(`note-${item.id}`).value
                };
            });

            // Hapus data lama di tanggal yang sama agar tidak duplikat (Overwriting)
            await _sb.from('chslr_result').delete().eq('log_id', log.id).eq('tanggal', tgl);
            
            // Insert data baru
            const { error: errResult } = await _sb.from('chslr_result').insert(results);

            if(!errResult) {
                alert("Data Harian Berhasil Disimpan!");
                location.reload();
            } else {
                alert("Gagal simpan: " + errResult.message);
                btn.disabled = false;
                btn.innerText = "SIMPAN DATA HARIAN";
            }
        }

        loadMesin();
    </script>
</body>
</html>
