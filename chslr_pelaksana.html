<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Scan CHSLR</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-slate-50 min-h-screen pb-20 font-sans">

    <div class="bg-white/80 backdrop-blur-md border-b p-4 sticky top-0 z-30">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <h1 class="font-black text-slate-800 tracking-tighter text-xl">DAILY SCAN</h1>
            <div id="date-tag" class="text-[10px] bg-blue-600 text-white px-3 py-1 rounded-full font-bold uppercase"></div>
        </div>
    </div>

    <div class="max-w-md mx-auto p-4">
        
        <div id="machine-info" class="bg-slate-900 rounded-3xl p-6 shadow-2xl mb-6 text-white relative overflow-hidden">
            <div class="relative z-10">
                <p class="text-blue-400 text-[10px] font-black uppercase tracking-widest mb-1">Unit Terdeteksi</p>
                <h2 id="out-nama-mesin" class="text-2xl font-black italic tracking-tight">MENCARI MESIN...</h2>
                <p id="out-merk" class="text-slate-400 text-xs font-bold uppercase"></p>
                
                <div class="mt-6">
                    <label class="block text-[10px] font-black text-slate-500 mb-2 uppercase">Pelaksana Hari Ini</label>
                    <input type="text" id="input-nama" placeholder="Ketik Nama Anda..." 
                        class="w-full bg-white/10 border border-white/20 rounded-2xl p-4 text-white placeholder:text-white/30 font-bold outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                </div>
            </div>
            <i class="fa-solid fa-robot absolute -bottom-4 -right-4 text-7xl text-white/5 rotate-12"></i>
        </div>

        <div id="checklist-container" class="space-y-4">
            <div class="flex flex-col items-center justify-center py-20 text-slate-300" id="loading-state">
                <i class="fa-solid fa-qrcode text-5xl animate-pulse mb-4"></i>
                <p class="font-bold">Scan QR Mesin untuk memulai...</p>
            </div>
        </div>

        <div id="footer-action" class="hidden fixed bottom-6 left-0 right-0 px-6 max-w-md mx-auto z-40">
            <button onclick="submitHarian()" id="btn-save" class="w-full bg-blue-600 text-white font-black py-5 rounded-[2rem] shadow-2xl shadow-blue-500/40 active:scale-95 transition-all flex items-center justify-center gap-3">
                <span>SIMPAN & SELESAI</span>
                <i class="fa-solid fa-check-double"></i>
            </button>
        </div>
    </div>

    <script>
        const SB_URL = "https://dsyvlavphvrdidmodokd.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
        const _sb = supabase.createClient(SB_URL, SB_KEY);

        let currentMachineId = null;
        const now = new Date();

        window.onload = async () => {
            // 1. Set Tanggal Otomatis
            document.getElementById('date-tag').innerText = now.toLocaleDateString('id-ID', { day:'numeric', month:'short', year:'numeric'});

            // 2. Ambil ID Mesin dari URL (?id=...)
            const params = new URLSearchParams(window.location.search);
            currentMachineId = params.get('id');

            if(currentMachineId) {
                await initChecklist();
            } else {
                document.getElementById('out-nama-mesin').innerText = "QR TIDAK VALID";
                document.getElementById('loading-state').innerHTML = `<p class="text-red-400 font-bold text-center">QR Code tidak terbaca atau link salah. Silahkan scan ulang.</p>`;
            }
        };

        async function initChecklist() {
            // Get Machine Detail
            const { data: mesin } = await _sb.from('chslr_mesin').select('*').eq('id', currentMachineId).single();
            
            if(!mesin) {
                alert("Mesin tidak terdaftar di database!");
                return;
            }

            document.getElementById('out-nama-mesin').innerText = mesin.nama_mesin;
            document.getElementById('out-merk').innerText = `${mesin.merk_mesin} - ${mesin.tonage}`;
            document.getElementById('loading-state').remove();
            
            // Load Items
            const { data: items } = await _sb.from('chslr_items').select('*').order('sort_order');
            const list = document.getElementById('checklist-container');
            
            let currentKategori = "";
            items.forEach(item => {
                if(item.kategori !== currentKategori) {
                    currentKategori = item.kategori;
                    list.insertAdjacentHTML('beforeend', `<div class="pt-4 text-[10px] font-black text-blue-600 uppercase tracking-[0.2em]">${currentKategori}</div>`);
                }

                const card = `
                    <div class="bg-white p-5 rounded-3xl border border-slate-200 shadow-sm mb-3">
                        <p class="font-bold text-slate-800 text-sm mb-1">${item.item_name}</p>
                        <p class="text-[10px] text-slate-400 italic mb-4">Std: ${item.standard}</p>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="cursor-pointer">
                                <input type="radio" name="status-${item.id}" value="OK" class="hidden peer" checked>
                                <div class="text-center py-3 rounded-2xl bg-slate-50 border-2 border-transparent peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 font-black text-xs transition-all">OK</div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="status-${item.id}" value="NG" class="hidden peer">
                                <div class="text-center py-3 rounded-2xl bg-slate-50 border-2 border-transparent peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 font-black text-xs transition-all">NG</div>
                            </label>
                        </div>
                    </div>
                `;
                list.insertAdjacentHTML('beforeend', card);
            });
            
            document.getElementById('footer-action').classList.remove('hidden');
        }

        async function submitHarian() {
            const nama = document.getElementById('input-nama').value.trim();
            if(!nama) return alert("Isi Nama Pelaksana dulu bro!");

            const btn = document.getElementById('btn-save');
            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-spinner animate-spin"></i> MENYIMPAN...`;

            const tgl = now.getDate();
            const bln = now.getMonth() + 1;
            const thn = now.getFullYear();

            // 1. Sync Log Bulanan
            let { data: log } = await _sb.from('chslr_log').select('*').eq('mesin_id', currentMachineId).eq('bulan', bln).eq('tahun', thn).maybeSingle();

            if (!log) {
                const { data: newLog } = await _sb.from('chslr_log').insert({
                    mesin_id: currentMachineId, bulan: bln, tahun: thn, pelaksana_names: [nama]
                }).select().single();
                log = newLog;
            } else {
                if(!log.pelaksana_names.includes(nama)) {
                    await _sb.from('chslr_log').update({ pelaksana_names: [...log.pelaksana_names, nama] }).eq('id', log.id);
                }
            }

            // 2. Insert Results
            const { data: items } = await _sb.from('chslr_items').select('id');
            const results = items.map(item => ({
                log_id: log.id,
                item_id: item.id,
                tanggal: tgl,
                status: document.querySelector(`input[name="status-${item.id}"]:checked`).value,
                keterangan: ""
            }));

            await _sb.from('chslr_result').delete().eq('log_id', log.id).eq('tanggal', tgl);
            const { error } = await _sb.from('chslr_result').insert(results);

            if(!error) {
                alert("DATA TERSIMPAN!");
                location.href = 'chslr.html';
            } else {
                alert("Error: " + error.message);
                btn.disabled = false;
                btn.innerText = "SIMPAN & SELESAI";
            }
        }
    </script>
</body>
</html>
