<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Superintendent - Final Approval CHSLR</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
</head>
<body class="bg-slate-100 min-h-screen p-4 md:p-8">

    <div class="max-w-2xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-black text-slate-900">SUPERINTENDENT</h1>
            <p class="text-slate-500 font-medium">Final Authorization Daily Checklist</p>
        </div>

        <div id="list-approval" class="space-y-6">
            <p class="text-center text-slate-400">Memeriksa laporan yang masuk...</p>
        </div>
    </div>

    <script>
        const SB_URL = "https://dsyvlavphvrdidmodokd.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzeXZsYXZwaHZyZGlkbW9kb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5NjMsImV4cCI6MjA4MTg0ODk2M30.mLmyZMUPtCaQl5Vck-Y7nImDFQuVWN_Mk6PrE-miP2E";
        const _sb = supabase.createClient(SB_URL, SB_KEY);
        let pads = {};

        async function loadPending() {
            // Ambil log yang SUDAH di-approve Koordinator tapi BELUM Final
            const { data, error } = await _sb.from('chslr_log')
                .select('*, chslr_mesin(nama_mesin, merk_mesin)')
                .eq('status_verifikasi', true)
                .eq('status_final', false)
                .order('created_at', { ascending: false });

            const container = document.getElementById('list-approval');
            if(!data || data.length === 0) {
                container.innerHTML = `<div class="bg-white p-10 rounded-3xl text-center shadow-sm border border-slate-200">
                    <div class="text-5xl mb-4 text-slate-200"><i class="fa-solid fa-circle-check"></i></div>
                    <p class="text-slate-500 font-bold">Semua laporan harian sudah ditandatangani.</p>
                </div>`;
                return;
            }

            container.innerHTML = "";
            data.forEach(log => {
                const monthName = new Date(0, log.bulan - 1).toLocaleString('id-ID', {month: 'long'});
                const card = `
                    <div id="card-${log.id}" class="bg-white rounded-[32px] p-6 shadow-xl shadow-slate-200/50 border border-slate-200 overflow-hidden relative">
                        <div class="absolute top-0 right-0 bg-blue-600 text-white px-6 py-2 rounded-bl-2xl font-black text-sm tracking-widest uppercase">
                            ${monthName} ${log.tahun}
                        </div>

                        <div class="mb-6">
                            <h2 class="text-2xl font-black text-slate-900">${log.chslr_mesin.nama_mesin}</h2>
                            <p class="text-slate-400 font-bold text-xs uppercase tracking-tighter">${log.chslr_mesin.merk_mesin}</p>
                        </div>

                        <div class="space-y-4 mb-8">
                            <div class="flex items-start gap-3">
                                <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 flex-shrink-0"><i class="fa-solid fa-users text-xs"></i></div>
                                <div>
                                    <p class="text-[10px] font-black text-slate-400 uppercase">Tim Pelaksana</p>
                                    <p class="text-sm font-bold text-slate-700">${log.pelaksana_names.join(', ')}</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center text-blue-500 flex-shrink-0"><i class="fa-solid fa-user-check text-xs"></i></div>
                                <div>
                                    <p class="text-[10px] font-black text-blue-400 uppercase">Koordinator (P2)</p>
                                    <p class="text-sm font-bold text-slate-700">${log.koordinator_nama}</p>
                                    <p class="text-xs text-slate-500 italic mt-1">"${log.koordinator_note || 'Tidak ada catatan khusus.'}"</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-slate-50 rounded-2xl p-5 border border-slate-100">
                            <label class="block text-[10px] font-black text-slate-400 uppercase mb-3">Otorisasi Superintendent</label>
                            <input type="text" id="name-${log.id}" oninput="validate('${log.id}')" placeholder="Ketik Nama Anda" 
                                class="w-full p-3 rounded-xl border border-slate-200 mb-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            
                            <div class="relative bg-white border border-slate-200 rounded-xl overflow-hidden">
                                <canvas id="pad-${log.id}" class="w-full h-32 touch-none"></canvas>
                                <button onclick="clearPad('${log.id}')" class="absolute top-2 right-2 text-[10px] bg-slate-100 px-2 py-1 rounded-md font-bold text-slate-500">RESET</button>
                            </div>

                            <button id="btn-${log.id}" onclick="submitFinal('${log.id}')" disabled
                                class="w-full mt-4 bg-slate-300 text-white font-black py-4 rounded-xl transition-all duration-300">
                                APPROVE & CLOSE REPORT
                            </button>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', card);
                initPad(log.id);
            });
        }

        function initPad(id) {
            setTimeout(() => {
                const canvas = document.getElementById(`pad-${id}`);
                const pad = new SignaturePad(canvas);
                pad.onEnd = () => validate(id);
                pads[id] = pad;
                
                // Fix canvas size
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
            }, 300);
        }

        function validate(id) {
            const name = document.getElementById(`name-${id}`).value.trim();
            const btn = document.getElementById(`btn-${id}`);
            const pad = pads[id];

            if(name.length > 2 && !pad.isEmpty()) {
                btn.disabled = false;
                btn.classList.replace('bg-slate-300', 'bg-blue-600');
                btn.classList.add('shadow-lg', 'shadow-blue-200');
            } else {
                btn.disabled = true;
                btn.classList.replace('bg-blue-600', 'bg-slate-300');
                btn.classList.remove('shadow-lg', 'shadow-blue-200');
            }
        }

        function clearPad(id) {
            pads[id].clear();
            validate(id);
        }

        async function submitFinal(id) {
            const btn = document.getElementById(`btn-${id}`);
            btn.innerText = "â³ MEMPROSES...";
            btn.disabled = true;

            const { error } = await _sb.from('chslr_log').update({
                superintendent_nama: document.getElementById(`name-${id}`).value,
                signature_superintendent: pads[id].toDataURL(),
                status_final: true
            }).eq('id', id);

            if(!error) {
                document.getElementById(`card-${id}`).classList.add('opacity-0', 'scale-95');
                setTimeout(() => loadPending(), 500);
            } else {
                alert("Gagal: " + error.message);
                btn.innerText = "APPROVE & CLOSE REPORT";
                btn.disabled = false;
            }
        }

        loadPending();
    </script>
</body>
</html>
